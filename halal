local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local taskWait = task.wait

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule = require(ReplicatedStorage.Modules.Items)
local RepLibrary = require(ReplicatedStorage.Modules.RepLibrary)

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")
local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

local TARGET_NAME = "valentine"

local inAuction = false
local foundTargetGarage = nil
local obtainedTarget = false
local halted = false
local currentNextBid
local currentBidder

-- Track current bid info
UpdateCurrentBid.OnClientEvent:Connect(function(data)
	if data then
		currentNextBid = data.nextBid
		currentBidder = data.player
	end
end)

-- Detect auctions starting/stopping
AuctionsFolder.ChildAdded:Connect(function()
	inAuction = true
end)
AuctionsFolder.ChildRemoved:Connect(function()
	if #AuctionsFolder:GetChildren() == 0 then
		inAuction = false
		foundTargetGarage = nil
	end
end)

-- Check if storage is full
local function storageFull()
	local success, data = pcall(function() return DataEvent:InvokeServer() end)
	if not success or not data then return false end
	local inv = data.Inventory or {}
	local invLevel = data.InventoryLevel
	local carryLevel = data.CarryLevel
	local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, carryLevel)
	local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, invLevel)
	local invCount = RepLibrary:GetLengthOfInventory(inv)
	return invCount >= invSpace or carrySpace <= 0
end

-- Safely click a button
local function clickButton(obj)
	if obj and (obj:IsA("TextButton") or obj:IsA("ImageButton")) then
		pcall(function() obj:Activate() end)
		if getconnections then
			for _, c in pairs(getconnections(obj.MouseButton1Click)) do
				pcall(function() c:Fire() end)
			end
		end
	end
end

-- Handle the "ItemsWon" GUI
local function handleItemsWon()
	local gui = LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("ItemsWon", true)
	if gui then
		local itemsFrame = gui:FindFirstChild("ItemsFrame", true)
		if itemsFrame then
			local frame = itemsFrame:FindFirstChild("Frame")
			if frame then
				for _, child in pairs(frame:GetChildren()) do
					if child:IsA("ImageButton") and child:FindFirstChild("Price") then
						local itemData = ItemsModule[child.Name]
						if itemData and itemData.Name and string.find(string.lower(itemData.Name), TARGET_NAME) then
							print("âœ… Obtained target item:", itemData.Name)
							clickButton(child)
							obtainedTarget = true
							break
						end
					end
				end
				local confirm = itemsFrame:FindFirstChild("ConfirmButton", true)
				clickButton(confirm)
			end
		end
		local noItems = gui:FindFirstChild("NoItems", true)
		if noItems and noItems.Visible then
			local btn = noItems:FindFirstChild("Button", true)
			clickButton(btn)
		end
	end
end

-- Sell all items except the target
local function sellOtherItems()
	local success, data = pcall(function() return DataEvent:InvokeServer() end)
	if not success or not data then return end
	local inv = data.Inventory or {}
	local tblToSell = {}
	for guid, item in pairs(inv) do
		local itemData = ItemsModule[item.itemId]
		if itemData and not string.find(string.lower(itemData.Name), TARGET_NAME) then
			tblToSell[guid] = item
		end
	end
	if next(tblToSell) then
		print("ðŸ’° Selling other items:", #tblToSell)
		pcall(function() ReplicatedStorage.Events.UI.SellItems:FireServer(tblToSell) end)
	end
end

-- Main loop
while not halted and not obtainedTarget do
	if storageFull() then
		print("âŒ Storage full. Script halted.")
		halted = true
		break
	end

	print("âž¡ Entering auction queue...")
	pcall(function() EnterQueue:InvokeServer("1") end)

	-- Wait for auction to start and garage replication
	repeat taskWait(0.1) until inAuction
	taskWait(0.5) -- small buffer for server replication

	-- Scan garages for target
	foundTargetGarage = nil
	local garages = AuctionsFolder:GetChildren()
	for _, garage in ipairs(garages) do
		print("ðŸ”Ž Scanning garage:", garage.Name)
		local itemsFolder = garage:FindFirstChild("Items")
		local hasTarget = false
		if itemsFolder then
			for _, itemInstance in pairs(itemsFolder:GetChildren()) do
				local itemData = ItemsModule[itemInstance.Name]
				if itemData and itemData.Name and string.find(string.lower(itemData.Name), TARGET_NAME) then
					hasTarget = true
					foundTargetGarage = garage
					print("ðŸŽ¯ Found target in garage:", garage.Name)
					break
				end
			end
		end

		if not hasTarget then
			print("â­ Target not in", garage.Name, "- skipping...")
			pcall(function() SkipCountdown:InvokeServer() end)
			pcall(function() Skip:InvokeServer() end)
			taskWait(1) -- give server time to update next garage
		end

		if foundTargetGarage then break end
	end

	-- Bid only in the garage with target
	if foundTargetGarage then
		print("ðŸ’µ Preparing to place bid in garage:", foundTargetGarage.Name)
		repeat taskWait(0.1) until currentNextBid and currentBidder ~= LocalPlayer
		pcall(function() PlaceBid:InvokeServer(currentNextBid) end)
		print("âœ… Bid placed:", currentNextBid)
	end

	handleItemsWon()

	if obtainedTarget then
		sellOtherItems()
	end

	taskWait(0.5)
end
