local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local taskWait = task.wait

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule = require(ReplicatedStorage.Modules.Items)
local RepLibrary = require(ReplicatedStorage.Modules.RepLibrary)

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")
local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

local TARGET_NAME = "valentine"
local SCAN_DURATION = 3
local BID_CHECK_INTERVAL = 0.2

local inAuction = false
local obtainedTarget = false
local auctionEnded = false
local halted = false
local currentNextBid
local currentBidder
local currentGarage = nil
local garagesSkipped = 0
local MAX_GARAGES = 3

-- Add a cooldown for skipping to prevent spam
local lastSkipTime = 0
local SKIP_COOLDOWN = 1

UpdateCurrentBid.OnClientEvent:Connect(function(data)
	if data then
		currentNextBid = data.nextBid
		currentBidder = data.player
	end
end)

AuctionsFolder.ChildAdded:Connect(function(garage)
	inAuction = true
	auctionEnded = false
	currentGarage = garage
	garagesSkipped = 0
	print("ğŸ Entered auction for garage:", garage.Name)
end)

AuctionsFolder.ChildRemoved:Connect(function(garage)
	if #AuctionsFolder:GetChildren() == 0 then
		inAuction = false
		currentGarage = nil
		print("ğŸ Left auction")
	end
end)

local function storageFull()
	local success, data = pcall(function() return DataEvent:InvokeServer() end)
	if not success or not data then return false end
	local inv = data.Inventory or {}
	local invLevel = data.InventoryLevel
	local carryLevel = data.CarryLevel
	local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, carryLevel)
	local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, invLevel)
	local invCount = RepLibrary:GetLengthOfInventory(inv)
	return invCount >= invSpace or carrySpace <= 0
end

local function clickButton(obj)
	if obj and (obj:IsA("TextButton") or obj:IsA("ImageButton")) then
		pcall(function() 
			obj:Activate() 
			if getconnections then
				for _, c in pairs(getconnections(obj.MouseButton1Click)) do
					pcall(function() c:Function() end)
				end
			end
		end)
	end
end

-- FIXED: Handle both cases - items won OR no items won
local function handleAuctionEnd()
	coroutine.wrap(function()
		local timeout = 30
		local start = tick()
		local handled = false
		
		-- First, find the target itemId from the module
		local targetItemId = nil
		local targetItemName = nil
		for itemId, itemData in pairs(ItemsModule) do
			if itemData and itemData.Name and 
			   string.find(string.lower(itemData.Name), TARGET_NAME) then
				targetItemId = itemId
				targetItemName = itemData.Name
				print("ğŸ” Target item found in module:", targetItemName, "ID:", targetItemId)
				break
			end
		end
		
		while not handled and tick() - start < timeout do
			local gui = LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("ItemsWon", true)
			
			if gui then
				-- Check for NoItems GUI first
				local noItems = gui:FindFirstChild("NoItems", true)
				if noItems and noItems.Visible then
					print("ğŸ“¦ No items won - clicking Okay button")
					local okButton = noItems:FindFirstChild("Button", true)
					if okButton then
						clickButton(okButton)
						handled = true
						auctionEnded = true
						print("âœ… No items dialog closed")
						break
					end
				end
				
				-- Check for ItemsFrame (when you won items)
				local itemsFrame = gui:FindFirstChild("ItemsFrame", true)
				if itemsFrame and itemsFrame.Visible then
					local frame = itemsFrame:FindFirstChild("Frame")
					if frame then
						-- Loop through all item buttons
						local targetFound = false
						local targetButton = nil
						
						for _, child in pairs(frame:GetChildren()) do
							if child:IsA("ImageButton") and child:FindFirstChild("Price") then
								
								-- METHOD 1: Check the actual item data by looking at the button's properties
								-- Sometimes the itemId is stored in the button's Name or as an attribute
								if child.Name == targetItemId or child:GetAttribute("itemId") == targetItemId then
									print("ğŸ¯ Found target by ID:", child.Name)
									targetButton = child
									targetFound = true
									break
								end
								
								-- METHOD 2: Look at the Price text - sometimes contains item name
								local priceLabel = child:FindFirstChild("Price")
								if priceLabel then
									local priceText = priceLabel.Text or ""
									if string.find(string.lower(priceText), TARGET_NAME) then
										print("ğŸ¯ Found target by price text")
										targetButton = child
										targetFound = true
										break
									end
								end
								
								-- METHOD 3: Look at any text labels that might contain the item name
								for _, label in pairs(child:GetDescendants()) do
									if label:IsA("TextLabel") or label:IsA("TextButton") then
										local text = label.Text or ""
										if string.find(string.lower(text), TARGET_NAME) then
											print("ğŸ¯ Found target by text label:", text)
											targetButton = child
											targetFound = true
											break
										end
									end
								end
								
								-- METHOD 4: Check if there's a ViewportFrame with a model that matches
								if not targetFound then
									local viewportFrame = child:FindFirstChild("ViewportFrame")
									if viewportFrame then
										-- Wait a tiny bit for the model to load
										task.wait(0.1)
										local model = viewportFrame:FindFirstChildWhichIsA("Model")
										if model and targetItemName then
											if model.Name == targetItemName or 
											   string.find(string.lower(model.Name), TARGET_NAME) then
												print("ğŸ¯ Found target by model name:", model.Name)
												targetButton = child
												targetFound = true
												break
											end
										end
									end
								end
							end
						end
						
						-- If we found the target button, click it
						if targetButton then
							print("âœ… Clicking Valentine item button")
							clickButton(targetButton)
							taskWait(0.3) -- Wait for selection
							obtainedTarget = true
						else
							-- If we didn't find target, let's debug what items we DID win
							print("âš ï¸ Valentine item not found in won items! Debugging...")
							for _, child in pairs(frame:GetChildren()) do
								if child:IsA("ImageButton") and child:FindFirstChild("Price") then
									print("  - Button name:", child.Name)
									-- Check for any identifying text
									for _, label in pairs(child:GetDescendants()) do
										if label:IsA("TextLabel") then
											print("    Text:", label.Text)
										end
									end
								end
							end
						end
						
						-- Click Confirm button to proceed
						taskWait(0.3)
						local confirm = itemsFrame:FindFirstChild("ConfirmButton", true)
						if confirm then
							print("âœ… Clicking Confirm button")
							clickButton(confirm)
							handled = true
							taskWait(1)
							
							-- Handle SellItems GUI
							local sellHandled = false
							local sellTimeout = tick() + 5
							
							while not sellHandled and tick() < sellTimeout do
								local sellGui = LocalPlayer:FindFirstChild("PlayerGui") and 
											   LocalPlayer.PlayerGui:FindFirstChild("SellItems", true)
								
								if sellGui and sellGui.Visible then
									print("ğŸ’° SellItems GUI found")
									
									-- Click the normal sell button
									local normalButton = sellGui:FindFirstChild("Frame") and 
													   sellGui.Frame:FindFirstChild("Normal")
									
									if normalButton then
										print("ğŸ’° Clicking sell button")
										clickButton(normalButton)
										sellHandled = true
										taskWait(0.5)
									end
								end
								taskWait(0.2)
							end
						end
					end
				end
			end
			taskWait(0.3)
		end
		
		if not handled then
			print("âš ï¸ Timed out waiting for auction end GUI")
		end
		auctionEnded = true
	end)()
end

local function scanCurrentGarageForTarget()
	if not currentGarage then return false end
	
	local itemsFolder = currentGarage:FindFirstChild("Items")
	if not itemsFolder then return false end
	
	-- Wait a bit for items to load
	taskWait(0.5)
	
	local startTime = tick()
	while tick() - startTime < SCAN_DURATION do
		for _, itemInstance in pairs(itemsFolder:GetChildren()) do
			local itemData = ItemsModule[itemInstance.Name]
			if itemData and itemData.Name and string.find(string.lower(itemData.Name), TARGET_NAME) then
				print("ğŸ¯ Target found in current garage:", currentGarage.Name)
				return true
			end
		end
		taskWait(0.2)
	end
	
	print("âŒ Target NOT found in current garage:", currentGarage and currentGarage.Name)
	return false
end

-- Main loop
while not halted do
	if storageFull() then
		print("âŒ Storage full. Script halted.")
		halted = true
		break
	end

	print("â¡ Entering auction queue...")
	local success = pcall(function() return EnterQueue:InvokeServer("1") end)
	if not success then
		print("âŒ Failed to enter queue, retrying...")
		taskWait(2)
		continue
	end
	
	-- Wait for auction to start
	local auctionStartTime = tick()
	local AUCTION_START_TIMEOUT = 10
	auctionEnded = false
	
	repeat 
		taskWait(0.1)
		if tick() - auctionStartTime > AUCTION_START_TIMEOUT then
			print("âš ï¸ Auction start timeout, retrying...")
			break
		end
	until inAuction
	
	if not inAuction then
		continue
	end
	
	-- Reset for new auction
	obtainedTarget = false
	garagesSkipped = 0
	
	-- Main auction loop - keep going until auction ends
	while inAuction and not auctionEnded do
		-- Scan current garage
		local currentGarageHasTarget = scanCurrentGarageForTarget()
		
		if currentGarageHasTarget then
			print("ğŸ’µ Target is in current garage! Bidding on:", currentGarage and currentGarage.Name)
			
			local bidStartTime = tick()
			local BID_TIMEOUT = 60
			
			-- Bid until we win or garage changes
			while not obtainedTarget and inAuction and currentGarage and not auctionEnded do
				if currentNextBid and currentBidder ~= LocalPlayer then
					local bidSuccess = pcall(function() 
						return PlaceBid:InvokeServer(currentNextBid) 
					end)
					if bidSuccess then
						print("âœ… Placed bid:", currentNextBid)
					end
				end
				
				if tick() - bidStartTime > BID_TIMEOUT then
					print("âš ï¸ Bid timeout reached, moving on")
					break
				end
				
				taskWait(BID_CHECK_INTERVAL)
			end
		else
			-- Current garage doesn't have target - skip it
			garagesSkipped = garagesSkipped + 1
			print("â­ Garage "..garagesSkipped.."/"..MAX_GARAGES.." doesn't have target - skipping:", currentGarage and currentGarage.Name)
			
			if currentGarage and tick() - lastSkipTime > SKIP_COOLDOWN then
				pcall(function() SkipCountdown:InvokeServer() end)
				taskWait(0.1)
				pcall(function() Skip:InvokeServer() end)
				lastSkipTime = tick()
				print("â­ Skipped garage without target")
			end
			
			-- Wait for next garage to load
			taskWait(1)
		end
		
		-- Small pause before next iteration
		taskWait(0.5)
	end
	
	-- Auction has ended - handle the end screen
	print("ğŸ Auction ended, handling end screen...")
	handleAuctionEnd()
	
	-- Wait for handling to complete
	taskWait(3)
	
	if obtainedTarget then
		print("ğŸ‰ Successfully obtained Valentine item!")
	else
		print("ğŸ˜” Did not obtain Valentine item this auction")
	end
	
	print("ğŸ”„ Preparing for next auction...")
	taskWait(2)
end
