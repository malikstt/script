local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local taskWait = task.wait

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule = require(ReplicatedStorage.Modules.Items)
local RepLibrary = require(ReplicatedStorage.Modules.RepLibrary)

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")
local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

local SellAllItemsRemote = Auctions:WaitForChild("SellAllItems")

local TARGET_ITEM_ID = "2740"
local SCAN_DURATION = 2
local BID_CHECK_INTERVAL = 0.2

-- TRACKING TARGETS ACROSS SESSION
local totalTargetsFound = 0
local totalTargetsObtained = 0
local sessionStartTime = tick()

local inAuction = false
local obtainedTarget = false
local auctionEnded = false
local halted = false
local currentNextBid
local currentBidder
local currentGarage = nil
local garagesSkipped = 0
local MAX_GARAGES = 3

local lastSkipTime = 0
local SKIP_COOLDOWN = 1

-- Get target name for display
local targetItemName = ItemsModule[TARGET_ITEM_ID] and ItemsModule[TARGET_ITEM_ID].Name or "Valentine"
print("üîç Targeting:", targetItemName, "ID:", TARGET_ITEM_ID)
print("üìä Session started - tracking targets...")

UpdateCurrentBid.OnClientEvent:Connect(function(data)
	if data then
		currentNextBid = data.nextBid
		currentBidder = data.player
	end
end)

AuctionsFolder.ChildAdded:Connect(function(garage)
	inAuction = true
	auctionEnded = false
	currentGarage = garage
	garagesSkipped = 0
	print("üèÅ Entered garage:", garage.Name)
end)

AuctionsFolder.ChildRemoved:Connect(function(garage)
	if #AuctionsFolder:GetChildren() == 0 then
		inAuction = false
		currentGarage = nil
		print("üèÅ Left auction")
	end
end)

local function storageFull()
	local success, data = pcall(function() return DataEvent:InvokeServer() end)
	if not success or not data then return false end
	local inv = data.Inventory or {}
	local invLevel = data.InventoryLevel
	local carryLevel = data.CarryLevel
	local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, carryLevel)
	local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, invLevel)
	local invCount = RepLibrary:GetLengthOfInventory(inv)
	
	-- Count how many targets we already have in inventory
	local currentTargetsInInv = 0
	for _, item in pairs(inv) do
		if item.itemId == TARGET_ITEM_ID then
			currentTargetsInInv = currentTargetsInInv + 1
		end
	end
	
	print("üìä Session stats - Found:", totalTargetsFound, "| Obtained:", totalTargetsObtained, "| In inventory:", currentTargetsInInv)
	
	return invCount >= invSpace and carrySpace <= 0
end

local function clickButton(btn)
	if not btn then return end
	pcall(function()
		btn:Activate()
		if getconnections then
			for _, connection in pairs(getconnections(btn.MouseButton1Click)) do
				pcall(function() connection:Function() end)
			end
		end
	end)
end

local function handleAuctionEnd()
	coroutine.wrap(function()
		local timeout = 30
		local start = tick()
		local handled = false
		
		while not handled and tick() - start < timeout do
			local gui = LocalPlayer:FindFirstChild("PlayerGui") and 
					   LocalPlayer.PlayerGui:FindFirstChild("ItemsWon", true)
			
			if gui then
				-- Check for NoItems GUI (won nothing)
				local noItems = gui:FindFirstChild("NoItems", true)
				if noItems and noItems.Visible then
					print("üì¶ No items won - closing")
					local okButton = noItems:FindFirstChild("Button", true)
					if okButton then
						clickButton(okButton)
					else
						gui:Destroy()
					end
					handled = true
					auctionEnded = true
					break
				end
				
				-- Check for ItemsFrame (won items)
				local itemsFrame = gui:FindFirstChild("ItemsFrame", true)
				if itemsFrame and itemsFrame.Visible then
					print("üéÅ Items won GUI detected")
					
					-- Get current inventory data for space checks
					local data = DataEvent:InvokeServer()
					local inventory = data.Inventory or {}
					local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, data.CarryLevel)
					local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, data.InventoryLevel)
					local invCount = RepLibrary:GetLengthOfInventory(inventory)
					
					-- First, count how many target items we won in THIS auction
					local targetItemsInThisAuction = 0
					local frame = itemsFrame:FindFirstChild("Frame")
					
					if frame then
						-- Count target items in this win screen
						for _, child in pairs(frame:GetChildren()) do
							if child:IsA("ImageButton") then
								local viewport = child:FindFirstChild("ViewportFrame")
								if viewport then
									local model = viewport:FindFirstChildWhichIsA("Model")
									if model and model.Name == targetItemName then
										targetItemsInThisAuction = targetItemsInThisAuction + 1
									end
								end
							end
						end
						
						-- Update total targets found
						if targetItemsInThisAuction > 0 then
							totalTargetsFound = totalTargetsFound + targetItemsInThisAuction
							print("üéØ Found", targetItemsInThisAuction, "target(s) in this auction")
							print("üìä Total targets found so far:", totalTargetsFound)
						end
						
						-- Calculate available space
						local availableCarrySpace = carrySpace
						local availableInvSpace = invSpace - invCount
						local canTake = math.min(availableCarrySpace, availableInvSpace)
						
						print("üìä Carry space:", carrySpace, "| Available slots:", canTake)
						print("üìä Targets in this win:", targetItemsInThisAuction)
						
						-- Select as many target items as we have space for
						local selectedCount = 0
						for _, child in pairs(frame:GetChildren()) do
							if child:IsA("ImageButton") and selectedCount < canTake then
								local viewport = child:FindFirstChild("ViewportFrame")
								if viewport then
									local model = viewport:FindFirstChildWhichIsA("Model")
									if model and model.Name == targetItemName then
										print("‚úÖ Selecting target item", selectedCount + 1)
										clickButton(child)
										selectedCount = selectedCount + 1
										obtainedTarget = true
										taskWait(0.1)
									end
								end
							end
						end
						
						if selectedCount > 0 then
							totalTargetsObtained = totalTargetsObtained + selectedCount
							print("üéâ Selected", selectedCount, "out of", targetItemsInThisAuction, "target items")
							print("üìä Total targets obtained so far:", totalTargetsObtained)
							
							-- Calculate success rate
							local successRate = (totalTargetsObtained / totalTargetsFound) * 100
							print("üìä Success rate: " .. string.format("%.1f", successRate) .. "%")
						else
							print("‚ö†Ô∏è Could not select any target items (no space)")
						end
					end
					
					-- Click Confirm
					taskWait(0.3)
					local confirm = itemsFrame:FindFirstChild("ConfirmButton", true)
					if confirm then
						print("‚úÖ Clicking Confirm")
						clickButton(confirm)
						handled = true
						taskWait(1)
						
						-- Now sell other items (only if we have space and selected items)
						if obtainedTarget then
							taskWait(0.5)
							local success, data = pcall(function() return DataEvent:InvokeServer() end)
							if success and data then
								local inv = data.Inventory or {}
								local toSell = {}
								
								-- Find all target GUIDs (multiple possible)
								local targetGuids = {}
								for guid, item in pairs(inv) do
									if item.itemId == TARGET_ITEM_ID then
										table.insert(targetGuids, guid)
									end
								end
								
								-- Sell everything that's NOT a target
								for guid, item in pairs(inv) do
									local isTarget = false
									for _, targetGuid in ipairs(targetGuids) do
										if guid == targetGuid then
											isTarget = true
											break
										end
									end
									
									if not isTarget then
										toSell[guid] = item
									end
								end
								
								if next(toSell) then
									print("üí∞ Selling", #toSell, "non-target items")
									pcall(function() SellAllItemsRemote:FireServer(toSell) end)
								else
									print("‚ú® No non-target items to sell")
								end
							end
						end
					end
				end
			end
			taskWait(0.3)
		end
		
		auctionEnded = true
	end)()
end

local function scanCurrentGarageForTarget()
	if not currentGarage then return false end
	
	local itemsFolder = currentGarage:FindFirstChild("Items")
	if not itemsFolder then return false end
	
	taskWait(0.5)
	
	local startTime = tick()
	while tick() - startTime < SCAN_DURATION do
		for _, itemInstance in pairs(itemsFolder:GetChildren()) do
			if itemInstance.Name == TARGET_ITEM_ID then
				print("üéØ Target found in garage:", currentGarage.Name)
				return true
			end
		end
		taskWait(0.2)
	end
	
	return false
end

-- Print session stats periodically
spawn(function()
	while not halted do
		taskWait(60) -- Every minute
		local runtime = math.floor((tick() - sessionStartTime) / 60)
		print("‚è±Ô∏è Runtime:", runtime, "minutes")
		print("üìä Targets found:", totalTargetsFound, "| Obtained:", totalTargetsObtained)
		if totalTargetsFound > 0 then
			local successRate = (totalTargetsObtained / totalTargetsFound) * 100
			print("üìä Success rate: " .. string.format("%.1f", successRate) .. "%")
		end
	end
end)

-- MAIN LOOP
while not halted do
	if storageFull() then
		print("‚ùå Storage completely full. Script halted.")
		print("üìä FINAL STATS - Runtime:", math.floor((tick() - sessionStartTime) / 60), "minutes")
		print("üìä Targets found:", totalTargetsFound, "| Obtained:", totalTargetsObtained)
		if totalTargetsFound > 0 then
			local successRate = (totalTargetsObtained / totalTargetsFound) * 100
			print("üìä Success rate: " .. string.format("%.1f", successRate) .. "%")
		end
		halted = true
		break
	end

	print("‚û° Entering auction...")
	pcall(function() EnterQueue:InvokeServer("1") end)
	
	local auctionStartTime = tick()
	auctionEnded = false
	
	repeat 
		taskWait(0.1)
	until inAuction or tick() - auctionStartTime > 10
	
	if not inAuction then
		continue
	end
	
	obtainedTarget = false
	garagesSkipped = 0
	
	while inAuction and not auctionEnded do
		if scanCurrentGarageForTarget() then
			print("üíµ Bidding in target garage")
			
			local bidStartTime = tick()
			while not obtainedTarget and inAuction and currentGarage and not auctionEnded do
				if currentNextBid and currentBidder ~= LocalPlayer then
					pcall(function() PlaceBid:InvokeServer(currentNextBid) end)
				end
				if tick() - bidStartTime > 60 then break end
				taskWait(BID_CHECK_INTERVAL)
			end
		else
			garagesSkipped = garagesSkipped + 1
			print("‚è≠ Skipping garage", garagesSkipped.."/"..MAX_GARAGES)
			
			if currentGarage and tick() - lastSkipTime > SKIP_COOLDOWN then
				pcall(function() SkipCountdown:InvokeServer() end)
				taskWait(0.1)
				pcall(function() Skip:InvokeServer() end)
				lastSkipTime = tick()
			end
			taskWait(1)
		end
		taskWait(0.5)
	end
	
	handleAuctionEnd()
	taskWait(3)
end
