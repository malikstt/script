local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule = require(ReplicatedStorage.Modules.Items)

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")

local Events = ReplicatedStorage:WaitForChild("Events")
local DataEvent = Events:WaitForChild("Data"):WaitForChild("GetAll")

local TARGET_NAME = "valentine"
local TARGET_ID = "Valentine Safe"

local currentNextBid
local currentBidder
local inAuction = false
local foundTargetInAuction = false
local obtainedTarget = false
local halted = false

UpdateCurrentBid.OnClientEvent:Connect(function(data)
	if not data then return end
	currentNextBid = data.nextBid
	currentBidder = data.player
end)

AuctionsFolder.ChildAdded:Connect(function()
	inAuction = true
end)

AuctionsFolder.ChildRemoved:Connect(function()
	if #AuctionsFolder:GetChildren() == 0 then
		inAuction = false
		foundTargetInAuction = false
	end
end)

local function storageFull()
	local success, data = pcall(function()
		return DataEvent:InvokeServer()
	end)
	if not success or not data then
		return false
	end
	local inv = data.Inventory or {}
	local carryLevel = data.CarryLevel
	local invLevel = data.InventoryLevel
	local RepLibrary = require(ReplicatedStorage.Modules.RepLibrary)
	local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, carryLevel)
	local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, invLevel)
	local invCount = RepLibrary:GetLengthOfInventory(inv)
	if invCount >= invSpace or carrySpace <= 0 then
		return true
	end
	return false
end

local function clickButton(obj)
	if obj and (obj:IsA("TextButton") or obj:IsA("ImageButton")) then
		pcall(function() obj:Activate() end)
		if getconnections then
			for _, c in pairs(getconnections(obj.MouseButton1Click)) do
				pcall(function() c:Fire() end)
			end
		end
	end
end

local function handleItemsWon()
	local gui = LocalPlayer:WaitForChild("PlayerGui"):FindFirstChild("ItemsWon", true)
	if not gui then return end

	local itemsFrame = gui:FindFirstChild("ItemsFrame", true)
	local noItems = gui:FindFirstChild("NoItems", true)

	if itemsFrame and itemsFrame.Visible then
		local frame = itemsFrame:FindFirstChild("Frame")
		if frame then
			local selected = {}
			for _, child in pairs(frame:GetChildren()) do
				if child:IsA("ImageButton") and child:FindFirstChild("Price") then
					local price = tonumber(child.Price.Text:match("%d+")) or 0
					local isTarget = false
					local itemId = child.Name
					local itemData = ItemsModule[itemId]
					if itemData and itemData.Name and string.find(string.lower(itemData.Name), TARGET_NAME) then
						isTarget = true
					end
					if isTarget then
						clickButton(child)
						obtainedTarget = true
					else
						table.insert(selected, child)
					end
				end
			end
			for _, btn in pairs(selected) do
				clickButton(btn)
			end
			local confirm = itemsFrame:FindFirstChild("ConfirmButton", true)
			clickButton(confirm)
		end
	end

	if noItems and noItems.Visible then
		local btn = noItems:FindFirstChild("Button", true)
		clickButton(btn)
	end
end

task.spawn(function()
	while not halted and not obtainedTarget do
		if storageFull() then
			print("Storage full. Script halted.")
			halted = true
			break
		end

		pcall(function()
			EnterQueue:InvokeServer("1")
		end)

		repeat task.wait(0.5) until inAuction or halted
		if halted then break end

		while inAuction and not foundTargetInAuction and not halted do
			for _, garage in ipairs(AuctionsFolder:GetChildren()) do
				local itemsFolder = garage:FindFirstChild("Items")
				local hasTarget = false
				if itemsFolder then
					for _, itemInstance in pairs(itemsFolder:GetChildren()) do
						local itemData = ItemsModule[itemInstance.Name]
						if itemData and itemData.Name and string.find(string.lower(itemData.Name), TARGET_NAME) then
							hasTarget = true
							foundTargetInAuction = true
							break
						end
					end
				end
				if not hasTarget then
					pcall(function() SkipCountdown:InvokeServer() end)
					task.wait(0.05)
					pcall(function() Skip:InvokeServer() end)
				end
				if foundTargetInAuction then break end
			end
			task.wait(0.3)
		end

		repeat task.wait(0.5) until not inAuction or halted
	end
end)

task.spawn(function()
	while not halted and not obtainedTarget do
		task.wait(0.2)
		if inAuction and foundTargetInAuction and currentNextBid and currentBidder ~= LocalPlayer then
			pcall(function()
				PlaceBid:InvokeServer(currentNextBid)
			end)
		end
	end
end)

LocalPlayer:WaitForChild("PlayerGui").DescendantAdded:Connect(function(obj)
	if obj.Name == "ItemsWon" or obj.Name == "Button" then
		task.wait()
		handleItemsWon()
	end
end)

task.spawn(function()
	while not halted and not obtainedTarget do
		task.wait(0.5)
		handleItemsWon()
	end
end)
