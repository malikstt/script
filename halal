local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local taskWait = task.wait

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule = require(ReplicatedStorage.Modules.Items)
local RepLibrary = require(ReplicatedStorage.Modules.RepLibrary)

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")
local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

local TARGET_NAME = "valentine"
local BID_CHECK_INTERVAL = 0.15
local AUCTION_START_TIMEOUT = 8
local BID_TIMEOUT = 45
local ITEMS_WON_TIMEOUT = 25
local SKIP_COOLDOWN = 0.8
local FALLBACK_TIMEOUT = 120

local inAuction = false
local obtainedTarget = false
local halted = false
local currentNextBid
local currentBidder
local currentGarage = nil
local lastSkipTime = 0
local lastActionTime = tick()

UpdateCurrentBid.OnClientEvent:Connect(function(data)
	if data then
		currentNextBid = data.nextBid
		currentBidder = data.player
	end
end)

AuctionsFolder.ChildAdded:Connect(function(garage)
	inAuction = true
	currentGarage = garage
	lastActionTime = tick()
	print("ðŸ Entered auction:", garage.Name)
end)

AuctionsFolder.ChildRemoved:Connect(function()
	if #AuctionsFolder:GetChildren() == 0 then
		inAuction = false
		currentGarage = nil
		lastActionTime = tick()
		print("ðŸ Auction ended")
	end
end)

local function safeInvoke(remote, ...)
	local ok, result = pcall(function()
		return remote:InvokeServer(...)
	end)
	if ok then
		lastActionTime = tick()
	end
	return ok, result
end

local function safeFire(remote, ...)
	local ok = pcall(function()
		remote:FireServer(...)
	end)
	if ok then
		lastActionTime = tick()
	end
	return ok
end

local function clickButton(obj)
	if obj and (obj:IsA("TextButton") or obj:IsA("ImageButton")) then
		pcall(function() obj:Activate() end)
		if getconnections then
			for _, c in pairs(getconnections(obj.MouseButton1Click)) do
				pcall(function() c:Fire() end)
			end
		end
		lastActionTime = tick()
	end
end

local function storageFull()
	local ok, data = safeInvoke(DataEvent)
	if not ok or not data then return false end
	local inv = data.Inventory or {}
	local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, data.InventoryLevel)
	local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, data.CarryLevel)
	local invCount = RepLibrary:GetLengthOfInventory(inv)
	if invCount >= invSpace or carrySpace <= 0 then
		print("âŒ Storage full")
		return true
	end
	return false
end

local function fastScanGarage()
	if not currentGarage then return false end
	local itemsFolder = currentGarage:FindFirstChild("Items")
	if not itemsFolder then return false end
	taskWait(0.4)
	for _, itemInstance in pairs(itemsFolder:GetChildren()) do
		local itemData = ItemsModule[itemInstance.Name]
		if itemData and itemData.Name and string.find(string.lower(itemData.Name), TARGET_NAME) then
			print("ðŸŽ¯ Target found in garage")
			return true
		end
	end
	print("â­ No target in garage")
	return false
end

local function handleItemsWon()
	local start = tick()
	while tick() - start < ITEMS_WON_TIMEOUT do
		local gui = LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("ItemsWon", true)
		if gui then
			local itemsFrame = gui:FindFirstChild("ItemsFrame", true)
			if itemsFrame then
				local frame = itemsFrame:FindFirstChild("Frame")
				if frame then
					for _, child in pairs(frame:GetChildren()) do
						if child:IsA("ImageButton") and child:FindFirstChild("ViewportFrame") then
							local model = child.ViewportFrame:FindFirstChildOfClass("Model")
							if model then
								local itemData = ItemsModule[model.Name]
								if itemData and itemData.Name and string.find(string.lower(itemData.Name), TARGET_NAME) then
									print("âœ… Selecting target won item")
									clickButton(child)
									obtainedTarget = true
									break
								end
							end
						end
					end
					local confirm = itemsFrame:FindFirstChild("ConfirmButton", true)
					if confirm then
						clickButton(confirm)
					end
				end
			end
			local sellUI = gui:FindFirstChild("SellItems", true)
			if sellUI and sellUI.Visible then
				local normal = sellUI:FindFirstChild("Normal", true)
				if normal then
					print("ðŸ’° Selling remaining items")
					clickButton(normal)
				end
			end
			local noItems = gui:FindFirstChild("NoItems", true)
			if noItems and noItems.Visible then
				local btn = noItems:FindFirstChild("Button", true)
				clickButton(btn)
			end
		end
		taskWait(0.4)
	end
end

while not halted do
	if storageFull() then
		halted = true
		break
	end

	if tick() - lastActionTime > FALLBACK_TIMEOUT then
		print("â™» Fallback triggered - resetting state")
		inAuction = false
		currentGarage = nil
		obtainedTarget = false
		lastActionTime = tick()
	end

	print("âž¡ Entering queue")
	local ok = safeInvoke(EnterQueue, "1")
	if not ok then
		taskWait(2)
		continue
	end

	local startWait = tick()
	repeat
		taskWait(0.1)
		if tick() - startWait > AUCTION_START_TIMEOUT then
			print("âš  Auction start timeout")
			break
		end
	until inAuction

	if not inAuction then
		continue
	end

	taskWait(0.8)
	obtainedTarget = false

	local hasTarget = fastScanGarage()

	if not hasTarget then
		if currentGarage and tick() - lastSkipTime > SKIP_COOLDOWN then
			safeInvoke(SkipCountdown)
			taskWait(0.1)
			safeInvoke(Skip)
			lastSkipTime = tick()
			print("â­ Skipped garage")
		end
		taskWait(1)
		continue
	end

	local bidStart = tick()
	while inAuction and currentGarage and not obtainedTarget do
		if currentNextBid and currentBidder ~= LocalPlayer then
			safeInvoke(PlaceBid, currentNextBid)
		end
		if tick() - bidStart > BID_TIMEOUT then
			print("âš  Bid timeout fallback")
			break
		end
		taskWait(BID_CHECK_INTERVAL)
	end

	handleItemsWon()
	taskWait(1.5)
end
