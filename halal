local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local taskWait = task.wait

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule = require(ReplicatedStorage.Modules.Items)

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")

local TARGET_ITEM_ID = "2740"

local currentNextBid
local currentBidder
local currentGarage

local inAuction = false
local garagesCompleted = 0
local MAX_GARAGES = 3

local lastSkipTime = 0
local SKIP_COOLDOWN = 0.5

local targetItemName = ItemsModule[TARGET_ITEM_ID] and ItemsModule[TARGET_ITEM_ID].Name or "Unknown"

print("üîç Targeting:", targetItemName)

----------------------------------------------------
-- UPDATE BID INFO
----------------------------------------------------

UpdateCurrentBid.OnClientEvent:Connect(function(data)
	if data then
		currentNextBid = data.nextBid
		currentBidder = data.player
	end
end)

----------------------------------------------------
-- GARAGE EVENTS
----------------------------------------------------

AuctionsFolder.ChildAdded:Connect(function(garage)
	currentGarage = garage
	inAuction = true
	print("üèÅ Entered garage:", garage.Name)
end)

AuctionsFolder.ChildRemoved:Connect(function()
	if #AuctionsFolder:GetChildren() == 0 then
		inAuction = false
		currentGarage = nil
	end
end)

----------------------------------------------------
-- CHECK TARGET
----------------------------------------------------

local function garageHasTarget()

	local garage = currentGarage
	if not garage then return false end

	local itemsFolder = garage:FindFirstChild("Items")
	if not itemsFolder then return false end

	for _, item in ipairs(itemsFolder:GetChildren()) do
		if item.Name == TARGET_ITEM_ID then
			return true
		end
	end

	return false
end

----------------------------------------------------
-- ITEMS WON HANDLER (YOUR SCRIPT)
----------------------------------------------------

local function handleItemsWon()

	local player = Players.LocalPlayer
	local gui = player.PlayerGui:WaitForChild("ItemsWon")

	local Items = require(game.ReplicatedStorage.Modules.Items)

	local TARGET_ID = 2740
	local targetData = Items[TARGET_ID] or Items[tostring(TARGET_ID)]

	if not targetData then return end

	local function click(btn)

		if getconnections then
			for _, c in ipairs(getconnections(btn.MouseButton1Click)) do
				pcall(function()
					c:Fire()
				end)
			end
		else
			btn:Activate()
		end

	end

	local clickedCount = 0

	local function scan()

		local frame = gui:WaitForChild("ItemsFrame"):WaitForChild("Frame")

		for _, item in ipairs(frame:GetChildren()) do

			if item:IsA("ImageButton")
			and item:FindFirstChild("Price")
			and item:FindFirstChild("Rarity") then

				local price = tonumber(item.Price.Text:match("%d+"))
				local rarity = item.Rarity.TextLabel.Text

				if price == targetData.Price
				and rarity == targetData.Rarity
				and targetData.SafeId then

					click(item)
					clickedCount += 1
					taskWait(0.15)

				end
			end
		end
	end

	taskWait(0.5)
	scan()

	if clickedCount <= 0 then

		local done = false
		local conn

		conn = gui.DescendantAdded:Connect(function()

			taskWait(0.2)
			scan()

			if clickedCount > 0 then
				done = true
				conn:Disconnect()
			end

		end)

		repeat taskWait() until done

	end

	repeat taskWait() until clickedCount > 0

	print("Selected", clickedCount, targetData.Name)

	taskWait(0.5)

	local confirmButton =
		gui.ItemsFrame.ConfirmButton

	repeat taskWait() until confirmButton.Visible

	click(confirmButton)

	print("Confirmed")

	taskWait(0.5)

	local sellButton =
		gui.SellItems.Frame.Normal.Button

	repeat taskWait() until sellButton.Visible

	click(sellButton)

	print("Sold rest")

end

----------------------------------------------------
-- RUN AUCTION
----------------------------------------------------

local function runAuction()

	print("‚û° Entering auction")

	pcall(function()
		EnterQueue:InvokeServer("1")
	end)

	local timeout = tick() + 10

	while not inAuction and tick() < timeout do
		taskWait(0.1)
	end

	if not inAuction then
		print("Failed to enter auction")
		return
	end

	garagesCompleted = 0

	while inAuction and garagesCompleted < MAX_GARAGES do

		if garageHasTarget() then

			print("üéØ Target found ‚Üí bidding")

			local bidding = true

			while bidding and inAuction do

				if not garageHasTarget() then
					break
				end

				if currentNextBid and currentBidder ~= LocalPlayer then
					pcall(function()
						PlaceBid:InvokeServer(currentNextBid)
					end)
				end

				taskWait(0.15)

			end

		else

			print("‚è≠ Skipping garage")

			if tick() - lastSkipTime > SKIP_COOLDOWN then

				pcall(function()
					SkipCountdown:InvokeServer()
				end)

				taskWait(0.05)

				pcall(function()
					Skip:InvokeServer()
				end)

				lastSkipTime = tick()

			end

		end

		garagesCompleted += 1

		taskWait(0.3)

	end

	print("üèÅ All garages done ‚Üí waiting for ItemsWon")

	handleItemsWon()

	print("‚úÖ Auction complete")

end

----------------------------------------------------
-- START
----------------------------------------------------

runAuction()
