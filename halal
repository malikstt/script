local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local taskWait = task.wait

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule = require(ReplicatedStorage.Modules.Items)
local RepLibrary = require(ReplicatedStorage.Modules.RepLibrary)

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")
local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

local TARGET_ITEM_ID = "2740"
local SKIP_COOLDOWN = 0.5
local BID_CHECK_INTERVAL = 0.1

local currentGarage = nil
local currentGarageId = nil
local garageHasTarget = false
local inAuction = false
local auctionEnded = false
local currentNextBid = nil
local currentBidder = nil
local lastSkipTime = 0

local targetItemName = ItemsModule[TARGET_ITEM_ID] and ItemsModule[TARGET_ITEM_ID].Name or "Valentine"

print("üîç Targeting:", targetItemName)

--------------------------------------------------
-- STORAGE CHECK
--------------------------------------------------

local function storageFull()

	local success, data = pcall(function()
		return DataEvent:InvokeServer()
	end)

	if not success or not data then
		return false
	end

	local inv = data.Inventory or {}

	local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, data.CarryLevel)
	local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, data.InventoryLevel)
	local invCount = RepLibrary:GetLengthOfInventory(inv)

	return invCount >= invSpace and carrySpace <= 0

end

--------------------------------------------------
-- GARAGE SCAN (INSTANT)
--------------------------------------------------

local function checkGarageForTarget(garage)

	if not garage then return false end

	local itemsFolder = garage:FindFirstChild("Items")

	if not itemsFolder then return false end

	for _, item in pairs(itemsFolder:GetChildren()) do

		if item.Name == TARGET_ITEM_ID then
			return true
		end

	end

	return false

end

--------------------------------------------------
-- GARAGE CHANGE DETECTION
--------------------------------------------------

local function onGarageEntered(garage)

	currentGarage = garage
	currentGarageId = garage:GetDebugId()

	garageHasTarget = checkGarageForTarget(garage)

	if garageHasTarget then
		print("üéØ Target garage:", garage.Name)
	else
		print("‚ùå No target garage:", garage.Name)
	end

end

--------------------------------------------------
-- AUCTION STATE TRACKING
--------------------------------------------------

AuctionsFolder.ChildAdded:Connect(function(garage)

	inAuction = true
	auctionEnded = false

	onGarageEntered(garage)

end)

AuctionsFolder.ChildRemoved:Connect(function(garage)

	if garage == currentGarage then

		currentGarage = nil
		currentGarageId = nil
		garageHasTarget = false

	end

	if #AuctionsFolder:GetChildren() == 0 then

		inAuction = false
		auctionEnded = true

	end

end)

--------------------------------------------------
-- BID UPDATE
--------------------------------------------------

UpdateCurrentBid.OnClientEvent:Connect(function(data)

	if not data then return end

	currentNextBid = data.nextBid
	currentBidder = data.player

end)

--------------------------------------------------
-- MAIN AUCTION LOGIC
--------------------------------------------------

local function runAuction()

	if storageFull() then
		print("‚ùå Storage full")
		return
	end

	-- Only enter queue if NOT already in auction
	if not inAuction then

		print("‚û° Entering auction queue")

		pcall(function()
			EnterQueue:InvokeServer("1")
		end)

	end

	local timeout = tick()

	while not inAuction and tick() - timeout < 10 do
		taskWait(0.05)
	end

	if not inAuction then
		print("‚ùå Failed to enter auction")
		return
	end

	print("‚úÖ Auction active")

	local lastGarageId = nil

	while inAuction and not auctionEnded do

		-- Detect garage change instantly
		if currentGarageId ~= lastGarageId then

			lastGarageId = currentGarageId

			if not garageHasTarget then

				if currentGarage and tick() - lastSkipTime > SKIP_COOLDOWN then

					print("‚è≠ Instant skip")

					pcall(function()
						SkipCountdown:InvokeServer()
					end)

					taskWait(0.05)

					pcall(function()
						Skip:InvokeServer()
					end)

					lastSkipTime = tick()

				end

			end

		end

		-- Only bid if CURRENT garage has target
		if garageHasTarget and currentGarage then

			if currentNextBid and currentBidder ~= LocalPlayer then

				pcall(function()

					-- Double check garage didn't change
					if currentGarageId == lastGarageId then
						PlaceBid:InvokeServer(currentNextBid)
					end

				end)

			end

		end

		taskWait(BID_CHECK_INTERVAL)

	end

	print("‚úÖ Auction ended")

end

--------------------------------------------------
-- RUN ONCE
--------------------------------------------------

runAuction()
