local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local taskWait = task.wait

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule = require(ReplicatedStorage.Modules.Items)
local RepLibrary = require(ReplicatedStorage.Modules.RepLibrary)

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")

local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")
local SellAllItemsRemote = Auctions:WaitForChild("SellAllItems")

local TARGET_NAME = "valentine"
local SCAN_DURATION = 3
local BID_CHECK_INTERVAL = 0.2

local inAuction = false
local obtainedTarget = false
local auctionEnded = false
local halted = false
local currentNextBid
local currentBidder
local currentGarage
local garagesSkipped = 0
local MAX_GARAGES = 3
local lastSkipTime = 0
local SKIP_COOLDOWN = 1

local targetItemId
for itemId, itemData in pairs(ItemsModule) do
	if itemData and itemData.Name and string.find(string.lower(itemData.Name), TARGET_NAME) then
		targetItemId = itemId
		break
	end
end

UpdateCurrentBid.OnClientEvent:Connect(function(data)
	if data then
		currentNextBid = data.nextBid
		currentBidder = data.player
	end
end)

AuctionsFolder.ChildAdded:Connect(function(garage)
	inAuction = true
	auctionEnded = false
	currentGarage = garage
	garagesSkipped = 0
end)

AuctionsFolder.ChildRemoved:Connect(function()
	if #AuctionsFolder:GetChildren() == 0 then
		inAuction = false
		currentGarage = nil
	end
end)

local function storageFull()
	local ok, data = pcall(function()
		return DataEvent:InvokeServer()
	end)
	if not ok or not data then return false end

	local inv = data.Inventory or {}
	local invCount = RepLibrary:GetLengthOfInventory(inv)
	local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, data.InventoryLevel)
	local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, data.CarryLevel)

	return invCount >= invSpace or carrySpace <= 0
end

local function sellNonTargetItems()
	local ok, data = pcall(function()
		return DataEvent:InvokeServer()
	end)
	if not ok or not data then return end

	local inv = data.Inventory or {}
	local sellTbl = {}
	local keepGuid

	for guid, item in pairs(inv) do
		if item.itemId == targetItemId then
			keepGuid = guid
			break
		end
	end

	for guid, item in pairs(inv) do
		if guid ~= keepGuid then
			sellTbl[guid] = item
		end
	end

	if next(sellTbl) then
		pcall(function()
			SellAllItemsRemote:FireServer(sellTbl)
		end)
	end
end

local function handleAuctionEnd()
	task.spawn(function()
		local start = tick()
		while tick() - start < 10 do
			local gui = LocalPlayer.PlayerGui:FindFirstChild("ItemsWon", true)
			if gui then
				gui:Destroy()
				obtainedTarget = true
				auctionEnded = true
				break
			end
			taskWait(0.1)
		end
		if obtainedTarget then
			taskWait(1)
			sellNonTargetItems()
		end
		auctionEnded = true
	end)
end

local function scanCurrentGarageForTarget()
	if not currentGarage then return false end
	local itemsFolder = currentGarage:FindFirstChild("Items")
	if not itemsFolder then return false end

	taskWait(0.5)
	local start = tick()

	while tick() - start < SCAN_DURATION do
		for _, inst in pairs(itemsFolder:GetChildren()) do
			local data = ItemsModule[inst.Name]
			if data and data.Name and string.find(string.lower(data.Name), TARGET_NAME) then
				return true
			end
		end
		taskWait(0.2)
	end

	return false
end

while not halted do
	if storageFull() then
		halted = true
		break
	end

	pcall(function()
		EnterQueue:InvokeServer("1")
	end)

	local start = tick()
	while not inAuction and tick() - start < 10 do
		taskWait(0.1)
	end

	if not inAuction then
		taskWait(1)
		continue
	end

	obtainedTarget = false
	garagesSkipped = 0

	while inAuction and not auctionEnded do
		if scanCurrentGarageForTarget() then
			local bidStart = tick()
			while inAuction and not obtainedTarget and not auctionEnded do
				if currentNextBid and currentBidder ~= LocalPlayer then
					pcall(function()
						PlaceBid:InvokeServer(currentNextBid)
					end)
				end
				if tick() - bidStart > 60 then
					break
				end
				taskWait(BID_CHECK_INTERVAL)
			end
		else
			garagesSkipped += 1
			if currentGarage and tick() - lastSkipTime > SKIP_COOLDOWN then
				pcall(function() SkipCountdown:InvokeServer() end)
				taskWait(0.1)
				pcall(function() Skip:InvokeServer() end)
				lastSkipTime = tick()
			end
			taskWait(1)
		end
		taskWait(0.3)
	end

	handleAuctionEnd()
	taskWait(3)
end
