local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "Role Control",
    LoadingTitle = "Utility",
    LoadingSubtitle = "Rayfield"
})

local MainTab = Window:CreateTab("Main", 4483362458)
local AddTab = Window:CreateTab("Adds", 4483362458)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local CHARACTERS = workspace:WaitForChild("CHARACTERS")

local State = {
    ESP = false,
    TP_SEEKER = false,
    TP_HIDER = false,
    AUTO_SWITCH = false,
    MODE = "NONSTOP",
    OLD_CAMERA = false,
    NEW_CAMERA = false,
    NOCLIP = false,
    AUTO_ATTACK = false
}

local SEEKER_COLOR = Color3.fromRGB(0,255,255)
local HIDER_COLOR = Color3.fromRGB(255,0,255)
local OUTLINE_COLOR = Color3.fromRGB(255,255,255)

local ESP_CACHE = {}
local lockedTarget
local cycleIndex = 1
local camSaved

local function getRole(p)
    local f = CHARACTERS:FindFirstChild(p.Name)
    if not f then return nil end
    if f:FindFirstChild("SeekerTitle") then return "SEEKER" end
    if f:FindFirstChild("HiderTitle") then return "HIDER" end
end

local function valid(p)
    local h = p.Character and p.Character:FindFirstChildOfClass("Humanoid")
    return h and h.Health > 0
end

local function getPlayersByRole(role)
    local t = {}
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and getRole(p) == role then
            table.insert(t,p)
        end
    end
    return t
end

RunService.Heartbeat:Connect(function()
    if not State.ESP then
        for _,h in pairs(ESP_CACHE) do h:Destroy() end
        table.clear(ESP_CACHE)
        return
    end
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            local h = ESP_CACHE[p]
            if not h then
                h = Instance.new("Highlight")
                h.Parent = p.Character
                h.Adornee = p.Character
                h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                ESP_CACHE[p] = h
            end
            local r = getRole(p)
            h.FillColor = r == "SEEKER" and SEEKER_COLOR or r == "HIDER" and HIDER_COLOR or Color3.new(1,1,1)
            h.OutlineColor = OUTLINE_COLOR
            h.FillTransparency = 0.25
            h.OutlineTransparency = 0
            h.Enabled = true
        end
    end
end)

RunService.Heartbeat:Connect(function()
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local role
    if State.AUTO_SWITCH then
        local seekers = getPlayersByRole("SEEKER")
        local hiders = getPlayersByRole("HIDER")
        role = #seekers > 0 and "SEEKER" or "HIDER"
    elseif State.TP_SEEKER then
        role = "SEEKER"
    elseif State.TP_HIDER then
        role = "HIDER"
    end

    if not role then
        lockedTarget = nil
        cycleIndex = 1
        return
    end

    local targets = getPlayersByRole(role)
    if #targets == 0 then return end

    if State.MODE == "NONSTOP" then
        lockedTarget = targets[cycleIndex]
        cycleIndex = (cycleIndex % #targets) + 1
    else
        if not lockedTarget or not valid(lockedTarget) then
            lockedTarget = targets[1]
        end
    end

    if lockedTarget and lockedTarget.Character then
        local tRoot = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
        if tRoot then
            root.CFrame = tRoot.CFrame
        end
    end
end)

RunService:BindToRenderStep("OldCam", Enum.RenderPriority.Camera.Value + 1, function()
    if not State.OLD_CAMERA then return end
    if not lockedTarget or not lockedTarget.Character then return end
    local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local focus = lockedTarget.Character:FindFirstChild("Head") or lockedTarget.Character:FindFirstChild("HumanoidRootPart")
    if not myRoot or not focus then return end
    camSaved = camSaved or Camera.CameraType
    Camera.CameraType = Enum.CameraType.Scriptable
    Camera.CFrame = CFrame.new(
        myRoot.CFrame:PointToWorldSpace(Vector3.new(0,6,-10)),
        focus.Position
    )
end)

RunService:BindToRenderStep("NewCam", Enum.RenderPriority.Camera.Value + 2, function()
    if not State.NEW_CAMERA then return end
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    camSaved = camSaved or Camera.CameraType
    Camera.CameraType = Enum.CameraType.Scriptable
    local back = root.CFrame * CFrame.new(0,0,2)
    Camera.CFrame = CFrame.new(back.Position, root.Position)
end)

local function unlockCam()
    if camSaved then
        Camera.CameraType = camSaved
        camSaved = nil
    end
end

RunService.Stepped:Connect(function()
    if not State.NOCLIP then return end
    local char = LocalPlayer.Character
    if not char then return end
    for _,p in ipairs(char:GetDescendants()) do
        if p:IsA("BasePart") then
            p.CanCollide = false
        end
    end
end)

task.spawn(function()
    while true do
        if State.AUTO_ATTACK then
            VirtualInputManager:SendMouseButtonEvent(0,0,0,true,game,0)
            VirtualInputManager:SendMouseButtonEvent(0,0,0,false,game,0)
        end
        task.wait(0.05)
    end
end)

MainTab:CreateToggle({ Name="ESP", Callback=function(v) State.ESP=v end })
MainTab:CreateToggle({ Name="Auto TP Seeker", Callback=function(v) State.TP_SEEKER=v if v then State.TP_HIDER=false State.AUTO_SWITCH=false end end })
MainTab:CreateToggle({ Name="Auto TP Hider", Callback=function(v) State.TP_HIDER=v if v then State.TP_SEEKER=false State.AUTO_SWITCH=false end end })
MainTab:CreateToggle({ Name="Auto Switch Roles", Callback=function(v) State.AUTO_SWITCH=v if v then State.TP_SEEKER=false State.TP_HIDER=false end end })
MainTab:CreateDropdown({ Name="Mode", Options={"NONSTOP","UNTIL_DEATH"}, Callback=function(v) State.MODE=v end })
MainTab:CreateToggle({ Name="Old Camera Lock", Callback=function(v) State.OLD_CAMERA=v if not v then unlockCam() end end })
MainTab:CreateToggle({ Name="New Camera Lock", Callback=function(v) State.NEW_CAMERA=v if not v then unlockCam() end end })
MainTab:CreateToggle({ Name="No Collision", Callback=function(v) State.NOCLIP=v end })
MainTab:CreateToggle({ Name="Auto Attack", Callback=function(v) State.AUTO_ATTACK=v end })

AddTab:CreateLabel("Extra features soon")
