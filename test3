-- ðŸŒˆ Rayfield
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "Role Teleport & ESP",
    LoadingTitle = "Utility UI",
    LoadingSubtitle = "Rayfield",
})

local Tab = Window:CreateTab("Main", 4483362458)

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--------------------------------------------------
-- STATES
--------------------------------------------------
local ESP_ON = false

local TP_SEEKER = false
local TP_HIDER = false

local ATTACK_SEEKER = false
local ATTACK_HIDER = false

local CAMERA_FOLLOW = false
local NOCLIP = false

-- "NONSTOP" or "UNTIL_DEATH"
local MODE = "NONSTOP"

--------------------------------------------------
-- ðŸ”´ RED ESP (OTHERS ONLY)
--------------------------------------------------
task.spawn(function()
    while true do
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                local char = player.Character
                if char then
                    local h = char:FindFirstChild("ESP_Highlight")
                    if ESP_ON then
                        if not h then
                            h = Instance.new("Highlight")
                            h.Name = "ESP_Highlight"
                            h.Adornee = char
                            h.Parent = char
                        end
                        h.Enabled = true
                        h.FillColor = Color3.fromRGB(255, 0, 0)
                        h.OutlineColor = Color3.fromRGB(255, 0, 0)
                        h.FillTransparency = 0.4
                        h.OutlineTransparency = 0
                        h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                    else
                        if h then h:Destroy() end
                    end
                end
            end
        end
        task.wait(0.5)
    end
end)

--------------------------------------------------
-- ROLE LOOKUP
--------------------------------------------------
local function getPlayersByRole(roleName)
    local list = {}
    local chars = workspace:FindFirstChild("CHARACTERS")
    if not chars then return list end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local folder = chars:FindFirstChild(player.Name)
            if folder and folder:FindFirstChild(roleName) then
                table.insert(list, player)
            end
        end
    end
    return list
end

--------------------------------------------------
-- AUTO TP (LOCKED TARGET)
--------------------------------------------------
local lockedTarget = nil

task.spawn(function()
    local index = 1

    while true do
        local myChar = LocalPlayer.Character
        local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")

        if myRoot then
            local roleName =
                TP_SEEKER and "SeekerTitle"
                or TP_HIDER and "HiderTitle"

            if roleName then
                local targets = getPlayersByRole(roleName)

                if MODE == "NONSTOP" then
                    if #targets > 0 then
                        lockedTarget = targets[index]
                        index = (index % #targets) + 1
                    end
                else
                    if not lockedTarget
                    or not lockedTarget.Character
                    or lockedTarget.Character:FindFirstChildOfClass("Humanoid").Health <= 0 then
                        lockedTarget = targets[1]
                    end
                end

                if lockedTarget and lockedTarget.Character then
                    local tRoot = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
                    if tRoot then
                        myRoot.CFrame = tRoot.CFrame + Vector3.new(0, 3, 0)
                    end
                end
            else
                lockedTarget = nil
                index = 1
            end
        end

        task.wait(0.2)
    end
end)

--------------------------------------------------
-- AUTO ATTACK
--------------------------------------------------
local attackRemote =
    ReplicatedStorage
        :WaitForChild("Assets")
        :WaitForChild("Knife")
        :WaitForChild("Remotes")
        :WaitForChild("Attack")

task.spawn(function()
    while true do
        local roleName =
            ATTACK_SEEKER and "SeekerTitle"
            or ATTACK_HIDER and "HiderTitle"

        if roleName then
            local targets = getPlayersByRole(roleName)
            local target = targets[1]

            if target and target.Character then
                local char = LocalPlayer.Character
                local knife = char and char:FindFirstChild("Knife")
                local root = char and char:FindFirstChild("HumanoidRootPart")

                if knife and root then
                    attackRemote:FireServer(
                        os.clock(),
                        knife,
                        root.CFrame,
                        {}
                    )
                end
            end
        end

        task.wait(0.25)
    end
end)

--------------------------------------------------
-- ðŸŽ¥ CAMERA LOCK TO TARGET CENTER
--------------------------------------------------
RunService:BindToRenderStep("LockCameraToTarget", Enum.RenderPriority.Camera.Value + 1, function()
    if not CAMERA_FOLLOW then return end
    if not lockedTarget or not lockedTarget.Character then return end

    local char = lockedTarget.Character
    local head = char:FindFirstChild("Head")
    local root = char:FindFirstChild("HumanoidRootPart")

    local focus = head or root
    if not focus then return end

    Camera.CameraType = Enum.CameraType.Scriptable
    Camera.CFrame = focus.CFrame
end)

--------------------------------------------------
-- NOCLIP
--------------------------------------------------
task.spawn(function()
    while true do
        if NOCLIP then
            local char = LocalPlayer.Character
            if char then
                for _, part in ipairs(char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end
        task.wait()
    end
end)

--------------------------------------------------
-- UI
--------------------------------------------------
Tab:CreateToggle({
    Name = "Red ESP (Others)",
    CurrentValue = false,
    Callback = function(v)
        ESP_ON = v
    end
})

Tab:CreateToggle({
    Name = "Auto TP Seeker",
    CurrentValue = false,
    Callback = function(v)
        TP_SEEKER = v
        if v then TP_HIDER = false end
    end
})

Tab:CreateToggle({
    Name = "Auto TP Hider",
    CurrentValue = false,
    Callback = function(v)
        TP_HIDER = v
        if v then TP_SEEKER = false end
    end
})

Tab:CreateToggle({
    Name = "Auto Attack Seeker",
    CurrentValue = false,
    Callback = function(v)
        ATTACK_SEEKER = v
        if v then ATTACK_HIDER = false end
    end
})

Tab:CreateToggle({
    Name = "Auto Attack Hider",
    CurrentValue = false,
    Callback = function(v)
        ATTACK_HIDER = v
        if v then ATTACK_SEEKER = false end
    end
})

Tab:CreateToggle({
    Name = "Camera Lock To Target",
    CurrentValue = false,
    Callback = function(v)
        CAMERA_FOLLOW = v
        if not v then
            Camera.CameraType = Enum.CameraType.Custom
        end
    end
})

Tab:CreateToggle({
    Name = "No Clip",
    CurrentValue = false,
    Callback = function(v)
        NOCLIP = v
    end
})

Tab:CreateDropdown({
    Name = "Mode",
    Options = { "NONSTOP", "UNTIL_DEATH" },
    CurrentOption = "NONSTOP",
    Callback = function(opt)
        MODE = opt
    end
})
