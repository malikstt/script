local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "Role Control",
    LoadingTitle = "Utility",
    LoadingSubtitle = "Rayfield"
})

local MainTab = Window:CreateTab("Main", 4483362458)
local AddTab = Window:CreateTab("Adds", 4483362458)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local CHARACTERS = workspace:WaitForChild("CHARACTERS")

local State = {
    ESP = false,
    AUTO_TP = false,
    CAMERA_LOCK = false,
    NOCLIP = false,
    AUTO_ATTACK = false
}

local SEEKER_COLOR = Color3.fromRGB(0,255,255)
local HIDER_COLOR = Color3.fromRGB(255,0,255)
local OUTLINE_COLOR = Color3.fromRGB(255,255,255)

local ESP_CACHE = {}
local lockedTarget
local cycleIndex = 1

local function getRole(p)
    local f = CHARACTERS:FindFirstChild(p.Name)
    if not f then return nil end
    if f:FindFirstChild("SeekerTitle") then return "SEEKER" end
    if f:FindFirstChild("HiderTitle") then return "HIDER" end
end

local function getTargets()
    local seekers = {}
    local hiders = {}
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            local r = getRole(p)
            if r == "SEEKER" then
                table.insert(seekers,p)
            elseif r == "HIDER" then
                table.insert(hiders,p)
            end
        end
    end
    return seekers,hiders
end

local function valid(p)
    local h = p.Character and p.Character:FindFirstChildOfClass("Humanoid")
    return h and h.Health > 0
end

RunService.Heartbeat:Connect(function()
    if not State.ESP then
        for _,h in pairs(ESP_CACHE) do h:Destroy() end
        table.clear(ESP_CACHE)
        return
    end
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            local h = ESP_CACHE[p]
            if not h then
                h = Instance.new("Highlight")
                h.Parent = p.Character
                h.Adornee = p.Character
                h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                ESP_CACHE[p] = h
            end
            local r = getRole(p)
            h.FillColor = r == "SEEKER" and SEEKER_COLOR or r == "HIDER" and HIDER_COLOR or Color3.new(1,1,1)
            h.OutlineColor = OUTLINE_COLOR
            h.FillTransparency = 0.25
            h.OutlineTransparency = 0
            h.Enabled = true
        end
    end
end)

RunService.Heartbeat:Connect(function()
    if not State.AUTO_TP then
        lockedTarget = nil
        cycleIndex = 1
        return
    end
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    local seekers,hiders = getTargets()
    local pool = #seekers > 0 and seekers or hiders
    if #pool == 0 then return end
    if not lockedTarget or not valid(lockedTarget) then
        lockedTarget = pool[cycleIndex]
        cycleIndex = (cycleIndex % #pool) + 1
    end
    if lockedTarget and lockedTarget.Character then
        local tRoot = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
        if tRoot then
            root.CFrame = tRoot.CFrame
        end
    end
end)

local camSaved

RunService:BindToRenderStep("BackLock", Enum.RenderPriority.Camera.Value + 2, function()
    if not State.CAMERA_LOCK then return end
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    if not camSaved then camSaved = Camera.CameraType end
    Camera.CameraType = Enum.CameraType.Scriptable
    local back = root.CFrame * CFrame.new(0,0,2)
    Camera.CFrame = CFrame.new(back.Position, root.Position)
end)

local function unlockCam()
    if camSaved then
        Camera.CameraType = camSaved
        camSaved = nil
    end
end

RunService.Stepped:Connect(function()
    if not State.NOCLIP then return end
    local char = LocalPlayer.Character
    if not char then return end
    for _,p in ipairs(char:GetDescendants()) do
        if p:IsA("BasePart") then
            p.CanCollide = false
        end
    end
end)

task.spawn(function()
    while true do
        if State.AUTO_ATTACK then
            VirtualInputManager:SendMouseButtonEvent(0,0,0,true,game,0)
            VirtualInputManager:SendMouseButtonEvent(0,0,0,false,game,0)
        end
        task.wait(0.05)
    end
end)

MainTab:CreateToggle({
    Name = "ESP",
    Callback = function(v) State.ESP = v end
})

MainTab:CreateToggle({
    Name = "Auto TP (Smart Role Switch)",
    Callback = function(v) State.AUTO_TP = v end
})

MainTab:CreateToggle({
    Name = "New Camera Lock",
    Callback = function(v)
        State.CAMERA_LOCK = v
        if not v then unlockCam() end
    end
})

MainTab:CreateToggle({
    Name = "No Collision",
    Callback = function(v) State.NOCLIP = v end
})

MainTab:CreateToggle({
    Name = "Auto Attack",
    Callback = function(v) State.AUTO_ATTACK = v end
})

AddTab:CreateLabel("More coming")
