--// SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

--// PLAYER
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRoot = character:WaitForChild("HumanoidRootPart")

--// FOLDERS
local SaveVars = player:WaitForChild("SaveVars")
local RNGFolder = ReplicatedStorage:WaitForChild("Events"):WaitForChild("RNG")
local SnowflakesFolder = workspace:WaitForChild("Debris"):WaitForChild("Snowflakes")

--// REMOTES
local GetUpgrades = RNGFolder:WaitForChild("GetHalloweenUpgrades")
local BuyUpgrade = RNGFolder:WaitForChild("BuyHalloweenUpgrade")

--// MODULE
local UpgradeData = require(
    ReplicatedStorage:WaitForChild("Modules"):WaitForChild("HalloweenRNGUpgrades")
)

local upgradeOrder = {
    "HeartsMultiplier",
    "Luck",
    "FasterRoll",
    "AutoRoll",
    "ValentinesSafeChance"
}

local touchedHearts = {}

local function killNotifyFolder()
    local gui = player:FindFirstChild("PlayerGui")
    if not gui then return end
    local notify = gui:FindFirstChild("NotifyFolder")
    if notify then
        notify:Destroy()
    end
end

local function touchHeart(heart)
    if heart:IsA("BasePart") and not touchedHearts[heart] then
        firetouchinterest(humanoidRoot, heart, 0)
        firetouchinterest(humanoidRoot, heart, 1)
        touchedHearts[heart] = true
    end
end

RunService.RenderStepped:Connect(function()
    for _, heart in ipairs(SnowflakesFolder:GetChildren()) do
        if heart.Name == "DroppedHeart" then
            touchHeart(heart)
        end
    end
end)

local function getCost(info)
    if not info then return 0 end
    return info.Hearts or 0
end

local function findHeartUpgrade()
    for name in pairs(UpgradeData) do
        if string.find(string.lower(name), "heart") then
            return name
        end
    end
end

task.spawn(function()
    local heartFallbackUsed = false

    while true do
        task.wait(0.2)

        killNotifyFolder()

        local success, levels = pcall(function()
            return GetUpgrades:InvokeServer()
        end)

        if not success or type(levels) ~= "table" then
            task.wait(1)
            continue
        end

        local anyPurchased = false

        for index, name in ipairs(upgradeOrder) do
            local data = UpgradeData[name]

            if not data and not heartFallbackUsed and string.find(string.lower(name), "heart") then
                local fallback = findHeartUpgrade()
                if fallback then
                    upgradeOrder[index] = fallback
                    name = fallback
                    data = UpgradeData[name]
                    heartFallbackUsed = true
                end
            end

            if not data then
                continue
            end

            local current = levels[name] or 0
            local maxLevel = #data

            while current < maxLevel do
                local heartsValue = SaveVars:FindFirstChild("Hearts2026")
                if not heartsValue then break end

                local hearts = heartsValue.Value
                local info = data[current + 1]
                local cost = getCost(info)

                if hearts >= cost then
                    local before = current

                    pcall(function()
                        BuyUpgrade:InvokeServer(name)
                    end)

                    task.wait(0.35)

                    local ok, newLevels = pcall(function()
                        return GetUpgrades:InvokeServer()
                    end)

                    if ok and newLevels then
                        local after = newLevels[name] or before
                        levels = newLevels

                        if after > before then
                            current = after
                            anyPurchased = true
                        else
                            if not heartFallbackUsed and string.find(string.lower(name), "heart") then
                                local fallback = findHeartUpgrade()
                                if fallback and fallback ~= name then
                                    upgradeOrder[index] = fallback
                                    heartFallbackUsed = true
                                end
                            end
                            break
                        end
                    else
                        break
                    end
                else
                    break
                end
            end
        end

        if not anyPurchased then
            task.wait(1)
        end
    end
end)
