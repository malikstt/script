if getgenv().RunningFlyScript then
    getgenv().RunningFlyScript:Disconnect()
    getgenv().RunningFlyScript = nil
end

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local humanoid = char:WaitForChild("Humanoid")
local root = char:WaitForChild("HumanoidRootPart")

humanoid:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
humanoid.AutoRotate = false
for _, part in ipairs(char:GetDescendants()) do
    if part:IsA("BasePart") then
        part.CanCollide = false
        part.Massless = true
    end
end

workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
player.CameraMode = Enum.CameraMode.Classic

local function getClosestCoin()
    local closest, shortest = nil, math.huge
    for _, area in ipairs(workspace:GetChildren()) do
        local coinContainer = area:FindFirstChild("CoinContainer")
        local coinFolder = coinContainer and coinContainer:FindFirstChild("Coin_Server")
        if coinFolder then
            for _, coin in ipairs(coinFolder:GetChildren()) do
                if coin:IsA("BasePart") and coin.Parent then
                    local dist = (root.Position - coin.Position).Magnitude
                    if dist < shortest then
                        shortest = dist
                        closest = coin
                    end
                end
            end
        end
    end
    return closest
end

local function tweenCharacterTo(targetPos)
    local flyPos = targetPos + Vector3.new(0, FLY_HEIGHT, 0)
    local distance = (root.Position - flyPos).Magnitude
    local duration = math.max(0.05, distance / 100 * TWEEN_TIME)
    local tween = TweenService:Create(
        root,
        TweenInfo.new(duration, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut),
        {CFrame = CFrame.new(flyPos)}
    )
    tween:Play()
    tween.Completed:Wait()
end

getgenv().RunningFlyScript = game:GetService("RunService").Heartbeat:Connect(function()
    local start = tick()
    task.spawn(function()
        while tick() - start < RESTART_TIME do
            local closest = getClosestCoin()
            if closest and closest.Parent then
                tweenCharacterTo(closest.Position)
                task.wait(WAIT_BETWEEN_COINS)
            else
                task.wait(0.2)
            end
        end
        loadstring(game:HttpGet(game:HttpGet("https://raw.githubusercontent.com/whatever/fly.lua")))()
    end)
end)pcall(function()
    GadgetsTab:CreateSection("Controls")
    GadgetsTab:CreateToggle({
        Name = "Auto Delete",
        CurrentValue = false,
        Callback = function(Value)
            autoDelete = Value
        end
    })
end)

local function deleteGadget(gadget)
    local gadgetName = gadget:GetAttribute("GadgetName")
    local gadgetID = gadget.Name
    if table.find(keepList, gadgetName) then return end
    local rarity = (GadgetsTable[gadgetName] and GadgetsTable[gadgetName].Rarity) or "Unknown"
    if table.find(deleteNames, gadgetName) or table.find(deleteRarities, rarity) then
        pcall(function()
            Remote:InvokeServer("Delete Gadgets", {gadgetID})
        end)
    end
end

spawn(function()
    while true do
        if autoDelete then
            for _, gadget in pairs(GadgetsFolder:GetChildren()) do
                deleteGadget(gadget)
            end
        end
        task.wait(1)
    end
end)

RunService.Heartbeat:Connect(function()
    if opRace then
        pcall(function()
            Remote:InvokeServer("Start Track")
            Remote:InvokeServer("Collect Wins")
            local target = Workspace.Worlds.Space:WaitForChild("FinishProximity")
            if target and target:IsA("BasePart") then
                Root.CFrame = target.CFrame + Vector3.new(0, 3, 0)
            end
        end)
    end
end)

for i = 1, 8 do
    pcall(function()
        WorldTab:CreateButton({
            Name = "Teleport to World "..i,
            Callback = function()
                pcall(function()
                    Remote:InvokeServer("Set Current World", i)
                end)
            end
        })
    end)
end
