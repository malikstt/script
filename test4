repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)

local RemoteEvent = ReplicatedStorage
    :WaitForChild("Shared")
    :WaitForChild("Framework")
    :WaitForChild("Network")
    :WaitForChild("Remote")
    :WaitForChild("RemoteEvent")

local PickupRemote = ReplicatedStorage
    :WaitForChild("Remotes")
    :WaitForChild("Pickups")
    :WaitForChild("CollectPickup")

local FARM_CFRAME = CFrame.new(-33.90,15971.73,37.79)

local WORLD_COSTS = {
    ["Minigame Paradise"] = 1000000000,
    ["Seven Seas"] = 2500000000
}

local claimed = {}

local function data()
    return LocalData:Get() or {}
end

local function isWorldUnlocked(world)
    local wu = data().WorldsUnlocked
    return wu and wu[world] == true
end

local function unlockWorld(world)
    RemoteEvent:FireServer("UnlockWorld", world)
end

local function teleportWorld(world)
    RemoteEvent:FireServer("WorldTeleport", world)
end

local function pressB()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.B, false, game)
    task.wait(0.02)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.B, false, game)
end

local function tp(cf)
    local c = player.Character or player.CharacterAdded:Wait()
    c:WaitForChild("HumanoidRootPart").CFrame = cf
end

local function grindCoinsUntil(target)
    tp(FARM_CFRAME)
    task.wait(0.5)
    tp(FARM_CFRAME)
    for i = 1,3 do
        pressB()
        task.wait(1)
    end
    while (data().Coins or 0) < target do
        local r = Workspace:FindFirstChild("Rendered")
        if r then
            local t = r:GetChildren()[15]
            if t then
                for _,o in ipairs(t:GetChildren()) do
                    if not claimed[o.Name] then
                        claimed[o.Name] = true
                        pcall(function()
                            PickupRemote:FireServer(o.Name)
                            o:Destroy()
                        end)
                    end
                end
            end
        end
        task.wait(0.1)
    end
end

local function ensureWorld(world)
    if isWorldUnlocked(world) then return end
    local cost = WORLD_COSTS[world]
    if not cost then return end
    if (data().Coins or 0) < cost then
        grindCoinsUntil(cost)
    end
    unlockWorld(world)
    task.wait(6)
    teleportWorld(world)
end

ensureWorld("Minigame Paradise")
ensureWorld("Seven Seas")
