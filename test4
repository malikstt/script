local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local player = Players.LocalPlayer

local WORLD = "The Overworld"
local COIN_TARGET = 3500000000
local FARM_CFRAME = CFrame.new(-33.90, 15971.73, 37.79)

local remotes = ReplicatedStorage
    :WaitForChild("Remotes")
    :WaitForChild("Pickups")
    :WaitForChild("CollectPickup")

local claimed = {}

local function getData()
    return LocalData:Get() or {}
end

local function waitForIslands()
    local w
    repeat
        w = Workspace.Worlds:FindFirstChild(WORLD)
        task.wait(1)
    until w and w:FindFirstChild("Islands")
    return w.Islands
end

local function unlockIslands()
    if not firetouchinterest then return end

    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    local islandsFolder = waitForIslands()

    while true do
        local unlocked = (getData().AreasUnlocked) or {}
        local remaining = {}

        for _, isl in ipairs(islandsFolder:GetChildren()) do
            if not unlocked[isl.Name] then
                table.insert(remaining, isl)
            end
        end

        if #remaining == 0 then break end

        for _, isl in ipairs(remaining) do
            local island = isl:FindFirstChild("Island")
            if island then
                for _, part in ipairs(island:GetDescendants()) do
                    if part:IsA("BasePart") then
                        firetouchinterest(hrp, part, 0)
                        task.wait()
                        firetouchinterest(hrp, part, 1)
                    end
                end
            end
        end

        task.wait(1)
    end
end

local function allOverworldIslandsUnlocked()
    local data = getData()
    local unlocked = data.AreasUnlocked or {}
    local world = Workspace.Worlds:FindFirstChild(WORLD)
    if not world or not world:FindFirstChild("Islands") then return false end
    for _, isl in ipairs(world.Islands:GetChildren()) do
        if not unlocked[isl.Name] then
            return false
        end
    end
    return true
end

local function tpToFarm()
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    hrp.CFrame = FARM_CFRAME
end

local function pressB()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.B, false, game)
    task.wait(0.02)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.B, false, game)
end

unlockIslands()
repeat task.wait(1) until allOverworldIslandsUnlocked()

tpToFarm()
task.wait(0.5)
tpToFarm()

for i = 1, 3 do
    pressB()
    task.wait(1)
end

while true do
    local data = getData()
    if data.Coins and data.Coins >= COIN_TARGET then break end

    local rendered = Workspace:FindFirstChild("Rendered")
    if rendered then
        local children = rendered:GetChildren()
        local target = children[15]
        if target then
            for _, obj in ipairs(target:GetChildren()) do
                local id = obj.Name
                if not claimed[id] then
                    claimed[id] = true
                    pcall(function()
                        remotes:FireServer(id)
                        obj:Destroy()
                    end)
                end
            end
        end
    end

    task.wait(0.1)
end
