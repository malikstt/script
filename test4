repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)

local RemoteEvent = ReplicatedStorage
    :WaitForChild("Shared")
    :WaitForChild("Framework")
    :WaitForChild("Network")
    :WaitForChild("Remote")
    :WaitForChild("RemoteEvent")

local PickupRemote = ReplicatedStorage
    :WaitForChild("Remotes")
    :WaitForChild("Pickups")
    :WaitForChild("CollectPickup")

local COIN_TARGET = 3500000000
local TICKET_TARGET = 1000000000
local OVERWORLD = "The Overworld"
local MINIGAME = "Minigame Paradise"
local FINAL_WORLD = "Seven Seas"

local FARM_CFRAME = CFrame.new(-33.90,15971.73,37.79)

local claimed = {}

local function data()
    return LocalData:Get() or {}
end

local function log(msg)
    warn("[SCRIPT]", msg)
end

local function pressB()
    VirtualInputManager:SendKeyEvent(true,Enum.KeyCode.B,false,game)
    task.wait(0.02)
    VirtualInputManager:SendKeyEvent(false,Enum.KeyCode.B,false,game)
end

local function tp(cf)
    local c = player.Character or player.CharacterAdded:Wait()
    c:WaitForChild("HumanoidRootPart").CFrame = cf
end

local function getAllWorlds()
    local worlds = {}
    if Workspace:FindFirstChild("Worlds") then
        for _,w in ipairs(Workspace.Worlds:GetChildren()) do
            table.insert(worlds, w.Name)
        end
    end
    return worlds
end

local function isWorldUnlocked(world)
    local wu = data().WorldsUnlocked
    return wu and wu[world] == true
end

local function unlockWorld(world)
    log("Attempting to unlock world: "..world)
    RemoteEvent:FireServer("UnlockWorld", world)
    task.wait(2)
    if isWorldUnlocked(world) then
        log("World unlocked: "..world)
        return true
    end
    log("World unlock not confirmed (server may still update): "..world)
    return false
end

local function teleportWorld(world)
    log("Teleporting to "..world)
    RemoteEvent:FireServer("WorldTeleport", world)
end

local function waitForIslands(world)
    local w
    repeat
        w = Workspace.Worlds:FindFirstChild(world)
        task.wait(0.5)
    until w and w:FindFirstChild("Islands")
    return w.Islands
end

local function allIslandsUnlocked(world)
    local unlocked = data().AreasUnlocked or {}
    local w = Workspace.Worlds:FindFirstChild(world)
    if not w or not w:FindFirstChild("Islands") then return false end
    for _,i in ipairs(w.Islands:GetChildren()) do
        if not unlocked[i.Name] then return false end
    end
    return true
end

local function unlockIslands(world)
    if not firetouchinterest then
        log("firetouchinterest missing, cannot unlock islands")
        return
    end
    log("Unlocking islands in "..world)
    local c = player.Character or player.CharacterAdded:Wait()
    local hrp = c:WaitForChild("HumanoidRootPart")
    local islands = waitForIslands(world)
    while true do
        local unlocked = data().AreasUnlocked or {}
        local left = {}
        for _,i in ipairs(islands:GetChildren()) do
            if not unlocked[i.Name] then table.insert(left,i) end
        end
        if #left == 0 then
            log("All islands unlocked in "..world)
            break
        end
        for _,i in ipairs(left) do
            local m = i:FindFirstChild("Island")
            if m then
                for _,p in ipairs(m:GetDescendants()) do
                    if p:IsA("BasePart") then
                        firetouchinterest(hrp,p,0)
                        task.wait()
                        firetouchinterest(hrp,p,1)
                    end
                end
            end
        end
        task.wait(0.5)
    end
end

log("Enumerating worlds from Workspace")
local worlds = getAllWorlds()
if #worlds == 0 then
    error("No worlds detected in Workspace.Worlds")
end

log("Ensuring Overworld islands")
unlockIslands(OVERWORLD)
repeat task.wait(0.5) until allIslandsUnlocked(OVERWORLD)

if (data().Coins or 0) < COIN_TARGET then
    log("Grinding coins")
    tp(FARM_CFRAME)
    task.wait(0.5)
    tp(FARM_CFRAME)
    for i=1,3 do pressB() task.wait(1) end
    while (data().Coins or 0) < COIN_TARGET do
        local r = Workspace:FindFirstChild("Rendered")
        if r then
            local t = r:GetChildren()[15]
            if t then
                for _,o in ipairs(t:GetChildren()) do
                    if not claimed[o.Name] then
                        claimed[o.Name] = true
                        pcall(function()
                            PickupRemote:FireServer(o.Name)
                            o:Destroy()
                        end)
                    end
                end
            end
        end
        task.wait(0.1)
    end
    log("Coin target reached")
else
    log("Coin target already met")
end

for _,world in ipairs(worlds) do
    if world ~= OVERWORLD and not isWorldUnlocked(world) then
        unlockWorld(world)
        task.wait(6)
    end
end

teleportWorld(MINIGAME)
task.wait(3)
for i=1,3 do pressB() task.wait(1) end

unlockIslands(MINIGAME)
repeat task.wait(0.5) until allIslandsUnlocked(MINIGAME)

if (data().Tickets or 0) < TICKET_TARGET then
    log("Waiting for ticket target")
    repeat task.wait(1) until (data().Tickets or 0) >= TICKET_TARGET
    log("Ticket target reached")
else
    log("Ticket target already met")
end

unlockWorld(FINAL_WORLD)
task.wait(5)
teleportWorld(FINAL_WORLD)

log("SCRIPT COMPLETE")
