--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

--// Rayfield
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
	Name = "Random Player TP + ESP",
	LoadingTitle = "Random TP",
	LoadingSubtitle = "Rayfield UI",
})

local Tab = Window:CreateTab("Main", 4483362458)

--// Variables
local TP_ENABLED = false
local TP_DELAY = 0.5
local usedPlayers = {}
local ESP_COLOR = Color3.fromRGB(255, 0, 0)
local ESP_ENABLED = false
local ESP_OBJECTS = {}

--// Utility
local function shuffle(tbl)
	for i = #tbl, 2, -1 do
		local j = math.random(i)
		tbl[i], tbl[j] = tbl[j], tbl[i]
	end
end

local function getNewPlayerList()
	local list = {}
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			table.insert(list, plr)
		end
	end
	shuffle(list)
	return list
end

--// Random TP Loop
task.spawn(function()
	local pool = {}

	while true do
		if TP_ENABLED then
			if #pool == 0 then
				pool = getNewPlayerList()
			end

			local target = table.remove(pool, 1)
			if target and target.Character and LocalPlayer.Character then
				local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
				local thrp = target.Character:FindFirstChild("HumanoidRootPart")
				if hrp and thrp then
					hrp.CFrame = thrp.CFrame * CFrame.new(0, 0, -3)
				end
			end
			task.wait(TP_DELAY)
		else
			task.wait(0.2)
		end
	end
end)

--// ESP Functions
local function clearESP()
	for _, h in pairs(ESP_OBJECTS) do
		if h then h:Destroy() end
	end
	table.clear(ESP_OBJECTS)
end

local function applyESP()
	clearESP()
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and plr.Character then
			local highlight = Instance.new("Highlight")
			highlight.FillColor = ESP_COLOR
			highlight.OutlineColor = ESP_COLOR
			highlight.FillTransparency = 0.5
			highlight.OutlineTransparency = 0
			highlight.Parent = plr.Character
			table.insert(ESP_OBJECTS, highlight)
		end
	end
end

Players.PlayerAdded:Connect(function()
	if ESP_ENABLED then
		task.wait(1)
		applyESP()
	end
end)

--// UI
Tab:CreateToggle({
	Name = "Enable Random Player TP",
	CurrentValue = false,
	Callback = function(v)
		TP_ENABLED = v
	end,
})

Tab:CreateSlider({
	Name = "TP Delay (seconds)",
	Range = {0.1, 1},
	Increment = 0.1,
	Suffix = "sec",
	CurrentValue = 0.5,
	Callback = function(v)
		TP_DELAY = v
	end,
})

Tab:CreateToggle({
	Name = "Enable ESP (Others Only)",
	CurrentValue = false,
	Callback = function(v)
		ESP_ENABLED = v
		if v then
			applyESP()
		else
			clearESP()
		end
	end,
})

Tab:CreateColorPicker({
	Name = "ESP Color",
	Color = ESP_COLOR,
	Callback = function(c)
		ESP_COLOR = c
		if ESP_ENABLED then
			applyESP()
		end
	end,
})
