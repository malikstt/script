local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local RNGFolder = ReplicatedStorage:WaitForChild("Events"):WaitForChild("RNG")
local GetUpgrades = RNGFolder:WaitForChild("GetHalloweenUpgrades")
local UpgradeData = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("HalloweenRNGUpgrades"))

-- Upgrade order
local upgradeOrder = {"HeartsMultiplier","Luck","FasterRoll","AutoRoll","ValentinesSafeChance"}

-- UI setup
local gui = Instance.new("ScreenGui")
gui.Name = "ValentineDashboard"
gui.Parent = player:WaitForChild("PlayerGui")
gui.ResetOnSpawn = false

local background = Instance.new("Frame")
background.Size = UDim2.fromScale(1,1)
background.BackgroundColor3 = Color3.fromRGB(0,0,0)
background.BackgroundTransparency = 0.4
background.Parent = gui

local container = Instance.new("Frame")
container.Size = UDim2.fromScale(0.6,0.78) 
container.Position = UDim2.fromScale(0.2,0.1) 
container.BackgroundTransparency = 1
container.Parent = background

-- Username at top
local userLabel = Instance.new("TextLabel")
userLabel.Size = UDim2.new(1,0,0,50)
userLabel.Position = UDim2.new(0,0,0,0)
userLabel.BackgroundTransparency = 1
userLabel.Text = "üë§ "..player.Name
userLabel.TextScaled = true
userLabel.Font = Enum.Font.GothamBold
userLabel.TextColor3 = Color3.fromRGB(255,255,255)
userLabel.Parent = container

-- Container for everything below username
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1,0,1,-60)
contentFrame.Position = UDim2.new(0,0,0,50)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = container

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0,12)
layout.Parent = contentFrame

-- Hearts & Cash
local heartsLabel = Instance.new("TextLabel")
heartsLabel.Size = UDim2.new(1,0,0,40)
heartsLabel.BackgroundTransparency = 1
heartsLabel.TextScaled = true
heartsLabel.Font = Enum.Font.GothamBold
heartsLabel.TextColor3 = Color3.fromRGB(255,255,255)
heartsLabel.Parent = contentFrame

-- Status label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1,0,0,35)
statusLabel.BackgroundTransparency = 1
statusLabel.TextScaled = true
statusLabel.Font = Enum.Font.GothamBold
statusLabel.TextColor3 = Color3.fromRGB(255,255,255)
statusLabel.Parent = contentFrame

-- Upgrade frames & bars
local upgradeFrames = {}
local upgradeBars = {}

for i, name in ipairs(upgradeOrder) do
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1,0,0,30)
    frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
    frame.BackgroundTransparency = 0.6
    frame.Parent = contentFrame

    local bar = Instance.new("Frame")
    bar.Size = UDim2.new(0,0,1,0)
    bar.BackgroundColor3 = Color3.fromRGB(255,0,150)
    bar.BorderSizePixel = 0
    bar.Parent = frame

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = Color3.fromRGB(255,255,255)
    label.Text = "üíò "..name.." | 0"
    label.Parent = frame

    upgradeFrames[name] = {frame=frame,label=label}
    upgradeBars[name] = bar
end

-- Format numbers K/M/B/T
local function formatNumber(n)
    local absn = math.abs(n)
    if absn >= 1e12 then return string.format("%.2fT", n/1e12)
    elseif absn >= 1e9 then return string.format("%.2fB", n/1e9)
    elseif absn >= 1e6 then return string.format("%.2fM", n/1e6)
    elseif absn >= 1e3 then return string.format("%.1fK", n/1e3)
    else return tostring(n)
    end
end

-- Hearts & Cash
local heartsVar = player:WaitForChild("SaveVars"):WaitForChild("Hearts2026")
local cashVar = player:WaitForChild("SaveVars"):WaitForChild("Cash")

local lastHearts = heartsVar.Value
local lastUpgrades = GetUpgrades:InvokeServer()

-- Detect purchased upgrade
local function getPurchased(prev, current)
    for _, name in ipairs(upgradeOrder) do
        if prev[name] < (current[name] or 0) then
            return name, prev[name], current[name]
        end
    end
    return nil
end

-- Rotating texts
local rotatingTexts = {
    "‚ù§Ô∏è Collecting Hearts...",
    "üí∏ Saving for next upgrade",
    "üéØ Next target: Luck",
    "üîÆ Upgrade path: Multiplier ‚Üí Luck ‚Üí Speed",
    "‚è≥ Waiting for enough Hearts"
}
local currentRotating = 1
local tempMessageEnd = 0

task.spawn(function()
    while true do
        if tick() > tempMessageEnd then
            statusLabel.Text = rotatingTexts[currentRotating]
        end
        currentRotating = currentRotating + 1
        if currentRotating > #rotatingTexts then currentRotating = 1 end
        task.wait(4)
    end
end)

-- RenderStepped updates
RunService.RenderStepped:Connect(function()
    local hearts = heartsVar.Value
    local cash = cashVar.Value
    local deltaHearts = hearts - lastHearts
    heartsLabel.Text = "‚ù§Ô∏è "..formatNumber(hearts).." | üí∏ "..formatNumber(cash)

    local levels = GetUpgrades:InvokeServer()

    -- Upgrade bars
    for _, name in ipairs(upgradeOrder) do
        local current = levels[name] or 0
        local max = UpgradeData[name] and #UpgradeData[name] or 1

        -- Update bar size
        local bar = upgradeBars[name]
        local newSize = UDim2.new(current/max,0,1,0)
        TweenService:Create(bar,TweenInfo.new(0.2),{Size=newSize}):Play()

        -- Only show current level
        upgradeFrames[name].label.Text = "üíò "..name.." | "..current

        -- Change bar color if maxed
        if current < max then
            bar.BackgroundColor3 = Color3.fromRGB(255,0,150)
        else
            bar.BackgroundColor3 = Color3.fromRGB(100,100,100)
        end
    end

    -- Dynamic temporary messages
    local tempDisplayed = false
    if deltaHearts > 0 then
        statusLabel.Text = "‚¨Ü + "..formatNumber(deltaHearts).." ‚ù§Ô∏è"
        tempMessageEnd = tick() + 2
        tempDisplayed = true
    elseif deltaHearts < 0 then
        local purchased, prevLv, newLv = getPurchased(lastUpgrades, levels)
        if purchased then
            local cost = 0
            if UpgradeData[purchased] and UpgradeData[purchased][newLv] then
                cost = UpgradeData[purchased][newLv].Hearts or 0
            end
            statusLabel.Text = "üéâ Purchased "..purchased.." Level "..newLv.." for "..formatNumber(cost).." ‚ù§Ô∏è"
            tempMessageEnd = tick() + 3
            tempDisplayed = true
        end
    end

    -- Keep rotating text if no temp message
    if not tempDisplayed and tick() > tempMessageEnd then
        statusLabel.Text = rotatingTexts[currentRotating]
    end

    lastHearts = hearts
    lastUpgrades = levels
end)
