local ACCEPT_PET_NAMES = {"Surge Dragon", "Dual Shock", "Overcharged Robot"}

local CHECK_INTERVAL = 1
local WAIT_TIME = 5
local DEBUG_MODE = true

local lastPetAddedTime = 0
local lastKnownPetIds = {}
local isInTrade = false
local tradePartnerId = nil
local readyUpCooldown = false

local function debugPrint(message)
    if DEBUG_MODE then
        print("[AutoTrade] " .. message)
    end
end

local function isPetInAcceptList(petName)
    for _, acceptedName in pairs(ACCEPT_PET_NAMES) do
        if string.find(petName, acceptedName) or petName == acceptedName then
            return true
        end
    end
    return false
end

local function getCurrentPetIds()
    local petIds = {}
    
    local success, replication = pcall(function()
        return require(game:GetService("ReplicatedStorage").Game.Replication)
    end)
    
    if success and replication and replication.Data and replication.Data.Pets then
        for petId, petData in pairs(replication.Data.Pets) do
            if petData and petData.Name then
                table.insert(petIds, petId)
            end
        end
    end
    
    return petIds
end

local function checkForNewPets()
    local currentPetIds = getCurrentPetIds()
    local newPetIds = {}
    
    for _, petId in pairs(currentPetIds) do
        if not table.find(lastKnownPetIds, petId) then
            table.insert(newPetIds, petId)
        end
    end
    
    lastKnownPetIds = currentPetIds
    
    return newPetIds
end

local function shouldAcceptTrade()
    if not isInTrade then
        return false
    end
    
    local timeSinceLastPet = tick() - lastPetAddedTime
    if timeSinceLastPet < WAIT_TIME then
        return false
    end
    
    return true
end

local function autoTradeLogic()
    while true do
        task.wait(CHECK_INTERVAL)
        
        local newPetIds = checkForNewPets()
        if #newPetIds > 0 then
            debugPrint("Detected " .. #newPetIds .. " new pet(s)")
            
            local replication = require(game:GetService("ReplicatedStorage").Game.Replication)
            local acceptedPetFound = false
            
            for _, petId in pairs(newPetIds) do
                if replication.Data.Pets[petId] then
                    local petName = replication.Data.Pets[petId].Name
                    if isPetInAcceptList(petName) then
                        debugPrint("Found: " .. petName)
                        acceptedPetFound = true
                        break
                    end
                end
            end
            
            if acceptedPetFound then
                lastPetAddedTime = tick()
            end
        end
        
        if shouldAcceptTrade() then
            debugPrint("Auto accepting trade...")

            -- Fire the remote to **accept** the trade
            local Network_upvr = require(game.ReplicatedStorage.Modules.Network)
            local success, result = pcall(function()
                return Network_upvr:FireServer("AcceptTrade")  -- Ensure this is the correct remote for accepting the trade
            end)
            
            if success then
                readyUpCooldown = true
                task.wait(2)
                readyUpCooldown = false
            else
                debugPrint("Failed to accept trade.")
            end
        end
    end
end

local function setupTradeHooks()
    local Network_upvr = require(game.ReplicatedStorage.Modules.Network)
    
    -- Handle trade start, close, and items being added or removed
    Network_upvr:BindEvents({
        ["StartTrade"] = function(tradeData)
            isInTrade = true
            tradePartnerId = tradeData.partner.UserId
            lastPetAddedTime = tick()
        end,
        
        ["CloseTrade"] = function()
            isInTrade = false
            tradePartnerId = nil
            readyUpCooldown = false
        end,
        
        ["AddTradeItem"] = function(itemData)
            if itemData[1] == "Pet" then
                lastPetAddedTime = tick()
            end
        end,
        
        ["RemoveTradeItem"] = function(itemData)
            if itemData[1] == "Pet" then
                lastPetAddedTime = tick()
            end
        end
    })
end

local function init()
    debugPrint("Starting Auto Trade for: Surge Dragon, Dual Shock, Overcharged Robot")
    
    lastKnownPetIds = getCurrentPetIds()
    
    local success, err = pcall(setupTradeHooks)
    if not success then
        debugPrint("Error: " .. tostring(err))
    end
    
    task.spawn(autoTradeLogic)
    
    debugPrint("Ready")
end

init()
