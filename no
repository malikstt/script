local RS = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local CS = game:GetService("CollectionService")
local HttpService = game:GetService("HttpService")

local Replication = require(RS.Game.Replication)
local Network = require(RS.Modules.Network)
local LP = Players.LocalPlayer

-- // CONFIGURATION
local API_BASE = "https://colon-vertical-cup-exchanges.trycloudflare.com"
local BLACKLISTED_PETS = {
    ["Surge Dragon"] = true,
    ["Dual Shock"] = true,
    ["Overcharged Robot"] = true
}

local currentListings = {} -- Track what we've already put on the booth

-- // HELPER: Fetch Alts from Node.js
local function getAltData()
    local success, res = pcall(function()
        return request({
            Url = API_BASE .. "/alts",
            Method = "GET"
        })
    end)
    
    if success and res.Body then
        local decoded = HttpService:JSONDecode(res.Body)
        return decoded.alts or {}
    end
    return {}
end

-- // HELPER: Find a "Trash" Pet to Sell
local function findAvailableTrashPet()
    for id, pet in pairs(Replication.Data.Pets or {}) do
        -- Check if it's NOT blacklisted, NOT locked, and NOT already listed
        if not BLACKLISTED_PETS[pet.Name] 
           and not pet.Locked 
           and not pet.Trading 
           and not currentListings[id] then
            return id, pet.Name
        end
    end
    return nil
end

-- // MAIN LOGIC: Sync Booth with Alt Tokens
local function syncBoothWithAlts()
    local alts = getAltData()
    if #alts == 0 then return end

    -- Report Main's location so Alts can join
    pcall(function()
        request({
            Url = API_BASE .. "/update",
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                role = "main",
                username = LP.Name,
                jobId = game.JobId,
                placeId = game.PlaceId
            })
        })
    end)

    for _, alt in ipairs(alts) do
        local tokenPrice = tonumber(alt.tokens) or 0
        
        -- Only list if the alt actually has tokens to spend
        if tokenPrice > 0 then
            local petId, petName = findAvailableTrashPet()
            
            if petId then
                print("Listing " .. petName .. " for Alt: " .. alt.username .. " (" .. tokenPrice .. " tokens)")
                local success = Network:InvokeServer("ListItem", "Pet", petId, tokenPrice)
                if success then
                    currentListings[petId] = true
                end
            end
        end
        task.wait(0.2)
    end
end

-- // BOOTH CLAIMER & AUTO-HRP (Your existing logic)
task.spawn(function()
    while true do
        local ownBooth = nil
        for _, b in ipairs(CS:GetTagged("Booth")) do
            if b:GetAttribute("BoothOwner") == LP.UserId then ownBooth = b break end
        end

        if not ownBooth then
            -- Try to claim any empty booth
            for _, b in ipairs(CS:GetTagged("Booth")) do
                if b:GetAttribute("BoothOwner") == nil then
                    Network:InvokeServer("ClaimBooth", b)
                    break
                end
            end
        else
            -- Stay at booth
            local hrp = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
            if hrp and ownBooth.PrimaryPart then
                hrp.CFrame = ownBooth.PrimaryPart.CFrame * CFrame.new(0, 5, 0)
            end
        end
        task.wait(5)
    end
end)

-- // START SYNC LOOP
task.spawn(function()
    while true do
        pcall(syncBoothWithAlts)
        task.wait(15) -- Check for new alts/tokens every 15 seconds
    end
end)

print("Main Account Controller Active.")
