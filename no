local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")

local Config = {
    AutoJoin = true,
    AutoBid = true,
    BidDelay = 0.5,
    MaxBid = 50000,
    Items = {
        ["Golden Statue"] = true,
        ["Diamond Ring"] = true,
        ["Luxury Watch"] = true,
        ["Antique Vase"] = true,
        ["Rare Painting"] = true,
    }
}

local State = {
    InAuction = false,
    CurrentItem = nil,
    CurrentBid = 0,
    GarageId = nil
}

local function log(...)
    print("[AUTO AUCTION]", ...)
end

local function warnlog(...)
    warn("[AUTO AUCTION ERROR]", ...)
end

local function safeFire(remote, ...)
    local ok, err = pcall(function()
        remote:FireServer(...)
    end)
    if not ok then
        warnlog("FireServer failed:", remote.Name, err)
        return false
    end
    return true
end

local function safeInvoke(remote, ...)
    local ok, result = pcall(function()
        return remote:InvokeServer(...)
    end)
    if not ok then
        warnlog("InvokeServer failed:", remote.Name, result)
        return nil
    end
    return result
end

local function tryJoin()
    if not Config.AutoJoin then return end
    log("Attempting to join auction queue")
    local ok = safeFire(Auctions.EnterQueue)
    if ok then
        log("Join request sent")
    end
end

local function shouldBid(itemName)
    if not itemName then return false end
    return Config.Items[itemName] == true
end

local function placeBid()
    if not Config.AutoBid then return end
    if not State.InAuction then return end
    if not State.CurrentItem then return end
    if not shouldBid(State.CurrentItem) then return end
    if State.CurrentBid >= Config.MaxBid then
        log("Max bid reached:", State.CurrentBid)
        return
    end

    task.wait(Config.BidDelay)

    local ok = safeFire(Auctions.PlaceBid)
    if ok then
        log("Bid placed on:", State.CurrentItem, "Current:", State.CurrentBid)
    end
end

local function detectAuction()
    local data = safeInvoke(Auctions.GetAuctionFromPlayer, LocalPlayer)
    if data then
        State.InAuction = true
        log("Detected auction via invoke")
    end
end

Auctions.SetupAuction.OnClientEvent:Connect(function(data)
    log("Auction setup detected")

    if typeof(data) == "table" then
        if data.itemName then
            State.CurrentItem = data.itemName
            log("Item detected:", State.CurrentItem)
        end
        if data.garageId then
            State.GarageId = data.garageId
            log("Garage detected:", State.GarageId)
        end
    end
end)

Auctions.StartAuction.OnClientEvent:Connect(function(...)
    State.InAuction = true
    log("Auction started")

    task.spawn(function()
        while State.InAuction do
            placeBid()
            task.wait(0.2)
        end
    end)
end)

Auctions.UpdateCurrentBid.OnClientEvent:Connect(function(bidData)
    if typeof(bidData) == "table" then
        if bidData.value then
            State.CurrentBid = bidData.value
            log("Current bid updated:", State.CurrentBid)
        end
        if bidData.itemName then
            State.CurrentItem = bidData.itemName
        end
    elseif typeof(bidData) == "number" then
        State.CurrentBid = bidData
        log("Current bid updated:", State.CurrentBid)
    end
end)

Auctions.EndAuction.OnClientEvent:Connect(function()
    State.InAuction = false
    State.CurrentItem = nil
    State.CurrentBid = 0
    State.GarageId = nil
    log("Auction ended")
end)

Auctions.PlayerLeftAuction.OnClientEvent:Connect(function(player)
    if player == LocalPlayer then
        State.InAuction = false
        log("You left auction")
    end
end)

task.spawn(function()
    while true do
        if not State.InAuction then
            tryJoin()
            detectAuction()
        end
        task.wait(3)
    end
end)

log("Auto auction initialized")
