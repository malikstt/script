-- Fluent UI Trade Listener
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local Window = Fluent:CreateWindow({
    Title = "Trade Listener",
    SubTitle = "Auto Accept Trades",
    TabWidth = 160,
    Size = UDim2.fromOffset(450, 350),
    Acrylic = false,
    Theme = "Dark"
})

local MainTab = Window:AddTab({Title = "Main", Icon = "settings"})

local StatusGroup = MainTab:AddGroup("Status", {LayoutOrder = 1})

local statusLabel = StatusGroup:AddParagraph({
    Title = "Listening:",
    Content = "Waiting for trades..."
})

local partnerLabel = StatusGroup:AddGroup("Partner", {LayoutOrder = 2})
partnerLabel:AddParagraph({
    Title = "Current:",
    Content = "None"
})

local ControlsGroup = MainTab:AddGroup("Settings", {LayoutOrder = 3})

local autoToggle = ControlsGroup:AddToggle("autoToggle", {
    Title = "Auto Accept",
    Description = "Accept trades automatically",
    Default = true
})

local delaySlider = ControlsGroup:AddSlider("delaySlider", {
    Title = "Delay (seconds)",
    Description = "Wait time before accepting",
    Default = 5,
    Min = 1,
    Max = 30,
    Rounding = 0
})

local conditionsLabel = ControlsGroup:AddParagraph({
    Title = "Conditions Met:",
    Content = "❌ Not in trade\n❌ Partner not ready\n❌ Items still adding"
})

local LogTab = Window:AddTab({Title = "Log", Icon = "list"})
local LogGroup = LogTab:AddGroup("Activity", {LayoutOrder = 1})

local logs = {}
local function addLog(message)
    table.insert(logs, 1, "[" .. os.date("%H:%M:%S") .. "] " .. message)
    if #logs > 10 then table.remove(logs, 11) end
    
    local content = ""
    for i, log in ipairs(logs) do
        content = content .. log .. "\n"
    end
    
    LogGroup:UpdateParagraph("logContent", {
        Title = "Recent Activity",
        Content = content
    })
end

local tradeData = {
    lastItemChange = 0,
    tradeStart = 0,
    isActive = false,
    partner = nil,
    itemsOffered = 0,
    tokensOffered = 0
}

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local function checkTradeConditions()
    if not tradeData.isActive or not autoToggle.Value then return false end
    
    local currentTime = tick()
    local inactiveTime = currentTime - tradeData.lastItemChange
    
    return inactiveTime >= delaySlider.Value
end

local function updateConditionsDisplay()
    local conditions = {}
    
    if not tradeData.isActive then
        table.insert(conditions, "❌ Not in trade")
    else
        table.insert(conditions, "✅ In trade")
    end
    
    if tradeData.partner then
        table.insert(conditions, "✅ Partner found")
    else
        table.insert(conditions, "❌ No partner")
    end
    
    local inactiveTime = tick() - tradeData.lastItemChange
    if inactiveTime >= delaySlider.Value then
        table.insert(conditions, "✅ Items stable")
    else
        table.insert(conditions, "❌ Items changing")
    end
    
    conditionsLabel:SetProps({
        Content = table.concat(conditions, "\n")
    })
end

-- Hook into trade system
local originalHandleStartTrade
if handleStartTrade_upvr then
    originalHandleStartTrade = handleStartTrade_upvr
    handleStartTrade_upvr = function(arg1)
        if originalHandleStartTrade then originalHandleStartTrade(arg1) end
        
        tradeData.isActive = true
        tradeData.tradeStart = tick()
        tradeData.lastItemChange = tick()
        tradeData.partner = arg1.partner
        tradeData.itemsOffered = 0
        tradeData.tokensOffered = 0
        
        statusLabel:SetProps({Content = "Monitoring trade..."})
        if tradeData.partner then
            partnerLabel:UpdateParagraph("partnerName", {
                Title = "Partner:",
                Content = tradeData.partner.Name
            })
        end
        
        addLog("Trade started with " .. (tradeData.partner and tradeData.partner.Name or "unknown"))
    end
end

-- Hook item additions
if handleAddTradeItem_upvr then
    local originalAddItem = handleAddTradeItem_upvr
    handleAddTradeItem_upvr = function(arg1)
        if originalAddItem then originalAddItem(arg1) end
        
        tradeData.lastItemChange = tick()
        tradeData.itemsOffered = tradeData.itemsOffered + 1
        addLog("Partner added item")
    end
end

-- Hook item removals
if handleRemoveTradeItem_upvr then
    local originalRemoveItem = handleRemoveTradeItem_upvr
    handleRemoveTradeItem_upvr = function(arg1)
        if originalRemoveItem then originalRemoveItem(arg1) end
        
        tradeData.lastItemChange = tick()
        tradeData.itemsOffered = math.max(0, tradeData.itemsOffered - 1)
        addLog("Partner removed item")
    end
end

-- Hook token updates
if handleTokensUpdate_upvr then
    local originalTokensUpdate = handleTokensUpdate_upvr
    handleTokensUpdate_upvr = function(arg1)
        if originalTokensUpdate then originalTokensUpdate(arg1) end
        
        tradeData.lastItemChange = tick()
        tradeData.tokensOffered = arg1 or 0
        addLog("Partner updated tokens: " .. tostring(tradeData.tokensOffered))
    end
end

-- Hook close trade
if closeActiveTrade_upvr then
    local originalCloseTrade = closeActiveTrade_upvr
    closeActiveTrade_upvr = function()
        if originalCloseTrade then originalCloseTrade() end
        
        tradeData.isActive = false
        tradeData.partner = nil
        statusLabel:SetProps({Content = "Waiting for trades..."})
        partnerLabel:UpdateParagraph("partnerName", {
            Title = "Partner:",
            Content = "None"
        })
        addLog("Trade ended")
    end
end

-- Auto-accept logic
RunService.Heartbeat:Connect(function()
    if not tradeData.isActive then return end
    
    updateConditionsDisplay()
    
    if checkTradeConditions() and autoToggle.Value then
        -- Auto ready up if conditions met
        if var44_upvw and Network_upvr and not var44_upvw.ready.self and not var51_upvw then
            Network_upvr:FireServer("ReadyUp", false, true)
            addLog("✅ AUTO READY: Conditions met")
        end
    end
end)

-- Start monitoring
addLog("Trade Listener initialized")
Fluent:Notify({
    Title = "Trade Listener",
    Content = "Ready to auto-accept trades",
    Duration = 3
})

Window:SelectTab(1)
