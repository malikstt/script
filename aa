local RS = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Replication = require(RS.Game.Replication)
local Network = require(RS.Modules.Network)

getgenv().AutoSellConfig = {
    Enabled = true,
    ScanInterval = 3,
    MaxListings = 12,
    Pets = {
        ["Surge Dragon"] = 75,
        ["Dual Shock"] = 225
    }
}

getgenv().AutoBuyConfig = {
    Enabled = false
}

local LocalPlayer = Players.LocalPlayer
local running = false
local debounce = {}

local function updateMyListings()
    local ok, list = pcall(function()
        return Network:InvokeServer("GetBoothListings", LocalPlayer.UserId)
    end)
    if not ok then
        warn("Failed to get listings:", list)
        return {}
    end
    return list or {}
end

local function autoSell()
    local myListings = updateMyListings()
    local listedCount = 0
    for _ in pairs(myListings) do listedCount = listedCount + 1 end
    
    local pets = Replication.Data and Replication.Data.Pets
    if not pets then
        warn("No pets data found")
        return
    end
    
    for _, pet in pairs(pets) do
        if not pet or not pet.Id then continue end
        if listedCount >= getgenv().AutoSellConfig.MaxListings then break end
        
        local price = getgenv().AutoSellConfig.Pets[pet.Name]
        if not price then continue end
        
        local alreadyListed = false
        for _, listing in pairs(myListings) do
            if listing.itemName == pet.Id then
                alreadyListed = true
                break
            end
        end
        if alreadyListed then continue end
        
        if debounce[pet.Id] then continue end
        debounce[pet.Id] = true
        
        local petName = pet.Name or "Unknown"
        
        local success, err = pcall(function()
            Network:InvokeServer("UpdateBoothListing", pet.Id, price)
        end)
        
        if success then
            print(string.format("âœ… Listed %s for %d", petName, price))
            listedCount = listedCount + 1
        else
            warn(string.format("âŒ Failed to list %s: %s", petName, err))
        end
        
        task.wait(0.5)
        debounce[pet.Id] = nil
    end
    
    if listedCount > 0 then
        print(string.format("ğŸ“Š Total listed this scan: %d", listedCount))
    end
end

local function checkSoldPets()
    local myListings = updateMyListings()
    local pets = Replication.Data and Replication.Data.Pets
    if not pets then return end
    
    local petIds = {}
    for _, pet in pairs(pets) do
        if pet and pet.Id then
            petIds[pet.Id] = true
        end
    end
    
    local soldCount = 0
    for _, listing in pairs(myListings) do
        if listing.itemType == "Pet" and not petIds[listing.itemName] then
            soldCount = soldCount + 1
        end
    end
    
    if soldCount > 0 then
        print(string.format("ğŸ‰ %d pet(s) sold! Rescanning...", soldCount))
        return true
    end
    return false
end

local function start()
    if running then return end
    running = true
    
    print("ğŸš€ Auto Sell started")
    print(string.format("ğŸ“ˆ Listing: Surge Dragon = %d, Dual Shock = %d", 
        getgenv().AutoSellConfig.Pets["Surge Dragon"],
        getgenv().AutoSellConfig.Pets["Dual Shock"]))
    
    while running do
        local success, err = pcall(function()
            if checkSoldPets() then
                task.wait(1)
            end
            autoSell()
        end)
        
        if not success then
            warn("Scan error:", err)
        end
        
        task.wait(getgenv().AutoSellConfig.ScanInterval or 3)
    end
end

local function stop()
    running = false
    print("â¹ï¸ Auto Sell stopped")
end

task.spawn(function()
    task.wait(5)
    if getgenv().AutoSellConfig.Enabled then
        start()
    end
end)

getgenv().AutoSell = {
    Start = start,
    Stop = stop
}
