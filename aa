local Players = game:GetService("Players")
local CollectionService = game:GetService("CollectionService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local Network

pcall(function()
	Network = require(ReplicatedStorage:FindFirstChild("Network") or ReplicatedStorage:WaitForChild("Network"))
end)

if not Network then
	pcall(function()
		Network = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Network"))
	end)
end

local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

local maxWait = 30
local startTime = tick()
while #CollectionService:GetTagged("Booth") == 0 and tick() - startTime < maxWait do
	task.wait(1)
end

if #CollectionService:GetTagged("Booth") == 0 then
	warn("No booths found")
	return
end

math.randomseed(os.clock() * 1000)

local function shuffle(t)
	for i = #t, 2, -1 do
		local j = math.random(i)
		t[i], t[j] = t[j], t[i]
	end
end

local function getRandomPlayer()
	local t = {}
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			table.insert(t, plr)
		end
	end
	return #t > 0 and t[math.random(#t)] or nil
end

local function getBoothsNearPosition(pos, range)
	local t = {}
	for _, booth in ipairs(CollectionService:GetTagged("Booth")) do
		if booth.PrimaryPart and booth:GetAttribute("BoothOwner") == nil then
			if (booth.PrimaryPart.Position - pos).Magnitude <= range then
				table.insert(t, booth)
			end
		end
	end
	return t
end

for _, booth in ipairs(CollectionService:GetTagged("Booth")) do
	if booth:GetAttribute("BoothOwner") == player.UserId then
		pcall(function()
			hrp.CFrame = booth.PrimaryPart.CFrame * CFrame.new(0, 5, 0)
		end)
		goto BOOTH_DONE
	end
end

local range = 20
local attempts = 0
local maxAttempts = 50

while attempts < maxAttempts do
	local target = getRandomPlayer()
	if target and target.Character then
		local th = target.Character:FindFirstChild("HumanoidRootPart")
		if th then
			local booths = getBoothsNearPosition(th.Position, range)
			if #booths > 0 then
				shuffle(booths)
				for _, booth in ipairs(booths) do
					attempts += 1
					pcall(function()
						if Network and Network.InvokeServer then
							Network:InvokeServer("ClaimBooth", booth)
						else
							local r = ReplicatedStorage:FindFirstChild("ClaimBooth")
							if not r then
								local re = ReplicatedStorage:FindFirstChild("RemoteEvents")
								r = re and re:FindFirstChild("ClaimBooth") or nil
							end
							if r and r.FireServer then
								r:FireServer(booth)
							end
						end
					end)

					local s = tick()
					while tick() - s < 2 do
						if booth:GetAttribute("BoothOwner") == player.UserId then
							pcall(function()
								hrp.CFrame = booth.PrimaryPart.CFrame * CFrame.new(0, 5, 0)
								hrp.AssemblyLinearVelocity = Vector3.zero
								hrp.AssemblyAngularVelocity = Vector3.zero
							end)
							goto BOOTH_DONE
						end
						task.wait(0.1)
					end
					task.wait(0.3)
				end
			end
		end
	end
	range += 10
	attempts += 1
	task.wait(0.5)
end

::BOOTH_DONE::

local httpRequest =
	(syn and syn.request) or
	(http and http.request) or
	(http_request) or
	(fluxus and fluxus.request) or
	(request)

if not httpRequest then
	warn("NO_HTTP_SUPPORT")
	return
end

getgenv().AutoSellConfig = {
	Enabled = true,
	ScanInterval = 3,
	MaxListings = 15,
	Pets = {
		["Surge Dragon"] = 50,
		["Dual Shock"] = 150,
		["Overcharged Robot"] = 650
	}
}

local notified = {}
local listed = {}
local busy = false

local Replication
pcall(function()
	Replication = require(
		ReplicatedStorage:FindFirstChild("Replication")
			or ReplicatedStorage:WaitForChild("Game"):WaitForChild("Replication")
			or (ReplicatedStorage:FindFirstChild("Modules") and ReplicatedStorage:FindFirstChild("Modules"):FindFirstChild("Replication"))
	)
end)

if not Replication then
	getgenv().AutoSellConfig.Enabled = false
	return
end

local function sendWebhook(userId, petName, tier, amount, petId)
	if notified[petId] then return end
	notified[petId] = true

	local content = string.format(
		"ðŸ’¸ **%s** (ID: %s) sold **%s**\nâž• **+%s tokens** | Tier: **%s** âœ¨",
		player.Name, userId, petName, amount, tier
	)

	pcall(function()
		httpRequest({
			Url = WEBHOOK_URL,
			Method = "POST",
			Headers = { ["Content-Type"] = "application/json" },
			Body = HttpService:JSONEncode({
				username = "Auto Sell",
				content = content
			})
		})
	end)
end

local function getPrice(pet)
	if not pet then return nil end
	local name = pet.Nickname or pet.Name
	local base = getgenv().AutoSellConfig.Pets[name]
	if not base then
		for k, v in pairs(getgenv().AutoSellConfig.Pets) do
			if string.find(name, k) then
				base = v
				break
			end
		end
	end
	if not base then return nil end

	local tier = pet.Tier or "Normal"
	if tier == "Golden" then
		return base * 5
	elseif tier == "Rainbow" or tier == "Shiny" then
		return base * 10
	elseif tier == "Normal" or tier == "Regular" then
		return base
	else
		return base * 2
	end
end

local function autoList()
	if busy or not getgenv().AutoSellConfig.Enabled then return end
	busy = true

	local pets = Replication.Data and Replication.Data.Pets
	if not pets then busy = false return end

	local count = 0
	for petId, pet in pairs(pets) do
		if count >= getgenv().AutoSellConfig.MaxListings then break end
		if not listed[petId] and not pet.Locked and not pet.Trading then
			local price = getPrice(pet)
			if price then
				local sellPrice = math.ceil(price)
				local ok, res = pcall(function()
					if Network and Network.InvokeServer then
						return Network:InvokeServer("ListItem", "Pet", petId, sellPrice)
					else
						local r = ReplicatedStorage:FindFirstChild("ListItem")
						if not r then
							local re = ReplicatedStorage:FindFirstChild("RemoteEvents")
							r = re and re:FindFirstChild("ListItem") or nil
						end
						if r and r.InvokeServer then
							return r:InvokeServer("Pet", petId, sellPrice)
						end
						return false
					end
				end)

				if ok and res then
					listed[petId] = true
					count += 1
					sendWebhook(player.UserId, pet.Nickname or pet.Name or "Pet", pet.Tier or "Normal", sellPrice, petId)
				end
				task.wait(0.25)
			end
		end
	end
	busy = false
end

task.spawn(function()
	while task.wait(getgenv().AutoSellConfig.ScanInterval) do
		pcall(autoList)
	end
end)

task.spawn(function()
	while task.wait(300) do
		notified = {}
	end
end)

print("Loaded")
