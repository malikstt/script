--// SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

--// MODULES
local Eggs = require(ReplicatedStorage.Shared.Data.Eggs)
local Pets = require(ReplicatedStorage.Shared.Data.Pets)
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local IndexUtil = require(ReplicatedStorage.Shared.Utils.IndexUtil)

local Remote = ReplicatedStorage.Shared.Framework.Network.Remote.RemoteEvent

--// STATE
local INDEX_MODE = "Normal" -- auto switches to Shiny
local EggOrder = {}
local EggPointer = 1

--// BUILD STABLE EGG LIST
for eggName in pairs(Eggs) do
    table.insert(EggOrder, eggName)
end
table.sort(EggOrder)

--// UI
local gui = Instance.new("ScreenGui", player.PlayerGui)
gui.Name = "IndexAutoCompleter"

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromScale(0.38, 0.36)
frame.Position = UDim2.fromScale(0.31, 0.04)
frame.BackgroundColor3 = Color3.fromRGB(18,18,18)
frame.BorderSizePixel = 0

local function label(y)
    local l = Instance.new("TextLabel", frame)
    l.Size = UDim2.fromScale(1, 0.1)
    l.Position = UDim2.fromScale(0, y)
    l.BackgroundTransparency = 1
    l.TextColor3 = Color3.new(1,1,1)
    l.TextScaled = true
    l.Font = Enum.Font.GothamBold
    l.TextXAlignment = Enum.TextXAlignment.Left
    return l
end

local title = label(0)
local modeLabel = label(0.1)
local eggLabel = label(0.2)
local petLabel = label(0.3)
local eggProgress = label(0.4)
local globalProgress = label(0.5)
local status = label(0.6)

title.Text = "üìò Index Auto Completer"

--// HELPERS
local function discoveredKey(pet)
    return INDEX_MODE == "Shiny" and ("Shiny "..pet) or pet
end

local function hasPet(data, pet)
    return data.Discovered[discoveredKey(pet)] ~= nil
end

--// TELEPORT TO EGG (YOUR METHOD)
local function teleportToEgg(eggName)
    local egg = workspace.Rendered.Generic:FindFirstChild(eggName)
    if not egg then return false end
    if not player.Character then return false end

    local hrp = player.Character:FindFirstChild("HumanoidRootPart")
    local eggPart = egg.PrimaryPart or egg:FindFirstChildWhichIsA("BasePart")

    if hrp and eggPart then
        hrp.CFrame = eggPart.CFrame
        return true
    end
    return false
end

--// FIND MISSING PET
local function findMissingPet(data, eggName)
    local egg = Eggs[eggName]
    if not egg then return end

    for _, pool in ipairs(egg.Pool) do
        if pool.Item.Type == "Pet" then
            local pet = pool.Item.Name
            local info = Pets[pet]

            if info and info.Rarity ~= "Secret" then
                if not hasPet(data, pet) then
                    return pet
                end
            end
        end
    end
end

--// EGG COMPLETED?
local function eggCompleted(data, eggName)
    local res = IndexUtil:GetEggCompleted(data, nil, INDEX_MODE, eggName)
    return res.Found >= res.Total and res.Total > 0
end

--// ALL EGGS DONE?
local function allEggsCompleted(data)
    for _, egg in ipairs(EggOrder) do
        if not eggCompleted(data, egg) then
            return false
        end
    end
    return true
end

--// MAIN LOOP
task.spawn(function()
    while true do
        local data = LocalData:Get()
        if not data then task.wait(1) continue end

        -- Switch to shiny only after ALL normals done
        if INDEX_MODE == "Normal" and allEggsCompleted(data) then
            INDEX_MODE = "Shiny"
            EggPointer = 1
        end

        local eggName = EggOrder[EggPointer]
        if not eggName then
            status.Text = "‚úÖ FULL INDEX COMPLETE"
            task.wait(5)
            continue
        end

        -- Skip completed eggs
        if eggCompleted(data, eggName) then
            EggPointer += 1
            task.wait(0.1)
            continue
        end

        local missingPet = findMissingPet(data, eggName)
        local prog = IndexUtil:GetEggCompleted(data, nil, INDEX_MODE, eggName)

        -- UI
        modeLabel.Text = "üìÇ Mode: "..INDEX_MODE
        eggLabel.Text = "ü•ö Egg: "..eggName
        petLabel.Text = "üéØ Target: "..(missingPet or "Unknown")
        eggProgress.Text = ("üìä Egg Progress: %d / %d"):format(prog.Found, prog.Total)
        globalProgress.Text = ("üóÇ Egg %d / %d"):format(EggPointer, #EggOrder)
        status.Text = "üìç Teleporting & hatching..."

        -- TELEPORT FIRST
        teleportToEgg(eggName)
        task.wait(0.25)

        -- HATCH
        Remote:FireServer("HatchEgg", eggName, getgenv().HATCH_AMOUNT)

        task.wait(getgenv().UPDATE_RATE)
    end
end)
