--// SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

--// MODULES
local Eggs = require(ReplicatedStorage.Shared.Data.Eggs)
local Pets = require(ReplicatedStorage.Shared.Data.Pets)
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local IndexUtil = require(ReplicatedStorage.Shared.Util.IndexUtil)

local Remote = ReplicatedStorage.Shared.Framework.Network.Remote.RemoteEvent

--// ALLOWED WORLDS
local ALLOWED_WORLDS = {
    ["Overworld"] = true,
    ["Minigame Paradise"] = true
}

--// UI
local gui = Instance.new("ScreenGui", player.PlayerGui)
gui.Name = "IndexAutoCompleter"

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromScale(0.36, 0.32)
frame.Position = UDim2.fromScale(0.32, 0.04)
frame.BackgroundColor3 = Color3.fromRGB(18,18,18)
frame.BorderSizePixel = 0

local function newLabel(y)
    local l = Instance.new("TextLabel", frame)
    l.Size = UDim2.fromScale(1, 0.11)
    l.Position = UDim2.fromScale(0, y)
    l.BackgroundTransparency = 1
    l.TextColor3 = Color3.new(1,1,1)
    l.TextScaled = true
    l.Font = Enum.Font.GothamBold
    l.TextXAlignment = Enum.TextXAlignment.Left
    l.Text = ""
    return l
end

local title = newLabel(0)
local progress = newLabel(0.12)
local worldLabel = newLabel(0.24)
local eggLabel = newLabel(0.36)
local petLabel = newLabel(0.48)
local statusLabel = newLabel(0.60)

title.Text = "üìò Auto Index Completer"

--// HELPERS
local function discoveredKey(pet)
    if getgenv().INDEX_MODE == "Shiny" then
        return "Shiny "..pet
    end
    return pet
end

local function hasPet(data, pet)
    return data.Discovered[discoveredKey(pet)] ~= nil
end

--// FIND NEXT TARGET
local function findNextTarget()
    local data = LocalData:Get()
    if not data then return end

    for eggName, egg in pairs(Eggs) do
        if egg.World and ALLOWED_WORLDS[egg.World] then
            for _, pool in ipairs(egg.Pool) do
                if pool.Item.Type == "Pet" then
                    local petName = pool.Item.Name
                    local info = Pets[petName]

                    if info and info.Rarity ~= "Secret" then
                        if not hasPet(data, petName) then
                            return {
                                World = egg.World,
                                Egg = eggName,
                                Pet = petName
                            }
                        end
                    end
                end
            end
        end
    end
end

--// TELEPORT TO EGG
local function teleportToEgg(eggName)
    local eggModel = workspace.Rendered.Generic:FindFirstChild(eggName)
    if not eggModel then return end

    local char = player.Character
    if not char then return end

    local hrp = char:FindFirstChild("HumanoidRootPart")
    local part = eggModel.PrimaryPart or eggModel:FindFirstChildWhichIsA("BasePart")

    if hrp and part then
        hrp.CFrame = part.CFrame * CFrame.new(0, 0, -4)
    end
end

--// HATCH
local function hatchEgg(eggName)
    Remote:FireServer("HatchEgg", eggName, getgenv().HATCH_AMOUNT)
end

--// MAIN LOOP
task.spawn(function()
    while true do
        local data = LocalData:Get()
        if not data then task.wait(1) continue end

        local target = findNextTarget()

        if not target then
            statusLabel.Text = "‚úÖ Index completed!"
            task.wait(5)
            continue
        end

        local completed = IndexUtil:GetEggCompleted(
            data,
            nil,
            getgenv().INDEX_MODE,
            target.Egg
        )

        progress.Text = ("üìä Progress: %d / %d"):format(
            completed.Found,
            completed.Total
        )

        worldLabel.Text = "üåç World: "..target.World
        eggLabel.Text = "ü•ö Egg: "..target.Egg
        petLabel.Text = "üéØ Target: "..target.Pet
        statusLabel.Text = "üöÄ Teleporting & hatching..."

        teleportToEgg(target.Egg)
        task.wait(0.4)
        hatchEgg(target.Egg)

        task.wait(getgenv().UPDATE_RATE)
    end
end)
