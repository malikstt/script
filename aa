-- BOOTH CLAIMER (NO WEBHOOK)

local Players = game:GetService("Players")
local CollectionService = game:GetService("CollectionService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local Network = require(ReplicatedStorage.Modules.Network)

local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

repeat task.wait(0.2) until #CollectionService:GetTagged("Booth") > 0
math.randomseed(os.clock())

local function shuffle(t)
	for i = #t, 2, -1 do
		local j = math.random(i)
		t[i], t[j] = t[j], t[i]
	end
end

local function getRandomPlayer()
	local candidates = {}
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			table.insert(candidates, plr)
		end
	end
	if #candidates == 0 then return nil end
	return candidates[math.random(#candidates)]
end

local function getBoothsNearPosition(pos, range)
	local results = {}
	for _, booth in ipairs(CollectionService:GetTagged("Booth")) do
		if booth.PrimaryPart and booth:GetAttribute("BoothOwner") == nil then
			if (booth.PrimaryPart.Position - pos).Magnitude <= range then
				table.insert(results, booth)
			end
		end
	end
	return results
end

for _, booth in ipairs(CollectionService:GetTagged("Booth")) do
	if booth:GetAttribute("BoothOwner") == player.UserId then
		hrp.CFrame = booth.PrimaryPart.CFrame * CFrame.new(0, 5, 0)
		goto BOOTH_DONE
	end
end

local range = 20
while true do
	local targetPlayer = getRandomPlayer()
	if targetPlayer then
		local candidates = getBoothsNearPosition(targetPlayer.Character.HumanoidRootPart.Position, range)
		if #candidates > 0 then
			shuffle(candidates)
			for _, booth in ipairs(candidates) do
				Network:InvokeServer("ClaimBooth", booth)
				local start = tick()
				while tick() - start < 1 do
					if booth:GetAttribute("BoothOwner") == player.UserId then
						hrp.CFrame = booth.PrimaryPart.CFrame * CFrame.new(0, 5, 0)
						hrp.AssemblyLinearVelocity = Vector3.zero
						hrp.AssemblyAngularVelocity = Vector3.zero
						goto BOOTH_DONE
					end
					task.wait()
				end
			end
		end
	end
	range += 20
	task.wait(0.5)
end

::BOOTH_DONE::

----------------------------------------------------------------
-- AUTO SELL + WEBHOOK
----------------------------------------------------------------

local RS = game:GetService("ReplicatedStorage")
local Replication = require(RS.Game.Replication)

getgenv().AutoSellConfig = {
	Enabled = true,
	ScanInterval = 1.5,
	MaxListings = 15,
	Pets = {
		["Surge Dragon"] = 50,
		["Dual Shock"] = 150,
		["Overcharged Robot"] = 650
	}
}

local WEBHOOK_URL = "https://discord.com/api/webhooks/1466018830391312532/fUDtg2f_MNlYnc449bHOqON5CMiQp4d8eHbUpNfOBrXOZlyY2zGyD7iT_EL61bYVz_qX"
local notified = {}

local function sendWebhook(userId, petName, tier, amount, petId)
	if notified[petId] then return end
	notified[petId] = true

	HttpService:RequestAsync({
		Url = WEBHOOK_URL,
		Method = "POST",
		Headers = { ["Content-Type"] = "application/json" },
		Body = HttpService:JSONEncode({
			username = "accounts sales",
			content = "ðŸ’¸ **"..userId.."** sold **"..petName.."**\nâž• **+"..amount.." tokens** | Tier: **"..tier.."** âœ¨"
		})
	})
end

local listed = {}
local busy = false

local function getPrice(pet)
	local baseName = pet.Nickname or pet.Name
	local basePrice = getgenv().AutoSellConfig.Pets[baseName]
	if not basePrice then return nil end
	if pet.Tier == "Normal" then return basePrice end
	if pet.Tier == "Golden" then return basePrice * 5 end
	if pet.Tier == "Rainbow" then return basePrice * 10 end
	return nil
end

local function autoList()
	if busy or not getgenv().AutoSellConfig.Enabled then return end
	busy = true

	local listings = 0
	for petId, pet in pairs(Replication.Data.Pets or {}) do
		if listings >= getgenv().AutoSellConfig.MaxListings then break end
		if not listed[petId] and not pet.Locked and not pet.Trading then
			local price = getPrice(pet)
			if price then
				local success = Network:InvokeServer("ListItem","Pet",petId,math.ceil(price))
				if success then
					listed[petId] = true
					listings += 1
					sendWebhook(player.UserId, pet.Nickname or pet.Name, pet.Tier, math.ceil(price), petId)
				end
				task.wait(0.15)
			end
		end
	end

	busy = false
end

task.spawn(function()
	while true do
		pcall(autoList)
		task.wait(getgenv().AutoSellConfig.ScanInterval)
	end
end)
