----------------------------------------------------------------
-- AUTO SELL + SOLD WEBHOOK (+ AMOUNT) + BOOTH CLAIMER
----------------------------------------------------------------

local httpRequest =
	(syn and syn.request) or
	(syn and syn.req) or
	(http and http.request) or
	(http_request) or
	(httprequest) or
	(fluxus and fluxus.request) or
	(krnl and krnl.request) or
	(request)

if not httpRequest then return end

local RS = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local CS = game:GetService("CollectionService")
local HttpService = game:GetService("HttpService")

local Replication = require(RS.Game.Replication)
local Network = require(RS.Modules.Network)

local LP = Players.LocalPlayer

local WEBHOOK_URL = "https://discord.com/api/webhooks/1466018830391312532/fUDtg2f_MNlYnc449bHOqON5CMiQp4d8eHbUpNfOBrXOZlyY2zGyD7iT_EL61bYVz_qX"

getgenv().AutoSellConfig = getgenv().AutoSellConfig or {
	Enabled = true,
	ScanInterval = 1.5,
	MaxListings = 15,
	Pets = {
		["Surge Dragon"] = 50,
		["Dual Shock"] = 150,
		["Overcharged Robot"] = 650
	}
}

local listed, busy = {}, false
local lastPets, sent = {}, {}

local function getAmount(p)
	local n = p.Nickname or p.Name
	local b = getgenv().AutoSellConfig.Pets[n]
	if not b then return end
	local t = p.Tier
	if t == "Golden" then return b * 5 end
	if t == "Rainbow" then return b * 10 end
	return b
end

local function sendSold(petId, pet)
	if sent[petId] then return end
	sent[petId] = true
	local amt = getAmount(pet) or 0

	httpRequest({
		Url = WEBHOOK_URL,
		Method = "POST",
		Headers = {["Content-Type"]="application/json"},
		Body = HttpService:JSONEncode({
			username = "Auto Sell",
			embeds = {{
				title = "ðŸ’¸ Pet Sold",
				color = 0xff5555,
				fields = {
					{name="Player", value=LP.Name, inline=true},
					{name="Pet", value=pet.Nickname or pet.Name or "Unknown", inline=true},
					{name="Tier", value=pet.Tier or "Normal", inline=true},
					{name="Amount", value="+ "..tostring(amt).." tokens", inline=true},
					{name="Pet ID", value=tostring(petId), inline=true}
				},
				timestamp = DateTime.now():ToIsoDate()
			}}
		})
	})
end

local function snapshot()
	local t = {}
	for id, pet in pairs(Replication.Data.Pets or {}) do
		t[id] = pet
	end
	return t
end

local function autoList()
	if busy or not getgenv().AutoSellConfig.Enabled then return end
	busy = true

	local c = 0
	for id, p in pairs(Replication.Data.Pets or {}) do
		if c >= getgenv().AutoSellConfig.MaxListings then break end
		if not listed[id] and not p.Locked and not p.Trading then
			local amt = getAmount(p)
			if amt then
				if Network:InvokeServer("ListItem","Pet",id,math.ceil(amt)) then
					listed[id] = true
					c += 1
				end
				task.wait(0.15)
			end
		end
	end

	busy = false
end

task.spawn(function()
	while true do
		pcall(autoList)
		task.wait(getgenv().AutoSellConfig.ScanInterval)
	end
end)

task.spawn(function()
	lastPets = snapshot()
	while true do
		task.wait(1)
		local now = snapshot()
		for id, pet in pairs(lastPets) do
			if not now[id] then
				sendSold(id, pet)
			end
		end
		lastPets = now
	end
end)

----------------------------------------------------------------
-- BOOTH CLAIMER
----------------------------------------------------------------

local function ownBooth()
	for _,b in ipairs(CS:GetTagged("Booth")) do
		if b:GetAttribute("BoothOwner") == LP.UserId then
			return b
		end
	end
end

local function hrp()
	local ch = LP.Character or LP.CharacterAdded:Wait()
	return ch:WaitForChild("HumanoidRootPart")
end

local function randPlr()
	local t = {}
	for _,p in ipairs(Players:GetPlayers()) do
		if p ~= LP and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			t[#t+1] = p
		end
	end
	if #t == 0 then return end
	return t[math.random(#t)]
end

task.spawn(function()
	repeat task.wait(0.2) until #CS:GetTagged("Booth") > 0
	math.randomseed(os.clock())
	local r = 20

	while true do
		local ob = ownBooth()
		if ob and ob.PrimaryPart then
			local h = hrp()
			h.CFrame = ob.PrimaryPart.CFrame * CFrame.new(0,5,0)
			return
		end

		local tp = randPlr()
		if tp and tp.Character and tp.Character:FindFirstChild("HumanoidRootPart") then
			local pos = tp.Character.HumanoidRootPart.Position
			for _,b in ipairs(CS:GetTagged("Booth")) do
				if b.PrimaryPart and b:GetAttribute("BoothOwner") == nil
				and (b.PrimaryPart.Position - pos).Magnitude <= r then
					Network:InvokeServer("ClaimBooth", b)
					local t0 = tick()
					while tick() - t0 < 1 do
						if b:GetAttribute("BoothOwner") == LP.UserId then
							local h = hrp()
							h.CFrame = b.PrimaryPart.CFrame * CFrame.new(0,5,0)
							h.AssemblyLinearVelocity = Vector3.zero
							h.AssemblyAngularVelocity = Vector3.zero
							return
						end
						task.wait()
					end
				end
			end
		end

		r += 20
		task.wait(0.5)
	end
end)
