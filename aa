local RS = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Replication = require(RS.Game.Replication)
local Network = require(RS.Modules.Network)

local LocalPlayer = Players.LocalPlayer

getgenv().AutoSellConfig = {
    Enabled = true,
    ScanInterval = 2,
    MaxListings = 12,
    Pets = {
        ["Surge Dragon"] = 75,
        ["Dual Shock"] = 225
    }
}

local running = true
local debounce = {}
local knownListed = {}

local function getMyListings()
    local ok, listings = pcall(function()
        return Network:InvokeServer("GetBoothListings", LocalPlayer.UserId)
    end)
    return ok and listings or {}
end

local function countTable(t)
    local n = 0
    for _ in pairs(t) do n += 1 end
    return n
end

local function autoSell()
    if not getgenv().AutoSellConfig.Enabled then return end

    local listings = getMyListings()
    local listedCount = countTable(listings)

    local currentListed = {}
    for _, listing in pairs(listings) do
        if listing.itemType == "Pet" then
            currentListed[listing.itemName] = true
        end
    end

    for petId in pairs(knownListed) do
        if not currentListed[petId] then
            if not (Replication.Data.Pets and Replication.Data.Pets[petId]) then
                print("[AUTO SELL] SOLD:", petId)
                knownListed[petId] = nil
            end
        end
    end

    local pets = Replication.Data and Replication.Data.Pets
    if not pets then return end

    for petId, petData in pairs(pets) do
        if listedCount >= getgenv().AutoSellConfig.MaxListings then break end
        if debounce[petId] then continue end

        local price = getgenv().AutoSellConfig.Pets[petData.Name]
        if not price then continue end
        if currentListed[petId] then
            knownListed[petId] = true
            continue
        end

        debounce[petId] = true
        Network:InvokeServer("PromptListBooth", petId)
        print("[AUTO SELL] LISTED:", petData.Name, "PRICE:", price)

        knownListed[petId] = true
        listedCount += 1

        task.delay(1, function()
            debounce[petId] = nil
        end)

        task.wait(0.25)
    end
end

task.spawn(function()
    task.wait(3)
    while running do
        pcall(autoSell)
        task.wait(getgenv().AutoSellConfig.ScanInterval)
    end
end)

getgenv().TradingAuto = {
    Stop = function()
        running = false
    end
}
