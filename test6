--// =========================
--// CONFIG (EDIT THIS)
--// =========================
local UPGRADE_PLAN = {
    { Key = "Currency",     TargetLevel = 1 },
    { Key = "Luck",         TargetLevel = 1 },
    { Key = "SecretLuck",   TargetLevel = 1 },
    { Key = "InfinityLuck", TargetLevel = 1 },
}

local STATUS_ROTATION_TIME = 2
local PICKUP_DELAY = 0.1

--// =========================
--// SERVICES / MODULES
--// =========================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local CircusUpgrades = require(ReplicatedStorage.Shared.Data.CircusUpgrades)

local RemoteEvent = ReplicatedStorage.Shared.Framework.Network.Remote.RemoteEvent
local PickupRemote = ReplicatedStorage.Remotes.Pickups.CollectPickup

--// =========================
--// TELEPORT TO CIRCUS
--// =========================
RemoteEvent:FireServer("Teleport", "Workspace.Circus Event.Spawn")

--// =========================
--// UI BUILD
--// =========================
local gui = Instance.new("ScreenGui")
gui.Name = "CircusAutomationUI"
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.Parent = player.PlayerGui

local bg = Instance.new("Frame")
bg.Size = UDim2.fromScale(1,1)
bg.BackgroundColor3 = Color3.fromRGB(10,10,15)
bg.BackgroundTransparency = 0.35
bg.Parent = gui

local title = Instance.new("TextLabel")
title.Size = UDim2.fromScale(1,0.08)
title.BackgroundTransparency = 1
title.Text = "ðŸŽª Circus Automation"
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255,180,255)
title.Parent = bg

local status = Instance.new("TextLabel")
status.Position = UDim2.fromScale(0,0.08)
status.Size = UDim2.fromScale(1,0.05)
status.BackgroundTransparency = 1
status.Text = "Initializingâ€¦"
status.TextScaled = true
status.Font = Enum.Font.Gotham
status.TextColor3 = Color3.fromRGB(220,220,220)
status.Parent = bg

local main = Instance.new("Frame")
main.Position = UDim2.fromScale(0.25,0.18)
main.Size = UDim2.fromScale(0.5,0.45)
main.BackgroundColor3 = Color3.fromRGB(20,20,30)
main.BackgroundTransparency = 0.25
main.Parent = bg
Instance.new("UICorner", main).CornerRadius = UDim.new(0,18)

local upgradeLabel = Instance.new("TextLabel")
upgradeLabel.Size = UDim2.fromScale(1,0.2)
upgradeLabel.BackgroundTransparency = 1
upgradeLabel.TextScaled = true
upgradeLabel.Font = Enum.Font.GothamBold
upgradeLabel.TextColor3 = Color3.fromRGB(255,255,255)
upgradeLabel.Parent = main

local levelLabel = Instance.new("TextLabel")
levelLabel.Position = UDim2.fromScale(0,0.2)
levelLabel.Size = UDim2.fromScale(1,0.15)
levelLabel.BackgroundTransparency = 1
levelLabel.TextScaled = true
levelLabel.Font = Enum.Font.Gotham
levelLabel.TextColor3 = Color3.fromRGB(200,200,200)
levelLabel.Parent = main

local progressBg = Instance.new("Frame")
progressBg.Position = UDim2.fromScale(0.1,0.42)
progressBg.Size = UDim2.fromScale(0.8,0.08)
progressBg.BackgroundColor3 = Color3.fromRGB(50,50,60)
progressBg.BackgroundTransparency = 0.2
progressBg.Parent = main
Instance.new("UICorner", progressBg).CornerRadius = UDim.new(1,0)

local progressBar = Instance.new("Frame")
progressBar.Size = UDim2.fromScale(0,1)
progressBar.BackgroundColor3 = Color3.fromRGB(255,120,255)
progressBar.Parent = progressBg
Instance.new("UICorner", progressBar).CornerRadius = UDim.new(1,0)

local currencyLabel = Instance.new("TextLabel")
currencyLabel.Position = UDim2.fromScale(0,0.55)
currencyLabel.Size = UDim2.fromScale(1,0.15)
currencyLabel.BackgroundTransparency = 1
currencyLabel.TextScaled = true
currencyLabel.Font = Enum.Font.Gotham
currencyLabel.TextColor3 = Color3.fromRGB(180,255,180)
currencyLabel.Parent = main

--// =========================
--// STATUS TEXT ROTATOR
--// =========================
local statusMessages = {
    "ðŸš€ Teleporting to Circus World",
    "ðŸ“¦ Farming pickups",
    "ðŸ§® Calculating upgrade cost",
    "ðŸ’° Grinding Circus Tickets",
    "âš™ï¸ Preparing upgrade purchase",
}

task.spawn(function()
    local i = 1
    while true do
        status.Text = statusMessages[i]
        i = i % #statusMessages + 1
        task.wait(STATUS_ROTATION_TIME)
    end
end)

--// =========================
--// HELPERS
--// =========================
local function getTickets()
    local d = LocalData:Get()
    return (d and d.CircusTickets) or 0
end

local function getLevel(key)
    local d = LocalData:Get()
    return (d and d.CircusUpgrades and d.CircusUpgrades[key]) or 0
end

--// =========================
--// PICKUP FARM
--// =========================
task.spawn(function()
    local claimed = {}
    while true do
        local rendered = workspace:FindFirstChild("Rendered")
        if rendered then
            for _, folder in ipairs(rendered:GetChildren()) do
                for _, obj in ipairs(folder:GetChildren()) do
                    local id = obj.Name
                    if not claimed[id] then
                        claimed[id] = true
                        pcall(function()
                            PickupRemote:FireServer(id)
                            obj:Destroy()
                        end)
                    end
                end
            end
        end
        task.wait(PICKUP_DELAY)
    end
end)

--// =========================
--// MAIN LOGIC
--// =========================
task.spawn(function()
    for _, plan in ipairs(UPGRADE_PLAN) do
        local key = plan.Key
        local target = plan.TargetLevel
        local cfg = CircusUpgrades[key]

        while true do
            local level = getLevel(key)
            if level >= target then break end

            local nextData = cfg.Upgrades[level + 1]
            if not nextData then break end

            upgradeLabel.Text = "ðŸŽ¯ "..cfg.Name
            levelLabel.Text = "Level "..level.." â†’ "..(level+1)
            currencyLabel.Text = "ðŸ’° "..getTickets().." / "..nextData.Cost

            while getTickets() < nextData.Cost do
                local ratio = math.clamp(getTickets() / nextData.Cost, 0, 1)
                progressBar:TweenSize(UDim2.fromScale(ratio,1), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.2, true)
                currencyLabel.Text = "ðŸ’° "..getTickets().." / "..nextData.Cost
                task.wait(0.25)
            end

            status.Text = "ðŸ›’ Buying "..cfg.Name
            RemoteEvent:FireServer("BuyCircusUpgrade", key)
            task.wait(1)
        end
    end

    status.Text = "âœ… All upgrades complete"
end)
