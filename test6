require(game:GetService("ReplicatedStorage").Client.Effects.HatchEgg).Play = function() return end

local MIN_REQUIRED_MULTI = 10
local MAX_TEAM_SIZE = 13
local PET_CHECK_INTERVAL = 120
local HATCH_CFRAME = CFrame.new(-2433.08, 10.14, 264.05)

local UPGRADE_PLAN = {
    { Key = "Currency",     TargetLevel = 4 },
    { Key = "Luck",         TargetLevel = 4 },
    { Key = "SecretLuck",   TargetLevel = 4 },
    { Key = "InfinityLuck", TargetLevel = 4 },
}

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local RemoteEvent = ReplicatedStorage.Shared.Framework.Network.Remote.RemoteEvent
local PickupRemote = ReplicatedStorage.Remotes.Pickups.CollectPickup

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local CircusUpgrades = require(ReplicatedStorage.Shared.Data.CircusUpgrades)
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

local PetsReady = false
local IsHatching = false
local IsUpgrading = false
local CircusLoaded = false
local Teleported = false
local LastPetSignature = ""

RemoteEvent:FireServer("Teleport", "Workspace.Circus Event.Spawn")
task.delay(6, function()
    CircusLoaded = true
end)

local gui = Instance.new("ScreenGui", player.PlayerGui)
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false

local bg = Instance.new("Frame", gui)
bg.Size = UDim2.fromScale(1,1)
bg.BackgroundColor3 = Color3.fromRGB(10,10,15)
bg.BackgroundTransparency = 0.35

local title = Instance.new("TextLabel", bg)
title.Size = UDim2.fromScale(1,0.08)
title.BackgroundTransparency = 1
title.Text = "üé™ Circus Automation"
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255,180,255)

local status = Instance.new("TextLabel", bg)
status.Position = UDim2.fromScale(0,0.08)
status.Size = UDim2.fromScale(1,0.05)
status.BackgroundTransparency = 1
status.TextScaled = true
status.Font = Enum.Font.Gotham
status.TextColor3 = Color3.fromRGB(220,220,220)

local main = Instance.new("Frame", bg)
main.Position = UDim2.fromScale(0.25,0.18)
main.Size = UDim2.fromScale(0.5,0.55)
main.BackgroundColor3 = Color3.fromRGB(20,20,30)
main.BackgroundTransparency = 0.25
Instance.new("UICorner", main).CornerRadius = UDim.new(0,18)

local petTitle = Instance.new("TextLabel", main)
petTitle.Position = UDim2.fromScale(0,0.14)
petTitle.Size = UDim2.fromScale(1,0.08)
petTitle.BackgroundTransparency = 1
petTitle.TextScaled = true
petTitle.Font = Enum.Font.GothamBold
petTitle.TextColor3 = Color3.fromRGB(255,220,180)
petTitle.Text = "Equipped Pets"

local petList = Instance.new("TextLabel", main)
petList.Position = UDim2.fromScale(0.05,0.23)
petList.Size = UDim2.fromScale(0.9,0.6)
petList.BackgroundTransparency = 1
petList.TextWrapped = true
petList.TextYAlignment = Enum.TextYAlignment.Top
petList.TextXAlignment = Enum.TextXAlignment.Left
petList.TextScaled = true
petList.Font = Enum.Font.Gotham
petList.TextColor3 = Color3.fromRGB(200,200,200)
petList.Text = "Grinding for pets‚Ä¶"

local timerLabel = Instance.new("TextLabel", main)
timerLabel.Position = UDim2.fromScale(0,0.84)
timerLabel.Size = UDim2.fromScale(1,0.1)
timerLabel.BackgroundTransparency = 1
timerLabel.TextScaled = true
timerLabel.Font = Enum.Font.GothamBold
timerLabel.TextColor3 = Color3.fromRGB(180,255,180)
timerLabel.Text = "02:00"

local MULTI_KEY = "CircusTickets"

local function pressE()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    task.wait(0.04)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
end

local function getPetMulti(name)
    local info = PetsModule[name]
    return info and info.Stats and info.Stats[MULTI_KEY] or 0
end

local function getAllCircusPetsSorted()
    local data = LocalData:Get()
    if not data or not data.Pets then return {} end
    local pets = {}
    for _, pet in pairs(data.Pets) do
        local multi = getPetMulti(pet.Name)
        if multi > 0 then
            pets[#pets+1] = { Id = pet.Id, Name = pet.Name, Multi = multi }
        end
    end
    table.sort(pets, function(a,b) return a.Multi > b.Multi end)
    return pets
end

local function equipBestFromInventory()
    local sorted = getAllCircusPetsSorted()
    if #sorted == 0 then return 0, 0 end

    local equipCount = math.min(MAX_TEAM_SIZE, #sorted)
    local desired = {}
    for i = 1, equipCount do
        desired[sorted[i].Id] = sorted[i]
    end

    local data = LocalData:Get()
    local equipped = {}
    if data and data.Teams and data.TeamEquipped then
        local team = data.Teams[data.TeamEquipped]
        if team and team.Pets then
            for _, id in ipairs(team.Pets) do
                equipped[id] = true
            end
        end
    end

    for id in pairs(equipped) do
        if not desired[id] then
            RemoteEvent:FireServer("UnequipPet", id)
            task.wait(0.08)
        end
    end

    local count = 0
    for id in pairs(desired) do
        if not equipped[id] then
            RemoteEvent:FireServer("EquipPet", id)
            task.wait(0.08)
        end
        count += 1
    end

    local worst = sorted[equipCount] and sorted[equipCount].Multi or 0
    return count, worst
end

local function updatePetUI()
    local data = LocalData:Get()
    local pets = {}
    if data and data.Teams and data.TeamEquipped then
        local team = data.Teams[data.TeamEquipped]
        if team and team.Pets then
            for _, id in ipairs(team.Pets) do
                for _, p in pairs(data.Pets) do
                    if p.Id == id then
                        pets[#pets+1] = { Id = p.Id, Name = p.Name, Multi = getPetMulti(p.Name) }
                        break
                    end
                end
            end
        end
    end
    table.sort(pets, function(a,b) return a.Multi > b.Multi end)

    local sig, text = "", ""
    for _, p in ipairs(pets) do
        sig ..= p.Id
        text ..= p.Name.." x"..p.Multi.."\n"
    end
    if sig ~= LastPetSignature then
        LastPetSignature = sig
        petList.Text = text ~= "" and text or "No pets equipped"
    end
end

task.spawn(function()
    local remotes = ReplicatedStorage.Remotes.Pickups.CollectPickup
    local claimed = {}
    while true do
        local rendered = workspace:FindFirstChild("Rendered")
        if rendered then
            local children = rendered:GetChildren()
            local target = children[15]
            if target then
                for _, obj in ipairs(target:GetChildren()) do
                    if obj:IsA("Model") then
                        local id = obj.Name
                        if not claimed[id] then
                            claimed[id] = true
                            pcall(function()
                                remotes:FireServer(id)
                            end)
                            obj.Parent = ReplicatedStorage
                        end
                    end
                end
            end
        end
        task.wait(0.1)
    end
end)

task.spawn(function()
    while true do
        if CircusLoaded and IsHatching and not IsUpgrading then
            if not Teleported then
                pcall(function()
                    player.Character:PivotTo(HATCH_CFRAME)
                end)
                Teleported = true
            end
            pressE()
        end
        task.wait(0.1)
    end
end)

task.spawn(function()
    while not CircusLoaded do task.wait(0.5) end

    while true do
        IsHatching = true
        status.Text = "üê£ Grinding for pets"
        local start = os.clock()

        while os.clock() - start < PET_CHECK_INTERVAL do
            local left = PET_CHECK_INTERVAL - (os.clock() - start)
            local m = math.floor(left / 60)
            local s = math.floor(left % 60)
            timerLabel.Text = string.format("%02d:%02d", m, s)
            task.wait(0.2)
        end

        IsHatching = false
        timerLabel.Text = "00:00"
        task.wait(0.4)

        local count, worst = equipBestFromInventory()
        updatePetUI()

        if count == MAX_TEAM_SIZE and worst >= MIN_REQUIRED_MULTI then
            PetsReady = true
            status.Text = "‚úÖ Pets ready"
            break
        end
    end
end)

task.spawn(function()
    while not PetsReady do task.wait(1) end

    IsUpgrading = true
    IsHatching = false

    for _, plan in ipairs(UPGRADE_PLAN) do
        local key = plan.Key
        local target = plan.TargetLevel
        local cfg = CircusUpgrades[key]

        while true do
            local data = LocalData:Get()
            local level = data and data.CircusUpgrades and data.CircusUpgrades[key] or 0
            if level >= target then break end

            RemoteEvent:FireServer("BuyCircusUpgrade", key)
            task.wait(1)
        end
    end

    status.Text = "‚úÖ All upgrades complete"
end)
