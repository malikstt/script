-- =========================
-- CONFIG
-- =========================
local TARGET_AMOUNT = 25_000_000_000 -- 25B
local CURRENCY_KEY = "CircusTickets"
local MAX_TEAM_SIZE = 13
local BAR_TWEEN_TIME = 0.25

-- =========================
-- SERVICES / MODULES
-- =========================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local RemoteEvent = ReplicatedStorage.Shared.Framework.Network.Remote.RemoteEvent
local PickupRemote = ReplicatedStorage.Remotes.Pickups.CollectPickup

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

local startTime = os.clock()

-- =========================
-- UTILS
-- =========================
local function format(n)
    if n >= 1e12 then
        return string.format("%.2fT", n/1e12)
    elseif n >= 1e9 then
        return string.format("%.2fB", n/1e9)
    elseif n >= 1e6 then
        return string.format("%.2fM", n/1e6)
    elseif n >= 1e3 then
        return string.format("%.2fK", n/1e3)
    else
        return tostring(math.floor(n))
    end
end

local function formatTime(sec)
    sec = math.max(0, sec)
    local h = math.floor(sec / 3600)
    local m = math.floor(sec % 3600 / 60)
    local s = math.floor(sec % 60)
    if h > 0 then
        return string.format("%02d:%02d:%02d", h, m, s)
    end
    return string.format("%02d:%02d", m, s)
end

-- =========================
-- PET EQUIP
-- =========================
local function getPetMulti(name)
    local info = PetsModule[name]
    return info and info.Stats and info.Stats[CURRENCY_KEY] or 0
end

local function equipBestPets()
    local data = LocalData:Get()
    if not data or not data.Pets then return end

    local pets = {}
    for _, pet in pairs(data.Pets) do
        local multi = getPetMulti(pet.Name)
        if multi > 0 then
            pets[#pets+1] = {Id = pet.Id, Multi = multi}
        end
    end

    table.sort(pets, function(a,b) return a.Multi > b.Multi end)

    for i = 1, math.min(MAX_TEAM_SIZE, #pets) do
        RemoteEvent:FireServer("EquipPet", pets[i].Id)
        task.wait(0.08)
    end
end

-- =========================
-- UI
-- =========================
local gui = Instance.new("ScreenGui", player.PlayerGui)
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromScale(0.42, 0.22)
frame.Position = UDim2.fromScale(0.29, 0.39)
frame.BackgroundColor3 = Color3.fromRGB(20,20,30)
frame.BackgroundTransparency = 0.1
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,18)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.fromScale(1,0.22)
title.BackgroundTransparency = 1
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255,220,180)
title.Text = "ðŸ’° Circus Grinder"

local info = Instance.new("TextLabel", frame)
info.Position = UDim2.fromScale(0,0.22)
info.Size = UDim2.fromScale(1,0.38)
info.BackgroundTransparency = 1
info.TextWrapped = true
info.TextScaled = true
info.Font = Enum.Font.Gotham
info.TextColor3 = Color3.fromRGB(230,230,230)
info.Text = "Starting..."

local barBG = Instance.new("Frame", frame)
barBG.Position = UDim2.fromScale(0.05,0.68)
barBG.Size = UDim2.fromScale(0.9,0.14)
barBG.BackgroundColor3 = Color3.fromRGB(40,40,60)
Instance.new("UICorner", barBG).CornerRadius = UDim.new(0,12)

local bar = Instance.new("Frame", barBG)
bar.Size = UDim2.fromScale(0,1)
bar.BackgroundColor3 = Color3.fromRGB(120,255,140)
Instance.new("UICorner", bar).CornerRadius = UDim.new(0,12)

-- =========================
-- FARM PICKUPS
-- =========================
task.spawn(function()
    local claimed = {}
    while true do
        local rendered = workspace:FindFirstChild("Rendered")
        if rendered then
            for _, folder in ipairs(rendered:GetChildren()) do
                for _, obj in ipairs(folder:GetChildren()) do
                    if obj:IsA("Model") and not claimed[obj.Name] then
                        claimed[obj.Name] = true
                        pcall(function()
                            PickupRemote:FireServer(obj.Name)
                        end)
                    end
                end
            end
        end
        task.wait(0.1)
    end
end)

-- =========================
-- TRACKER + ETA
-- =========================
local lastAmount = 0
local lastTick = os.clock()
local avgRate = 0

task.spawn(function()
    while true do
        local data = LocalData:Get()
        local current = data and data.Currency and data.Currency[CURRENCY_KEY] or 0

        if current >= TARGET_AMOUNT then
            gui:Destroy()
            loadstring(game:HttpGet(
                "https://raw.githubusercontent.com/IdiotHub/Scripts/main/Loader"
            ))()
            break
        end

        local now = os.clock()
        local deltaT = now - lastTick
        if deltaT >= 1 then
            local gain = current - lastAmount
            if gain > 0 then
                local rate = gain / deltaT
                avgRate = avgRate == 0 and rate or (avgRate * 0.85 + rate * 0.15)
            end
            lastAmount = current
            lastTick = now
        end

        local remaining = TARGET_AMOUNT - current
        local eta = avgRate > 0 and remaining / avgRate or 0
        local runtime = now - startTime
        local percent = math.clamp(current / TARGET_AMOUNT, 0, 1)

        info.Text =
            format(current) .. " / " .. format(TARGET_AMOUNT) ..
            "\nRuntime: " .. formatTime(runtime) ..
            "\nETA: " .. formatTime(eta)

        TweenService:Create(
            bar,
            TweenInfo.new(BAR_TWEEN_TIME, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {Size = UDim2.fromScale(percent, 1)}
        ):Play()

        task.wait(0.2)
    end
end)

-- =========================
-- START
-- =========================
equipBestPets()
RemoteEvent:FireServer("Teleport", "Workspace.Circus Event.Spawn")
