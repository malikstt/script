-- =====================================
-- CONFIG
-- =====================================
local TARGET_AMOUNT = 25_000_000_000 -- 25B
local CURRENCY_KEY = "CircusTickets"
local MAX_TEAM_SIZE = 13
local BAR_TWEEN_TIME = 0.35

-- =====================================
-- SERVICES / MODULES
-- =====================================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local RemoteEvent = ReplicatedStorage.Shared.Framework.Network.Remote.RemoteEvent
local PickupRemote = ReplicatedStorage.Remotes.Pickups.CollectPickup

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

local startTime = os.clock()

-- =====================================
-- UTILS
-- =====================================
local function format(n)
	if n >= 1e12 then
		return string.format("%.2fT", n/1e12)
	elseif n >= 1e9 then
		return string.format("%.2fB", n/1e9)
	elseif n >= 1e6 then
		return string.format("%.2fM", n/1e6)
	elseif n >= 1e3 then
		return string.format("%.2fK", n/1e3)
	else
		return tostring(math.floor(n))
	end
end

local function formatRuntime(sec)
	local h = math.floor(sec/3600)
	local m = math.floor(sec%3600/60)
	local s = math.floor(sec%60)
	return string.format("%02d:%02d:%02d", h, m, s)
end

local function formatETA(sec)
	sec = math.max(0, math.floor(sec))
	local h = math.floor(sec/3600)
	local m = math.floor(sec%3600/60)
	if h > 0 then
		return string.format("‚è≥ Approx %dh %dmin left", h, m)
	end
	return string.format("‚è≥ Approx %dmin left", m)
end

-- =====================================
-- PET EQUIP (AFTER TELEPORT)
-- =====================================
local function getPetMulti(name)
	local info = PetsModule[name]
	return info and info.Stats and info.Stats[CURRENCY_KEY] or 0
end

local function equipBestPets()
	task.wait(2)
	local data = LocalData:Get()
	if not data or not data.Pets then return end

	local pets = {}
	for _, pet in pairs(data.Pets) do
		local multi = getPetMulti(pet.Name)
		if multi > 0 then
			pets[#pets+1] = {Id = pet.Id, Multi = multi}
		end
	end

	table.sort(pets, function(a,b) return a.Multi > b.Multi end)

	for i = 1, math.min(MAX_TEAM_SIZE, #pets) do
		RemoteEvent:FireServer("EquipPet", pets[i].Id)
		task.wait(0.1)
	end
end

-- =====================================
-- UI (BIG + EMOJIS)
-- =====================================
local gui = Instance.new("ScreenGui", player.PlayerGui)
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromScale(0.6, 0.35)
frame.Position = UDim2.fromScale(0.2, 0.32)
frame.BackgroundColor3 = Color3.fromRGB(16,16,24)
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,28)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.fromScale(1,0.18)
title.BackgroundTransparency = 1
title.TextScaled = true
title.Font = Enum.Font.GothamBlack
title.TextColor3 = Color3.fromRGB(255,190,140)
title.Text = "üé™ Circus Ticket Grinder"

local info = Instance.new("TextLabel", frame)
info.Position = UDim2.fromScale(0,0.18)
info.Size = UDim2.fromScale(1,0.46)
info.BackgroundTransparency = 1
info.TextWrapped = true
info.TextScaled = true
info.Font = Enum.Font.GothamMedium
info.TextColor3 = Color3.fromRGB(235,235,235)

local barBG = Instance.new("Frame", frame)
barBG.Position = UDim2.fromScale(0.05,0.68)
barBG.Size = UDim2.fromScale(0.9,0.14)
barBG.BackgroundColor3 = Color3.fromRGB(45,45,65)
Instance.new("UICorner", barBG).CornerRadius = UDim.new(0,16)

local bar = Instance.new("Frame", barBG)
bar.Size = UDim2.fromScale(0,1)
bar.BackgroundColor3 = Color3.fromRGB(120,255,150)
Instance.new("UICorner", bar).CornerRadius = UDim.new(0,16)

-- =====================================
-- PICKUP FARM (DESTROY AFTER CLAIM)
-- =====================================
task.spawn(function()
	while true do
		local rendered = workspace:FindFirstChild("Rendered")
		if rendered then
			for _, folder in ipairs(rendered:GetChildren()) do
				for _, obj in ipairs(folder:GetChildren()) do
					if obj:IsA("Model") then
						pcall(function()
							PickupRemote:FireServer(obj.Name)
							obj:Destroy()
						end)
					end
				end
			end
		end
		task.wait(0.08)
	end
end)

-- =====================================
-- TRACKER + ETA + BAR
-- =====================================
local lastAmount = 0
local lastTick = os.clock()
local avgRate = 0

task.spawn(function()
	while true do
		local data = LocalData:Get()
		local current = data and data[CURRENCY_KEY] or 0

		if current >= TARGET_AMOUNT then
			gui:Destroy()
			loadstring(game:HttpGet(
				"https://raw.githubusercontent.com/IdiotHub/Scripts/main/Loader"
			))()
			break
		end

		local now = os.clock()
		local dt = now - lastTick
		if dt >= 1 then
			local gain = current - lastAmount
			if gain > 0 then
				local rate = gain / dt
				avgRate = avgRate == 0 and rate or (avgRate*0.85 + rate*0.15)
			end
			lastAmount = current
			lastTick = now
		end

		local remaining = TARGET_AMOUNT - current
		local eta = avgRate > 0 and remaining / avgRate or 0
		local percent = math.clamp(current / TARGET_AMOUNT, 0, 1)

		info.Text =
			"üí∞ " .. format(current) .. " / " .. format(TARGET_AMOUNT) ..
			"\n‚è± Runtime: " .. formatRuntime(now - startTime) ..
			"\n" .. formatETA(eta)

		TweenService:Create(
			bar,
			TweenInfo.new(BAR_TWEEN_TIME, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
			{Size = UDim2.fromScale(percent, 1)}
		):Play()

		task.wait(0.2)
	end
end)

-- =====================================
-- START
-- =====================================
RemoteEvent:FireServer("Teleport", "Workspace.Circus Event.Spawn")
task.delay(4, equipBestPets)
