--// =========================
--// CONFIG
--// =========================
local MIN_REQUIRED_MULTI = 10
local MAX_TEAM_SIZE = 8
local PET_CHECK_INTERVAL = 120
local HATCH_CFRAME = CFrame.new(-2433.08, 10.14, 264.05)

local UPGRADE_PLAN = {
    { Key = "Currency",     TargetLevel = 4 },
    { Key = "Luck",         TargetLevel = 4 },
    { Key = "SecretLuck",   TargetLevel = 4 },
    { Key = "InfinityLuck", TargetLevel = 4 },
}

--// =========================
--// SERVICES
--// =========================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local RemoteEvent = ReplicatedStorage.Shared.Framework.Network.Remote.RemoteEvent
local PickupRemote = ReplicatedStorage.Remotes.Pickups.CollectPickup

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local CircusUpgrades = require(ReplicatedStorage.Shared.Data.CircusUpgrades)
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

--// =========================
--// GLOBAL STATE
--// =========================
local PetsReady = false
local IsHatching = false
local IsUpgrading = false
local LastPetSignature = ""

--// =========================
--// TELEPORT TO CIRCUS
--// =========================
RemoteEvent:FireServer("Teleport", "Workspace.Circus Event.Spawn")

--// =========================
--// UI
--// =========================
local gui = Instance.new("ScreenGui", player.PlayerGui)
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false

local bg = Instance.new("Frame", gui)
bg.Size = UDim2.fromScale(1,1)
bg.BackgroundColor3 = Color3.fromRGB(10,10,15)
bg.BackgroundTransparency = 0.35

local title = Instance.new("TextLabel", bg)
title.Size = UDim2.fromScale(1,0.08)
title.BackgroundTransparency = 1
title.Text = "ðŸŽª Circus Automation"
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255,180,255)

local status = Instance.new("TextLabel", bg)
status.Position = UDim2.fromScale(0,0.08)
status.Size = UDim2.fromScale(1,0.05)
status.BackgroundTransparency = 1
status.Text = "Initializingâ€¦"
status.TextScaled = true
status.Font = Enum.Font.Gotham
status.TextColor3 = Color3.fromRGB(220,220,220)

local main = Instance.new("Frame", bg)
main.Position = UDim2.fromScale(0.25,0.18)
main.Size = UDim2.fromScale(0.5,0.55)
main.BackgroundColor3 = Color3.fromRGB(20,20,30)
main.BackgroundTransparency = 0.25
Instance.new("UICorner", main).CornerRadius = UDim.new(0,18)

local upgradeLabel = Instance.new("TextLabel", main)
upgradeLabel.Size = UDim2.fromScale(1,0.15)
upgradeLabel.BackgroundTransparency = 1
upgradeLabel.TextScaled = true
upgradeLabel.Font = Enum.Font.GothamBold
upgradeLabel.TextColor3 = Color3.fromRGB(255,255,255)

local petTitle = Instance.new("TextLabel", main)
petTitle.Position = UDim2.fromScale(0,0.18)
petTitle.Size = UDim2.fromScale(1,0.08)
petTitle.BackgroundTransparency = 1
petTitle.TextScaled = true
petTitle.Font = Enum.Font.GothamBold
petTitle.TextColor3 = Color3.fromRGB(255,220,180)
petTitle.Text = "[ Equipped Pets ]"

local petList = Instance.new("TextLabel", main)
petList.Position = UDim2.fromScale(0.05,0.27)
petList.Size = UDim2.fromScale(0.9,0.65)
petList.BackgroundTransparency = 1
petList.TextWrapped = true
petList.TextYAlignment = Enum.TextYAlignment.Top
petList.TextXAlignment = Enum.TextXAlignment.Left
petList.TextScaled = true
petList.Font = Enum.Font.Gotham
petList.TextColor3 = Color3.fromRGB(200,200,200)
petList.Text = "Scanning petsâ€¦"

--// =========================
--// HELPERS
--// =========================
local MULTI_KEY = "CircusTickets"

local function pressE()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    task.wait(0.04)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
end

local function getPetMulti(name)
    local info = PetsModule[name]
    return info and info.Stats and info.Stats[MULTI_KEY] or 0
end

local function getEquippedPets()
    local data = LocalData:Get()
    local pets = {}
    if data and data.Teams and data.TeamEquipped then
        local team = data.Teams[data.TeamEquipped]
        if team and team.Pets then
            for _, id in ipairs(team.Pets) do
                for _, pet in pairs(data.Pets) do
                    if pet.Id == id then
                        table.insert(pets,{
                            Id = pet.Id,
                            Name = pet.Name,
                            Multi = getPetMulti(pet.Name)
                        })
                        break
                    end
                end
            end
        end
    end
    table.sort(pets,function(a,b) return a.Multi > b.Multi end)
    return pets
end

local function updatePetUI()
    local pets = getEquippedPets()
    local sig = ""
    local text = ""

    for _, p in ipairs(pets) do
        sig ..= p.Id
        text ..= p.Name.." x"..p.Multi.."\n"
    end

    if sig ~= LastPetSignature then
        LastPetSignature = sig
        petList.Text = text ~= "" and text or "No pets equipped"
    end

    if #pets < MAX_TEAM_SIZE then return false end
    return pets[#pets].Multi >= MIN_REQUIRED_MULTI
end

--// =========================
--// PICKUP FARM
--// =========================
task.spawn(function()
    while true do
        local rendered = workspace:FindFirstChild("Rendered")
        if rendered then
            for _, folder in ipairs(rendered:GetChildren()) do
                for _, obj in ipairs(folder:GetChildren()) do
                    pcall(function()
                        PickupRemote:FireServer(obj.Name)
                        obj:Destroy()
                    end)
                end
            end
        end
        task.wait(0.1)
    end
end)

--// =========================
--// HATCHING LOOP
--// =========================
task.spawn(function()
    while true do
        if IsHatching and not IsUpgrading then
            pcall(function()
                player.Character:PivotTo(HATCH_CFRAME)
            end)
            pressE()
        end
        task.wait(0.1)
    end
end)

--// =========================
--// PET CHECK LOOP
--// =========================
task.spawn(function()
    while true do
        status.Text = "ðŸ£ Farming pets (need â‰¥10x team)"
        IsHatching = true
        task.wait(PET_CHECK_INTERVAL)

        IsHatching = false
        task.wait(1)

        PetsReady = updatePetUI()
        if PetsReady then
            status.Text = "âœ… Pets ready"
            break
        end
    end
end)

--// =========================
--// UPGRADE LOGIC
--// =========================
task.spawn(function()
    while not PetsReady do task.wait(1) end

    IsUpgrading = true
    IsHatching = false

    for _, plan in ipairs(UPGRADE_PLAN) do
        local key = plan.Key
        local target = plan.TargetLevel
        local cfg = CircusUpgrades[key]

        while true do
            local data = LocalData:Get()
            local level = data and data.CircusUpgrades and data.CircusUpgrades[key] or 0
            if level >= target then break end

            upgradeLabel.Text = "ðŸŽ¯ "..cfg.Name
            RemoteEvent:FireServer("BuyCircusUpgrade", key)
            task.wait(1)
        end
    end

    status.Text = "âœ… All upgrades complete"
end)
