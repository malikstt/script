local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local lp = Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)

local RemoteEvent = ReplicatedStorage
    :WaitForChild("Shared"):WaitForChild("Framework")
    :WaitForChild("Network"):WaitForChild("Remote")
    :WaitForChild("RemoteEvent")

local function gd()
    local ok,d = pcall(function() return LocalData:Get() end)
    return ok and d or {}
end

local OWNED_TAG = "__OPT_UI__"

local function tag(i)
    i:SetAttribute(OWNED_TAG,true)
end

local function isOwned(i)
    return i:GetAttribute(OWNED_TAG) == true
end

local gui = Instance.new("ScreenGui")
tag(gui)
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.DisplayOrder = 1e9
gui.Parent = lp.PlayerGui

local bg = Instance.new("Frame",gui)
tag(bg)
bg.Size = UDim2.new(1,0,1,0)
bg.BackgroundColor3 = Color3.new(0,0,0)

local container = Instance.new("Frame",bg)
tag(container)
container.AnchorPoint = Vector2.new(0.5,0.5)
container.Position = UDim2.new(0.5,0,0.5,0)
container.Size = UDim2.new(0.42,0,0.18,0)
container.BackgroundTransparency = 1

local outline = Instance.new("Frame",container)
tag(outline)
outline.Size = UDim2.new(1,0,1,0)
outline.BackgroundColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner",outline).CornerRadius = UDim.new(0,18)

local fill = Instance.new("Frame",outline)
tag(fill)
fill.Position = UDim2.new(0.02,0,0.1,0)
fill.Size = UDim2.new(0,0,0.8,0)
fill.BackgroundColor3 = Color3.fromRGB(200,50,50)
Instance.new("UICorner",fill).CornerRadius = UDim.new(0,14)

local cap = Instance.new("Frame",container)
tag(cap)
cap.AnchorPoint = Vector2.new(0,0.5)
cap.Position = UDim2.new(1,6,0.5,0)
cap.Size = UDim2.new(0,18,0.35,0)
cap.BackgroundColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner",cap).CornerRadius = UDim.new(0,6)

local pct = Instance.new("TextLabel",container)
tag(pct)
pct.Size = UDim2.new(1,0,1,0)
pct.BackgroundTransparency = 1
pct.Font = Enum.Font.GothamBlack
pct.TextScaled = true
pct.TextColor3 = Color3.new(1,1,1)
pct.Text = "0%"

local status = Instance.new("TextLabel",bg)
tag(status)
status.AnchorPoint = Vector2.new(0.5,0)
status.Position = UDim2.new(0.5,0,0.62,0)
status.Size = UDim2.new(0.9,0,0.05,0)
status.BackgroundTransparency = 1
status.Font = Enum.Font.GothamBold
status.TextScaled = true
status.TextColor3 = Color3.fromRGB(200,200,200)
status.Text = "ðŸ”„ Optimizing Client"

local progress,target = 0,0
RunService.RenderStepped:Connect(function()
    progress += (target-progress)*0.08
    fill.Size = UDim2.new((progress/100)*0.96,0,0.8,0)
    pct.Text = math.floor(progress).."%"
    if progress < 30 then fill.BackgroundColor3 = Color3.fromRGB(200,50,50)
    elseif progress < 70 then fill.BackgroundColor3 = Color3.fromRGB(220,180,40)
    else fill.BackgroundColor3 = Color3.fromRGB(80,220,120) end
end)

local function stage(p,t)
    target = p
    status.Text = t
end

local function clearForeignUI()
    local pg = lp:FindFirstChild("PlayerGui")
    if not pg then return end
    for _,g in ipairs(pg:GetChildren()) do
        if (g:IsA("ScreenGui") or g:IsA("BillboardGui") or g:IsA("SurfaceGui")) and not isOwned(g) then
            pcall(function() g:Destroy() end)
        end
    end
end

lp.PlayerGui.ChildAdded:Connect(function(g)
    task.wait()
    if (g:IsA("ScreenGui") or g:IsA("BillboardGui") or g:IsA("SurfaceGui")) and not isOwned(g) then
        pcall(function() g:Destroy() end)
    end
end)

local keep = {}
local function k(x) if x then keep[x]=true end end

k(Workspace.Camera)
k(char)
k(Workspace:FindFirstChild("Worlds"))
k(Workspace.Worlds and Workspace.Worlds:FindFirstChild("Christmas World"))

if Workspace.Worlds and Workspace.Worlds:FindFirstChild("Christmas World") then
    for _,v in ipairs(Workspace.Worlds["Christmas World"]:GetDescendants()) do
        k(v)
    end
end

local function d(i)
    if i and i.Parent and not keep[i] and not i:IsDescendantOf(char) then
        pcall(function() i:Destroy() end)
    end
end

local function batch(list,b,w)
    local i=1
    while i<=#list do
        for j=i,math.min(i+b-1,#list) do d(list[j]) end
        i+=b
        task.wait(w)
    end
end

stage(10,"ðŸ§¹ Clearing UI")
clearForeignUI()
task.wait(0.4)

stage(30,"ðŸ”¥ Removing Visuals")
batch(Workspace:GetDescendants(),40,0.01)

stage(55,"ðŸŒ Deleting Other Worlds")
if Workspace.Worlds then
    for _,w in ipairs(Workspace.Worlds:GetChildren()) do
        if w.Name ~= "Christmas World" then
            pcall(function() w:Destroy() end)
        end
    end
end

stage(75,"âš™ï¸ Disabling Rendering")
pcall(function() RunService:Set3dRenderingEnabled(false) end)

stage(100,"ðŸŽ„ Checking Christmas World")
task.wait(0.4)

local function fireUnlock()
    RemoteEvent:FireServer("UnlockWorld","Christmas World")
end

local function fireTeleport()
    RemoteEvent:FireServer("WorldTeleport","Christmas World")
end

local data = gd()
local unlocked = data.WorldsUnlocked and data.WorldsUnlocked["Christmas World"]

if unlocked then
    status.Text = "ðŸš€ Teleporting to Christmas World"
    fireTeleport()
else
    status.Text = "ðŸ”“ Unlocking Christmas World"
    fireUnlock()
    task.wait(8)
    fireTeleport()
end

task.wait(6)

local function getUnlockedIslands()
    local d = gd()
    local t = {}
    if d.AreasUnlocked then
        for n in pairs(d.AreasUnlocked) do t[n]=true end
    end
    return t
end

local function getIslands()
    local cw = Workspace.Worlds and Workspace.Worlds:FindFirstChild("Christmas World")
    if not cw or not cw:FindFirstChild("Islands") then return {} end
    local r={}
    for _,i in ipairs(cw.Islands:GetChildren()) do table.insert(r,i.Name) end
    return r
end

local function farmIsland(name)
    status.Text = "ðŸŒ´ Farming "..name
    local hrp = char:WaitForChild("HumanoidRootPart")
    local island = Workspace.Worlds["Christmas World"].Islands:FindFirstChild(name)
    if not island then return end
    local model = island:FindFirstChild("Island")
    if not model then return end
    local cf = model:GetPivot()
    hrp.CFrame = cf + Vector3.new(0,6,0)
    local t = tick()+20
    while tick()<t do
        VirtualInputManager:SendKeyEvent(true,Enum.KeyCode.E,false,game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(false,Enum.KeyCode.E,false,game)
        task.wait(0.4)
    end
end

while true do
    local unlockedIslands = getUnlockedIslands()
    local all = getIslands()
    local missing = {}
    for _,n in ipairs(all) do
        if not unlockedIslands[n] then table.insert(missing,n) end
    end
    status.Text = "ðŸï¸ Islands Unlocked "..( #all-#missing ).."/"..#all
    if #missing==0 then break end
    for _,n in ipairs(missing) do
        farmIsland(n)
        task.wait(1)
    end
end

status.Text = "âœ… Xmas World Unlocked | Islands Complete"
pct.Text = lp.Name
fill.Size = UDim2.new(0.96,0,0.8,0)
fill.BackgroundColor3 = Color3.fromRGB(80,220,120)
