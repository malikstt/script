-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local lp = Players.LocalPlayer
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

-- SAFE GET DATA
local function gd()
    local ok, d = pcall(function()
        return LocalData:Get()
    end)
    return ok and d or {}
end

-- NUMBER FORMAT
local function fmt(n)
    n = tonumber(n) or 0
    if n >= 1e12 then return string.format("%.2fT", n/1e12)
    elseif n >= 1e9 then return string.format("%.2fB", n/1e9)
    elseif n >= 1e6 then return string.format("%.2fM", n/1e6)
    elseif n >= 1e3 then return string.format("%.2fK", n/1e3)
    else return tostring(n) end
end

-- GET SNOWFLAKES
local function getSnow()
    return gd().Snowflakes or 0
end

-- GET TEAM MULTI
local function getTeamMulti()
    local d = gd()
    local ids = (d.Teams and d.TeamEquipped and d.Teams[d.TeamEquipped]
        and d.Teams[d.TeamEquipped].Pets) or {}

    local petMap = {}
    if d.Pets then
        for _, p in pairs(d.Pets) do
            petMap[tostring(p.Id)] = p
        end
    end

    local sum = 0
    for _, id in ipairs(ids) do
        local pet = petMap[tostring(id)]
        if pet and PetsModule[pet.Name] and PetsModule[pet.Name].Stats then
            sum += (PetsModule[pet.Name].Stats.Snowflakes or 0)
        end
    end
    return sum
end

-- PER MIN CALC
local samples = {}
local function push(v)
    samples[#samples+1] = {t = tick(), v = v}
    while #samples > 1 and tick() - samples[1].t > 60 do
        table.remove(samples, 1)
    end
end

local function perMin()
    if #samples < 2 then return 0 end
    local a, b = samples[1], samples[#samples]
    if b.t - a.t <= 0 then return 0 end
    return ((b.v - a.v) / (b.t - a.t)) * 60
end

-- UI
local gui = Instance.new("ScreenGui", lp.PlayerGui)
gui.Name = "SnowflakeStatsUI"
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.DisplayOrder = 999999

local bg = Instance.new("Frame", gui)
bg.Size = UDim2.new(1,0,1,0)
bg.BackgroundColor3 = Color3.fromRGB(0,0,0)

local box = Instance.new("Frame", bg)
box.AnchorPoint = Vector2.new(0.5,0.5)
box.Position = UDim2.new(0.5,0,0.5,0)
box.Size = UDim2.new(0.45,0,0.35,0)
box.BackgroundColor3 = Color3.fromRGB(12,12,14)
Instance.new("UICorner", box).CornerRadius = UDim.new(0,20)

local function makeText(y, size)
    local t = Instance.new("TextLabel", box)
    t.Size = UDim2.new(1,-40,0,60)
    t.Position = UDim2.new(0,20,0,y)
    t.BackgroundTransparency = 1
    t.Font = Enum.Font.GothamBlack
    t.TextScaled = true
    t.TextWrapped = true
    t.TextColor3 = Color3.fromRGB(255,255,255)
    t.TextSize = size
    return t
end

-- TEXT ELEMENTS
local USER = makeText(20, 28)
local TOTAL = makeText(95, 40)
local RATE = makeText(175, 28)
local MULTI = makeText(245, 28)

-- LOOP
task.spawn(function()
    while true do
        local snow = getSnow()
        push(snow)

        USER.Text = "ðŸ‘¤ "..lp.Name
        TOTAL.Text = "â„ï¸ "..fmt(snow).." Snowflakes"
        RATE.Text = "â±ï¸ "..fmt(perMin()).." / min"
        MULTI.Text = "âœ¨ Team Multi: "..fmt(getTeamMulti())

        task.wait(1)
    end
end)
