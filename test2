-- MASTER SCRIPT

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ws = workspace

local lp = Players.LocalPlayer
local pg = lp:WaitForChild("PlayerGui")
local char = lp.Character or lp.CharacterAdded:Wait()

-- ================= SCREEN GUI ENFORCER =================
local function isOurs(g)
	return g:GetAttribute("OwnedByUs") == true
end

for _,g in ipairs(pg:GetChildren()) do
	if g:IsA("ScreenGui") and not isOurs(g) then
		g:Destroy()
	end
end

pg.ChildAdded:Connect(function(c)
	task.wait()
	if c:IsA("ScreenGui") and not isOurs(c) then
		c:Destroy()
	end
end)

-- ================= LOADER UI =================
local loaderGui = Instance.new("ScreenGui")
loaderGui.Name = "__LOADER__"
loaderGui:SetAttribute("OwnedByUs", true)
loaderGui.IgnoreGuiInset = true
loaderGui.ResetOnSpawn = false
loaderGui.DisplayOrder = 1e9
loaderGui.Parent = pg

local bg = Instance.new("Frame", loaderGui)
bg.Size = UDim2.new(1,0,1,0)
bg.BackgroundColor3 = Color3.new(0,0,0)

local container = Instance.new("Frame", bg)
container.AnchorPoint = Vector2.new(0.5,0.5)
container.Position = UDim2.new(0.5,0,0.5,0)
container.Size = UDim2.new(0.42,0,0.18,0)
container.BackgroundTransparency = 1

local outline = Instance.new("Frame", container)
outline.Size = UDim2.new(1,0,1,0)
outline.BackgroundColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", outline).CornerRadius = UDim.new(0,18)

local fill = Instance.new("Frame", outline)
fill.Position = UDim2.new(0.02,0,0.1,0)
fill.Size = UDim2.new(0,0,0.8,0)
fill.BackgroundColor3 = Color3.fromRGB(200,50,50)
Instance.new("UICorner", fill).CornerRadius = UDim.new(0,14)

local cap = Instance.new("Frame", container)
cap.AnchorPoint = Vector2.new(0,0.5)
cap.Position = UDim2.new(1,6,0.5,0)
cap.Size = UDim2.new(0,18,0.35,0)
cap.BackgroundColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", cap).CornerRadius = UDim.new(0,6)

local pct = Instance.new("TextLabel", container)
pct.Size = UDim2.new(1,0,1,0)
pct.BackgroundTransparency = 1
pct.Font = Enum.Font.GothamBlack
pct.TextScaled = true
pct.TextColor3 = Color3.new(1,1,1)
pct.Text = "0%"

local status = Instance.new("TextLabel", bg)
status.AnchorPoint = Vector2.new(0.5,0)
status.Position = UDim2.new(0.5,0,0.62,0)
status.Size = UDim2.new(0.9,0,0.06,0)
status.BackgroundTransparency = 1
status.Font = Enum.Font.GothamBold
status.TextScaled = true
status.TextColor3 = Color3.fromRGB(200,200,200)
status.Text = "Loading…"

local progress,target = 0,0
RunService.RenderStepped:Connect(function()
	progress += (target-progress)*0.1
	progress = math.clamp(progress,0,100)
	fill.Size = UDim2.new((progress/100)*0.96,0,0.8,0)
	pct.Text = math.floor(progress).."%"
	if progress < 30 then
		fill.BackgroundColor3 = Color3.fromRGB(200,50,50)
	elseif progress < 70 then
		fill.BackgroundColor3 = Color3.fromRGB(220,180,40)
	else
		fill.BackgroundColor3 = Color3.fromRGB(80,220,120)
	end
end)

local function stage(p,t)
	target = p
	status.TextTransparency = 1
	status.Text = t
	TweenService:Create(status,TweenInfo.new(0.15),{TextTransparency=0}):Play()
	task.wait(0.5)
end

-- ================= OPTIMIZATION =================
local keep = {}
local function k(x) if x then keep[x]=true end end

k(ws.Camera)
k(char)

local worlds = ws:FindFirstChild("Worlds")
local cw = worlds and worlds:FindFirstChild("Christmas World")
k(worlds)
k(cw)
if cw then for _,v in ipairs(cw:GetDescendants()) do k(v) end end

local function protectChar(c)
	k(c)
	for _,v in ipairs(c:GetDescendants()) do k(v) end
end
protectChar(char)

lp.CharacterAdded:Connect(function(c)
	task.wait(0.4)
	protectChar(c)
end)

local function isChar(o)
	return lp.Character and (o==lp.Character or o:IsDescendantOf(lp.Character))
end

local function d(i)
	if i and i.Parent and not keep[i] and not isChar(i) then
		pcall(function() i:Destroy() end)
	end
end

local function batch(list,b,w)
	local i=1
	while i<=#list do
		for j=i,math.min(i+b-1,#list) do d(list[j]) end
		i+=b
		task.wait(w)
	end
end

local function collect(pred)
	local t={}
	for _,o in ipairs(ws:GetDescendants()) do
		if pred(o) and not keep[o] then table.insert(t,o) end
	end
	return t
end

stage(5,"Destroying Worlds")
stage(10,"Deleting Baseplates")

stage(25,"Removing Visuals")
batch(collect(function(o)
	return o:IsA("MeshPart") or o:IsA("UnionOperation") or o:IsA("SpecialMesh")
	or o:IsA("Texture") or o:IsA("Decal") or o:IsA("ParticleEmitter")
	or o:IsA("Beam") or o:IsA("Trail") or o:IsA("Fire")
	or o:IsA("Smoke") or o:IsA("Sparkles") or o:IsA("Highlight")
	or o:IsA("SurfaceAppearance")
end),40,0.35)

stage(45,"Deleting Decorations")
batch(collect(function(o)
	return o:IsA("Adornment") or o:IsA("SelectionBox")
	or o:IsA("SelectionSphere") or o:IsA("ArcHandles")
end),20,0.3)

stage(65,"Removing Scripts")
batch(collect(function(o)
	return (o:IsA("Script") or o:IsA("LocalScript") or o:IsA("ModuleScript"))
	and not o:IsDescendantOf(lp.Character)
end),20,0.6)

stage(80,"Purging Workspace")
batch(collect(function(o)
	return not o:IsA("BasePart")
end),30,0.5)

stage(95,"Shutting Down Lighting")
for _,v in ipairs(Lighting:GetChildren()) do
	if not keep[v] then pcall(function() v:Destroy() end) end
end

pcall(function() RunService:Set3dRenderingEnabled(false) end)
stage(100,"Loading…")

task.wait(0.4)
TweenService:Create(bg,TweenInfo.new(0.25),{BackgroundTransparency=1}):Play()
task.wait(0.3)
loaderGui:Destroy()
