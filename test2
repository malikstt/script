local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local lp = Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)

local RemoteEvent = ReplicatedStorage
    :WaitForChild("Shared"):WaitForChild("Framework")
    :WaitForChild("Network"):WaitForChild("Remote")
    :WaitForChild("RemoteEvent")

local function gd()
    local ok,d = pcall(function() return LocalData:Get() end)
    return ok and d or {}
end

-- =======================
-- LOADER UI (BATTERY)
-- =======================
local OWNED="__OPT_UI__"
local function tag(i) i:SetAttribute(OWNED,true) end
local function owned(i) return i:GetAttribute(OWNED)==true end

local gui=Instance.new("ScreenGui")
tag(gui)
gui.IgnoreGuiInset=true
gui.ResetOnSpawn=false
gui.DisplayOrder=1e9
gui.Parent=lp.PlayerGui

local bg=Instance.new("Frame",gui)
tag(bg)
bg.Size=UDim2.new(1,0,1,0)
bg.BackgroundColor3=Color3.new(0,0,0)

local cont=Instance.new("Frame",bg)
tag(cont)
cont.AnchorPoint=Vector2.new(0.5,0.5)
cont.Position=UDim2.new(0.5,0,0.5,0)
cont.Size=UDim2.new(0.42,0,0.18,0)
cont.BackgroundTransparency=1

local outline=Instance.new("Frame",cont)
tag(outline)
outline.Size=UDim2.new(1,0,1,0)
outline.BackgroundColor3=Color3.fromRGB(255,255,255)
Instance.new("UICorner",outline).CornerRadius=UDim.new(0,18)

local fill=Instance.new("Frame",outline)
tag(fill)
fill.Position=UDim2.new(0.02,0,0.1,0)
fill.Size=UDim2.new(0,0,0.8,0)
fill.BackgroundColor3=Color3.fromRGB(200,50,50)
Instance.new("UICorner",fill).CornerRadius=UDim.new(0,14)

local cap=Instance.new("Frame",cont)
tag(cap)
cap.AnchorPoint=Vector2.new(0,0.5)
cap.Position=UDim2.new(1,6,0.5,0)
cap.Size=UDim2.new(0,18,0.35,0)
cap.BackgroundColor3=Color3.fromRGB(255,255,255)
Instance.new("UICorner",cap).CornerRadius=UDim.new(0,6)

local pct=Instance.new("TextLabel",cont)
tag(pct)
pct.Size=UDim2.new(1,0,1,0)
pct.BackgroundTransparency=1
pct.Font=Enum.Font.GothamBlack
pct.TextScaled=true
pct.TextColor3=Color3.new(1,1,1)
pct.Text="0%"

local status=Instance.new("TextLabel",bg)
tag(status)
status.AnchorPoint=Vector2.new(0.5,0)
status.Position=UDim2.new(0.5,0,0.62,0)
status.Size=UDim2.new(0.9,0,0.05,0)
status.BackgroundTransparency=1
status.Font=Enum.Font.GothamBold
status.TextScaled=true
status.TextColor3=Color3.fromRGB(200,200,200)
status.Text="üîÑ Optimizing Client"

local progress,target=0,0
RunService.RenderStepped:Connect(function()
    progress+=(target-progress)*0.08
    fill.Size=UDim2.new((progress/100)*0.96,0,0.8,0)
    pct.Text=math.floor(progress).."%"
    if progress<30 then fill.BackgroundColor3=Color3.fromRGB(200,50,50)
    elseif progress<70 then fill.BackgroundColor3=Color3.fromRGB(220,180,40)
    else fill.BackgroundColor3=Color3.fromRGB(80,220,120) end
end)

local function stage(p,t) target=p status.Text=t end

local function clearForeignUI()
    local pg=lp:FindFirstChild("PlayerGui")
    if not pg then return end
    for _,g in ipairs(pg:GetChildren()) do
        if (g:IsA("ScreenGui") or g:IsA("BillboardGui") or g:IsA("SurfaceGui")) and not owned(g) then
            pcall(function() g:Destroy() end)
        end
    end
end

lp.PlayerGui.ChildAdded:Connect(function(g)
    task.wait()
    if (g:IsA("ScreenGui") or g:IsA("BillboardGui") or g:IsA("SurfaceGui")) and not owned(g) then
        pcall(function() g:Destroy() end)
    end
end)

-- =======================
-- OPTIMIZE (NO GAMEPLAY TOUCH)
-- =======================
local keep={}
local function k(x) if x then keep[x]=true end end
k(Workspace.Camera)
k(char)
k(Workspace:FindFirstChild("Worlds"))
k(Workspace.Worlds and Workspace.Worlds:FindFirstChild("Christmas World"))
if Workspace.Worlds and Workspace.Worlds:FindFirstChild("Christmas World") then
    for _,v in ipairs(Workspace.Worlds["Christmas World"]:GetDescendants()) do k(v) end
end

local function d(i)
    if i and i.Parent and not keep[i] and not i:IsDescendantOf(char) then
        pcall(function() i:Destroy() end)
    end
end

local function batch(list,b,w)
    local i=1
    while i<=#list do
        for j=i,math.min(i+b-1,#list) do d(list[j]) end
        i+=b
        task.wait(w)
    end
end

stage(10,"üßπ Clearing UI")
clearForeignUI()
task.wait(0.3)

stage(40,"üî• Removing Visuals")
batch(Workspace:GetDescendants(),50,0.01)

stage(70,"üåç Deleting Other Worlds")
if Workspace.Worlds then
    for _,w in ipairs(Workspace.Worlds:GetChildren()) do
        if w.Name~="Christmas World" then pcall(function() w:Destroy() end) end
    end
end

stage(90,"‚öôÔ∏è Disabling Rendering")
pcall(function() RunService:Set3dRenderingEnabled(false) end)

stage(100,"‚úÖ Optimization Complete")
task.wait(0.5)

TweenService:Create(bg,TweenInfo.new(0.35),{BackgroundTransparency=1}):Play()
task.wait(0.4)
gui:Destroy()

-- =======================
-- ISLAND STATUS UI
-- =======================
local ui=Instance.new("ScreenGui",lp.PlayerGui)
ui.IgnoreGuiInset=true
ui.ResetOnSpawn=false
ui.DisplayOrder=1e9

local root=Instance.new("Frame",ui)
root.Size=UDim2.new(1,0,1,0)
root.BackgroundTransparency=1

local card=Instance.new("Frame",root)
card.AnchorPoint=Vector2.new(0.5,0.5)
card.Position=UDim2.new(0.5,0,0.5,0)
card.Size=UDim2.new(0.55,0,0.28,0)
card.BackgroundColor3=Color3.fromRGB(10,10,12)
Instance.new("UICorner",card).CornerRadius=UDim.new(0,16)

local title=Instance.new("TextLabel",card)
title.Size=UDim2.new(1,-24,0,44)
title.Position=UDim2.new(0,12,0,10)
title.BackgroundTransparency=1
title.Font=Enum.Font.GothamBlack
title.TextScaled=true
title.TextColor3=Color3.new(1,1,1)
title.Text="üéÑ Christmas World Status"

local body=Instance.new("TextLabel",card)
body.Size=UDim2.new(1,-24,1,-70)
body.Position=UDim2.new(0,12,0,60)
body.BackgroundTransparency=1
body.Font=Enum.Font.GothamBold
body.TextScaled=true
body.TextColor3=Color3.fromRGB(220,220,220)
body.TextWrapped=true
body.TextXAlignment=Enum.TextXAlignment.Left
body.TextYAlignment=Enum.TextYAlignment.Top

local function setBody(t) body.Text=t end

-- =======================
-- WORLD UNLOCK
-- =======================
local function fireUnlockWorld()
    RemoteEvent:FireServer("UnlockWorld","Christmas World")
end
local function fireTeleportWorld()
    RemoteEvent:FireServer("WorldTeleport","Christmas World")
end

local data=gd()
if data.WorldsUnlocked and data.WorldsUnlocked["Christmas World"] then
    setBody("üë§ "..lp.Name.."\nüåç Xmas World: Unlocked")
    fireTeleportWorld()
else
    setBody("üë§ "..lp.Name.."\nüåç Xmas World: Unlocking‚Ä¶")
    fireUnlockWorld()
    task.wait(8)
    fireTeleportWorld()
end

task.wait(6)

-- =======================
-- FAKE TOUCH ISLAND UNLOCK
-- =======================
if not firetouchinterest then
    setBody("üë§ "..lp.Name.."\n‚ùå firetouchinterest not supported")
    return
end

local cw=Workspace.Worlds and Workspace.Worlds:FindFirstChild("Christmas World")
local islandsFolder=cw and cw:FindFirstChild("Islands")
if not islandsFolder then
    setBody("üë§ "..lp.Name.."\n‚ùå Islands not found")
    return
end

local function getUnlockedIslands()
    local d=gd()
    local t={}
    if d.AreasUnlocked then for n in pairs(d.AreasUnlocked) do t[n]=true end end
    return t
end

local islandParts={}
local islandNames={}
for _,isl in ipairs(islandsFolder:GetChildren()) do
    table.insert(islandNames,isl.Name)
    local island=isl:FindFirstChild("Island")
    if island then
        for _,p in ipairs(island:GetDescendants()) do
            if p:IsA("BasePart") then table.insert(islandParts,p) end
        end
    end
end

local total=#islandNames

task.spawn(function()
    while true do
        for _,p in ipairs(islandParts) do
            if p:IsDescendantOf(Workspace) then
                firetouchinterest(hrp,p,0)
                task.wait()
                firetouchinterest(hrp,p,1)
            end
        end
        task.wait(0.1)
    end
end)

while true do
    local unlocked=getUnlockedIslands()
    local count=0
    for _,n in ipairs(islandNames) do if unlocked[n] then count+=1 end end
    setBody("üë§ "..lp.Name.."\nüéÑ Xmas World: Unlocked\nüèùÔ∏è Islands Found: "..total.."\n‚úÖ Islands Unlocked: "..count.."/"..total)
    if count>=total then break end
    task.wait(0.5)
end

setBody("üë§ "..lp.Name.."\nüéÑ Xmas World: Unlocked\nüèùÔ∏è Islands Found: "..total.."\n‚úÖ Islands Unlocked: "..total.."/"..total)
