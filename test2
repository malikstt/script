task.spawn(function()
    local Players=game:GetService("Players")
    local RunService=game:GetService("RunService")
    local ReplicatedStorage=game:GetService("ReplicatedStorage")
    local VirtualInputManager=game:GetService("VirtualInputManager")

    local lp=Players.LocalPlayer
    local hrp

    local function bindChar(c)
        hrp=c:WaitForChild("HumanoidRootPart")
    end
    if lp.Character then bindChar(lp.Character) end
    lp.CharacterAdded:Connect(bindChar)

    -- ===== DATA =====
    local LocalData=require(ReplicatedStorage.Client.Framework.Services.LocalData)
    local PetsModule=require(ReplicatedStorage.Shared.Data.Pets)
    local RemoteFunction=ReplicatedStorage.Shared.Framework.Network.Remote.RemoteFunction

    local function gd()
        local ok,d=pcall(function()return LocalData:Get()end)
        return ok and d or {}
    end

    -- ===== UI =====
    local function fmt(n)
        n=tonumber(n) or 0
        if n>=1e12 then return string.format("%.2fT",n/1e12)
        elseif n>=1e9 then return string.format("%.2fB",n/1e9)
        elseif n>=1e6 then return string.format("%.2fM",n/1e6)
        elseif n>=1e3 then return string.format("%.2fK",n/1e3)
        else return tostring(n) end
    end

    local function getSnow()
        return gd().Snowflakes or 0
    end

    local function getTeamMulti()
        local d=gd()
        local ids=(d.Teams and d.TeamEquipped and d.Teams[d.TeamEquipped] and d.Teams[d.TeamEquipped].Pets) or {}
        local map={}
        if d.Pets then
            for _,p in pairs(d.Pets) do map[tostring(p.Id)]=p end
        end
        local sum=0
        for _,id in ipairs(ids) do
            local p=map[tostring(id)]
            if p and PetsModule[p.Name] and PetsModule[p.Name].Stats then
                sum+=(PetsModule[p.Name].Stats.Snowflakes or 0)
            end
        end
        return sum
    end

    local samples={}
    local function push(v)
        samples[#samples+1]={t=os.clock(),v=v}
        while #samples>1 and os.clock()-samples[1].t>60 do
            table.remove(samples,1)
        end
    end

    local function perMin()
        if #samples<2 then return 0 end
        local a,b=samples[1],samples[#samples]
        return ((b.v-a.v)/(b.t-a.t))*60
    end

    local gui=Instance.new("ScreenGui",lp.PlayerGui)
    gui.Name="SnowflakeStatsUI"
    gui.IgnoreGuiInset=true
    gui.ResetOnSpawn=false
    gui.DisplayOrder=999999

    local bg=Instance.new("Frame",gui)
    bg.Size=UDim2.new(1,0,1,0)
    bg.BackgroundColor3=Color3.fromRGB(0,0,0)

    local box=Instance.new("Frame",bg)
    box.AnchorPoint=Vector2.new(0.5,0.5)
    box.Position=UDim2.new(0.5,0,0.5,0)
    box.Size=UDim2.new(0.45,0,0.35,0)
    box.BackgroundColor3=Color3.fromRGB(12,12,14)
    Instance.new("UICorner",box).CornerRadius=UDim.new(0,20)

    local function makeText(y)
        local t=Instance.new("TextLabel",box)
        t.Size=UDim2.new(1,-40,0,60)
        t.Position=UDim2.new(0,20,0,y)
        t.BackgroundTransparency=1
        t.Font=Enum.Font.GothamBlack
        t.TextScaled=true
        t.TextWrapped=true
        t.TextColor3=Color3.fromRGB(255,255,255)
        return t
    end

    local USER=makeText(20)
    local TOTAL=makeText(95)
    local RATE=makeText(175)
    local MULTI=makeText(245)

    RunService.Heartbeat:Connect(function()
        local snow=getSnow()
        push(snow)
        USER.Text="ðŸ‘¤ "..lp.Name
        TOTAL.Text="â„ï¸ "..fmt(snow).." Snowflakes"
        RATE.Text="â±ï¸ "..fmt(perMin()).." / min"
        MULTI.Text="âœ¨ Team Multi: "..fmt(getTeamMulti())
    end)

    -- ===== GIFTS =====
    local GiveGifts=workspace.Worlds["Christmas World"].GiveGifts
    local function getActivationPart(a)
        if a:IsA("BasePart") then return a end
        for _,d in ipairs(a:GetDescendants()) do
            if d:IsA("BasePart") then return d end
        end
    end

    local function touch(part)
        if not hrp then return end
        hrp.CFrame=part.CFrame*CFrame.new(0,4,0)
        RunService.Heartbeat:Wait()
        hrp.CFrame=part.CFrame*CFrame.new(0,-2.5,0)
        RunService.Heartbeat:Wait()
        local t=tick()
        while tick()-t<0.25 do
            hrp.AssemblyLinearVelocity=Vector3.zero
            hrp.AssemblyAngularVelocity=Vector3.zero
            hrp.CFrame=part.CFrame*CFrame.new(0,1.5,0)
            RunService.Heartbeat:Wait()
        end
    end

    task.spawn(function()
        while true do
            for _,h in ipairs(GiveGifts:GetChildren()) do
                local a=h:FindFirstChild("Activation")
                if a then
                    local p=getActivationPart(a)
                    if p then pcall(touch,p) task.wait(6.5) end
                end
            end
        end
    end)

    -- ===== PRESS B =====
    task.spawn(function()
        while true do
            VirtualInputManager:SendKeyEvent(true,Enum.KeyCode.B,false,game)
            task.wait(0.05)
            VirtualInputManager:SendKeyEvent(false,Enum.KeyCode.B,false,game)
            task.wait(60)
        end
    end)

    -- ===== PICKUPS =====
    local pickupRemote=ReplicatedStorage.Remotes.Pickups.CollectPickup
    task.spawn(function()
        local claimed={}
        while true do
            local r=workspace:FindFirstChild("Rendered")
            if r then
                local t=r:GetChildren()[15]
                if t then
                    for _,o in ipairs(t:GetChildren()) do
                        if not claimed[o.Name] then
                            claimed[o.Name]=true
                            pcall(function()
                                pickupRemote:FireServer(o.Name)
                                o:Destroy()
                            end)
                        end
                    end
                end
            end
            task.wait(0.1)
        end
    end)

    -- ===== ENCHANT =====
    task.spawn(function()
        if not LocalData:IsReady() then LocalData.DataReady:Wait() end
        local function findPet(id)
            for _,p in ipairs(LocalData:Get().Pets or {}) do
                if p.Id==id then return p end
            end
        end
        local function hasTU5(p)
            for _,e in ipairs(p.Enchants or {}) do
                if e.Id and string.lower(e.Id)=="team-up 5" then return true end
            end
        end
        local d=LocalData:Get()
        local team=d.TeamEquipped and d.Teams and d.Teams[d.TeamEquipped]
        if not(team and team.Pets) then return end
        for _,id in ipairs(team.Pets) do
            task.spawn(function(pid)
                while true do
                    local p=findPet(pid)
                    if not p or hasTU5(p) then return end
                    RemoteFunction:InvokeServer("RerollEnchants",pid,"Gems")
                    task.wait(0.5)
                end
            end,id)
        end
    end)
end)
