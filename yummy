local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local TradeEvent = ReplicatedStorage
    :WaitForChild("Shared")
    :WaitForChild("Framework")
    :WaitForChild("Network")
    :WaitForChild("Remote")
    :WaitForChild("RemoteEvent")

local LocalData = require(
    ReplicatedStorage
        :WaitForChild("Client")
        :WaitForChild("Framework")
        :WaitForChild("Services")
        :WaitForChild("LocalData")
)

getgenv().Settings = {
    AutoTradeEnabled = false,
    AutoTradeDelay = 1,
    SelectedPlayer = nil,

    AutoConfirmEnabled = false,
    AutoConfirmDelay = 2,
}

local autoTradeRunning = false
local autoConfirmRunning = false

local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "Trade Automation",
    LoadingTitle = "Trade System",
    LoadingSubtitle = "Professional Trading Suite",
    ConfigurationSaving = {
        Enabled = true,
        FileName = "TradeAutoConfig"
    },
    KeySystem = false
})

local MainTab = Window:CreateTab("Main", 4483362458)

local function startAutoTradeLoop()
    if autoTradeRunning then return end
    autoTradeRunning = true

    task.spawn(function()
        while autoTradeRunning do
            if getgenv().Settings.AutoTradeEnabled and getgenv().Settings.SelectedPlayer then
                TradeEvent:FireServer("TradeRequest", getgenv().Settings.SelectedPlayer)
            end
            task.wait(getgenv().Settings.AutoTradeDelay)
        end
    end)
end

local function startAutoConfirmLoop()
    if autoConfirmRunning then return end
    autoConfirmRunning = true

    task.spawn(function()
        while autoConfirmRunning do
            if getgenv().Settings.AutoConfirmEnabled then
                local args = { "TradeConfirm" }
                TradeEvent:FireServer(unpack(args))
            end
            task.wait(getgenv().Settings.AutoConfirmDelay)
        end
    end)
end

MainTab:CreateToggle({
    Name = "Enable Auto-Trade (Requests)",
    CurrentValue = getgenv().Settings.AutoTradeEnabled,
    Flag = "AutoTradeToggle",
    Callback = function(Value)
        getgenv().Settings.AutoTradeEnabled = Value
        if Value then
            startAutoTradeLoop()
        end
    end
})

MainTab:CreateSlider({
    Name = "Auto-Trade Delay (seconds)",
    Range = {0.2, 10},
    Increment = 0.1,
    Suffix = "s",
    CurrentValue = getgenv().Settings.AutoTradeDelay,
    Flag = "AutoTradeDelay",
    Callback = function(Value)
        getgenv().Settings.AutoTradeDelay = Value
    end
})

MainTab:CreateToggle({
    Name = "Enable Auto-Confirm",
    CurrentValue = getgenv().Settings.AutoConfirmEnabled,
    Flag = "AutoConfirmToggle",
    Callback = function(Value)
        getgenv().Settings.AutoConfirmEnabled = Value
        if Value then
            startAutoConfirmLoop()
        end
    end
})

MainTab:CreateSlider({
    Name = "Auto-Confirm Delay (seconds)",
    Range = {0.2, 10},
    Increment = 0.1,
    Suffix = "s",
    CurrentValue = getgenv().Settings.AutoConfirmDelay,
    Flag = "AutoConfirmDelay",
    Callback = function(Value)
        getgenv().Settings.AutoConfirmDelay = Value
    end
})

local PlayerSection = MainTab:CreateSection("Player Selection")

local PlayerDropdown = MainTab:CreateDropdown({
    Name = "Select Player",
    Options = {"None"},
    CurrentOption = "None",
    Flag = "PlayerSelect",
    Callback = function(Option)
        if Option ~= "None" then
            getgenv().Settings.SelectedPlayer = Players:FindFirstChild(Option)
        else
            getgenv().Settings.SelectedPlayer = nil
        end
    end
})

local function updatePlayerList()
    local playerNames = {"None"}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            table.insert(playerNames, player.Name)
        end
    end
    pcall(function()
        PlayerDropdown:Refresh(playerNames, true)
    end)
end

Players.PlayerAdded:Connect(updatePlayerList)
Players.PlayerRemoving:Connect(updatePlayerList
