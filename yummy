local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- Destroy unwanted UI
local blocked = {
    ["ShowGems"] = true,
    ["FTUEAuctionPrompt"] = true,
    ["NotifyFolder"] = true
}

RunService.Heartbeat:Connect(function()
    for _, obj in ipairs(PlayerGui:GetDescendants()) do
        if blocked[obj.Name] or obj:FindFirstAncestor("NotifyFolder") then
            obj:Destroy()
        end
    end
end)

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FarmingToggle"
screenGui.Parent = PlayerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 300, 0, 250) -- Increased size
mainFrame.Position = UDim2.new(0, 20, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
mainFrame.BackgroundTransparency = 0.1
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0,10)
uiCorner.Parent = mainFrame

-- Title
local titleLabel = Instance.new("TextLabel")
titleLabel.Name = "Title"
titleLabel.Size = UDim2.new(1,0,0,35)
titleLabel.Position = UDim2.new(0,0,0,5)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Farming Controls"
titleLabel.TextScaled = true
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextColor3 = Color3.fromRGB(255,255,255)
titleLabel.Parent = mainFrame

-- Status
local statusLabel = Instance.new("TextLabel")
statusLabel.Name = "Status"
statusLabel.Size = UDim2.new(1,-20,0,30)
statusLabel.Position = UDim2.new(0,10,0,40)
statusLabel.BackgroundTransparency = 0.5
statusLabel.BackgroundColor3 = Color3.fromRGB(0,0,0)
statusLabel.Text = "Farming: OFF"
statusLabel.TextScaled = true
statusLabel.Font = Enum.Font.GothamSemibold
statusLabel.TextColor3 = Color3.fromRGB(255,100,100)
statusLabel.Parent = mainFrame

local statusCorner = Instance.new("UICorner")
statusCorner.CornerRadius = UDim.new(0,5)
statusCorner.Parent = statusLabel

-- Gems Display
local gemsLabel = Instance.new("TextLabel")
gemsLabel.Name = "GemsLabel"
gemsLabel.Size = UDim2.new(1,-20,0,30)
gemsLabel.Position = UDim2.new(0,10,0,75)
gemsLabel.BackgroundTransparency = 0.5
gemsLabel.BackgroundColor3 = Color3.fromRGB(0,0,0)
gemsLabel.Text = "Gems: 0"
gemsLabel.TextScaled = true
gemsLabel.Font = Enum.Font.GothamBold
gemsLabel.TextColor3 = Color3.fromRGB(0,255,200)
gemsLabel.Parent = mainFrame

local gemsCorner = Instance.new("UICorner")
gemsCorner.CornerRadius = UDim.new(0,5)
gemsCorner.Parent = gemsLabel

-- Gems per minute
local gemsPerMinLabel = Instance.new("TextLabel")
gemsPerMinLabel.Name = "GemsPerMinLabel"
gemsPerMinLabel.Size = UDim2.new(1,-20,0,30)
gemsPerMinLabel.Position = UDim2.new(0,10,0,110)
gemsPerMinLabel.BackgroundTransparency = 0.5
gemsPerMinLabel.BackgroundColor3 = Color3.fromRGB(0,0,0)
gemsPerMinLabel.Text = "Gems/Min: 0"
gemsPerMinLabel.TextScaled = true
gemsPerMinLabel.Font = Enum.Font.GothamBold
gemsPerMinLabel.TextColor3 = Color3.fromRGB(0,255,200)
gemsPerMinLabel.Parent = mainFrame

local gemsPerMinCorner = Instance.new("UICorner")
gemsPerMinCorner.CornerRadius = UDim.new(0,5)
gemsPerMinCorner.Parent = gemsPerMinLabel

-- FPS Display (Actual FPS, not cap)
local fpsLabel = Instance.new("TextLabel")
fpsLabel.Name = "FPSLabel"
fpsLabel.Size = UDim2.new(1,-20,0,30)
fpsLabel.Position = UDim2.new(0,10,0,145)
fpsLabel.BackgroundTransparency = 0.5
fpsLabel.BackgroundColor3 = Color3.fromRGB(0,0,0)
fpsLabel.Text = "FPS: 0"
fpsLabel.TextScaled = true
fpsLabel.Font = Enum.Font.GothamBold
fpsLabel.TextColor3 = Color3.fromRGB(255,255,0)
fpsLabel.Parent = mainFrame

local fpsCorner = Instance.new("UICorner")
fpsCorner.CornerRadius = UDim.new(0,5)
fpsCorner.Parent = fpsLabel

-- Toggle Button
local toggleButton = Instance.new("TextButton")
toggleButton.Name = "ToggleButton"
toggleButton.Size = UDim2.new(1,-20,0,40)
toggleButton.Position = UDim2.new(0,10,0,180)
toggleButton.BackgroundColor3 = Color3.fromRGB(70,130,200)
toggleButton.TextColor3 = Color3.fromRGB(255,255,255)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.GothamBold
toggleButton.Text = "Start Farming"
toggleButton.Parent = mainFrame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0,5)
buttonCorner.Parent = toggleButton

-- Variables
local farmingActive = false
local heartbeatConnection = nil
local EndTutorialEvent = nil
local DataGetAllEvent = nil
local previousGems = 0
local gemsStart = 0
local gemsPerMin = 0
local lastCheck = tick()
local fpsUpdateTime = tick()
local frameCount = 0
local currentFPS = 0

-- Get remote events
local function setupRemotes()
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("Events"):WaitForChild("Tutorial"):WaitForChild("EndTutorial")
    end)
    if success then
        EndTutorialEvent = result
        
        local success2, result2 = pcall(function()
            return ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")
        end)
        if success2 then
            DataGetAllEvent = result2
            statusLabel.Text = "Connected"
            statusLabel.TextColor3 = Color3.fromRGB(100,255,100)
            
            -- Get initial gems
            local success3, data = pcall(function()
                return DataGetAllEvent:InvokeServer()
            end)
            if success3 then
                gemsStart = data.Gems or 0
                previousGems = gemsStart
            end
        else
            statusLabel.Text = "Data event not found!"
            statusLabel.TextColor3 = Color3.fromRGB(255,100,100)
        end
    else
        statusLabel.Text = "Tutorial event not found!"
        statusLabel.TextColor3 = Color3.fromRGB(255,100,100)
        toggleButton.Text = "Error"
        toggleButton.BackgroundColor3 = Color3.fromRGB(150,150,150)
    end
end

-- Farming toggle
local function toggleFarming()
    if not EndTutorialEvent then
        statusLabel.Text = "Event missing!"
        return
    end
    
    farmingActive = not farmingActive
    
    if farmingActive then
        toggleButton.Text = "Stop Farming"
        toggleButton.BackgroundColor3 = Color3.fromRGB(200,70,70)
        statusLabel.Text = "Farming: ON"
        statusLabel.TextColor3 = Color3.fromRGB(100,255,100)
        
        -- Reset gems tracking when starting
        local success, data = pcall(function()
            return DataGetAllEvent:InvokeServer()
        end)
        if success then
            gemsStart = data.Gems or 0
            previousGems = gemsStart
            lastCheck = tick()
        end
        
        heartbeatConnection = RunService.Heartbeat:Connect(function()
            EndTutorialEvent:FireServer()
        end)
    else
        toggleButton.Text = "Start Farming"
        toggleButton.BackgroundColor3 = Color3.fromRGB(70,130,200)
        statusLabel.Text = "Farming: OFF"
        statusLabel.TextColor3 = Color3.fromRGB(255,100,100)
        
        if heartbeatConnection then
            heartbeatConnection:Disconnect()
            heartbeatConnection = nil
        end
    end
end

toggleButton.MouseButton1Click:Connect(toggleFarming)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.F then
        toggleFarming()
    end
end)

-- Main update loop
RunService.Heartbeat:Connect(function(deltaTime)
    -- FPS calculation
    frameCount = frameCount + 1
    local now = tick()
    if now - fpsUpdateTime >= 1 then
        currentFPS = frameCount / (now - fpsUpdateTime)
        fpsLabel.Text = string.format("FPS: %.1f", currentFPS)
        frameCount = 0
        fpsUpdateTime = now
    end
    
    -- Gems tracking
    if DataGetAllEvent then
        local success, data = pcall(function()
            return DataGetAllEvent:InvokeServer()
        end)
        
        if success and data then
            local currentGems = data.Gems or 0
            gemsLabel.Text = "Gems: "..tostring(currentGems)
            
            -- Gems per minute calculation (resets when farming starts)
            local delta = now - lastCheck
            if delta > 1 then -- Update every second for smoother display
                gemsPerMin = ((currentGems - gemsStart) / delta) * 60
                if gemsPerMin < 0 then gemsPerMin = 0 end
                gemsPerMinLabel.Text = string.format("Gems/Min: %.1f", gemsPerMin)
                
                -- Don't update lastCheck here, we want it to keep accumulating time
            end
        end
    end
end)

-- Initialize
setupRemotes()
