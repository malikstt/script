local ReplicatedStorage=game:GetService("ReplicatedStorage")
local Players=game:GetService("Players")
local LocalPlayer=Players.LocalPlayer
local taskWait=task.wait

local AuctionsFolder=workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule=require(ReplicatedStorage.Modules.Items)
local GaragesModule=require(ReplicatedStorage.Modules.Garages)
local RepLibrary=require(ReplicatedStorage.Modules.RepLibrary)

local Auctions=ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue=Auctions:WaitForChild("EnterQueue")
local Skip=Auctions:WaitForChild("Skip")
local SkipCountdown=Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid=Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid=Auctions:WaitForChild("PlaceBid")
local DataEvent=ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

local SCAN_DURATION=2
local BID_CHECK_INTERVAL=0.2
local SKIP_COOLDOWN=1
local SALE_PENALTY=0.05

local inAuction=false
local auctionEnded=false
local halted=false
local currentNextBid
local currentBidder
local currentGarage=nil
local lastSkipTime=0

local function calculateGarageValue(itemsFolder)
	local total=0
	if not itemsFolder then return 0 end
	for _,inst in pairs(itemsFolder:GetChildren()) do
		local itemData=ItemsModule[inst.Name]
		if type(itemData)=="table" and itemData.Price then
			total+=itemData.Price
		end
	end
	return total
end

UpdateCurrentBid.OnClientEvent:Connect(function(data)
	if data then
		currentNextBid=data.nextBid
		currentBidder=data.player
	end
end)

AuctionsFolder.ChildAdded:Connect(function(garage)
	inAuction=true
	auctionEnded=false
	currentGarage=garage
	print("Entered garage:",garage.Name)
end)

AuctionsFolder.ChildRemoved:Connect(function()
	if #AuctionsFolder:GetChildren()==0 then
		inAuction=false
		currentGarage=nil
		print("Left auction")
	end
end)

local function storageFull()
	local success,data=pcall(function()return DataEvent:InvokeServer()end)
	if not success or not data then return false end
	local inv=data.Inventory or {}
	local invLevel=data.InventoryLevel
	local carryLevel=data.CarryLevel
	local carrySpace=RepLibrary:GetCarrySpace(LocalPlayer,carryLevel)
	local invSpace=RepLibrary:GetInventorySpace(LocalPlayer,invLevel)
	local invCount=RepLibrary:GetLengthOfInventory(inv)
	return invCount>=invSpace and carrySpace<=0
end

local function tryClick(obj)
	if obj:IsA("TextButton") or obj:IsA("ImageButton") then
		pcall(function() obj:Activate() end)
		if getconnections then
			for _,v in pairs(getconnections(obj.MouseButton1Click)) do
				pcall(function() v:Fire() end)
			end
		end
	end
end

local function scanCurrentGarageItems()
	if not currentGarage then return nil end
	local itemsFolder=currentGarage:FindFirstChild("Items")
	if not itemsFolder then return nil end
	taskWait(0.5)
	local start=tick()
	while tick()-start<SCAN_DURATION do
		taskWait(0.2)
	end
	return itemsFolder
end

local function handleItemsWon()
	local gui=LocalPlayer.PlayerGui:FindFirstChild("ItemsWon")
	if gui then
		local confirmButton=gui:FindFirstChild("ItemsFrame")
		if confirmButton then
			confirmButton=confirmButton:FindFirstChild("ConfirmButton")
			if confirmButton then
				repeat task.wait() until confirmButton.Visible
				tryClick(confirmButton)
				print("Confirmed items")
			end
		end

		local sellItems=gui:FindFirstChild("SellItems")
		if sellItems then
			local frame=sellItems:FindFirstChild("Frame")
			if frame then
				local normal=frame:FindFirstChild("Normal")
				if normal then
					local button=normal:FindFirstChild("Button")
					if button then
						repeat task.wait() until button.Visible
						tryClick(button)
						print("Sold all items")
					end
				end
			end
		end
	end
end

while not halted do
	if storageFull() then
		print("Storage full. Stopping.")
		break
	end

	print("Entering auction...")
	pcall(function()EnterQueue:InvokeServer("51")end)

	local start=tick()
	repeat taskWait(0.1) until inAuction or tick()-start>10
	if not inAuction then continue end

	while inAuction and not auctionEnded do
		local itemsFolder=scanCurrentGarageItems()
		local garageValue=calculateGarageValue(itemsFolder)
		print("Total garage value:",garageValue)

		if garageValue>0 then
			local maxSafeBid=garageValue*(1-SALE_PENALTY)
			if currentNextBid and currentNextBid<maxSafeBid and currentBidder~=LocalPlayer then
				local bidAmount=currentNextBid+1
				if bidAmount>maxSafeBid then bidAmount=maxSafeBid end
				pcall(function()PlaceBid:InvokeServer(bidAmount)end)
				print("Bidding:",bidAmount)
			end

			local bidStart=tick()
			while inAuction and currentGarage and not auctionEnded do
				if tick()-bidStart>30 then break end
				taskWait(BID_CHECK_INTERVAL)
			end
		else
			if currentGarage and tick()-lastSkipTime>SKIP_COOLDOWN then
				pcall(function()SkipCountdown:InvokeServer()end)
				taskWait(0.1)
				pcall(function()Skip:InvokeServer()end)
				lastSkipTime=tick()
				print("Skipped garage")
			end
			taskWait(1)
		end
		taskWait(0.5)
	end

	taskWait(3)
	handleItemsWon()
	taskWait(1)
end
