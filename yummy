local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Wait for game services
local Network = ReplicatedStorage
    :WaitForChild("Shared")
    :WaitForChild("Framework")
    :WaitForChild("Network")
    :WaitForChild("Remote")
    :WaitForChild("RemoteEvent")

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local PetsModule = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Data"):WaitForChild("Pets"))

-- Create window
local Window = Rayfield:CreateWindow({
    Name = "Ultimate Trade Tool",
    ConfigurationSaving = {Enabled = false},
    LoadingTitle = "Pet Trader",
    LoadingSubtitle = "Secret Variant Loop"
})

-- Create tabs
local MainTab = Window:CreateTab("Main", 4483362458)
local TradeTab = Window:CreateTab("Trade Settings", 4483362458)
local PetAdderTab = Window:CreateTab("Secret Pet Adder", 4483362458)

-- ========== MAIN TRADE CONTROLS ==========
local autoTrade = false
local autoTradeDelay = 1
local autoConfirm = false
local autoConfirmDelay = 1
local targetName = nil

local tradeLoopRunning = false
local confirmLoopRunning = false

local function StartTradeLoop()
    if tradeLoopRunning then return end
    tradeLoopRunning = true
    task.spawn(function()
        while tradeLoopRunning do
            if autoTrade and targetName then
                local target = Players:WaitForChild(targetName)
                local args = {
                    "TradeRequest",
                    target
                }
                Network:FireServer(unpack(args))
            end
            task.wait(autoTradeDelay)
        end
    end)
end

local function StartConfirmLoop()
    if confirmLoopRunning then return end
    confirmLoopRunning = true
    task.spawn(function()
        while confirmLoopRunning do
            if autoConfirm then
                local args = {
                    "TradeConfirm"
                }
                Network:FireServer(unpack(args))
            end
            task.wait(autoConfirmDelay)
        end
    end)
end

-- Main tab controls
MainTab:CreateToggle({
    Name = "Auto Trade",
    CurrentValue = false,
    Callback = function(v)
        autoTrade = v
        if v then
            StartTradeLoop()
        else
            tradeLoopRunning = false
        end
    end
})

MainTab:CreateSlider({
    Name = "Trade Delay",
    Range = {0.1, 10},
    Increment = 0.1,
    Suffix = "seconds",
    CurrentValue = 1,
    Callback = function(v)
        autoTradeDelay = v
    end
})

MainTab:CreateToggle({
    Name = "Auto Confirm",
    CurrentValue = false,
    Callback = function(v)
        autoConfirm = v
        if v then
            StartConfirmLoop()
        else
            confirmLoopRunning = false
        end
    end
})

MainTab:CreateSlider({
    Name = "Confirm Delay",
    Range = {0.1, 10},
    Increment = 0.1,
    Suffix = "seconds",
    CurrentValue = 1,
    Callback = function(v)
        autoConfirmDelay = v
    end
})

-- Player dropdown
local playerList = {"None"}
for _, p in ipairs(Players:GetPlayers()) do
    if p ~= Players.LocalPlayer then
        table.insert(playerList, p.Name)
    end
end

local Dropdown = MainTab:CreateDropdown({
    Name = "Select Player",
    Options = playerList,
    CurrentOption = "None",
    Callback = function(option)
        local name
        if typeof(option) == "table" then
            name = option[1]
        else
            name = option
        end

        if name == "None" then
            targetName = nil
        else
            targetName = name
        end
    end
})

Players.PlayerAdded:Connect(function(p)
    if p ~= Players.LocalPlayer then
        table.insert(playerList, p.Name)
        Dropdown:Refresh(playerList, true)
    end
end)

Players.PlayerRemoving:Connect(function(p)
    for i, v in ipairs(playerList) do
        if v == p.Name then
            table.remove(playerList, i)
            break
        end
    end
    Dropdown:Refresh(playerList, true)
end)

-- ========== TRADE SETTINGS TAB ==========
TradeTab:CreateLabel("Trade Configuration")
TradeTab:CreateParagraph({Title = "Information", Content = "Configure your trade settings here. Use Main tab for auto-trading and Pet Adder for secret pets."})

-- ========== SECRET PET ADDER TAB ==========
local petAmount = 10
local petAuto = {Normal = false, Shiny = false, Mythic = false, ShinyMythic = false}

-- Get all secret pet names
local secretNames = {}
for name, info in pairs(PetsModule) do
    if info.Rarity == "Secret" then
        secretNames[name] = true
    end
end

local function formatPetId(petId)
    local s = tostring(petId)
    if not s:match(":") then
        return s .. ":0"
    end
    return s
end

local function getSecretByVariant()
    local res = {Normal = {}, Shiny = {}, Mythic = {}, ShinyMythic = {}}
    local data = LocalData:Get()
    if not data or not data.Pets then return res end

    for _, pet in pairs(data.Pets) do
        if secretNames[pet.Name] then
            local v
            if pet.Shiny and pet.Mythic then
                v = "ShinyMythic"
            elseif pet.Shiny then
                v = "Shiny"
            elseif pet.Mythic then
                v = "Mythic"
            else
                v = "Normal"
            end
            table.insert(res[v], pet.Id)
        end
    end

    return res
end

local function addFromList(list)
    for i = 1, math.min(petAmount, #list) do
        Network:FireServer("TradeAddPet", formatPetId(list[i]))
        task.wait(0.2)
    end
end

local function startPetLoop(key)
    task.spawn(function()
        while petAuto[key] do
            local all = getSecretByVariant()
            local list = all[key]
            if list and #list > 0 then
                addFromList(list)
            end
            task.wait(0.5)
        end
    end)
end

PetAdderTab:CreateSlider({
    Name = "Amount per cycle",
    Range = {10, 30},
    Increment = 1,
    Suffix = "pets",
    CurrentValue = petAmount,
    Callback = function(v)
        petAmount = v
    end,
})

-- Create stats display
local statsLabel = PetAdderTab:CreateLabel("Inventory Stats: Loading...")

local function updateStatsDisplay()
    local all = getSecretByVariant()
    local statsText = "Secret Pets Inventory:\n"
    statsText = statsText .. "• Normal: " .. #all.Normal .. "\n"
    statsText = statsText .. "• Shiny: " .. #all.Shiny .. "\n"
    statsText = statsText .. "• Mythic: " .. #all.Mythic .. "\n"
    statsText = statsText .. "• ShinyMythic: " .. #all.ShinyMythic
    
    statsLabel:Set(statsText)
end

-- Refresh button
PetAdderTab:CreateButton({
    Name = "Refresh Stats",
    Callback = function()
        updateStatsDisplay()
    end
})

-- Create auto toggles for each variant
for _, key in ipairs({"Normal","Shiny","Mythic","ShinyMythic"}) do
    PetAdderTab:CreateToggle({
        Name = "Auto Secret " .. key,
        CurrentValue = false,
        Callback = function(v)
            petAuto[key] = v
            if v then
                startPetLoop(key)
            end
        end,
    })
end

-- Add a button to manually add all secrets
PetAdderTab:CreateButton({
    Name = "Add All Secret Pets (Manual)",
    Callback = function()
        local all = getSecretByVariant()
        local totalAdded = 0
        
        for _, variant in pairs(all) do
            for i = 1, math.min(petAmount, #variant) do
                Network:FireServer("TradeAddPet", formatPetId(variant[i]))
                task.wait(0.2)
                totalAdded = totalAdded + 1
            end
        end
        
        Rayfield:Notify({
            Title = "Pet Adder",
            Content = "Added " .. totalAdded .. " secret pets to trade",
            Duration = 3,
            Image = 4483362458
        })
    end
})

-- Initialize stats display
updateStatsDisplay()

-- Auto-refresh stats every 10 seconds
task.spawn(function()
    while true do
        task.wait(10)
        if not game:GetService("CoreGui"):FindFirstChild("Rayfield") then break end
        updateStatsDisplay()
    end
end)

-- Notification when loaded
Rayfield:Notify({
    Title = "Ultimate Trade Tool",
    Content = "Script loaded successfully!",
    Duration = 3,
    Image = 4483362458
})
