getgenv().waitTime = 2.5
getgenv().running = not getgenv().running
getgenv().autoGift = not getgenv().autoGift

local RS = game:GetService("ReplicatedStorage")
local RemoteEventRef = RS.Shared.Framework.Network.Remote.RemoteEvent
local Remote = require(RS.Shared.Framework.Network.Remote)
local PhysicalItem = require(RS.Client.Effects.PhysicalItem)
local LocalData = require(RS.Client.Framework.Services.LocalData)
local RunService = game:GetService("RunService")

local function getData()
    return LocalData:Get()
end

local potions = {
    {"Speed", 7},
    {"Lucky", 7},
    {"Egg Elixir", 1},
    {"Mythic", 7},
    {"Coins", 7},
    {"Tickets", 7},
}

local idx = 1
task.spawn(function()
    RunService.Heartbeat:Connect(function()
        if getgenv().running then
            local p = potions[idx]
            if p then
                RemoteEventRef:FireServer("UsePotion", p[1], p[2])
            end
            idx += 1
            if idx > #potions then idx = 1 end
        end
    end)
end)

getgenv().oldGift = getgenv().oldGift or PhysicalItem.Gift
PhysicalItem.Gift = function(gid, gtype, gpos)
    if not getgenv().autoGift then
        return getgenv().oldGift(gid, gtype, gpos)
    end
    task.spawn(function()
        pcall(function()
            Remote:FireServer("ClaimGift", gid)
        end)
    end)
    return nil
end

getgenv().popUpConnection = getgenv().popUpConnection or nil
local gen = workspace.Rendered:FindFirstChild("Generic")
if getgenv().autoGift then
    if gen and not getgenv().popUpConnection then
        getgenv().popUpConnection = gen.ChildAdded:Connect(function(i)
            if i:IsA("Part") and #i.Name == 36 then i:Destroy() end
        end)
    end
else
    if getgenv().popUpConnection then
        getgenv().popUpConnection:Disconnect()
        getgenv().popUpConnection = nil
    end
end

RemoteEventRef:FireServer("SetSetting", "Ultra Low Detail Mode", true)

task.spawn(function()
    if getgenv().autoGift then
        local data = getData()
        if not data or not data.Powerups then return end
        local powerups = data.Powerups
        local boxes = {}

        for n,a in pairs(powerups) do
            if not string.find(n,"Mystery Box") and a > 0 then
                table.insert(boxes, {name=n, amount=a})
            end
        end

        table.sort(boxes, function(a,b) return a.amount > b.amount end)

        for _,box in ipairs(boxes) do
            while getgenv().autoGift do
                local am = getData().Powerups[box.name] or 0
                if am > 0 then
                    Remote:FireServer("UseGift", box.name, (am > 25 and 25 or am))
                    task.wait(getgenv().waitTime)
                else
                    break
                end
            end
        end
    end
end)
