local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

--[[
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    SILLY HUB - Ultimate Pet Simulator Trader
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
    WHAT THIS SCRIPT DOES:
    â€¢ Auto-trades with selected players
    â€¢ Auto-confirms trades for instant completion
    â€¢ Adds secret pets to trades automatically
    â€¢ Saves your settings so you don't have to reconfigure
    
    FEATURES EXPLAINED:
    1. Auto Trade: Automatically sends trade requests to selected player
    2. Auto Accept: Accepts incoming trade requests automatically
    3. Auto Confirm: Confirms your side of the trade automatically
    4. Secret Pet Adder: Automatically adds your secret pets to trades
    5. Config Saving: Remembers your settings between game sessions
]]

-- Wait for game services to load
local Network = ReplicatedStorage
    :WaitForChild("Shared")
    :WaitForChild("Framework")
    :WaitForChild("Network")
    :WaitForChild("Remote")
    :WaitForChild("RemoteEvent")

-- Load required modules
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local PetsModule = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Data"):WaitForChild("Pets"))

-- Create Silly Hub window with config saving enabled
local Window = Rayfield:CreateWindow({
    Name = "Silly Hub - Pet Trader",
    ConfigurationSaving = {
        Enabled = true,  -- This enables config saving
        FolderName = "SillyHubConfigs"  -- Folder where configs are saved
    },
    LoadingTitle = "Silly Hub Loading...",
    LoadingSubtitle = "Making trading silly since 2024!"
})

-- Create tabs (removed useless 2nd tab)
local MainTab = Window:CreateTab("Trade Controls", 4483362458)  -- Changed to Trade Controls
local PetAdderTab = Window:CreateTab("Secret Pet Manager", 4483362458)

-- ========== CONFIGURATION VARIABLES ==========
-- These will be saved automatically thanks to Rayfield's ConfigurationSaving
local autoTrade = false           -- Auto send trade requests
local autoAccept = false          -- Auto accept incoming trades (NEW FEATURE)
local autoConfirm = false         -- Auto confirm trade
local autoTradeDelay = 1          -- Delay between trade requests
local autoConfirmDelay = 1        -- Delay before confirming
local targetName = nil            -- Player to trade with

local tradeLoopRunning = false    -- Controls trade request loop
local acceptLoopRunning = false   -- Controls accept loop (NEW)
local confirmLoopRunning = false  -- Controls confirm loop

-- Pet Adder variables
local petAmount = 10              -- How many pets to add per cycle
local petAuto = {                 -- Auto-add for each variant
    Normal = false,
    Shiny = false,
    Mythic = false,
    ShinyMythic = false
}

-- ========== TRADE FUNCTIONS ==========

-- Function to start auto-trade loop
local function StartTradeLoop()
    if tradeLoopRunning then return end
    tradeLoopRunning = true
    
    task.spawn(function()
        -- This loop runs continuously while auto-trade is enabled
        while tradeLoopRunning do
            if autoTrade and targetName then
                local target = Players:FindFirstChild(targetName)
                if target then
                    local args = {
                        "TradeRequest",
                        target
                    }
                    Network:FireServer(unpack(args))
                end
            end
            task.wait(autoTradeDelay)
        end
    end)
end

-- NEW FUNCTION: Auto-accept trades
local function StartAcceptLoop()
    if acceptLoopRunning then return end
    acceptLoopRunning = true
    
    task.spawn(function()
        -- This loop continuously accepts incoming trades
        while acceptLoopRunning do
            if autoAccept then
                local args = {"TradeAccept"}
                Network:FireServer(unpack(args))
            end
            task.wait(0.5) -- Check every 0.5 seconds for incoming trades
        end
    end)
end

-- Function to start auto-confirm loop
local function StartConfirmLoop()
    if confirmLoopRunning then return end
    confirmLoopRunning = true
    
    task.spawn(function()
        -- This loop confirms trades automatically
        while confirmLoopRunning do
            if autoConfirm then
                local args = {"TradeConfirm"}
                Network:FireServer(unpack(args))
            end
            task.wait(autoConfirmDelay)
        end
    end)
end

-- ========== MAIN TAB CONTROLS ==========
MainTab:CreateLabel("ğŸ¤– Auto Trade Controls")
MainTab:CreateParagraph({
    Title = "How to use:",
    Content = "1. Select a player from dropdown\n2. Enable auto-trade features\n3. Your settings save automatically!\n\nTip: Use delays to avoid getting flagged."
})

-- Player selection dropdown
local playerList = {"None"}
for _, p in ipairs(Players:GetPlayers()) do
    if p ~= Players.LocalPlayer then
        table.insert(playerList, p.Name)
    end
end

local Dropdown = MainTab:CreateDropdown({
    Name = "ğŸ¯ Select Trading Partner",
    Options = playerList,
    CurrentOption = "None",
    Callback = function(option)
        local name
        if typeof(option) == "table" then
            name = option[1]
        else
            name = option
        end

        if name == "None" then
            targetName = nil
            Rayfield:Notify({
                Title = "Silly Hub",
                Content = "Player selection cleared",
                Duration = 2,
                Image = 4483362458
            })
        else
            targetName = name
            Rayfield:Notify({
                Title = "Silly Hub",
                Content = "Now trading with: " .. name,
                Duration = 3,
                Image = 4483362458
            })
        end
    end
})

-- Auto-trade toggle
MainTab:CreateToggle({
    Name = "ğŸ”„ Auto Trade Request",
    CurrentValue = autoTrade,
    Callback = function(v)
        autoTrade = v
        if v then
            StartTradeLoop()
            Rayfield:Notify({
                Title = "Auto Trade",
                Content = "Now sending trade requests automatically",
                Duration = 3,
                Image = 4483362458
            })
        else
            tradeLoopRunning = false
        end
    end
})

-- Trade delay slider
MainTab:CreateSlider({
    Name = "â±ï¸ Trade Request Delay",
    Range = {0.5, 10},
    Increment = 0.1,
    Suffix = "seconds",
    CurrentValue = autoTradeDelay,
    Callback = function(v)
        autoTradeDelay = v
    end
})

-- NEW: Auto-accept toggle
MainTab:CreateToggle({
    Name = "âœ… Auto Accept Trades",
    CurrentValue = autoAccept,
    Callback = function(v)
        autoAccept = v
        if v then
            StartAcceptLoop()
            Rayfield:Notify({
                Title = "Auto Accept",
                Content = "Now accepting incoming trades automatically",
                Duration = 3,
                Image = 4483362458
            })
        else
            acceptLoopRunning = false
        end
    end
})

-- Auto-confirm toggle
MainTab:CreateToggle({
    Name = "âœ“ Auto Confirm Trade",
    CurrentValue = autoConfirm,
    Callback = function(v)
        autoConfirm = v
        if v then
            StartConfirmLoop()
            Rayfield:Notify({
                Title = "Auto Confirm",
                Content = "Now confirming trades automatically",
                Duration = 3,
                Image = 4483362458
            })
        else
            confirmLoopRunning = false
        end
    end
})

-- Confirm delay slider
MainTab:CreateSlider({
    Name = "â±ï¸ Confirm Delay",
    Range = {0.1, 5},
    Increment = 0.1,
    Suffix = "seconds",
    CurrentValue = autoConfirmDelay,
    Callback = function(v)
        autoConfirmDelay = v
    end
})

-- ========== PLAYER LIST UPDATES ==========
-- Update dropdown when players join
Players.PlayerAdded:Connect(function(p)
    if p ~= Players.LocalPlayer then
        table.insert(playerList, p.Name)
        Dropdown:Refresh(playerList, true)
    end
end)

-- Update dropdown when players leave
Players.PlayerRemoving:Connect(function(p)
    for i, v in ipairs(playerList) do
        if v == p.Name then
            table.remove(playerList, i)
            break
        end
    end
    Dropdown:Refresh(playerList, true)
end)

-- ========== SECRET PET ADDER TAB ==========
PetAdderTab:CreateLabel("ğŸŒŸ Secret Pet Manager")
PetAdderTab:CreateParagraph({
    Title = "How it works:",
    Content = "This automatically adds your secret pets to trades.\nEnable auto-add for specific variants or use manual buttons.\n\nNote: Only adds pets from your inventory!"
})

-- Get all secret pet names
local secretNames = {}
for name, info in pairs(PetsModule) do
    if info.Rarity == "Secret" then
        secretNames[name] = true
    end
end

-- Format pet ID for trading
local function formatPetId(petId)
    local s = tostring(petId)
    if not s:match(":") then
        return s .. ":0"
    end
    return s
end

-- Get all secret pets categorized by variant
local function getSecretByVariant()
    local res = {
        Normal = {},
        Shiny = {},
        Mythic = {},
        ShinyMythic = {}
    }
    
    local data = LocalData:Get()
    if not data or not data.Pets then return res end

    for _, pet in pairs(data.Pets) do
        if secretNames[pet.Name] then
            local variant
            if pet.Shiny and pet.Mythic then
                variant = "ShinyMythic"
            elseif pet.Shiny then
                variant = "Shiny"
            elseif pet.Mythic then
                variant = "Mythic"
            else
                variant = "Normal"
            end
            table.insert(res[variant], pet.Id)
        end
    end

    return res
end

-- Add pets from list to trade
local function addFromList(list)
    for i = 1, math.min(petAmount, #list) do
        Network:FireServer("TradeAddPet", formatPetId(list[i]))
        task.wait(0.2) -- Delay to prevent rate limiting
    end
end

-- Start auto-adding loop for specific variant
local function startPetLoop(key)
    task.spawn(function()
        while petAuto[key] do
            local all = getSecretByVariant()
            local list = all[key]
            if list and #list > 0 then
                addFromList(list)
            end
            task.wait(0.5) -- Check inventory every 0.5 seconds
        end
    end)
end

-- Create stats display
local statsLabel = PetAdderTab:CreateLabel("ğŸ“Š Loading inventory stats...")

-- Function to update inventory display
local function updateStatsDisplay()
    local all = getSecretByVariant()
    local statsText = "ğŸŒŸ Secret Pets Inventory:\n"
    statsText = statsText .. "â€¢ Normal: " .. #all.Normal .. "\n"
    statsText = statsText .. "â€¢ Shiny: " .. #all.Shiny .. "\n"
    statsText = statsText .. "â€¢ Mythic: " .. #all.Mythic .. "\n"
    statsText = statsText .. "â€¢ ShinyMythic: " .. #all.ShinyMythic
    
    statsLabel:Set(statsText)
end

-- Refresh button
PetAdderTab:CreateButton({
    Name = "ğŸ”„ Refresh Inventory",
    Callback = function()
        updateStatsDisplay()
        Rayfield:Notify({
            Title = "Inventory",
            Content = "Inventory stats refreshed!",
            Duration = 2,
            Image = 4483362458
        })
    end
})

-- Amount per cycle slider
PetAdderTab:CreateSlider({
    Name = "ğŸ“¦ Pets Per Cycle",
    Range = {1, 30},
    Increment = 1,
    Suffix = "pets",
    CurrentValue = petAmount,
    Callback = function(v)
        petAmount = v
    end,
})

-- Create auto-add toggles for each variant
local variantIcons = {
    Normal = "â­",
    Shiny = "âœ¨",
    Mythic = "ğŸ”®",
    ShinyMythic = "ğŸŒŸ"
}

for _, key in ipairs({"Normal","Shiny","Mythic","ShinyMythic"}) do
    PetAdderTab:CreateToggle({
        Name = variantIcons[key] .. " Auto Add " .. key .. " Secrets",
        CurrentValue = petAuto[key],
        Callback = function(v)
            petAuto[key] = v
            if v then
                startPetLoop(key)
                Rayfield:Notify({
                    Title = "Auto Add",
                    Content = "Now auto-adding " .. key .. " secrets",
                    Duration = 3,
                    Image = 4483362458
                })
            end
        end,
    })
end

-- Manual add buttons
PetAdderTab:CreateLabel("ğŸ› ï¸ Manual Controls")

PetAdderTab:CreateButton({
    Name = "ğŸ¯ Add All Secret Pets (Manual)",
    Callback = function()
        local all = getSecretByVariant()
        local totalAdded = 0
        
        task.spawn(function()
            for _, variant in pairs(all) do
                for i = 1, math.min(petAmount, #variant) do
                    Network:FireServer("TradeAddPet", formatPetId(variant[i]))
                    task.wait(0.2)
                    totalAdded = totalAdded + 1
                end
            end
            
            Rayfield:Notify({
                Title = "Manual Add",
                Content = "Added " .. totalAdded .. " secret pets to trade",
                Duration = 3,
                Image = 4483362458
            })
            
            updateStatsDisplay()
        end)
    end
})

-- Initialize stats display
updateStatsDisplay()

-- Auto-refresh stats every 15 seconds
task.spawn(function()
    while true do
        task.wait(15)
        if not game:GetService("CoreGui"):FindFirstChild("Rayfield") then break end
        updateStatsDisplay()
    end
end)

-- ========== FINAL SETUP ==========
-- Send notification when loaded
task.wait(1)
Rayfield:Notify({
    Title = "Silly Hub Loaded! ğŸ‰",
    Content = "Your configs are automatically saved!\nEnjoy easy pet trading!",
    Duration = 5,
    Image = 4483362458
})

print("Silly Hub - Ultimate Pet Trader loaded successfully!")
print("Features: Auto Trade, Auto Accept, Auto Confirm, Secret Pet Adder")
print("Config saving is ENABLED - your settings will be remembered!")
