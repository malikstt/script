local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer
local taskWait = task.wait

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local ItemsModule = require(ReplicatedStorage.Modules.Items)
local RepLibrary = require(ReplicatedStorage.Modules.RepLibrary)

-- WEBHOOK for auction items
local AUCTION_WEBHOOK = "https://discord.com/api/webhooks/1473040107572297761/-FOyJPBRqHg9EYpyhC8x-yz7dk9Z9-D6FYfTt9IbrjV75UoxLtfDfCmPVujy9HvTADEo"

local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")
local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

local TARGET_ITEM_ID = "681"
local SCAN_DURATION = 2
local BID_CHECK_INTERVAL = 0.2

local inAuction = false
local obtainedTarget = false
local auctionEnded = false
local halted = false
local currentNextBid
local currentBidder
local currentGarage = nil
local garagesSkipped = 0
local MAX_GARAGES = 3

local lastSkipTime = 0
local SKIP_COOLDOWN = 1

local targetItemName = ItemsModule[TARGET_ITEM_ID] and ItemsModule[TARGET_ITEM_ID].Name or "Unknown"
local targetItemPrice = ItemsModule[TARGET_ITEM_ID] and ItemsModule[TARGET_ITEM_ID].Price or 0
print("ðŸ” Targeting:", targetItemName, "($" .. targetItemPrice .. ") ID:", TARGET_ITEM_ID)

local function postWebhook(url, data)
    request({
        Url = url,
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json"
        },
        Body = HttpService:JSONEncode(data)
    })
end

-- Send auction item notification
local function sendAuctionNotification(playerName, itemName, itemPrice)
    postWebhook(AUCTION_WEBHOOK, {
        username = "Auction Item",
        embeds = {{
            title = "ðŸŽ‰ Auction Item Obtained!",
            description = playerName .. " just got a **" .. itemName .. "** from the auction house for **$" .. itemPrice .. "**!",
            color = 0x9b59b6, -- Purple
            footer = {
                text = "Auction Success"
            }
        }}
    })
    print("âœ¨ Auction notification sent to Discord for:", itemName)
end

UpdateCurrentBid.OnClientEvent:Connect(function(data)
    if data then
        currentNextBid = data.nextBid
        currentBidder = data.player
    end
end)

AuctionsFolder.ChildAdded:Connect(function(garage)
    inAuction = true
    auctionEnded = false
    currentGarage = garage
    garagesSkipped = 0
    print("ðŸ Entered garage:", garage.Name)
end)

AuctionsFolder.ChildRemoved:Connect(function(garage)
    if #AuctionsFolder:GetChildren() == 0 then
        inAuction = false
        currentGarage = nil
        print("ðŸ Left auction")
    end
end)

local function storageFull()
    local success, data = pcall(function() return DataEvent:InvokeServer() end)
    if not success or not data then return false end
    local inv = data.Inventory or {}
    local invLevel = data.InventoryLevel
    local carryLevel = data.CarryLevel
    local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, carryLevel)
    local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, invLevel)
    local invCount = RepLibrary:GetLengthOfInventory(inv)

    return invCount >= invSpace and carrySpace <= 0
end

local function clickButton(btn)
    if not btn then return end
    pcall(function()
        btn:Activate()
        if getconnections then
            for _, connection in pairs(getconnections(btn.MouseButton1Click)) do
                pcall(function() connection:Function() end)
            end
        end
    end)
end

local function scanCurrentGarageForTarget()
    if not currentGarage then return false end

    local itemsFolder = currentGarage:FindFirstChild("Items")
    if not itemsFolder then return false end

    taskWait(0.5)

    local startTime = tick()
    while tick() - startTime < SCAN_DURATION do
        for _, itemInstance in pairs(itemsFolder:GetChildren()) do
            if itemInstance.Name == TARGET_ITEM_ID then
                print("ðŸŽ¯ Target found in garage:", currentGarage.Name)
                return true
            end
        end
        taskWait(0.2)
    end

    return false
end

local function tryClick(obj)
    if obj:IsA("TextButton") or obj:IsA("ImageButton") then
        print("Auto clicking:", obj:GetFullName())

        pcall(function()
            obj:Activate()
        end)

        if getconnections then
            for _, v in pairs(getconnections(obj.MouseButton1Click)) do
                pcall(function()
                    v:Fire()
                end)
            end
        end
    end
end

local function checkForButton()
    local itemsWon = LocalPlayer.PlayerGui:FindFirstChild("ItemsWon", true)
    if itemsWon then
        local button = itemsWon:FindFirstChild("Button", true)
        if button then
            tryClick(button)
        end
    end
end

while not halted do
    if storageFull() then
        print("âŒ Storage completely full. Script halted.")
        halted = true
        break
    end

    print("âž¡ Entering auction...")
    pcall(function() EnterQueue:InvokeServer("51") end)

    local auctionStartTime = tick()
    auctionEnded = false

    repeat
        taskWait(0.1)
    until inAuction or tick() - auctionStartTime > 10

    if not inAuction then
        continue
    end

    obtainedTarget = false
    garagesSkipped = 0
    local targetFoundInThisAuction = false

    while inAuction and not auctionEnded do
        if scanCurrentGarageForTarget() then
            targetFoundInThisAuction = true
            print("ðŸ’µ Bidding in target garage")

            local bidStartTime = tick()
            while not obtainedTarget and inAuction and currentGarage and not auctionEnded do
                if currentNextBid and currentBidder ~= LocalPlayer then
                    pcall(function() PlaceBid:InvokeServer(currentNextBid) end)
                end
                if tick() - bidStartTime > 60 then break end
                taskWait(BID_CHECK_INTERVAL)
            end
        else
            garagesSkipped = garagesSkipped + 1
            print("â­ Skipping garage", garagesSkipped.."/"..MAX_GARAGES)

            if currentGarage and tick() - lastSkipTime > SKIP_COOLDOWN then
                pcall(function() SkipCountdown:InvokeServer() end)
                taskWait(0.1)
                pcall(function() Skip:InvokeServer() end)
                lastSkipTime = tick()
            end
            taskWait(1)
        end
        taskWait(0.5)
    end

    taskWait(3)

    if targetFoundInThisAuction then
        local player = Players.LocalPlayer
        local gui = player.PlayerGui:WaitForChild("ItemsWon")

        local Items = require(game.ReplicatedStorage.Modules.Items)

        local TARGET_ID = 681
        local targetData = Items[TARGET_ID] or Items[tostring(TARGET_ID)]

        if targetData then
            local clickedCount = 0

            local function scan()
                local frame = gui:WaitForChild("ItemsFrame"):WaitForChild("Frame")
                
                for _, item in ipairs(frame:GetChildren()) do
                    if item:IsA("ImageButton") and item:FindFirstChild("Price") and item:FindFirstChild("Rarity") then
                        
                        local price = tonumber(item.Price.Text:match("%d+"))
                        local rarity = item.Rarity.TextLabel.Text
                        
                        if price == targetData.Price
                        and rarity == targetData.Rarity
                        and targetData.SafeId then
                            
                            tryClick(item)
                            clickedCount = clickedCount + 1
                            
                            -- Send webhook notification for auction item
                            sendAuctionNotification(LocalPlayer.Name, targetData.Name, targetData.Price)
                            
                            task.wait(0.15)
                        end
                    end
                end
            end

            task.wait(0.5)
            scan()

            if clickedCount <= 0 then
                local done = false
                local conn
                conn = gui.DescendantAdded:Connect(function()
                    task.wait(0.2)
                    scan()
                    if clickedCount > 0 then
                        done = true
                        conn:Disconnect()
                    end
                end)
                
                repeat task.wait() until done
            end

            repeat task.wait() until clickedCount > 0

            print("Selected", clickedCount, targetData.Name)

            task.wait(0.5)

            local confirmButton = gui
                :WaitForChild("ItemsFrame")
                :WaitForChild("ConfirmButton")

            repeat task.wait() until confirmButton.Visible

            tryClick(confirmButton)

            print("Confirmed")

            task.wait(0.5)

            local sellButton = gui
                :WaitForChild("SellItems")
                :WaitForChild("Frame")
                :WaitForChild("Normal")
                :WaitForChild("Button")

            repeat task.wait() until sellButton.Visible

            tryClick(sellButton)

            print("Sold rest")
        end
    else
        checkForButton()
        LocalPlayer.PlayerGui.DescendantAdded:Connect(function(obj)
            if obj.Name == "Button" then
                task.wait()
                tryClick(obj)
            end
        end)

        task.spawn(function()
            local timeout = tick() + 5
            while tick() < timeout do
                task.wait(0.5)
                checkForButton()
            end
        end)
    end

    task.wait(1)
end
