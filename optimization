getgenv().waitTime = 2.5

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local Remote = require(ReplicatedStorage.Shared.Framework.Network.Remote)
local PhysicalItem = require(ReplicatedStorage.Client.Effects.PhysicalItem)
local LocalDataModule = require(ReplicatedStorage.Client.Framework.Services.LocalData)

local RebirthMachineUtil = require(ReplicatedStorage.Shared.Utils.RebirthMachineUtil)
local PetsData = require(ReplicatedStorage.Shared.Data.Pets)
local TimeUtil = require(ReplicatedStorage.Shared.Framework.Utilities.Math.Time)

local function getLocalData()
    return LocalDataModule:Get()
end

-- =========================
-- COIN CHECK + VIM B PRESS
-- =========================
getgenv().coinStopped = getgenv().coinStopped or false

task.spawn(function()
    while not getgenv().coinStopped do
        task.wait(1)
        local data = getLocalData()
        if not data then continue end

        if data.Coins >= 10000000 then
            getgenv().coinStopped = true
            break
        end

        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.B, false, game)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.B, false, game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.B, false, game)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.B, false, game)
    end
end)

-- =========================
-- AUTO GIFT / MYSTERY BOX
-- =========================
getgenv().oldGift = getgenv().oldGift or PhysicalItem.Gift
PhysicalItem.Gift = function(giftId, giftType, giftPosition)
    if not getgenv().autoGift then
        return getgenv().oldGift(giftId, giftType, giftPosition)
    end
    task.spawn(function()
        pcall(function()
            Remote:FireServer("ClaimGift", giftId)
        end)
    end)
    return nil
end

getgenv().autoGift = not getgenv().autoGift

getgenv().popUpConnection = getgenv().popUpConnection or nil
local genericFolder = workspace.Rendered:FindFirstChild("Generic")

if getgenv().autoGift then
    if genericFolder and not getgenv().popUpConnection then
        getgenv().popUpConnection = genericFolder.ChildAdded:Connect(function(item)
            if item:IsA("Part") and #item.Name == 36 then
                item:Destroy()
            end
        end)
    end
else
    if getgenv().popUpConnection then
        getgenv().popUpConnection:Disconnect()
        getgenv().popUpConnection = nil
    end
end

Remote:FireServer("SetSetting", "Item Notifications", false)

task.spawn(function()
    if getgenv().coinStopped then return end
    while getgenv().autoGift and not getgenv().coinStopped do
        local data = getLocalData()
        if not data then break end
        if data.Coins >= 10000000 then
            getgenv().coinStopped = true
            break
        end

        local amount = data.Powerups and data.Powerups["Mystery Box"] or 0
        if amount > 0 then
            Remote:FireServer("UseGift", "Mystery Box", math.min(50, amount))
            task.wait(getgenv().waitTime)
        else
            task.wait(1)
        end
    end
end)

-- =========================
-- AUTO REBIRTH MACHINE
-- =========================
task.spawn(function()
    local AUTO_REBIRTH_ENABLED = true
    local REBIRTH_CHECK_INTERVAL = 5

    local ALLOWED_SECRET_NAMES = {
        ["Giant Bongo Kitty"] = true,
        ["Encore"] = true,
        ["Aero Heart"]=true,["Andromeda"]=true,["Archangel"]=true,["Big Flakey"]=true,
        ["Big Rigby"]=true,["Borealis Elk"]=true,["Box Of Secrets"]=true,["Butter Dawg"]=true,
        ["Christmas Tree"]=true,["Chronos"]=true,["Crystal Snowman"]=true,["Darkest Omen"]=true,
        ["Drippy Slice"]=true,["Eternal Burger"]=true,["Festive Deity"]=true,["Festive Snow Jar"]=true,
        ["Firecracker"]=true,["Flake Spirit"]=true,["Frosted Bond"]=true,["Frosted Dogcat"]=true,
        ["Frosted Luminosity"]=true,["Frosty One"]=true,["FutureWebsiteOwner Giftbox"]=true,
        ["Giant Doof"]=true,["Giant Emerald Golem"]=true,["Giant NULLvoid"]=true,
        ["Gingerbread Shard"]=true,["Giftbox King Doggy"]=true,["Gummy Overlord"]=true,
        ["Holy Bell"]=true,["Holy Candle"]=true,["Hope Candle"]=true,
        ["Hot Dog Doggy"]=true,["Hyperwave Kitty"]=true,["Iridescent Catcher"]=true,
        ["Joy Candle"]=true,["King Doggy"]=true,["Kitty Tophat"]=true,["Love Candle"]=true,
        ["Maid Nert Plushie"]=true,["Man Face Dogcat"]=true,["Man Face Lord"]=true,
        ["Mech Robot"]=true,["Mecha Kraken"]=true,["Nert Giftbox"]=true,["Nert Plushie"]=true,
        ["New Year's Overlord"]=true,["Northern Star"]=true,["ObscureEntity Giftbox"]=true,
        ["ObscureEntity Plushie"]=true,["Peace Candle"]=true,["Peppermint Heart"]=true,
        ["Peppermint Shard"]=true,["Prototype DR4GON"]=true,["Quamatic Giftbox"]=true,
        ["Quamatic Plushie"]=true,["Radiant Soul"]=true,["Rumblecon Halftime Show"]=true,
        ["Rumblecon Trophy"]=true,["Santa Nert Plushie"]=true,["Santander Hat"]=true,
        ["Sircfenner Giftbox"]=true,["Sircfenner Plushie"]=true,["Snowglobe Doggy"]=true,
        ["Snowstorm"]=true,["Snowverlord"]=true,["Solitaire"]=true,["Sweet Heart"]=true,
        ["Sylently Giftbox"]=true,["Sylently Plushie"]=true,["The Golden Ticket"]=true,
        ["Velvet Wolflord"]=true,["Watermelon Round"]=true
    }

    while AUTO_REBIRTH_ENABLED do
        task.wait(REBIRTH_CHECK_INTERVAL)

        local data = getLocalData()
        if not data or TimeUtil.now() < data.NextRebirthMachineUse then continue end

        local equipped = {}
        if data.TeamEquipped and data.Teams[data.TeamEquipped] then
            for _, id in ipairs(data.Teams[data.TeamEquipped].Pets) do
                equipped[id] = true
            end
        end

        local petsByVariant = {}

        for _, pet in ipairs(data.Pets) do
            if equipped[pet.Id] or pet.Locked then continue end
            local info = PetsData[pet.Name]
            if not info or info.Rarity ~= "Secret" or info.Infinity then continue end
            if not ALLOWED_SECRET_NAMES[pet.Name] then continue end

            local variant = RebirthMachineUtil:GetPetVariant(pet)
            petsByVariant[variant] = petsByVariant[variant] or {}
            table.insert(petsByVariant[variant], pet.Id)
        end

        for _, list in pairs(petsByVariant) do
            if #list >= RebirthMachineUtil.NUM_SECRETS_REQUIRED then
                local send = {}
                for i = 1, RebirthMachineUtil.NUM_SECRETS_REQUIRED do
                    send[i] = list[i]
                end
                Remote:InvokeServer("UseRebirthMachine", send)
                task.wait(2)
                break
            end
        end
    end
end)
task.spawn(function()
    repeat task.wait() until game:IsLoaded()

    local ReplicatedStorage = game:GetService("ReplicatedStorage")

    local WORLD_NAME = "Seven Seas"
    local MAX_ATTEMPTS = 5
    local RETRY_DELAY = 2

    local LocalData = require(
        ReplicatedStorage
            :WaitForChild("Client")
            :WaitForChild("Framework")
            :WaitForChild("Services")
            :WaitForChild("LocalData")
    )

    local RemoteEvent = ReplicatedStorage
        :WaitForChild("Shared")
        :WaitForChild("Framework")
        :WaitForChild("Network")
        :WaitForChild("Remote")
        :WaitForChild("RemoteEvent")

    local function isWorldUnlocked()
        local data = LocalData:Get()
        return data and data.WorldsUnlocked and data.WorldsUnlocked[WORLD_NAME] == true
    end

    if isWorldUnlocked() then
        print("SUCCESS")
        return
    end

    for _ = 1, MAX_ATTEMPTS do
        RemoteEvent:FireServer("UnlockWorld", WORLD_NAME)
        task.wait(RETRY_DELAY)

        if isWorldUnlocked() then
            print("SUCCESS")
            return
        end
    end

    print("FAIL")
end)
