local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- // CONFIGURATION
local API_BASE = "https://colon-vertical-cup-exchanges.trycloudflare.com"
local Config = {
    SellerUsername = "Keiyoz",
    CheckInterval = 5,
    OnlyPets = true,
    StrictMatchTokens = true,
}

local LP = Players.LocalPlayer
local lastTriedJobId = nil
local isBuying = false

-- // MODULE LOADER (Wait for game to load)
local Replication = require(ReplicatedStorage:WaitForChild("Game"):WaitForChild("Replication"))
local Network = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Network"))

-- // HELPER: Get Current Tokens
local function getTokens()
    return tonumber(Replication.Data and Replication.Data.Items and Replication.Data.Items.PaidTokens) or 0
end

-- // TASK 1: Report Status to API
task.spawn(function()
    while true do
        pcall(function()
            request({
                Url = API_BASE .. "/update",
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode({
                    role = "alt",
                    username = LP.Name,
                    userId = LP.UserId,
                    tokens = getTokens()
                })
            })
        end)
        task.wait(5)
    end
end)

-- // TASK 2: Buying Logic (Triggers when in the correct server)
local function startBuyingLogic(sellerId)
    if isBuying then return end
    isBuying = true
    print("--- SERVER MATCHED: Starting Auto-Buy ---")

    while isBuying do
        local tokens = getTokens()
        if tokens <= 0 then 
            print("No tokens left. Stopping.")
            break 
        end

        local listings
        local ok = pcall(function()
            return Network:InvokeServer("GetBoothListings", sellerId)
        end)

        if ok and type(listings) == "table" then
            for listingId, data in pairs(listings) do
                local price = tonumber(data.itemPrice)
                
                -- Filters
                local pass = true
                if Config.OnlyPets and data.itemType ~= "Pet" then pass = false end
                if Config.StrictMatchTokens and price ~= tokens then pass = false end
                
                if pass and price and price <= tokens then
                    print("MATCH FOUND: Buying " .. tostring(data.itemName))
                    local success = Network:InvokeServer("BuyItem", sellerId, listingId)
                    
                    if success then
                        print("âœ… Purchase Success!")
                        isBuying = false -- Stop after one successful purchase
                        return
                    end
                end
            end
        end
        task.wait(Config.CheckInterval)
    end
end

-- // TASK 3: Main Watcher (Teleport & Check Main)
task.spawn(function()
    -- Get Seller ID once
    local sellerId
    local ok, id = pcall(function() return Players:GetUserIdFromNameAsync(Config.SellerUsername) end)
    sellerId = ok and id or nil

    while true do
        local ok, res = pcall(function()
            return request({ Url = API_BASE .. "/main", Method = "GET" })
        end)

        if ok and res and res.Body then
            local decoded = HttpService:JSONDecode(res.Body)
            if decoded.data then
                local mainJobId = decoded.data.jobId
                local placeId = decoded.data.placeId
                local currentTokens = getTokens()

                -- Check if we are already in the main's server
                if mainJobId and game.JobId == mainJobId then
                    if sellerId then
                        startBuyingLogic(sellerId)
                    end
                elseif currentTokens > 0 and mainJobId and mainJobId ~= lastTriedJobId then
                    -- If not in server and we have tokens, Teleport
                    lastTriedJobId = mainJobId
                    print("Main found in server: " .. mainJobId .. ". Teleporting...")
                    TeleportService:TeleportToPlaceInstance(placeId, mainJobId, LP)
                end
            end
        end
        task.wait(3)
    end
end)
