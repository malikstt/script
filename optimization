local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local RebirthMachineUtil = require(ReplicatedStorage.Shared.Utils.RebirthMachineUtil)
local PetsData = require(ReplicatedStorage.Shared.Data.Pets)
local TimeUtil = require(ReplicatedStorage.Shared.Framework.Utilities.Math.Time)
local Remote = require(ReplicatedStorage.Shared.Framework.Network.Remote)

local REBIRTH_CHECK_INTERVAL = 5

local ALLOWED_SECRET_NAMES = {
    ["Giant Bongo Kitty"] = true,
    ["Encore"] = true,
    ["Aero Heart"]=true,["Andromeda"]=true,["Archangel"]=true,["Big Flakey"]=true,
    ["Big Rigby"]=true,["Borealis Elk"]=true,["Box Of Secrets"]=true,["Butter Dawg"]=true,
    ["Christmas Tree"]=true,["Chronos"]=true,["Crystal Snowman"]=true,["Darkest Omen"]=true,
    ["Drippy Slice"]=true,["Eternal Burger"]=true,["Festive Deity"]=true,["Festive Snow Jar"]=true,
    ["Firecracker"]=true,["Flake Spirit"]=true,["Frosted Bond"]=true,["Frosted Dogcat"]=true,
    ["Frosted Luminosity"]=true,["Frosty One"]=true,["FutureWebsiteOwner Giftbox"]=true,
    ["Giant Doof"]=true,["Giant Emerald Golem"]=true,["Giant NULLvoid"]=true,
    ["Gingerbread Shard"]=true,["Giftbox King Doggy"]=true,["Gummy Overlord"]=true,
    ["Holy Bell"]=true,["Holy Candle"]=true,["Hope Candle"]=true,
    ["Hot Dog Doggy"]=true,["Hyperwave Kitty"]=true,["Iridescent Catcher"]=true,
    ["Joy Candle"]=true,["King Doggy"]=true,["Kitty Tophat"]=true,["Love Candle"]=true,
    ["Maid Nert Plushie"]=true,["Man Face Dogcat"]=true,["Man Face Lord"]=true,
    ["Mech Robot"]=true,["Mecha Kraken"]=true,["Nert Giftbox"]=true,["Nert Plushie"]=true,
    ["New Year's Overlord"]=true,["Northern Star"]=true,["ObscureEntity Giftbox"]=true,
    ["ObscureEntity Plushie"]=true,["Peace Candle"]=true,["Peppermint Heart"]=true,
    ["Peppermint Shard"]=true,["Prototype DR4GON"]=true,["Quamatic Giftbox"]=true,
    ["Quamatic Plushie"]=true,["Radiant Soul"]=true,["Rumblecon Halftime Show"]=true,
    ["Rumblecon Trophy"]=true,["Santa Nert Plushie"]=true,["Santander Hat"]=true,
    ["Sircfenner Giftbox"]=true,["Sircfenner Plushie"]=true,["Snowglobe Doggy"]=true,
    ["Snowstorm"]=true,["Snowverlord"]=true,["Solitaire"]=true,["Sweet Heart"]=true,
    ["Sylently Giftbox"]=true,["Sylently Plushie"]=true,["The Golden Ticket"]=true,
    ["Velvet Wolflord"]=true,["Watermelon Round"]=true
}

task.spawn(function()
    while true do
        task.wait(REBIRTH_CHECK_INTERVAL)

        local data = LocalData:Get()
        if not data or TimeUtil.now() < data.NextRebirthMachineUse then continue end

        local equipped = {}
        if data.TeamEquipped and data.Teams[data.TeamEquipped] then
            for _, id in ipairs(data.Teams[data.TeamEquipped].Pets) do
                equipped[id] = true
            end
        end

        local petsByVariant = {}

        for _, pet in ipairs(data.Pets) do
            if equipped[pet.Id] or pet.Locked then continue end
            local info = PetsData[pet.Name]
            if not info or info.Rarity ~= "Secret" or info.Infinity then continue end
            if not ALLOWED_SECRET_NAMES[pet.Name] then continue end

            local variant = RebirthMachineUtil:GetPetVariant(pet)
            petsByVariant[variant] = petsByVariant[variant] or {}
            table.insert(petsByVariant[variant], pet.Id)
        end

        for _, list in pairs(petsByVariant) do
            if #list >= RebirthMachineUtil.NUM_SECRETS_REQUIRED then
                local send = {}
                for i = 1, RebirthMachineUtil.NUM_SECRETS_REQUIRED do
                    send[i] = list[i]
                end
                Remote:InvokeServer("UseRebirthMachine", send)
                task.wait(2)
                break
            end
        end
    end
end)
