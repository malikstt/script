local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local ItemsModule = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Items"))

local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

-- WEBHOOK (only for Gem Safe Legendary)
local NORMAL_WEBHOOK = "https://discord.com/api/webhooks/1473040107572297761/-FOyJPBRqHg9EYpyhC8x-yz7dk9Z9-D6FYfTt9IbrjV75UoxLtfDfCmPVujy9HvTADEo"

-- Anti idle
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    task.wait(0.1)
    VirtualUser:ClickButton2(Vector2.new(0,0))
end)

local Events = ReplicatedStorage:WaitForChild("Events")
local RNG = Events:WaitForChild("RNG")
local Roll = RNG:WaitForChild("Roll")

local rolledIDs = {}

local RARITY_COLORS = {
    ["Common"] = 0x95a5a6,
    ["Uncommon"] = 0x3498db,
    ["Rare"] = 0x2ecc71,
    ["Epic"] = 0xf1c40f,
    ["Limited"] = 0xe74c3c,
    ["Legendary"] = 0x9b59b6,
    ["Godly"] = 0x8e44ad,
    ["Mythical"] = 0xf39c12,
    ["Insane"] = 0x8b4513
}

local function postWebhook(url, data)
    request({
        Url = url,
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json"
        },
        Body = HttpService:JSONEncode(data)
    })
end

-- GET SERIAL FROM INVENTORY
local function getInventory()
    local success, data = pcall(function()
        return DataEvent:InvokeServer()
    end)

    if success and data then
        return data.ValentinesInventory2026
    end

    return nil
end

-- SEND NOTIFICATION FOR GEM SAFE ONLY
local function sendGemSafeNotification(playerName, itemData, serial)
    local itemName = itemData.Name or "Unknown"
    local price = itemData.Price or 0
    local hasSerial = serial and type(serial) == "number"

    local description = 
        "Item: " .. itemName ..
        "\nRarity: " .. itemData.Rarity

    if price > 0 then
        description = description .. "\nCost: $" .. price
    end

    if hasSerial then
        description = description .. "\nSerial: #" .. serial
    end

    -- Send to webhook
    postWebhook(NORMAL_WEBHOOK, {
        username = "Gem Safe Notifier",
        embeds = {{
            title = playerName .. " Rolled Gem Safe!",
            description = description,
            color = RARITY_COLORS["Legendary"] -- Purple
        }}
    })
end

-- ROLL LOOP
task.spawn(function()
    print("ðŸŽ² Roller started - Waiting for rolls...")
    
    while true do
        task.wait(4)

        local success, result = pcall(function()
            return Roll:InvokeServer()
        end)

        if success and result then
            local itemID

            if type(result) == "table" then
                itemID = tostring(result.ID or result.Id or result.id)
            else
                itemID = tostring(result)
            end

            if itemID then
                local itemData = ItemsModule[itemID]
                if not itemData then continue end

                -- Get serial if it exists
                local inventory = getInventory()
                local serial = nil

                if inventory then
                    for _, invItem in pairs(inventory) do
                        if tostring(invItem.Id) == itemID then
                            if invItem.SerialId and type(invItem.SerialId) == "number" then
                                serial = invItem.SerialId
                                break
                            end
                        end
                    end
                end

                local uniqueKey = serial and (itemID .. "_" .. serial) or itemID

                -- Always print what we rolled to console
                if serial then
                    print(string.format("ðŸŽ² Rolled: %s (%s) #%d", itemData.Name, itemData.Rarity, serial))
                else
                    print(string.format("ðŸŽ² Rolled: %s (%s)", itemData.Name, itemData.Rarity))
                end

                -- Only send webhook if it's a Gem Safe Legendary AND we haven't sent it before
                if itemData.Rarity == "Legendary" and itemData.Name == "Gem Safe" and not rolledIDs[uniqueKey] then
                    rolledIDs[uniqueKey] = true
                    print("âœ¨ GEM SAFE DETECTED! Sending to Discord...")
                    sendGemSafeNotification(LocalPlayer.Name, itemData, serial)
                end
            end
        end
    end
end)
