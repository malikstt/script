local RS = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local CollectionService = game:GetService("CollectionService")

local Replication = require(RS.Game.Replication)
local Network = require(RS.Modules.Network)

local LP = Players.LocalPlayer

-- Configuration
getgenv().AutoSellConfig = {
    Enabled = true,
    ScanInterval = 1.5,
    MaxListings = 15,
    Pets = {
        ["Surge Dragon"] = 50,
        ["Dual Shock"] = 150,
        ["Overcharged Robot"] = 650
    }
}

-- Variables
local listed = {}
local busy = false
local hasBooth = false
local claimedBooth = nil

-- Character setup
local character = LP.Character or LP.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- Wait for booths to load
repeat task.wait(0.2) until #CollectionService:GetTagged("Booth") > 0

math.randomseed(os.clock())

-- Helper: shuffle table
local function shuffle(t)
    for i = #t, 2, -1 do
        local j = math.random(i)
        t[i], t[j] = t[j], t[i]
    end
end

-- Get random OTHER player with HRP
local function getRandomPlayer()
    local candidates = {}
    
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LP and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            table.insert(candidates, plr)
        end
    end
    
    if #candidates == 0 then
        return nil
    end
    
    return candidates[math.random(#candidates)]
end

-- Get unclaimed booths near a position
local function getBoothsNearPosition(pos, range)
    local results = {}
    
    for _, booth in ipairs(CollectionService:GetTagged("Booth")) do
        if booth.PrimaryPart and booth:GetAttribute("BoothOwner") == nil then
            local dist = (booth.PrimaryPart.Position - pos).Magnitude
            if dist <= range then
                table.insert(results, booth)
            end
        end
    end
    
    return results
end

-- Calculate pet price
local function getPrice(pet)
    local baseName = pet.Nickname or pet.Name
    local basePrice = getgenv().AutoSellConfig.Pets[baseName]
    if not basePrice then return nil end
    
    local tier = pet.Tier
    if tier == "Normal" then
        return basePrice
    elseif tier == "Golden" then
        return basePrice * 5
    elseif tier == "Rainbow" then
        return basePrice * 10
    end
    
    return nil
end

-- Auto-list pets
local function autoList()
    if busy or not getgenv().AutoSellConfig.Enabled or not hasBooth then return end
    busy = true
    
    local listings = 0
    
    for petId, pet in pairs(Replication.Data.Pets or {}) do
        if listings >= getgenv().AutoSellConfig.MaxListings then break end
        
        if not listed[petId] and not pet.Locked and not pet.Trading then
            local price = getPrice(pet)
            if price then
                local success = Network:InvokeServer(
                    "ListItem",
                    "Pet",
                    petId,
                    math.ceil(price)
                )
                
                if success then
                    listed[petId] = true
                    listings += 1
                end
                
                task.wait(0.15)
            end
        end
    end
    
    busy = false
end

-- Check if we already own a booth
local function checkExistingBooth()
    for _, booth in ipairs(CollectionService:GetTagged("Booth")) do
        if booth:GetAttribute("BoothOwner") == LP.UserId then
            print("‚úÖ Already own booth:", booth.Name)
            hrp.CFrame = booth.PrimaryPart.CFrame * CFrame.new(0, 5, 0)
            hasBooth = true
            claimedBooth = booth
            return true
        end
    end
    return false
end

-- Claim a booth
local function claimBooth()
    print("üß† Starting booth claimer...")
    
    if checkExistingBooth() then
        return true
    end
    
    local range = 20
    
    while true do
        local targetPlayer = getRandomPlayer()
        
        if targetPlayer then
            local targetHRP = targetPlayer.Character.HumanoidRootPart
            print("üéØ Using player:", targetPlayer.Name, "range:", range)
            
            local candidates = getBoothsNearPosition(targetHRP.Position, range)
            
            if #candidates > 0 then
                shuffle(candidates)
                
                for _, booth in ipairs(candidates) do
                    print("‚û°Ô∏è Trying booth near", targetPlayer.Name, ":", booth.Name)
                    
                    Network:InvokeServer("ClaimBooth", booth)
                    
                    -- Wait for server confirmation
                    local start = tick()
                    while tick() - start < 1 do
                        if booth:GetAttribute("BoothOwner") == LP.UserId then
                            print("üéâ Booth claimed:", booth.Name)
                            
                            -- Instant teleport
                            hrp.CFrame = booth.PrimaryPart.CFrame * CFrame.new(0, 5, 0)
                            hrp.AssemblyLinearVelocity = Vector3.zero
                            hrp.AssemblyAngularVelocity = Vector3.zero
                            
                            hasBooth = true
                            claimedBooth = booth
                            return true
                        end
                        task.wait()
                    end
                end
            end
        end
        
        -- Expand radius and retry
        range += 20
        task.wait(0.5)
    end
end

-- Monitor booth ownership
local function monitorBooth()
    while true do
        if claimedBooth and claimedBooth.Parent then
            local owner = claimedBooth:GetAttribute("BoothOwner")
            if owner ~= LP.UserId then
                print("‚ö†Ô∏è Lost booth ownership!")
                hasBooth = false
                claimedBooth = nil
                -- Try to reclaim
                claimBooth()
            end
        else
            -- Booth no longer exists or we lost it
            hasBooth = false
            claimedBooth = nil
            if not checkExistingBooth() then
                claimBooth()
            end
        end
        task.wait(2)
    end
end

-- Main execution
local function main()
    -- First claim a booth
    if claimBooth() then
        print("‚úÖ Booth secured! Starting auto-sell...")
        
        -- Start booth monitoring
        task.spawn(monitorBooth)
        
        -- Start auto-selling
        task.spawn(function()
            while true do
                pcall(autoList)
                task.wait(getgenv().AutoSellConfig.ScanInterval)
            end
        end)
    else
        print("‚ùå Failed to claim booth. Retrying...")
        task.wait(3)
        main() -- Retry
    end
end

-- Start the script
main()
