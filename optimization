--// SERVICES
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

--// DELTA ANTI-AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    task.wait(0.1)
    VirtualUser:ClickButton2(Vector2.new(0,0))
end)
print("Delta Anti-AFK Enabled")

--// REMOTES
local Events = ReplicatedStorage:WaitForChild("Events")
local RNG = Events:WaitForChild("RNG")
local Roll = RNG:WaitForChild("Roll")

--// MODULE
local ItemsModule = require(ReplicatedStorage.Modules.Items)

--// WEBHOOK
local WEBHOOK_URL = "https://discord.com/api/webhooks/1473040107572297761/-FOyJPBRqHg9EYpyhC8x-yz7dk9Z9-D6FYfTt9IbrjV75UoxLtfDfCmPVujy9HvTADEo"
local PING_TEXT = "<@1135837863603351573> <@1135837863603351573>"

--// STORAGE
local rolledIDs = {}

--// COLORS
local RARITY_COLORS = {
    ["Common"] = 0x95a5a6,
    ["Uncommon"] = 0x3498db,
    ["Rare"] = 0x2ecc71,
    ["Epic"] = 0xf1c40f,
    ["Limited"] = 0xe74c3c,
    ["Legendary"] = 0x9b59b6,
    ["Godly"] = 0x8e44ad,
    ["Mythical"] = 0xf39c12,
    ["Insane"] = 0x8b4513
}

--// SERIAL EXTRACTOR
local function getSerial(result)
    if type(result) ~= "table" then return nil end
    if result.Serial then return result.Serial end
    if result.serial then return result.serial end
    if result.Serials then return result.Serials end
    if result.Data then
        if result.Data.Serial then return result.Data.Serial end
        if result.Data.Serials then return result.Data.Serials end
    end
    return nil
end

--// REMOVE LayoutOrder from data
local function cleanData(data)
    local copy = {}
    for k,v in pairs(data) do
        if k ~= "LayoutOrder" then
            copy[k] = v
        end
    end
    return copy
end

--// WEBHOOK FUNCTION
local function sendDiscordNotification(username, itemData, serial)
    local rarity = itemData.Rarity or "Unknown"
    local price = itemData.Price or itemData.Cost or itemData.Value or 0
    local color = RARITY_COLORS[rarity] or 0xffffff

    local title = username .. " GOT A LIMITED ITEM!"
    local description = "Full Item Data:\n```json\n" .. HttpService:JSONEncode(cleanData(itemData)) .. "\n```"
    local content = serial and PING_TEXT or nil

    local data = {
        username = "Item Notifier",
        content = content,
        embeds = {{
            title = title,
            description = description,
            color = color
        }}
    }

    request({
        Url = WEBHOOK_URL,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(data)
    })
end

--// MAIN LOOP
task.spawn(function()
    while true do
        task.wait(4)

        local success, result = pcall(function()
            return Roll:InvokeServer()
        end)

        if success and result then

            local itemID = tostring(result.ID or result.Id or result.id)
            local serial = getSerial(result)

            if itemID then

                local itemData = ItemsModule[itemID] or result.Data
                if not itemData then
                    continue
                end

                -- Only Limited items costing 1500+
                local price = itemData.Price or itemData.Cost or itemData.Value or 0
                local rarity = itemData.Rarity or "Unknown"
                if rarity ~= "Limited" or price < 1500 then
                    continue
                end

                local uniqueKey = serial and (itemID .. "_" .. serial) or itemID
                if rolledIDs[uniqueKey] then
                    continue
                end
                rolledIDs[uniqueKey] = true

                -- Send webhook
                sendDiscordNotification(LocalPlayer.Name, itemData, serial)
            end
        end
    end
end)
