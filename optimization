local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local RebirthMachineUtil = require(ReplicatedStorage.Shared.Utils.RebirthMachineUtil)
local PetsData = require(ReplicatedStorage.Shared.Data.Pets)
local TimeUtil = require(ReplicatedStorage.Shared.Framework.Utilities.Math.Time)
local Remote = require(ReplicatedStorage.Shared.Framework.Network.Remote)

local LocalPlayer = Players.LocalPlayer

local AUTO_REBIRTH_ENABLED = true
local CHECK_INTERVAL = 5

local ALLOWED_SECRET_NAMES = {
    -- ORIGINAL
    ["The Golden Ticket"] = true,
    ["Butter Dawg"] = true,
    ["Man Face Lord"] = true,
    ["Man Face Dogcat"] = true,
    ["Drippy Slice"] = true,
    ["Giant Emerald Golem"] = true,
    ["Hot Dog Doggy"] = true,
    ["Rumblecon Trophy"] = true,
    ["Rumblecon Halftime Show"] = true,
    ["Watermelon Round"] = true,
    ["Eternal Burger"] = true,
    ["Giftbox King Doggy"] = true,
    ["Nert Giftbox"] = true,
    ["Quamatic Giftbox"] = true,
    ["ObscureEntity Giftbox"] = true,
    ["Sircfenner Giftbox"] = true,
    ["Sylently Giftbox"] = true,
    ["FutureWebsiteOwner Giftbox"] = true,
    ["Hyperwave Kitty"] = true,
    ["King Doggy"] = true,
    ["Maid Nert Plushie"] = true,
    ["Santa Nert Plushie"] = true,
    ["OG BGS Plaque"] = true,
    ["OG Crystal Teddy"] = true,
    ["OG Morning Star"] = true,
    ["OG The Overlord"] = true,
    ["Frosted Bond"] = true,
    ["Giant One Eyed Monster"] = true,
    ["Giant Pearl"] = true,
    ["God Tamer"] = true,
    ["Guardian Angel"] = true,
    ["Hermit Crab"] = true,
    ["Holy Bell"] = true,
    ["Holy Candle"] = true,
    ["Kitty Tophat"] = true,
    ["Mech Robot"] = true,
    ["Mech Kraken"] = true,
    ["Moonlord"] = true,
    ["OG Archangel"] = true,
    ["Peppermint Heart"] = true,
    ["Tidal God"] = true,
    ["Whimsical Fairy"] = true,
    ["Wicked Widow"] = true,
    ["The Overlord"] = true,
    ["Silly King Doggy"] = true,
    ["Sinistar"] = true,
    ["Pumpkin Pie"] = true,
    ["Pumpgeist"] = true,
    ["OG Soulflake"] = true,
    ["OG Hellfire"] = true,
    ["Giant NULLvoid"] = true,
    ["Giant DOOF"] = true,
    ["Ghosdeeri"] = true,
    ["Giant Fall Turkey"] = true,
    ["Fox O' Wisp"] = true,
    ["Flake Spirit"] = true,
    ["Box of Secrets"] = true,
    ["Chronos"] = true,
    ["Axolotl Army"] = true,
    ["Archangel"] = true,
}

task.spawn(function()
    while AUTO_REBIRTH_ENABLED do
        task.wait(CHECK_INTERVAL)

        local playerData = LocalData:Get()
        if not playerData or not playerData.Pets or not playerData.Teams or not playerData.TeamEquipped then
            continue
        end

        if TimeUtil.now() < playerData.NextRebirthMachineUse then
            continue
        end

        local equippedPetIds = {}
        local activeTeamIndex = playerData.TeamEquipped

        if activeTeamIndex and playerData.Teams[activeTeamIndex] and playerData.Teams[activeTeamIndex].Pets then
            for _, petId in ipairs(playerData.Teams[activeTeamIndex].Pets) do
                equippedPetIds[petId] = true
            end
        end

        local petsByVariant = {}

        for _, petData in ipairs(playerData.Pets) do
            if equippedPetIds[petData.Id] or petData.Locked then
                continue
            end

            local petInfo = PetsData[petData.Name]
            if not petInfo then
                continue
            end

            if petInfo.Rarity ~= "Secret" or petInfo.Infinity then
                continue
            end

            if not ALLOWED_SECRET_NAMES[petData.Name] then
                continue
            end

            local variant = RebirthMachineUtil:GetPetVariant(petData)
            petsByVariant[variant] = petsByVariant[variant] or {}
            table.insert(petsByVariant[variant], petData.Id)
        end

        local petIdsToSend
        local requiredAmount = RebirthMachineUtil.NUM_SECRETS_REQUIRED

        for _, idList in pairs(petsByVariant) do
            if #idList >= requiredAmount then
                petIdsToSend = {}
                for i = 1, requiredAmount do
                    petIdsToSend[#petIdsToSend + 1] = idList[i]
                end
                break
            end
        end

        if petIdsToSend then
            Remote:InvokeServer("UseRebirthMachine", petIdsToSend)
            task.wait(2)
        end
    end
end)
