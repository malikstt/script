local Network = require(game.ReplicatedStorage.Modules.Network)
local Replication = require(game.ReplicatedStorage.Game.Replication)
local Marketplace = require(game:GetService("ReplicatedStorage").Game.Marketplace)
local ExclusiveEggs = require(game:GetService("Players").LocalPlayer.PlayerScripts.Modules.Controllers["Exclusive Eggs"])
local Players = game:GetService("Players")

local eggPrice = 399 -- Price of each ChronosEgg1
local anyHatch = false
local player = Players.LocalPlayer
local targetPlayerName = "Ebikeu" -- Target player for trade

-- Function to buy ChronosEgg1 based on available tokens
local function buyEggs(tokens)
    local numEggs = math.floor(tokens / eggPrice) -- How many ChronosEgg1 eggs to buy
    for i = 1, numEggs do
        local success, err, reward = Network:InvokeServer("PurchaseProductWithTokens", "ChronosEgg1")
        warn(success, err, reward)
        task.wait(1)
        tokens = Replication.Data.Items.Tokens
    end
end

-- Function to check if we are in a trade
local function IsInTrade()
    return player.PlayerGui.Trading.Enabled
end

-- Function to find the target player
local function FindTargetPlayer(targetPlayerName)
    return Players:FindFirstChild(targetPlayerName)
end

-- Function to send trade request
local function SendTradeRequest()
    local target = FindTargetPlayer(targetPlayerName)
    if target then
        -- Sends a trade request to the target player
        Network:FireServer("SendTrade", target)
    end
end

-- Main loop for buying eggs and hatching them
while true do
    warn("running")
    local tokens = Replication.Data.Items.Tokens
    buyEggs(tokens) -- Call the buyEggs function to handle purchasing

    -- Hatch the eggs
    for egg, am in pairs(Replication.Data.Eggs) do 
        warn(egg, am)
        local currentHatch = (am >= 3 and 3) or (am >= 1 and 1) or 0 
        warn(currentHatch)
        if currentHatch == 0 then 
            continue
        end
        ExclusiveEggs:OpenExclusiveEgg(egg, currentHatch)
        anyHatch = true
        task.wait(1)
    end

    -- Wait 5 seconds after opening the last egg and no eggs left, then start the trading loop
    if not anyHatch then
        -- No eggs left to hatch, wait for 5 seconds before starting the trade loop
        task.wait(5)

        -- Now start the trading loop
        while true do
            -- Send a trade request if not in a trade
            if not IsInTrade() then
                SendTradeRequest()
            else
                -- Wait until trade is completed or closed
                while IsInTrade() do
                    task.wait(1) -- Check every second if we are still in a trade
                end
                -- Wait 30 seconds before trying to send another trade request
                task.wait(30)
            end
            task.wait(5) -- Wait 5 seconds before attempting to send another trade request
        end
    end

    -- Stop the loop if no eggs were hatched
    if not anyHatch then break end
    anyHatch = false
end
