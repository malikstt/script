local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")

local LocalDataModule = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local RemoteEvent = ReplicatedStorage.Shared.Framework.Network.Remote.RemoteEvent
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

local platformPos = Vector3.new(1030.17, 1129.41, 467.18)
local platformSize = Vector3.new(10, 1, 10)

local platform = Instance.new("Part")
platform.Size = platformSize
platform.Position = platformPos
platform.Anchored = true
platform.CanCollide = true
platform.Material = Enum.Material.Neon
platform.Color = Color3.fromRGB(50, 50, 50)
platform.Name = "PermanentPlatform"
platform.Parent = Workspace

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")

local function placeOnPlatform()
    hrp.CFrame = CFrame.new(platformPos + Vector3.new(0, platformSize.Y/2 + hrp.Size.Y/2, 0))
end

placeOnPlatform()

local function getEggs()
    return LocalDataModule:Get().EggsOpened
end

local lastEggs = {}
for name, amount in pairs(getEggs()) do
    lastEggs[name] = amount
end

RunService.Heartbeat:Connect(function()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.R, false, game)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.R, false, game)
    local current = getEggs()
    for eggName, newAmount in pairs(current) do
        local oldAmount = lastEggs[eggName] or 0
        if newAmount > oldAmount then
            RemoteEvent:FireServer("HatchEgg", eggName, 99)
        end
        lastEggs[eggName] = newAmount
    end
end)

spawn(function()
    while true do
        task.wait(300)
        local targetPos = platformPos + Vector3.new(0, platformSize.Y/2 + hrp.Size.Y/2, 0)
        local distance = (hrp.Position - targetPos).Magnitude
        if distance > 1 then
            placeOnPlatform()
        end
    end
end)

local TARGET_ENCHANT = "secret-hunter"
local enchanted = {}

task.spawn(function()
    while true do
        local data = LocalDataModule:Get()
        if data and data.Pets and data.Teams and data.TeamEquipped then
            local equipped = {}
            local team = data.Teams[data.TeamEquipped]
            if team and team.Pets then
                for _, id in ipairs(team.Pets) do
                    equipped[id] = true
                end
            end

            local secrets = {}
            for _, pet in pairs(data.Pets) do
                local info = PetsModule[pet.Name]
                if info and info.Rarity == "Secret" then
                    table.insert(secrets, pet.Id)
                end
            end

            local c = 0
            for _, id in ipairs(secrets) do
                if c >= 13 then break end
                if not equipped[id] then
                    RemoteEvent:FireServer("EquipPet", id)
                    task.wait(0.15)
                end
                c += 1
            end

            for id in pairs(equipped) do
                local keep = false
                for i = 1, math.min(13, #secrets) do
                    if id == secrets[i] then
                        keep = true
                        break
                    end
                end
                if not keep then
                    RemoteEvent:FireServer("UnequipPet", id)
                    task.wait(0.15)
                end
            end
        end
        task.wait(0.3)
    end
end)

task.spawn(function()
    while true do
        local data = LocalDataModule:Get()
        if data and data.Teams and data.TeamEquipped then
            local team = data.Teams[data.TeamEquipped]
            if team and team.Pets then
                for _, petId in ipairs(team.Pets) do
                    if not enchanted[petId] then
                        local pet
                        for _, p in ipairs(data.Pets or {}) do
                            if p.Id == petId then pet = p break end
                        end
                        if pet then
                            local has = false
                            for _, e in ipairs(pet.Enchants or {}) do
                                if e.Id == TARGET_ENCHANT then
                                    has = true
                                    break
                                end
                            end
                            if has then
                                enchanted[petId] = true
                            else
                                RemoteEvent:FireServer("UseShadowCrystal", petId)
                            end
                        end
                    end
                    task.wait(0.1)
                end
            end
        end
        task.wait(0.1)
    end
end)
