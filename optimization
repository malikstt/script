local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local VIM = game:GetService("VirtualInputManager")
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)

-- Function to get unlocked islands from save data
local function getUnlockedIslands()
    local data = LocalData:Get()
    if not data or not data.AreasUnlocked then return {} end
    
    local unlocked = {}
    for islandName, _ in pairs(data.AreasUnlocked) do
        unlocked[islandName] = true
    end
    return unlocked
end

-- Main farming function that uses island's pivot point
local function farmIsland(islandName)
    local character = player.Character or player.CharacterAdded:Wait()
    local hrp = character:WaitForChild("HumanoidRootPart")
    
    -- Find the Christmas world and target island
    local christmasWorld = Workspace.Worlds:FindFirstChild("Christmas World")
    if not christmasWorld then 
        warn("Christmas World not found")
        return false
    end
    
    local islandsFolder = christmasWorld.Islands
    local islandContainer = islandsFolder:FindFirstChild(islandName)
    if not islandContainer then 
        warn("Island " .. islandName .. " not found")
        return false
    end
    
    -- Get the island model and its pivot
    local islandModel = islandContainer:WaitForChild("Island")
    if not islandModel then 
        warn("Island model not found for " .. islandName)
        return false
    end
    
    -- Get the pivot CFrame (center position)
    local pivotCF = islandModel:GetPivot()
    if not pivotCF then
        warn("Could not get pivot for " .. islandName)
        return false
    end
    
    print("ðŸŒ´ Farming island: " .. islandName)
    print("   Position: " .. tostring(pivotCF.Position))
    
    -- Teleport to the island's surface (adjust Y offset as needed)
    local teleportHeight = 10  -- Adjust based on island size
    hrp.CFrame = pivotCF + Vector3.new(0, teleportHeight, 0)
    
    -- Press E to interact with the island
    task.wait(1)
    local stopTime = tick() + 10  -- Press E for 10 seconds
    
    while tick() < stopTime do
        VIM:SendKeyEvent(true, Enum.KeyCode.E, false, game)
        task.wait(0.1)
        VIM:SendKeyEvent(false, Enum.KeyCode.E, false, game)
        task.wait(0.5)  -- Interval between E presses
    end
    
    return true
end

-- Function to get all Christmas island names
local function getChristmasIslands()
    local christmasWorld = Workspace.Worlds:FindFirstChild("Christmas World")
    if not christmasWorld then return {} end
    
    local islands = {}
    if christmasWorld:FindFirstChild("Islands") then
        for _, island in pairs(christmasWorld.Islands:GetChildren()) do
            table.insert(islands, island.Name)
        end
    end
    
    return islands
end

-- Shuffle table for random order
local function shuffleTable(t)
    for i = #t, 2, -1 do
        local j = math.random(1, i)
        t[i], t[j] = t[j], t[i]
    end
    return t
end

-- Main execution loop
task.spawn(function()
    while true do
        task.wait(2)
        
        local unlocked = getUnlockedIslands()
        local allIslands = getChristmasIslands()
        
        -- Find islands that aren't unlocked yet
        local missingIslands = {}
        for _, islandName in ipairs(allIslands) do
            if not unlocked[islandName] then
                table.insert(missingIslands, islandName)
            end
        end
        
        -- Exit if all islands are unlocked
        if #missingIslands == 0 then
            print("âœ… All Christmas islands unlocked!")
            break
        end
        
        -- Randomize the order
        missingIslands = shuffleTable(missingIslands)
        print("ðŸ” Missing " .. #missingIslands .. " islands: " .. table.concat(missingIslands, ", "))
        
        -- Farm each missing island
        for _, islandName in ipairs(missingIslands) do
            local success = farmIsland(islandName)
            
            if success then
                task.wait(2)  -- Brief pause between islands
                
                -- Check if the island was unlocked
                local newUnlocked = getUnlockedIslands()
                if newUnlocked[islandName] then
                    print("âœ… Successfully unlocked: " .. islandName)
                else
                    print("âš ï¸ Island " .. islandName .. " not unlocked yet")
                end
            end
        end
        
        print("ðŸ”„ Loop completed, checking again...")
    end
end)

print("ðŸŽ„ Christmas Island Unlocker started!")
