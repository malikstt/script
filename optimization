local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)

local function getUnlockedIslands()
    local data = LocalData:Get()
    if not data or not data.AreasUnlocked then return {} end
    
    local unlocked = {}
    for islandName, _ in pairs(data.AreasUnlocked) do
        unlocked[islandName] = true
    end
    return unlocked
end

local function farmIsland(islandName)
    local character = player.Character or player.CharacterAdded:Wait()
    local hrp = character:WaitForChild("HumanoidRootPart")
    
    local christmasWorld = Workspace.Worlds:FindFirstChild("Christmas World")
    if not christmasWorld then return end
    
    local islandsFolder = christmasWorld.Islands
    local islandContainer = islandsFolder:FindFirstChild(islandName)
    if not islandContainer then return end
    
    local islandModel = islandContainer:WaitForChild("Island")
    local pivot = islandModel:GetPivot()
    hrp.CFrame = pivot + Vector3.new(0, 6, 0)
    
    local parts = {}
    for _, obj in ipairs(islandModel:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Position.Y > pivot.Position.Y - 5 then
            table.insert(parts, obj)
        end
    end
    
    if #parts == 0 then return end
    
    local startTime = tick()
    local index = 1
    
    while tick() - startTime < 25 do
        local part = parts[index]
        if part and part:IsDescendantOf(Workspace) then
            hrp.CFrame = part.CFrame + Vector3.new(0, 6, 0)
            task.wait(0.1)
            hrp.CFrame = part.CFrame + Vector3.new(0, 2, 0)
            task.wait(0.1)
        end
        
        index += 1
        if index > #parts then
            index = 1
        end
    end
end

local function getChristmasIslands()
    local christmasWorld = Workspace.Worlds:FindFirstChild("Christmas World")
    if not christmasWorld then return {} end
    
    local islands = {}
    if christmasWorld:FindFirstChild("Islands") then
        for _, island in pairs(christmasWorld.Islands:GetChildren()) do
            table.insert(islands, island.Name)
        end
    end
    
    return islands
end

local function shuffleTable(t)
    for i = #t, 2, -1 do
        local j = math.random(1, i)
        t[i], t[j] = t[j], t[i]
    end
    return t
end

task.spawn(function()
    while true do
        task.wait(2)
        
        local unlocked = getUnlockedIslands()
        local allIslands = getChristmasIslands()
        
        local missingIslands = {}
        for _, islandName in ipairs(allIslands) do
            if not unlocked[islandName] then
                table.insert(missingIslands, islandName)
            end
        end
        
        if #missingIslands == 0 then
            print("‚úÖ All Christmas islands unlocked!")
            break
        end
        
        missingIslands = shuffleTable(missingIslands)
        print("üîç Missing islands: " .. table.concat(missingIslands, ", "))
        
        for _, islandName in ipairs(missingIslands) do
            print("üå¥ Farming: " .. islandName)
            farmIsland(islandName)
            
            task.wait(2)
            
            local newUnlocked = getUnlockedIslands()
            if newUnlocked[islandName] then
                print("‚úÖ Unlocked: " .. islandName)
            end
        end
    end
end)
