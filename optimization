local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local ItemsModule = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Items"))

local GetAssets = ReplicatedStorage:WaitForChild("Events")
:WaitForChild("Misc")
:WaitForChild("GetAssets")

local HIGH_VALUE_THRESHOLD = 1500
local HIGH_VALUE_WEBHOOK = "https://discord.com/api/webhooks/1473934078087528509/V3Bm-RyTV4mlClC5TKQn9gH6BK-ooqsssPw9P13_egipjWwjGoEOAn_7pbfA3TdAIL75"
local NORMAL_WEBHOOK = "https://discord.com/api/webhooks/1473040107572297761/-FOyJPBRqHg9EYpyhC8x-yz7dk9Z9-D6FYfTt9IbrjV75UoxLtfDfCmPVujy9HvTADEo"

LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    task.wait(0.1)
    VirtualUser:ClickButton2(Vector2.new(0,0))
end)

local Events = ReplicatedStorage:WaitForChild("Events")
local RNG = Events:WaitForChild("RNG")
local Roll = RNG:WaitForChild("Roll")

local rolledIDs = {}
local highValueItems = {} -- Store high value LIMITED items for summary

local RARITY_COLORS = {
    ["Common"] = 0x95a5a6,
    ["Uncommon"] = 0x3498db,
    ["Rare"] = 0x2ecc71,
    ["Epic"] = 0xf1c40f,
    ["Limited"] = 0xe74c3c,
    ["Legendary"] = 0x9b59b6,
    ["Godly"] = 0x8e44ad,
    ["Mythical"] = 0xf39c12,
    ["Insane"] = 0x8b4513
}

local function postWebhook(url, data)
    request({
        Url = url,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(data)
    })
end

local function sendNormal(username, itemData, serial)
    local rarity = itemData.Rarity or "Unknown"
    local price = itemData.Price or itemData.Cost or itemData.Value or 0
    
    -- Only send notifications for Limited items
    if rarity ~= "Limited" then
        return
    end
    
    -- Use bright gold color for 1500+ items, otherwise use rarity color
    local color
    if price >= HIGH_VALUE_THRESHOLD then
        color = 0xFFD700 -- Bright gold for high value
    else
        color = RARITY_COLORS[rarity] or 0xffffff
    end
    
    local title = username .. " Rolled a Limited Item!"
    local description =
        "Item: " .. (itemData.Name or "Unknown") ..
        "\nRarity: " .. rarity ..
        "\nCost: $" .. tostring(price)
    
    -- Add serial to description if it exists
    local hasSerial = serial and serial ~= "None" and serial ~= ""
    if hasSerial then
        description = description .. "\nSerial: #" .. tostring(serial)
    end
    
    -- Add HIGH VALUE tag to title for 1500+ items
    if price >= HIGH_VALUE_THRESHOLD then
        title = "ðŸ’° " .. title .. " ðŸ’°"
    end
    
    local data = {
        username = "Item Notifier",
        embeds = {{
            title = title,
            description = description,
            color = color
        }}
    }
    postWebhook(NORMAL_WEBHOOK, data)
    
    -- If it has a serial, also send to high value webhook
    if hasSerial then
        local serialData = {
            username = "Serial Alert",
            content = "**ðŸ”´ SERIAL LIMITED DETECTED!**\n" ..
                     "Player: " .. username .. "\n" ..
                     "Item: " .. (itemData.Name or "Unknown") .. "\n" ..
                     "Serial: #" .. tostring(serial) .. "\n" ..
                     "Value: $" .. price
        }
        postWebhook(HIGH_VALUE_WEBHOOK, serialData)
    end
end

local function sendHighValueSummary()
    if #highValueItems == 0 then return end
    
    -- Build summary message (only LIMITED items that are 1500+)
    local summary = "**HIGH VALUE LIMITED ITEMS SUMMARY (1500+)**\n\n"
    for _, item in ipairs(highValueItems) do
        summary = summary .. 
            "â€¢ " .. item.name .. 
            " ($" .. item.price .. ")" ..
            (item.serial and " - Serial #" .. item.serial or "") ..
            "\n"
    end
    
    local data = {
        username = "High Value Limited Summary",
        embeds = {{
            title = LocalPlayer.Name .. " - High Value Limited Items Collected",
            description = summary,
            color = 0xFFD700,
            footer = {
                text = "Total Limited: " .. #highValueItems .. " items"
            }
        }}
    }
    
    postWebhook(HIGH_VALUE_WEBHOOK, data)
    highValueItems = {}
end

-- Check existing assets for high value LIMITED items
local success, assets = pcall(function()
    return GetAssets:InvokeServer()
end)

if success and assets then
    for _, itemInfo in pairs(assets) do
        local itemID = tostring(itemInfo.ID or itemInfo.Id or itemInfo.id)
        local serial = itemInfo.SerialId or itemInfo.Serials or itemInfo.Serial or itemInfo.serial
        local itemData = ItemsModule[itemID]
        
        if itemData then
            local price = itemData.Price or itemData.Cost or itemData.Value or 0
            local rarity = itemData.Rarity or "Unknown"
            
            if rarity == "Limited" and price >= HIGH_VALUE_THRESHOLD then
                table.insert(highValueItems, {
                    name = itemData.Name or "Unknown",
                    price = price,
                    serial = serial
                })
            end
        end
    end
    
    sendHighValueSummary()
end

-- Rolling loop
task.spawn(function()
    local rollCount = 0
    while true do
        task.wait(4)
        
        rollCount = rollCount + 1
        print("[Roll #" .. rollCount .. "] Attempting to roll...")
        
        local successRoll, result = pcall(function()
            return Roll:InvokeServer()
        end)
        
        if successRoll and result then
            local itemID
            local serial
            
            if type(result) == "table" then
                itemID = tostring(result.ID or result.Id or result.id)
                serial = result.SerialId or result.Serials or result.Serial or result.serial
            else
                itemID = tostring(result)
            end
            
            if itemID then
                local itemData = ItemsModule[itemID]
                if itemData then
                    local price = itemData.Price or itemData.Cost or itemData.Value or 0
                    local rarity = itemData.Rarity or "Unknown"
                    local itemName = itemData.Name or "Unknown"
                    
                    print(string.format("[Roll #%d] Result: %s | Rarity: %s | Value: $%d %s", 
                        rollCount, itemName, rarity, price,
                        serial and "(Serial #" .. serial .. ")" or ""
                    ))
                    
                    local uniqueKey = serial and (itemID .. "_" .. tostring(serial)) or itemID
                    
                    if not rolledIDs[uniqueKey] then
                        rolledIDs[uniqueKey] = true
                        
                        if rarity == "Limited" and price >= HIGH_VALUE_THRESHOLD then
                            table.insert(highValueItems, {
                                name = itemName,
                                price = price,
                                serial = serial
                            })
                            print("[HIGH VALUE LIMITED] Added to summary: " .. itemName)
                        end
                        
                        -- Send to normal webhook for ALL Limited items
                        sendNormal(LocalPlayer.Name, itemData, serial)
                    end
                end
            end
        else
            print("[Roll #" .. rollCount .. "] Failed to roll")
        end
    end
end)

-- Send summary when player leaves
LocalPlayer.AncestryChanged:Connect(function()
    if not LocalPlayer.Parent then
        if #highValueItems > 0 then
            sendHighValueSummary()
        end
    end
end)
