local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local ItemsModule = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Items"))

local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

-- YOUR WEBHOOK (only one now)
local NORMAL_WEBHOOK = "https://discord.com/api/webhooks/1473040107572297761/-FOyJPBRqHg9EYpyhC8x-yz7dk9Z9-D6FYfTt9IbrjV75UoxLtfDfCmPVujy9HvTADEo"

-- Anti idle
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    task.wait(0.1)
    VirtualUser:ClickButton2(Vector2.new(0,0))
end)

local Events = ReplicatedStorage:WaitForChild("Events")
local RNG = Events:WaitForChild("RNG")
local Roll = RNG:WaitForChild("Roll")

local rolledIDs = {}

local RARITY_COLORS = {
    ["Common"] = 0x95a5a6,
    ["Uncommon"] = 0x3498db,
    ["Rare"] = 0x2ecc71,
    ["Epic"] = 0xf1c40f,
    ["Limited"] = 0xe74c3c,
    ["Legendary"] = 0x9b59b6,
    ["Godly"] = 0x8e44ad,
    ["Mythical"] = 0xf39c12,
    ["Insane"] = 0x8b4513
}

local function postWebhook(url, data)
    request({
        Url = url,
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json"
        },
        Body = HttpService:JSONEncode(data)
    })
end

-- GET SERIAL FROM INVENTORY
local function getInventory()
    local success, data = pcall(function()
        return DataEvent:InvokeServer()
    end)

    if success and data then
        return data.ValentinesInventory2026
    end

    return nil
end

-- SEND NOTIFICATION FOR ROLLED ITEMS
local function sendNotification(playerName, itemData, serial)

    -- Only send for Limited items OR Legendary items named "Gem Safe"
    if itemData.Rarity ~= "Limited" and not (itemData.Rarity == "Legendary" and itemData.Name == "Gem Safe") then 
        return 
    end

    local itemName = itemData.Name or "Unknown"
    local price = itemData.Price or 0

    local hasSerial = serial and type(serial) == "number"

    -- Set color based on rarity
    local color
    if itemData.Rarity == "Limited" then
        color = hasSerial and 0xf1c40f or RARITY_COLORS["Limited"] -- YELLOW if has serial, RED if not
    elseif itemData.Rarity == "Legendary" then
        color = RARITY_COLORS["Legendary"] -- Purple
    end

    local description = 
        "Item: " .. itemName ..
        "\nRarity: " .. itemData.Rarity

    -- Add price if it exists
    if price > 0 then
        description = description .. "\nCost: $" .. price
    end

    -- Add serial if it exists
    if hasSerial then
        description = description .. "\nSerial: #" .. serial
    end

    -- Send to webhook
    postWebhook(NORMAL_WEBHOOK, {
        username = "Item Notifier",
        embeds = {{
            title = playerName .. " Rolled " .. itemData.Rarity,
            description = description,
            color = color
        }}
    })
end

-- ROLL LOOP
task.spawn(function()

    local rollCount = 0

    while true do

        task.wait(4)

        rollCount += 1

        local success, result = pcall(function()
            return Roll:InvokeServer()
        end)

        if success and result then

            local itemID

            if type(result) == "table" then
                itemID = tostring(result.ID or result.Id or result.id)
            else
                itemID = tostring(result)
            end

            if itemID then

                local itemData = ItemsModule[itemID]
                if not itemData then continue end

                local inventory = getInventory()
                local serial = nil

                if inventory then
                    for _, invItem in pairs(inventory) do
                        if tostring(invItem.Id) == itemID then
                            if invItem.SerialId and type(invItem.SerialId) == "number" then
                                serial = invItem.SerialId
                                break
                            end
                        end
                    end
                end

                local uniqueKey = serial and (itemID .. "_" .. serial) or itemID

                if not rolledIDs[uniqueKey] then

                    rolledIDs[uniqueKey] = true

                    -- Send notification (now handles both Limited and Gem Safe Legendary)
                    sendNotification(LocalPlayer.Name, itemData, serial)

                end

            end

        end

    end

end)
