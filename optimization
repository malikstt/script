local RS = game:GetService("ReplicatedStorage")
local LocalData = require(RS.Client.Framework.Services.LocalData)
local RemoteEvent = RS.Shared.Framework.Network.Remote.RemoteEvent
local PetsModule = require(RS.Shared.Data.Pets)

local TARGET_ENCHANT = "secret-hunter"
local enchanted = {}

task.spawn(function()
    while true do
        local data = LocalData:Get()
        if data and data.Pets and data.Teams and data.TeamEquipped then
            local equipped = {}
            local team = data.Teams[data.TeamEquipped]
            if team and team.Pets then
                for _, id in ipairs(team.Pets) do
                    equipped[id] = true
                end
            end

            local secrets = {}
            for _, pet in pairs(data.Pets) do
                local info = PetsModule[pet.Name]
                if info and info.Rarity == "Secret" then
                    table.insert(secrets, pet.Id)
                end
            end

            local c = 0
            for _, id in ipairs(secrets) do
                if c >= 13 then break end
                if not equipped[id] then
                    RemoteEvent:FireServer("EquipPet", id)
                    task.wait(0.15)
                end
                c += 1
            end

            for id in pairs(equipped) do
                local keep = false
                for i = 1, math.min(13, #secrets) do
                    if id == secrets[i] then
                        keep = true
                        break
                    end
                end
                if not keep then
                    RemoteEvent:FireServer("UnequipPet", id)
                    task.wait(0.15)
                end
            end
        end
        task.wait(0.3)
    end
end)

task.spawn(function()
    while true do
        local data = LocalData:Get()
        if data and data.Teams and data.TeamEquipped then
            local team = data.Teams[data.TeamEquipped]
            if team and team.Pets then
                for _, petId in ipairs(team.Pets) do
                    if not enchanted[petId] then
                        local pet
                        for _, p in ipairs(data.Pets or {}) do
                            if p.Id == petId then pet = p break end
                        end
                        if pet then
                            local has = false
                            for _, e in ipairs(pet.Enchants or {}) do
                                if e.Id == TARGET_ENCHANT then
                                    has = true
                                    break
                                end
                            end
                            if has then
                                enchanted[petId] = true
                            else
                                RemoteEvent:FireServer("UseShadowCrystal", petId)
                            end
                        end
                    end
                    task.wait(0.1)
                end
            end
        end
        task.wait(0.1)
    end
end)
