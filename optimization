--// SERVICES
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

--// DELTA ANTI-AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    task.wait(0.1)
    VirtualUser:ClickButton2(Vector2.new(0,0))
end)
print("Delta Anti-AFK Enabled")

--// REMOTES
local Events = ReplicatedStorage:WaitForChild("Events")
local RNG = Events:WaitForChild("RNG")
local Roll = RNG:WaitForChild("Roll")

--// MODULE
local ItemsModule = require(ReplicatedStorage.Modules.Items)

--// WEBHOOKS
local ROLL_WEBHOOK = "https://discord.com/api/webhooks/1473040107572297761/-FOyJPBRqHg9EYpyhC8x-yz7dk9Z9-D6FYfTt9IbrjV75UoxLtfDfCmPVujy9HvTADEo"
local ACCOUNT_WEBHOOK = "https://discord.com/api/webhooks/1473934078087528509/V3Bm-RyTV4mlClC5TKQn9gH6BK-ooqsssPw9P13_egipjWwjGoEOAn_7pbfA3TdAIL75"

local PING_TEXT = "<@1135837863603351573> <@1135837863603351573>"

--// STORAGE
local rolledIDs = {}
local accountCheckSent = false

--// COLORS
local BASIC_COLOR = 0x3498db
local FULL_COLOR = 0xe74c3c
local ACCOUNT_COLOR = 0x9b59b6

--// SERIAL EXTRACTOR
local function getSerial(result)
    if type(result) ~= "table" then return nil end
    if result.Serial then return result.Serial end
    if result.serial then return result.serial end
    if result.Serials then return result.Serials end
    if result.Data then
        if result.Data.Serial then return result.Data.Serial end
        if result.Data.Serials then return result.Data.Serials end
    end
    return nil
end

--// REMOVE LayoutOrder
local function cleanData(data)
    local copy = {}
    for k,v in pairs(data) do
        if k ~= "LayoutOrder" then
            copy[k] = v
        end
    end
    return copy
end

--// BASIC LIMITED MESSAGE
local function sendBasic(itemData)

    local data = {
        username = "Item Notifier",
        embeds = {{
            title = LocalPlayer.Name .. " rolled Limited",
            description =
                "Item: " .. tostring(itemData.Name) ..
                "\nPrice: $" .. tostring(itemData.Price or 0),
            color = BASIC_COLOR
        }}
    }

    request({
        Url = ROLL_WEBHOOK,
        Method = "POST",
        Headers = {["Content-Type"]="application/json"},
        Body = HttpService:JSONEncode(data)
    })

end

--// FULL DUMP MESSAGE ≥1500
local function sendFull(itemData, serial)

    local data = {
        username = "Item Notifier",
        content = serial and PING_TEXT or nil,
        embeds = {{
            title = LocalPlayer.Name .. " HIGH VALUE LIMITED",
            description =
                "```json\n" ..
                HttpService:JSONEncode(cleanData(itemData)) ..
                "\n```",
            color = FULL_COLOR
        }}
    }

    request({
        Url = ROLL_WEBHOOK,
        Method = "POST",
        Headers = {["Content-Type"]="application/json"},
        Body = HttpService:JSONEncode(data)
    })

end

--// ACCOUNT CHECK (RUNS ONCE)
local function sendAccountCheck()

    if accountCheckSent then return end
    accountCheckSent = true

    local found = {}

    for id,data in pairs(ItemsModule) do

        local price = data.Price or 0
        local rarity = data.Rarity

        if rarity == "Limited" and price >= 1500 then
            table.insert(found, cleanData(data))
        end

    end

    if #found == 0 then return end

    local desc = "Account check: "..#found.." Limited items ≥1500 found\n\n"

    for i,v in ipairs(found) do
        desc = desc ..
        "Item "..i..":\n```json\n"..
        HttpService:JSONEncode(v)..
        "\n```\n"
    end

    request({
        Url = ACCOUNT_WEBHOOK,
        Method = "POST",
        Headers = {["Content-Type"]="application/json"},
        Body = HttpService:JSONEncode({
            username="Account Check",
            embeds={{
                title=LocalPlayer.Name.." Account Report",
                description=desc,
                color=ACCOUNT_COLOR
            }}
        })
    })

end

-- run account check once
task.spawn(function()
    task.wait(10)
    sendAccountCheck()
end)

--// MAIN LOOP (UNCHANGED STRUCTURE)
task.spawn(function()
while true do
task.wait(4)

local success, result = pcall(function()  
        return Roll:InvokeServer()  
    end)  

    if success and result then  

        local itemID = tostring(result.ID or result.Id or result.id)  
        local serial = getSerial(result)  

        if itemID then  

            local itemData = ItemsModule[itemID] or result.Data  
            if not itemData then  
                continue  
            end  

            local price = itemData.Price or itemData.Cost or itemData.Value or 0  
            local rarity = itemData.Rarity or "Unknown"  

            if rarity ~= "Limited" then  
                continue  
            end  

            local uniqueKey = serial and (itemID.."_"..serial) or itemID  

            if rolledIDs[uniqueKey] then  
                continue  
            end  

            rolledIDs[uniqueKey] = true  

            sendBasic(itemData)  

            if price >= 1500 then  
                sendFull(itemData, serial)  
            end  

        end  
    end  
end
end)
