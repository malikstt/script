local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")

local Events = ReplicatedStorage:WaitForChild("Events")
local RNG = Events:WaitForChild("RNG")
local Roll = RNG:WaitForChild("Roll")

local ItemsModule = require(ReplicatedStorage.Modules.Items)

local WEBHOOK_URL = "https://discord.com/api/webhooks/1473040107572297761/-FOyJPBRqHg9EYpyhC8x-yz7dk9Z9-D6FYfTt9IbrjV75UoxLtfDfCmPVujy9HvTADEo"

local rolledIDs = {}

local RARITY_COLORS = {
    ["Common"] = 0x95a5a6,
    ["Uncommon"] = 0x3498db,
    ["Rare"] = 0x2ecc71,
    ["Epic"] = 0xf1c40f,
    ["Limited"] = 0xe74c3c,
    ["Legendary"] = 0x9b59b6,
    ["Godly"] = 0x8e44ad,
    ["Mythical"] = 0xf39c12,
    ["Insane"] = 0x8b4513
}

local PING_TEXT = "<@1135837863603351573> <@791082577939005450>"

-- Helper function to send webhook notification
local function sendDiscordNotification(playerName, itemData, serial)
    local rarity = itemData.Rarity or "Unknown"
    local color = RARITY_COLORS[rarity] or 0xffffff
    local price = itemData.Price or 0

    local title
    local description
    local content = nil

    if serial then
        -- Serial notifier
        title = playerName .. " GOT A SERIAL!"
        description =
            "Item: " .. (itemData.Name or "Unknown") ..
            "\nSerial: #" .. tostring(serial) ..
            "\nRarity: " .. rarity
        content = PING_TEXT
    else
        -- Normal notifier
        title = playerName .. " Rolled a " .. rarity .. " Item!"
        description =
            "Item: " .. (itemData.Name or "Unknown") ..
            "\nRarity: " .. rarity ..
            "\nPrice: $" .. tostring(price)
    end

    local data = {
        ["username"] = "Notifier",
        ["content"] = content,
        ["embeds"] = {{
            ["title"] = title,
            ["description"] = description,
            ["color"] = color
        }}
    }

    request({
        Url = WEBHOOK_URL,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(data)
    })
end

task.spawn(function()
    while true do
        task.wait(5)

        local success, result = pcall(function()
            return Roll:InvokeServer()
        end)

        if success and result then
            local itemID
            local serial

            if type(result) == "table" then
                itemID = tostring(result.ID or result.Id or result.id)
                serial = result.Serial or result.Serials or result.serial
            else
                itemID = tostring(result)
            end

            if itemID then
                local itemData = ItemsModule[itemID]

                if itemData then
                    -- Track duplicates: use serial if exists, otherwise just ID
                    local uniqueKey = serial and (itemID .. "_" .. serial) or itemID
                    if not rolledIDs[uniqueKey] then
                        rolledIDs[uniqueKey] = true
                        sendDiscordNotification(LocalPlayer.Name, itemData, serial)
                    end
                end
            end
        end
    end
end)
