--// SERVICES
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

--// DELTA ANTI-AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    task.wait(0.1)
    VirtualUser:ClickButton2(Vector2.new(0,0))
end)
print("Delta Anti-AFK Enabled")

--// REMOTES
local Events = ReplicatedStorage:WaitForChild("Events")
local RNG = Events:WaitForChild("RNG")
local Roll = RNG:WaitForChild("Roll")

--// MODULE
local ItemsModule = require(ReplicatedStorage.Modules.Items)

--// WEBHOOKS
local LIVE_WEBHOOK = "https://discord.com/api/webhooks/1473040107572297761/-FOyJPBRqHg9EYpyhC8x-yz7dk9Z9-D6FYfTt9IbrjV75UoxLtfDfCmPVujy9HvTADEo"
local ACCOUNT_WEBHOOK = "https://discord.com/api/webhooks/1473934078087528509/V3Bm-RyTV4mlClC5TKQn9gH6BK-ooqsssPw9P13_egipjWwjGoEOAn_7pbfA3TdAIL75"
local PING = "<@1135837863603351573>"

--// STORAGE
local rolledCache = {}
local accountLimiteds = {}

--// COLORS
local COLORS = {
    LIMITED_BASIC = 0xf1c40f,   -- yellow (normal limited)
    LIMITED_HIGH  = 0xe74c3c,   -- red (≥1500)
    ACCOUNT_CHECK = 0x3498db    -- blue
}

--// SERIAL EXTRACTOR
local function getSerial(result)
    if type(result) ~= "table" then return nil end
    if result.Serial then return result.Serial end
    if result.serial then return result.serial end
    if result.Serials then return result.Serials end
    if result.Data then
        if result.Data.Serial then return result.Data.Serial end
        if result.Data.Serials then return result.Data.Serials end
    end
end

--// CLEAN DATA (remove LayoutOrder)
local function cleanData(data)
    local copy = {}
    for k,v in pairs(data) do
        if k ~= "LayoutOrder" then
            copy[k] = v
        end
    end
    return copy
end

--// WEBHOOK SENDER
local function sendWebhook(url, payload)
    request({
        Url = url,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(payload)
    })
end

--// LIVE LIMITED SHORT MESSAGE
local function sendLimitedBasic(itemData)
    local name = itemData.Name or "Unknown"
    local price = itemData.Price or 0
    local payload = {
        username = "Limited Notifier",
        embeds = {{
            title = LocalPlayer.Name.." got a Limited!",
            description = "Item: **"..name.."**\nPrice: **"..price.."**",
            color = COLORS.LIMITED_BASIC
        }}
    }
    sendWebhook(LIVE_WEBHOOK, payload)
end

--// LIVE HIGH VALUE LIMITED FULL DUMP
local function sendFullDump(itemID, itemData, serial)
    local dump = cleanData(itemData)
    local payload = {
        username = "High Value Limited",
        content = serial and PING or nil,
        embeds = {{
            title = LocalPlayer.Name.." got HIGH VALUE Limited",
            description = "```json\n"..HttpService:JSONEncode(dump).."\n```",
            color = COLORS.LIMITED_HIGH
        }}
    }
    sendWebhook(LIVE_WEBHOOK, payload)
end

--// MAIN ROLL LOOP
task.spawn(function()
    while true do
        task.wait(4)

        local success, result = pcall(function()
            return Roll:InvokeServer()
        end)
        if not success or not result then continue end

        local itemID = tostring(result.ID)
        local serial = getSerial(result)
        local itemData = ItemsModule[itemID] or result.Data
        if not itemData then continue end

        local rarity = itemData.Rarity
        local price = itemData.Price or 0

        if rarity ~= "Limited" then continue end

        local key = serial and itemID.."_"..serial or itemID
        if rolledCache[key] then continue end
        rolledCache[key] = true

        -- Short message for all Limited
        sendLimitedBasic(itemData)

        -- High value ≥1500 → full dump + store for account check
        if price >= 1500 then
            sendFullDump(itemID, itemData, serial)
            accountLimiteds[key] = {
                ID = itemID,
                Data = cleanData(itemData)
            }
        end
    end
end)

--// SINGLE ACCOUNT CHECK (runs once)
task.spawn(function()
    task.wait(10) -- small delay to accumulate initial rolls

    local count = 0
    local lines = {}

    for _, item in pairs(accountLimiteds) do
        count += 1
        table.insert(lines, "Item "..count.." : "..HttpService:JSONEncode(item))
    end

    if count > 0 then
        local payload = {
            username = "Account Check",
            embeds = {{
                title = "Account check: "..count.." Limited items ≥1500 found",
                description = table.concat(lines, "\n"),
                color = COLORS.ACCOUNT_CHECK
            }}
        }
        sendWebhook(ACCOUNT_WEBHOOK, payload)
    end
end)
