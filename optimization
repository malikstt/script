local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local API_BASE = "https://chips-workers-hammer-consulting.trycloudflare.com"
local Config = {
    SellerUsername = "Keiyoz",
    CheckInterval = 5,
    OnlyPets = true,
    StrictMatchTokens = true,
}

local LP = Players.LocalPlayer
local lastTriedJobId = nil
local isBuying = false

local Replication = require(ReplicatedStorage:WaitForChild("Game"):WaitForChild("Replication"))
local Network = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Network"))

local function getTokens()
    return tonumber(Replication.Data and Replication.Data.Items and Replication.Data.Items.PaidTokens) or 0
end

task.spawn(function()
    while true do
        pcall(function()
            request({
                Url = API_BASE .. "/update",
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode({
                    role = "alt",
                    username = LP.Name,
                    userId = LP.UserId,
                    tokens = getTokens()
                })
            })
        end)
        task.wait(5)
    end
end)

local function startBuyingLogic(sellerId)
    if isBuying then return end
    isBuying = true

    while isBuying do
        local tokens = getTokens()
        if tokens <= 0 then break end

        local ok, listings = pcall(function()
            return Network:InvokeServer("GetBoothListings", sellerId)
        end)

        if ok and type(listings) == "table" then
            for listingId, data in pairs(listings) do
                if type(data) == "table" then
                    local price = tonumber(data.itemPrice)
                    local pass = true
                    if Config.OnlyPets and data.itemType ~= "Pet" then pass = false end
                    if Config.StrictMatchTokens and price ~= tokens then pass = false end

                    if pass and price and price <= tokens then
                        local success = Network:InvokeServer("BuyItem", sellerId, listingId)
                        if success then
                            isBuying = false
                            return
                        end
                    end
                end
            end
        end
        task.wait(Config.CheckInterval)
    end
end

task.spawn(function()
    local sellerId
    do
        local ok, id = pcall(function()
            return Players:GetUserIdFromNameAsync(Config.SellerUsername)
        end)
        sellerId = ok and id or nil
    end

    while true do
        local ok, res = pcall(function()
            return request({ Url = API_BASE .. "/main", Method = "GET" })
        end)

        if ok and res and res.Body then
            local decoded
            local okDecode = pcall(function()
                decoded = HttpService:JSONDecode(res.Body)
            end)

            if okDecode and decoded and decoded.data then
                local mainJobId = decoded.data.jobId
                local placeId = decoded.data.placeId
                local currentTokens = getTokens()

                if mainJobId and game.JobId == mainJobId then
                    if sellerId then
                        startBuyingLogic(sellerId)
                    end
                elseif currentTokens > 0 and mainJobId and placeId and mainJobId ~= lastTriedJobId then
                    lastTriedJobId = mainJobId
                    TeleportService:TeleportToPlaceInstance(placeId, mainJobId, LP)
                end
            end
        end

        task.wait(3)
    end
end)
