local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local API_BASE = "https://chips-workers-hammer-consulting.trycloudflare.com"
local Config = {
    SellerUsername = "Keiyoz",
    CheckInterval = 5,
    OnlyPets = true,
    StrictMatchTokens = true,
}

local LP = Players.LocalPlayer
local lastTriedJobId = nil
local isBuying = false

local Replication = require(ReplicatedStorage:WaitForChild("Game"):WaitForChild("Replication"))
local Network = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Network"))

local function getTokens()
    return tonumber(Replication.Data and Replication.Data.Items and Replication.Data.Items.PaidTokens) or 0
end

local function teleportAroundKeiyoz()
    local sellerPlayer = Players:FindFirstChild(Config.SellerUsername)
    if not sellerPlayer or not sellerPlayer.Character or not sellerPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local sellerHRP = sellerPlayer.Character.HumanoidRootPart
    local character = LP.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then
        return false
    end
    
    -- Teleport in 5 stud circle around seller 3 times
    for i = 1, 3 do
        for j = 1, 3 do  -- Do 3 teleports per circle for smoother movement
            if not character or not character.Parent then break end
            
            -- Calculate random position in 5 stud circle
            local angle = math.random() * math.pi * 2
            local radius = math.random() * 5
            local offset = Vector3.new(
                math.cos(angle) * radius,
                0,
                math.sin(angle) * radius
            )
            
            local targetPosition = sellerHRP.Position + offset
            
            -- Teleport player
            character:SetPrimaryPartCFrame(CFrame.new(targetPosition))
            
            -- Small wait between teleports
            task.wait(0.1)
        end
        
        -- Wait a bit between circles
        if i < 3 then
            task.wait(0.3)
        end
    end
    
    return true
end

-- Update API function
task.spawn(function()
    while true do
        pcall(function()
            request({
                Url = API_BASE .. "/update",
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode({
                    role = "alt",
                    username = LP.Name,
                    userId = LP.UserId,
                    tokens = getTokens()
                })
            })
        end)
        task.wait(5)
    end
end)

local function startBuyingLogic(sellerId)
    if isBuying then return end
    isBuying = true
    
    -- First teleport around Keiyoz before buying
    teleportAroundKeiyoz()
    
    -- Small delay after teleportation
    task.wait(0.5)
    
    while isBuying do
        local tokens = getTokens()
        
        -- Kick player if tokens reach 0
        if tokens <= 0 then
            LP:Kick("Tokens depleted - autobuy stopped")
            isBuying = false
            break
        end
        
        local ok, listings = pcall(function()
            return Network:InvokeServer("GetBoothListings", sellerId)
        end)
        
        if ok and type(listings) == "table" then
            for listingId, data in pairs(listings) do
                if type(data) == "table" then
                    local price = tonumber(data.itemPrice)
                    local pass = true
                    
                    if Config.OnlyPets and data.itemType ~= "Pet" then 
                        pass = false 
                    end
                    
                    if Config.StrictMatchTokens and price ~= tokens then 
                        pass = false 
                    end
                    
                    if pass and price and price <= tokens then
                        -- Small random delay before buying
                        task.wait(math.random(0.1, 0.3))
                        
                        local success = Network:InvokeServer("BuyItem", sellerId, listingId)
                        if success then
                            print("Successfully purchased item!")
                            isBuying = false
                            return
                        end
                    end
                end
            end
        end
        
        -- Optional: Teleport around again between checks
        if math.random(1, 3) == 1 then -- 33% chance to teleport between checks
            teleportAroundKeiyoz()
        end
        
        task.wait(Config.CheckInterval)
    end
    
    isBuying = false
end

-- Main monitoring loop
task.spawn(function()
    local sellerId
    do
        local ok, id = pcall(function()
            return Players:GetUserIdFromNameAsync(Config.SellerUsername)
        end)
        sellerId = ok and id or nil
    end
    
    while true do
        local ok, res = pcall(function()
            return request({ Url = API_BASE .. "/main", Method = "GET" })
        end)
        
        if ok and res and res.Body then
            local decoded
            local okDecode = pcall(function()
                decoded = HttpService:JSONDecode(res.Body)
            end)
            
            if okDecode and decoded and decoded.data then
                local mainJobId = decoded.data.jobId
                local placeId = decoded.data.placeId
                local currentTokens = getTokens()
                
                if mainJobId and game.JobId == mainJobId then
                    if sellerId then
                        startBuyingLogic(sellerId)
                    end
                elseif currentTokens > 0 and mainJobId and placeId and mainJobId ~= lastTriedJobId then
                    lastTriedJobId = mainJobId
                    TeleportService:TeleportToPlaceInstance(placeId, mainJobId, LP)
                end
            end
        end
        
        task.wait(3)
    end
end)

-- Safety check for tokens depletion
task.spawn(function()
    while true do
        local tokens = getTokens()
        if tokens <= 0 then
            LP:Kick("No tokens remaining - autobuy stopped")
            break
        end
        task.wait(1)
    end
end)
