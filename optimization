local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local ItemsModule = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Items"))

local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

-- YOUR ORIGINAL WEBHOOKS (UNCHANGED)
local NORMAL_WEBHOOK = "https://discord.com/api/webhooks/1473040107572297761/-FOyJPBRqHg9EYpyhC8x-yz7dk9Z9-D6FYfTt9IbrjV75UoxLtfDfCmPVujy9HvTADEo"
local SERIAL_WEBHOOK = "https://discord.com/api/webhooks/1473934078087528509/V3Bm-RyTV4mlClC5TKQn9gH6BK-ooqsssPw9P13_egipjWwjGoEOAn_7pbfA3TdAIL75"

-- Anti idle
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    task.wait(0.1)
    VirtualUser:ClickButton2(Vector2.new(0,0))
end)

local Events = ReplicatedStorage:WaitForChild("Events")
local RNG = Events:WaitForChild("RNG")
local Roll = RNG:WaitForChild("Roll")

-- Prevent duplicates
local rolledIDs = {}
local sentSerials = {}

-- Colors
local RARITY_COLORS = {
    ["Common"] = 0x95a5a6,
    ["Uncommon"] = 0x3498db,
    ["Rare"] = 0x2ecc71,
    ["Epic"] = 0xf1c40f,
    ["Limited"] = 0xe74c3c,
    ["Legendary"] = 0x9b59b6,
    ["Godly"] = 0x8e44ad,
    ["Mythical"] = 0xf39c12,
    ["Insane"] = 0x8b4513
}

-- Webhook sender
local function postWebhook(url, data)

    request({
        Url = url,
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json"
        },
        Body = HttpService:JSONEncode(data)
    })

end

-- GET SERIAL FROM INVENTORY (CORRECT SOURCE)
local function getSerial(itemID)

    local success, data = pcall(function()
        return DataEvent:InvokeServer()
    end)

    if not success or not data then
        return nil
    end

    local inventory = data.ValentinesInventory2026

    if not inventory then
        return nil
    end

    for _, item in pairs(inventory) do

        if tostring(item.Id) == tostring(itemID) then

            if item.SerialId and type(item.SerialId) == "number" then
                return item.SerialId
            end

        end

    end

    return nil

end

-- SEND NORMAL WEBHOOK
local function sendNormal(playerName, itemData, serial)

    local rarity = itemData.Rarity or "Unknown"

    if rarity ~= "Limited" then
        return
    end

    local itemName = itemData.Name or "Unknown"
    local price = itemData.Price or 0

    local hasSerial = serial and type(serial) == "number"

    -- COLOR FIX
    local color

    if hasSerial then
        color = 0xf1c40f -- yellow
    else
        color = RARITY_COLORS[rarity] or 0xffffff -- red
    end

    local description =
        "Item: " .. itemName ..
        "\nRarity: " .. rarity ..
        "\nCost: $" .. price

    if hasSerial then
        description = description ..
        "\nSerial: #" .. serial
    end

    -- NORMAL WEBHOOK
    postWebhook(NORMAL_WEBHOOK, {

        username = "Item Notifier",

        embeds = {{

            title = playerName .. " Rolled Limited",

            description = description,

            color = color

        }}

    })

    -- SERIAL WEBHOOK (CLEAN FORMAT)
    if hasSerial then

        local key = playerName .. "_" .. itemName .. "_" .. serial

        if not sentSerials[key] then

            sentSerials[key] = true

            postWebhook(SERIAL_WEBHOOK, {

                username = "Serial Logger",

                content =
                    playerName ..
                    ":" ..
                    itemName ..
                    ":" ..
                    serial

            })

        end

    end

end

-- ROLL LOOP
task.spawn(function()

    local rollCount = 0

    while true do

        task.wait(4)

        rollCount += 1

        print("[Roll #" .. rollCount .. "] Rolling...")

        local success, result = pcall(function()
            return Roll:InvokeServer()
        end)

        if success and result then

            local itemID

            if type(result) == "table" then
                itemID = tostring(result.ID or result.Id or result.id)
            else
                itemID = tostring(result)
            end

            if itemID then

                local itemData = ItemsModule[itemID]

                if itemData then

                    -- GET SERIAL FROM INVENTORY
                    local serial = getSerial(itemID)

                    local uniqueKey

                    if serial then
                        uniqueKey = itemID .. "_" .. serial
                    else
                        uniqueKey = itemID
                    end

                    if not rolledIDs[uniqueKey] then

                        rolledIDs[uniqueKey] = true

                        print(
                            "[Roll #" .. rollCount .. "] Got:",
                            itemData.Name,
                            serial and ("Serial #" .. serial) or "(No Serial)"
                        )

                        sendNormal(LocalPlayer.Name, itemData, serial)

                    end

                end

            end

        else

            print("[Roll #" .. rollCount .. "] Roll failed")

        end

    end

end)
