local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

local gui = Instance.new("ScreenGui", lp.PlayerGui)
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.DisplayOrder = 9999999

local bg = Instance.new("Frame", gui)
bg.Size = UDim2.new(1,0,1,0)
bg.BackgroundColor3 = Color3.fromRGB(0,0,0)
bg.BorderSizePixel = 0

local function NewText(parent)
	local t = Instance.new("TextLabel", parent)
	t.Size = UDim2.new(1,0,1,0)
	t.BackgroundTransparency = 1
	t.Font = Enum.Font.GothamBlack
	t.TextScaled = true
	t.TextColor3 = Color3.fromRGB(255,255,255)
	t.TextWrapped = true
	return t
end

local function Section(x,y,w,h)
	local f = Instance.new("Frame", bg)
	f.AnchorPoint = Vector2.new(0.5,0.5)
	f.Position = UDim2.new(x,0,y,0)
	f.Size = UDim2.new(w,0,h,0)
	f.BackgroundTransparency = 1

	local ar = Instance.new("UIAspectRatioConstraint", f)
	ar.AspectRatio = 4
	ar.DominantAxis = Enum.DominantAxis.Height

	return f
end

local topLeft     = Section(0.22,0.10,0.44,0.08)
local topRight    = Section(0.78,0.10,0.44,0.08)
local centerBig   = Section(0.50,0.33,0.70,0.18)
local centerRate  = Section(0.50,0.45,0.50,0.10)
local midLeft     = Section(0.22,0.60,0.44,0.09)
local midRight    = Section(0.78,0.60,0.44,0.09)
local bottomFull  = Section(0.50,0.82,0.90,0.12)

local TL  = NewText(topLeft)
local TR  = NewText(topRight)
local BIG = NewText(centerBig)
local RATE= NewText(centerRate)
local ML  = NewText(midLeft)
local MR  = NewText(midRight)
local BOT = NewText(bottomFull)

local function gd() local ok,d=pcall(function()return LocalData:Get()end) return ok and d or {} end

local function fmt(n)
	n = tonumber(n) or 0
	if n>=1e12 then return string.format("%.2fT",n/1e12)
	elseif n>=1e9 then return string.format("%.2fB",n/1e9)
	elseif n>=1e6 then return string.format("%.2fM",n/1e6)
	elseif n>=1e3 then return string.format("%.2fK",n/1e3)
	else return tostring(n) end
end

local function getSnow() return gd().Snowflakes or 0 end

local function getPep()
	local d = gd().Cooldowns
	return d and (d["Peppermint Chest"] or d["PeppermintChest"] or d["Peppermint"])
end

local function fmtTime(sec)
	if not sec or sec<=0 then return "Ready" end
	sec = math.floor(sec/1000)
	return string.format("%d:%02d", math.floor(sec/60), sec%60)
end

local function getXmas()
	return gd().MasteryLevels and gd().MasteryLevels.Christmas or 0
end

local ITEMS = {
	"Christmas Present",
	"Christmas Key",
	"Christmas Spin Ticket"
}

local function getItems()
	local d = gd()
	local r = {}
	local function scan(t)
		for k,v in pairs(t) do
			if type(v)=="table" then scan(v)
			else for _,nm in ipairs(ITEMS) do if k==nm then r[nm]=v end end end
		end
	end
	scan(d)
	return r
end

local function getTeam()
	local d = gd()
	local ids = (d.Teams and d.TeamEquipped and d.Teams[d.TeamEquipped] and d.Teams[d.TeamEquipped].Pets) or {}
	local map={}
	if d.Pets then for _,p in pairs(d.Pets)do map[tostring(p.Id)]=p end end
	local arr={} local sum=0
	for _,id in ipairs(ids)do
		local p=map[tostring(id)]
		if p and PetsModule[p.Name] and PetsModule[p.Name].Stats then
			local sf = PetsModule[p.Name].Stats.Snowflakes or 0
			sum += sf
			arr[#arr+1] = {Name=p.Name, Snow=sf}
		end
	end
	return arr,sum
end

local shown = 0
local samples = {}
local idx = 1

local function push(v)
	samples[#samples+1]={t=tick(),v=v}
	while #samples>1 and tick()-samples[1].t>60 do table.remove(samples,1) end
end

local function perMin()
	if #samples<2 then return 0 end
	local a=samples[1]
	local b=samples[#samples]
	if b.t-a.t<=0 or b.v-a.v<0 then return 0 end
	return ((b.v-a.v)/(b.t-a.t))*60
end

task.spawn(function()
	while true do
		local snow=getSnow()
		push(snow)

		local s0 = shown
		local s1 = snow
		local t0 = tick()
		local c

		c = RunService.Heartbeat:Connect(function()
			local a = math.clamp((tick()-t0)/0.25,0,1)
			shown = s0 + (s1 - s0)*a
			BIG.Text = "â„ï¸ "..fmt(shown)
			if a>=1 then c:Disconnect() end
		end)

		RATE.Text = "â„ï¸/min: "..fmt(perMin())
		TL.Text = "ğŸ¬ Peppermint Chest: "..fmtTime(getPep())
		TR.Text = "ğŸ„ Xmas Mastery: "..getXmas()

		local it=getItems()
		ML.Text = "ğŸ Christmas Presents: "..fmt(it["Christmas Present"] or 0)
		MR.Text = "ğŸ—ï¸ Keys: "..fmt(it["Christmas Key"] or 0).."\nğŸ¡ Spins: "..fmt(it["Christmas Spin Ticket"] or 0)

		local arr,sum=getTeam()
		if #arr>0 then
			if idx>#arr then idx=1 end
			local p = arr[idx]
			BOT.Text = "ğŸ¾ "..p.Name.." x"..fmt(p.Snow).."   |   â„ï¸ Team Multi: "..fmt(sum)
			idx += 1
		else
			BOT.Text = "ğŸ¾ No Pets Equipped"
		end

		task.wait(1)
	end
end)
