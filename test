repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)

local RemoteEvent = ReplicatedStorage
    :WaitForChild("Shared"):WaitForChild("Framework")
    :WaitForChild("Network"):WaitForChild("Remote")
    :WaitForChild("RemoteEvent")

local Remote = require(ReplicatedStorage.Shared.Framework.Network.Remote)
local PhysicalItem = require(ReplicatedStorage.Client.Effects.PhysicalItem)
local LocalDataModule = require(ReplicatedStorage.Client.Framework.Services.LocalData)

getgenv().waitTime = 2.5

local function getData()
    return LocalData:Get() or {}
end

local function isWorldUnlocked(world)
    local d = getData()
    return d.WorldsUnlocked and d.WorldsUnlocked[world] == true
end

local function allIslandsUnlocked(world)
    local d = getData()
    local unlocked = d.AreasUnlocked or {}
    local w = Workspace.Worlds:FindFirstChild(world)
    if not w or not w:FindFirstChild("Islands") then return false end
    for _, isl in ipairs(w.Islands:GetChildren()) do
        if not unlocked[isl.Name] then
            return false
        end
    end
    return true
end

local function fireUnlock(world)
    if not isWorldUnlocked(world) then
        RemoteEvent:FireServer("UnlockWorld", world)
        task.wait(6)
    end
end

local function fireTeleport(world)
    RemoteEvent:FireServer("WorldTeleport", world)
end

local function waitForWorld(world)
    while not Workspace.Worlds:FindFirstChild(world) do
        task.wait(1)
    end
end

local function waitForIslands(world)
    local w
    repeat
        w = Workspace.Worlds:FindFirstChild(world)
        task.wait(1)
    until w and w:FindFirstChild("Islands")
    return w.Islands
end

local function unlockIslands(world)
    if not firetouchinterest then return end
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    local islandsFolder = waitForIslands(world)

    while true do
        local unlocked = getData().AreasUnlocked or {}
        local remaining = {}

        for _, isl in ipairs(islandsFolder:GetChildren()) do
            if not unlocked[isl.Name] then
                table.insert(remaining, isl)
            end
        end

        if #remaining == 0 then break end

        for _, isl in ipairs(remaining) do
            local island = isl:FindFirstChild("Island")
            if island then
                for _, part in ipairs(island:GetDescendants()) do
                    if part:IsA("BasePart") then
                        firetouchinterest(hrp, part, 0)
                        task.wait()
                        firetouchinterest(hrp, part, 1)
                    end
                end
            end
        end

        task.wait(2)
    end
end

pcall(function() setfpscap(10) end)

if not isWorldUnlocked("The Overworld") then
    fireUnlock("The Overworld")
    fireTeleport("The Overworld")
    waitForWorld("The Overworld")
    task.wait(5)
    unlockIslands("The Overworld")
else
    fireTeleport("The Overworld")
    waitForWorld("The Overworld")
end

if not allIslandsUnlocked("The Overworld") then
    unlockIslands("The Overworld")
end

local t = tick()
while tick() - t < 60 do
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.B, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.B, false, game)
    task.wait(10)
end

getgenv().oldGift = getgenv().oldGift or PhysicalItem.Gift
PhysicalItem.Gift = function(giftId, giftType, giftPosition)
    if not getgenv().autoGift then
        return getgenv().oldGift(giftId, giftType, giftPosition)
    end
    task.spawn(function()
        pcall(function()
            Remote:FireServer("ClaimGift", giftId)
        end)
    end)
    return nil
end

getgenv().autoGift = true
Remote:FireServer("SetSetting","Item Notifications",false)

local giftStart = tick()
while tick() - giftStart < 60 do
    local powerups = LocalDataModule:Get().Powerups or {}
    for name, amount in pairs(powerups) do
        if string.find(name, "Mystery Box") and amount > 0 then
            Remote:FireServer("UseGift", name, (amount > 25 and 25 or amount))
            task.wait(getgenv().waitTime)
        end
    end
end

getgenv().autoGift = false

fireUnlock("Christmas World")
fireTeleport("Christmas World")
waitForWorld("Christmas World")
task.wait(5)
unlockIslands("Christmas World")

local gui = Instance.new("ScreenGui")
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.Parent = player.PlayerGui

local frame = Instance.new("Frame")
frame.Parent = gui
frame.Size = UDim2.fromOffset(200,200)
frame.Position = UDim2.fromScale(0.5,0.5)
frame.AnchorPoint = Vector2.new(0.5,0.5)
frame.BackgroundColor3 = Color3.fromRGB(0,180,0)

Instance.new("UICorner", frame).CornerRadius = UDim.new(0,18)

local function label(txt, y)
    local l = Instance.new("TextLabel")
    l.Parent = frame
    l.Size = UDim2.new(1,-20,0,40)
    l.Position = UDim2.fromOffset(10,y)
    l.BackgroundTransparency = 1
    l.TextScaled = true
    l.Font = Enum.Font.GothamBold
    l.TextColor3 = Color3.new(1,1,1)
    l.Text = txt
end

label("Christmas World Unlocked ✓",30)
label("All Xmas Islands Unlocked ✓",120)
