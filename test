local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local taskWait = task.wait

local AuctionsFolder = workspace:WaitForChild("Debris"):WaitForChild("Auctions")
local Auctions = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Auctions")
local EnterQueue = Auctions:WaitForChild("EnterQueue")
local Skip = Auctions:WaitForChild("Skip")
local SkipCountdown = Auctions:WaitForChild("SkipCountdown")
local UpdateCurrentBid = Auctions:WaitForChild("UpdateCurrentBid")
local PlaceBid = Auctions:WaitForChild("PlaceBid")
local DataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Data"):WaitForChild("GetAll")

local SCAN_DURATION = 2
local BID_CHECK_INTERVAL = 0.2

local inAuction = false
local auctionEnded = false
local halted = false
local currentNextBid
local currentBidder
local currentGarage = nil
local garagesSkipped = 0
local MAX_GARAGES = 3

local lastSkipTime = 0
local SKIP_COOLDOWN = 1

print("ðŸš€ Script started - Will bid on all garages and collect all items")

UpdateCurrentBid.OnClientEvent:Connect(function(data)
    if data then
        currentNextBid = data.nextBid
        currentBidder = data.player
    end
end)

AuctionsFolder.ChildAdded:Connect(function(garage)
    inAuction = true
    auctionEnded = false
    currentGarage = garage
    garagesSkipped = 0
    print("ðŸ Entered garage:", garage.Name)
end)

AuctionsFolder.ChildRemoved:Connect(function(garage)
    if #AuctionsFolder:GetChildren() == 0 then
        inAuction = false
        currentGarage = nil
        print("ðŸ Left auction")
    end
end)

local function storageFull()
    local success, data = pcall(function() return DataEvent:InvokeServer() end)
    if not success or not data then return false end
    local inv = data.Inventory or {}
    local invLevel = data.InventoryLevel
    local carryLevel = data.CarryLevel
    
    local RepLibrary = require(ReplicatedStorage.Modules.RepLibrary)
    local carrySpace = RepLibrary:GetCarrySpace(LocalPlayer, carryLevel)
    local invSpace = RepLibrary:GetInventorySpace(LocalPlayer, invLevel)
    local invCount = RepLibrary:GetLengthOfInventory(inv)

    return invCount >= invSpace and carrySpace <= 0
end

local function tryClick(obj)
    if obj and (obj:IsA("TextButton") or obj:IsA("ImageButton")) then
        print("Clicking:", obj.Name)
        pcall(function()
            obj:Activate()
        end)

        if getconnections then
            for _, v in pairs(getconnections(obj.MouseButton1Click)) do
                pcall(function()
                    v:Function()
                end)
            end
        end
    end
end

local function checkForButton()
    local itemsWon = LocalPlayer.PlayerGui:FindFirstChild("ItemsWon", true)
    if itemsWon then
        local button = itemsWon:FindFirstChild("Button", true)
        if button then
            tryClick(button)
        end
    end
end

local function clickConfirmAndSell()
    task.wait(1)
    
    -- Find ItemsWon GUI
    local itemsWon = LocalPlayer.PlayerGui:FindFirstChild("ItemsWon")
    if not itemsWon then return end
    
    -- Click Confirm Button
    local confirmButton = itemsWon:FindFirstChild("ItemsFrame"):FindFirstChild("ConfirmButton", true)
    if confirmButton and confirmButton.Visible then
        tryClick(confirmButton)
        print("âœ… Clicked Confirm")
    end
    
    task.wait(0.5)
    
    -- Click Sell All Button
    local sellButton = itemsWon:FindFirstChild("SellItems"):FindFirstChild("Frame"):FindFirstChild("Normal"):FindFirstChild("Button", true)
    if sellButton and sellButton.Visible then
        tryClick(sellButton)
        print("âœ… Clicked Sell All")
    end
end

-- Main loop
while not halted do
    if storageFull() then
        print("âŒ Storage completely full. Script halted.")
        halted = true
        break
    end

    print("âž¡ Entering auction queue...")
    pcall(function() EnterQueue:InvokeServer("51") end)

    local auctionStartTime = tick()
    auctionEnded = false

    repeat
        taskWait(0.1)
    until inAuction or tick() - auctionStartTime > 10

    if not inAuction then
        continue
    end

    garagesSkipped = 0

    -- Bid on all garages
    while inAuction and not auctionEnded do
        print("ðŸ’° Bidding in garage:", currentGarage and currentGarage.Name or "Unknown")
        
        -- Bid on current garage
        local bidStartTime = tick()
        while inAuction and currentGarage and not auctionEnded do
            if currentNextBid and currentBidder ~= LocalPlayer then
                pcall(function() PlaceBid:InvokeServer(currentNextBid) end)
                print("ðŸ’µ Placed bid:", currentNextBid)
            end
            if tick() - bidStartTime > 60 then break end
            taskWait(BID_CHECK_INTERVAL)
        end
        
        -- Skip to next garage
        garagesSkipped = garagesSkipped + 1
        print("â­ Moving to next garage", garagesSkipped.."/"..MAX_GARAGES)

        if currentGarage and tick() - lastSkipTime > SKIP_COOLDOWN then
            pcall(function() SkipCountdown:InvokeServer() end)
            taskWait(0.1)
            pcall(function() Skip:InvokeServer() end)
            lastSkipTime = tick()
        end
        
        taskWait(1)
    end

    -- Handle ItemsWon screen - NO ITEM SELECTION
    print("ðŸ“¦ Processing ItemsWon screen (skipping item selection)")
    
    -- Setup automatic button clicking for any popup buttons
    checkForButton()
    
    -- Monitor for new buttons
    LocalPlayer.PlayerGui.DescendantAdded:Connect(function(obj)
        if obj.Name == "Button" then
            task.wait(0.2)
            tryClick(obj)
        end
    end)
    
    -- Click confirm and sell all
    clickConfirmAndSell()
    
    -- Backup button checker
    task.spawn(function()
        local timeout = tick() + 8
        while tick() < timeout do
            task.wait(0.5)
            checkForButton()
            clickConfirmAndSell()
        end
    end)

    task.wait(2)
end
