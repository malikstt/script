local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local lp = game.Players.LocalPlayer
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

local function getSnow()
    local ok,d = pcall(function() return LocalData:Get() end)
    if ok and d and d.Snowflakes then return d.Snowflakes end
    return 0
end

local function fmt(n)
    n = math.floor(n or 0)
    return tostring(n):reverse():gsub("(%d%d%d)","%1,"):reverse():gsub("^,","")
end

local gui = Instance.new("ScreenGui")
gui.Name = "SnowflakesUI"
gui.Parent = lp:WaitForChild("PlayerGui")
gui.DisplayOrder = 999999
gui.ResetOnSpawn = false

local card = Instance.new("Frame", gui)
card.Size = UDim2.new(0,360,0,250)
card.Position = UDim2.new(1,-380,0,24)
card.BackgroundColor3 = Color3.fromRGB(20,22,30)
card.BorderSizePixel = 0
Instance.new("UICorner", card).CornerRadius = UDim.new(0,14)

local grad = Instance.new("UIGradient", card)
grad.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0,Color3.fromRGB(120,180,255)),
    ColorSequenceKeypoint.new(1,Color3.fromRGB(200,140,255))
}
grad.Rotation = 45
grad.Transparency = NumberSequence.new(0.88,0.9)

local title = Instance.new("TextLabel", card)
title.Size = UDim2.new(1,-20,0,28)
title.Position = UDim2.new(0,10,0,8)
title.BackgroundTransparency = 1
title.Text = "SNOWFLAKES"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.GothamBlack
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left

local big = Instance.new("TextLabel", card)
big.Size = UDim2.new(1,-20,0,60)
big.Position = UDim2.new(0,10,0,36)
big.BackgroundTransparency = 1
big.Font = Enum.Font.GothamBlack
big.TextSize = 36
big.TextColor3 = Color3.new(1,1,1)
big.TextXAlignment = Enum.TextXAlignment.Left
big.Text = "0"

local rate = Instance.new("TextLabel", card)
rate.Size = UDim2.new(1,-20,0,22)
rate.Position = UDim2.new(0,10,0,100)
rate.BackgroundTransparency = 1
rate.Font = Enum.Font.GothamBold
rate.TextSize = 14
rate.TextColor3 = Color3.fromRGB(200,200,255)
rate.TextXAlignment = Enum.TextXAlignment.Left
rate.Text = "/min: 0"

local cycle = Instance.new("TextLabel", card)
cycle.Size = UDim2.new(1,-20,0,22)
cycle.Position = UDim2.new(0,10,0,124)
cycle.BackgroundTransparency = 1
cycle.Font = Enum.Font.GothamBold
cycle.TextSize = 14
cycle.TextColor3 = Color3.fromRGB(255,255,255)
cycle.TextXAlignment = Enum.TextXAlignment.Left
cycle.Text = "Equipped: ..."

local totalTeam = Instance.new("TextLabel", card)
totalTeam.Size = UDim2.new(1,-20,0,22)
totalTeam.Position = UDim2.new(0,10,0,148)
totalTeam.BackgroundTransparency = 1
totalTeam.Font = Enum.Font.GothamBold
totalTeam.TextSize = 14
totalTeam.TextColor3 = Color3.fromRGB(255,255,200)
totalTeam.TextXAlignment = Enum.TextXAlignment.Left
totalTeam.Text = "Team Total: 0"

-- new: peppermint cooldown label
local peppermintLabel = Instance.new("TextLabel", card)
peppermintLabel.Size = UDim2.new(1,-20,0,20)
peppermintLabel.Position = UDim2.new(0,10,0,178)
peppermintLabel.BackgroundTransparency = 1
peppermintLabel.Font = Enum.Font.GothamBold
peppermintLabel.TextSize = 14
peppermintLabel.TextColor3 = Color3.fromRGB(255,180,180)
peppermintLabel.TextXAlignment = Enum.TextXAlignment.Left
peppermintLabel.Text = "Peppermint Chest: Unknown"

-- new: christmas mastery label
local christmasLabel = Instance.new("TextLabel", card)
christmasLabel.Size = UDim2.new(1,-20,0,22)
christmasLabel.Position = UDim2.new(0,10,0,202)
christmasLabel.BackgroundTransparency = 1
christmasLabel.Font = Enum.Font.GothamBold
christmasLabel.TextSize = 14
christmasLabel.TextColor3 = Color3.fromRGB(180,255,220)
christmasLabel.TextXAlignment = Enum.TextXAlignment.Left
christmasLabel.Text = "Christmas Mastery: Unknown"

local samples = {}
local shown = 0

local function animateNumber(vTo)
    local s = shown
    local t0 = tick()
    local conn
    conn = RunService.Heartbeat:Connect(function()
        local a = math.clamp((tick()-t0)/0.4,0,1)
        shown = s + (vTo - s) * a
        big.Text = fmt(shown)
        if a >= 1 then conn:Disconnect() end
    end)
end

local function push(v)
    table.insert(samples,{t=tick(),v=v})
    while #samples>1 and tick()-samples[1].t>60 do table.remove(samples,1) end
end

local function perMin()
    if #samples<2 then return 0 end
    local a=samples[1]
    local b=samples[#samples]
    if b.t-a.t<=0 or b.v-a.v<0 then return 0 end
    return ((b.v-a.v)/(b.t-a.t))*60
end

local function getEquipped()
    local d = LocalData:Get()
    if not d or not d.Teams or not d.TeamEquipped then return {} end
    local t = d.Teams[d.TeamEquipped]
    return (t and t.Pets) or {}
end

local function calcTeam()
    local ids = getEquipped()
    local map = {}
    local d = LocalData:Get()
    if d and d.Pets then
        for _,p in pairs(d.Pets) do map[tostring(p.Id)] = p end
    end
    local arr = {}
    local sum = 0
    for _,id in ipairs(ids) do
        local p = map[tostring(id)]
        if p and PetsModule[p.Name] and PetsModule[p.Name].Stats and PetsModule[p.Name].Stats.Snowflakes then
            local sf = tonumber(PetsModule[p.Name].Stats.Snowflakes) or 0
            sum += sf
            table.insert(arr,{name=p.Name,sf=sf})
        end
    end
    return arr,sum
end

local function formatTimeSeconds(sec)
    if not sec or sec <= 0 then return "Ready" end
    sec = math.floor(sec)
    local m = math.floor(sec / 60)
    local s = sec % 60
    return string.format("%d:%02d", m, s)
end

local function getPeppermintCooldown()
    local ok, d = pcall(function() return LocalData:Get() end)
    if not ok or not d then return nil end
    local cd = d.Cooldowns and (d.Cooldowns["Peppermint Chest"] or d.Cooldowns["PeppermintChest"] or d.Cooldowns["Peppermint"] )
    return cd
end

local function getChristmasLevel()
    local ok, d = pcall(function() return LocalData:Get() end)
    if not ok or not d then return nil end
    return d.MasteryLevels and d.MasteryLevels.Christmas
end

local lastTeamHash = ""
local petsCycle = {}
local idx = 1

local lastPepper = getPeppermintCooldown()
local lastChristmas = getChristmasLevel()
if lastPepper ~= nil then peppermintLabel.Text = "Peppermint Chest: "..formatTimeSeconds(lastPepper) end
if lastChristmas ~= nil then christmasLabel.Text = "Christmas Mastery: "..tostring(lastChristmas) end

local function flashLabel(lbl)
    local tween1 = TweenService:Create(lbl, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {TextSize = lbl.TextSize + 4})
    local tween2 = TweenService:Create(lbl, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {TextSize = lbl.TextSize})
    tween1:Play()
    tween1.Completed:Wait()
    tween2:Play()
end

task.spawn(function()
    while true do
        local s = getSnow()
        push(s)
        animateNumber(s)
        rate.Text = "/min: "..fmt(perMin())

        local arr,sum = calcTeam()
        local h = ""
        for _,v in ipairs(arr) do h = h..v.name..v.sf end

        if h ~= lastTeamHash then
            lastTeamHash = h
            petsCycle = arr
            idx = 1
            totalTeam.Text = "Current Snowflakes Multi: "..fmt(sum)
        end

        if #petsCycle > 0 then
            local p = petsCycle[idx]
            cycle.Text = p.name.." : x"..p.sf
            idx = idx + 1
            if idx > #petsCycle then idx = 1 end
        else
            cycle.Text = "Equipped: None"
        end

        -- peppermint cooldown update
        local nowPep = getPeppermintCooldown()
        if nowPep ~= lastPepper then
            lastPepper = nowPep
            peppermintLabel.Text = "Peppermint Chest: "..formatTimeSeconds(nowPep)
            flashLabel(peppermintLabel)
        else
            -- update countdown display if numeric
            if nowPep and type(nowPep) == "number" and nowPep > 0 then
                peppermintLabel.Text = "Peppermint Chest: "..formatTimeSeconds(nowPep)
            end
        end

        -- christmas mastery update
        local nowXmas = getChristmasLevel()
        if nowXmas ~= lastChristmas then
            christmasLabel.Text = "Christmas Mastery: "..tostring(nowXmas or "nil")
            if lastChristmas ~= nil and nowXmas and lastChristmas and nowXmas > lastChristmas then
                flashLabel(christmasLabel)
            end
            lastChristmas = nowXmas
        end

        task.wait(1)
    end
end)
