local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Remote = require(ReplicatedStorage.Shared.Framework.Network.Remote)
local PetsData = require(ReplicatedStorage.Shared.Data.Pets)
local IsTrading = require(script.Parent.IsTrading)

local TradeConfig = require(script.Parent.TradeConfig)

local LocalPlayer = Players.LocalPlayer

local function petMatchesCriteria(petName, petRarity)
    for _, targetName in ipairs(TradeConfig.TargetPetNames) do
        if petName == targetName then
            return true
        end
    end
    
    for _, targetRarity in ipairs(TradeConfig.TargetRarities) do
        if petRarity == targetRarity then
            return true
        end
    end
    
    return false
end

local function checkOffer()
    local tradeData = getfenv().var70_upvw
    
    if not tradeData then return false end
    
    local theirOffer = tradeData.Party1.Offer
    
    if #theirOffer == 0 then
        return false
    end
    
    for _, pet in ipairs(theirOffer) do
        if pet.Type == "Pet" then
            local petName = pet.Name
            local petRarity = PetsData[petName].Rarity
            
            if petMatchesCriteria(petName, petRarity) then
                return true
            end
        end
    end
    
    return false
end

while true do
    while IsTrading() do
        task.wait(1)
    end
    
    local allPlayers = Players:GetPlayers()
    
    for _, targetUsername in ipairs(TradeConfig.TargetUsers) do
        local targetPlayer
        for _, player in ipairs(allPlayers) do
            if player.Name == targetUsername then
                targetPlayer = player
                break
            end
        end
        
        if targetPlayer and targetPlayer ~= LocalPlayer then
            Remote:FireServer("TradeRequest", targetPlayer)
            
            local startTime = tick()
            while not IsTrading() and tick() - startTime < 10 do
                task.wait(0.5)
            end
            
            if IsTrading() then
                task.wait(2)
                
                if checkOffer() then
                    Remote:FireServer("TradeAccept")
                else
                    Remote:FireServer("TradeDecline")
                end
                
                while IsTrading() do
                    task.wait(1)
                end
            end
            
            task.wait(3)
        end
    end
    
    task.wait(5)
end
