repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

pcall(function()
    require(ReplicatedStorage.Client.Effects.HatchEgg).Play = function() return end
end)

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)

local RE = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Framework"):WaitForChild("Network"):WaitForChild("Remote"):WaitForChild("RemoteEvent")

local CHRISTMAS = "Christmas World"
local TP_AFTER_GIFTS = CFrame.new(-2566.67, 25681.74, 1150.58)
local SNOWFLAKE_MAX = 5000000000
local SNOWFLAKE_MIN = 50000
local STALL_TIME = 120

local HouseLocations = {
    CFrame.new(-2422, 32, 974),
    CFrame.new(-2415, 32, 999),
    CFrame.new(-2521, 21, 1067),
    CFrame.new(-2711, 32, 1162),
    CFrame.new(-2709, 33, 1194),
    CFrame.new(-2672, 32, 1213),
    CFrame.new(-2450, 32, 972),
    CFrame.new(-2604, 21, 1115),
    CFrame.new(-2601, 21, 1066),
}

local function data()
    return LocalData:Get() or {}
end

local function isWorldUnlocked(world)
    local wu = data().WorldsUnlocked
    return wu and wu[world] == true
end

local function unlockWorld(world)
    RE:FireServer("UnlockWorld", world)
end

local function teleportWorld(world)
    RE:FireServer("WorldTeleport", world)
end

local function tp(cf)
    local c = player.Character or player.CharacterAdded:Wait()
    c:WaitForChild("HumanoidRootPart").CFrame = cf
end

local function pressE()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    task.wait(0.02)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
end

local function pressB()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.B, false, game)
    task.wait(0.02)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.B, false, game)
end

local function makeFailUI()
    local gui = Instance.new("ScreenGui")
    gui.IgnoreGuiInset = true
    gui.ResetOnSpawn = false
    gui.Parent = PlayerGui
    local frame = Instance.new("Frame")
    frame.Size = UDim2.fromOffset(200,200)
    frame.Position = UDim2.fromScale(0.5,0.5)
    frame.AnchorPoint = Vector2.new(0.5,0.5)
    frame.BackgroundColor3 = Color3.new(0,0,0)
    frame.Parent = gui
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.fromScale(0.8,0.25)
    btn.Position = UDim2.fromScale(0.5,0.5)
    btn.AnchorPoint = Vector2.new(0.5,0.5)
    btn.Text = "DISABLE UI"
    btn.Font = Enum.Font.GothamBold
    btn.TextScaled = true
    btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Parent = frame
    btn.MouseButton1Click:Connect(function()
        gui.Enabled = not gui.Enabled
    end)
end

local function makeSuccessUI()
    local gui = Instance.new("ScreenGui")
    gui.IgnoreGuiInset = true
    gui.ResetOnSpawn = false
    gui.Parent = PlayerGui
    local frame = Instance.new("Frame")
    frame.Size = UDim2.fromOffset(200,200)
    frame.Position = UDim2.fromScale(0.5,0.5)
    frame.AnchorPoint = Vector2.new(0.5,0.5)
    frame.BackgroundColor3 = Color3.fromRGB(0,200,0)
    frame.Parent = gui
    local label = Instance.new("TextLabel")
    label.Size = UDim2.fromScale(1,1)
    label.BackgroundTransparency = 1
    label.Text = "5B SNOWFLAKES SECURED"
    label.Font = Enum.Font.GothamBold
    label.TextScaled = true
    label.TextColor3 = Color3.new(0,0,0)
    label.Parent = frame
end

unlockWorld(CHRISTMAS)
task.wait(6)

if not isWorldUnlocked(CHRISTMAS) then
    makeFailUI()
else
    teleportWorld(CHRISTMAS)
end

task.wait(5)

local function sweepHouse(baseCF)
    local c = player.Character or player.CharacterAdded:Wait()
    local hrp = c:WaitForChild("HumanoidRootPart")
    hrp.CFrame = baseCF + Vector3.new(0,6,0)
    for i = 1,5 do
        hrp.CFrame = baseCF + Vector3.new(0,-4,0)
        task.wait(1)
    end
    hrp.CFrame = baseCF + Vector3.new(0,6,0)
    task.wait(1)
    task.wait(10)
end

local function grindHousesOnce()
    for _, cf in ipairs(HouseLocations) do
        sweepHouse(cf)
    end
end

local function spamEUntilMinOrStall()
    local last = data().Snowflakes or 0
    local t0 = tick()
    while (data().Snowflakes or 0) > SNOWFLAKE_MIN do
        pressE()
        task.wait(0.05)
        local cur = data().Snowflakes or 0
        if cur < last then
            last = cur
            t0 = tick()
        end
        if tick() - t0 >= STALL_TIME then
            return false
        end
    end
    return true
end

task.spawn(function()
    while true do
        pressB()
        task.wait(60)
    end
end)

task.spawn(function()
    local remotes = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Pickups"):WaitForChild("CollectPickup")
    local claimed = {}
    while true do
        local children = Workspace.Rendered:GetChildren()
        local target = children[15]
        if target then
            for _, obj in ipairs(target:GetChildren()) do
                local id = obj.Name
                if not claimed[id] then
                    claimed[id] = true
                    pcall(function()
                        remotes:FireServer(id)
                        obj:Destroy()
                    end)
                end
            end
        end
        task.wait(0.1)
    end
end)

while (data().Snowflakes or 0) < SNOWFLAKE_MAX do
    if (data().Snowflakes or 0) <= SNOWFLAKE_MIN then
        grindHousesOnce()
    else
        tp(TP_AFTER_GIFTS)
        task.wait(0.5)
        local ok = spamEUntilMinOrStall()
        if not ok then
            grindHousesOnce()
        end
    end
    task.wait(1)
end

if (data().Snowflakes or 0) >= SNOWFLAKE_MAX then
    makeSuccessUI()
end
