local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ws = workspace

local lp = Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()

local gui = Instance.new("ScreenGui")
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.DisplayOrder = 1e9
gui.Name = "LOADER"
gui.Parent = lp.PlayerGui

local bg = Instance.new("Frame", gui)
bg.Size = UDim2.new(1,0,1,0)
bg.BackgroundColor3 = Color3.new(0,0,0)

local container = Instance.new("Frame", bg)
container.AnchorPoint = Vector2.new(0.5,0.5)
container.Position = UDim2.new(0.5,0,0.5,0)
container.Size = UDim2.new(0.42,0,0.18,0)
container.BackgroundTransparency = 1

local outline = Instance.new("Frame", container)
outline.Size = UDim2.new(1,0,1,0)
outline.BackgroundColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", outline).CornerRadius = UDim.new(0,18)

local fill = Instance.new("Frame", outline)
fill.Position = UDim2.new(0.02,0,0.1,0)
fill.Size = UDim2.new(0,0,0.8,0)
fill.BackgroundColor3 = Color3.fromRGB(200,50,50)
Instance.new("UICorner", fill).CornerRadius = UDim.new(0,14)

local cap = Instance.new("Frame", container)
cap.AnchorPoint = Vector2.new(0,0.5)
cap.Position = UDim2.new(1,6,0.5,0)
cap.Size = UDim2.new(0,18,0.35,0)
cap.BackgroundColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", cap).CornerRadius = UDim.new(0,6)

local pct = Instance.new("TextLabel", container)
pct.Size = UDim2.new(1,0,1,0)
pct.BackgroundTransparency = 1
pct.Font = Enum.Font.GothamBlack
pct.TextScaled = true
pct.TextColor3 = Color3.new(1,1,1)
pct.Text = "0%"

local status = Instance.new("TextLabel", bg)
status.AnchorPoint = Vector2.new(0.5,0)
status.Position = UDim2.new(0.5,0,0.62,0)
status.Size = UDim2.new(0.9,0,0.06,0)
status.BackgroundTransparency = 1
status.Font = Enum.Font.GothamBold
status.TextScaled = true
status.TextColor3 = Color3.fromRGB(200,200,200)
status.Text = "üîÑ Loading‚Ä¶"

local progress,target = 0,0
RunService.RenderStepped:Connect(function()
	progress += (target-progress)*0.1
	progress = math.clamp(progress,0,100)
	fill.Size = UDim2.new((progress/100)*0.96,0,0.8,0)
	pct.Text = math.floor(progress).."%"
	if progress < 30 then
		fill.BackgroundColor3 = Color3.fromRGB(200,50,50)
	elseif progress < 70 then
		fill.BackgroundColor3 = Color3.fromRGB(220,180,40)
	else
		fill.BackgroundColor3 = Color3.fromRGB(80,220,120)
	end
end)

local function stage(p,t)
	target = p
	status.TextTransparency = 1
	status.Text = t
	TweenService:Create(status,TweenInfo.new(0.15),{TextTransparency=0}):Play()
	task.wait(0.2)
end

local keep = {}
local function k(x) if x then keep[x]=true end end

k(gui);k(bg);k(container);k(outline);k(fill);k(cap);k(pct);k(status)
k(ws.Camera)
k(char)

k(ReplicatedStorage)
for _,v in ipairs(ReplicatedStorage:GetDescendants()) do k(v) end

local worlds = ws:FindFirstChild("Worlds")
local christmas = worlds and worlds:FindFirstChild("Christmas World")
k(worlds)

if christmas then
	k(christmas)
	for _,v in ipairs(christmas:GetDescendants()) do k(v) end
	christmas.DescendantAdded:Connect(function(v) k(v) end)
end

local function protectCharacter(c)
	if not c then return end
	k(c)
	for _,v in ipairs(c:GetDescendants()) do k(v) end
end

protectCharacter(char)
lp.CharacterAdded:Connect(function(c)
	task.wait(0.4)
	protectCharacter(c)
end)

for _,g in ipairs(lp.PlayerGui:GetChildren()) do
	if g:IsA("ScreenGui") and g ~= gui then
		if g.Name:lower():find("snow") or g.Name:lower():find("flake") then
			k(g)
			for _,v in ipairs(g:GetDescendants()) do k(v) end
		end
	end
end

local surf = Instance.new("Part",ws)
surf.Size = Vector3.new(2000,20,2000)
surf.Position = Vector3.new(0,5,0)
surf.Anchored=true
surf.CanCollide=true
surf.Transparency=1
k(surf)

local function collectFrom(root,pred)
	local t={}
	if not root then return t end
	for _,o in ipairs(root:GetDescendants()) do
		if pred(o) and not keep[o] then
			t[#t+1]=o
		end
	end
	return t
end

local function batchFast(list,chunk,waitt)
	local i=1
	while i<=#list do
		for j=i,math.min(i+chunk-1,#list) do
			local o=list[j]
			if o and o.Parent and not keep[o] then
				pcall(function() o:Destroy() end)
			end
		end
		i+=chunk
		task.wait(waitt)
	end
end

stage(5,"üß® Destroying Worlds")
stage(10,"üíÄ Killing Server Players")
stage(15,"üß± Deleting Baseplates")

stage(20,"üñ•Ô∏è Erasing UI Layers")
task.spawn(function()
	batchFast(collectFrom(ws,function(o)
		return o:IsA("SurfaceGui") or o:IsA("BillboardGui")
	end),120,0.03)
end)

stage(35,"üéÜ Removing Visuals")
task.spawn(function()
	local rendered=ws:FindFirstChild("Rendered")
	batchFast(collectFrom(rendered,function(o)
		return o:IsA("MeshPart") or o:IsA("SpecialMesh") or o:IsA("UnionOperation")
		or o:IsA("Texture") or o:IsA("Decal") or o:IsA("ParticleEmitter")
		or o:IsA("Beam") or o:IsA("Trail") or o:IsA("Fire")
		or o:IsA("Smoke") or o:IsA("Sparkles") or o:IsA("Highlight")
		or o:IsA("SurfaceAppearance")
	end),120,0.03)
end)

stage(30,"üß® Destroying Rendered")
task.spawn(function()
	local rendered=ws:FindFirstChild("Rendered")
	if rendered then
		for _,v in ipairs(rendered:GetDescendants()) do
			if not keep[v] then pcall(function() v:Destroy() end) end
		end
		pcall(function() rendered:Destroy() end)
	end
end)

stage(50,"üéØ Deleting Decorations")
task.spawn(function()
	batchFast(collectFrom(ws,function(o)
		return o:IsA("Adornment") or o:IsA("SelectionBox")
		or o:IsA("SelectionSphere") or o:IsA("ArcHandles")
	end),120,0.03)
end)

stage(65,"‚öôÔ∏è Setting Game Settings")

local RemoteEvent = ReplicatedStorage:WaitForChild("Shared")
	:WaitForChild("Framework")
	:WaitForChild("Network")
	:WaitForChild("Remote")
	:WaitForChild("RemoteEvent")

RemoteEvent:FireServer("SetSetting","Low Detail Mode",true)
RemoteEvent:FireServer("SetSetting","Ultra Low Detail Mode",true)

local settings = {
	"Hide Pet Notifications","Delete Legendary T3 Mythics","Compact Pet Inventory",
	"Skip Easy Mythics","Skip All Non-Secrets","Skip Secrets","Bubble Gravity",
	"Sound Effects","Mystery Box Visibility","Hide Bubbles","Item Notifications",
	"Hide Quests","Skip Easy Legendary","Hide Others Pets","Hide All Pets",
	"Hide Global Secret Messages"
}

task.spawn(function()
	while #settings > 0 do
		local i = math.random(1,#settings)
		RemoteEvent:FireServer("SetSetting",settings[i],true)
		table.remove(settings,i)
		task.wait(5)
	end
end)

stage(75,"‚öôÔ∏è Setting Game Settings")
stage(85,"‚öôÔ∏è Setting Game Settings")
stage(92,"‚öôÔ∏è Setting Game Settings")
stage(97,"‚öôÔ∏è Setting Game Settings")
stage(100,"‚öôÔ∏è Setting Game Settings")

pcall(function() RunService:Set3dRenderingEnabled(true) end)

task.wait(0.2)
TweenService:Create(bg,TweenInfo.new(0.25),{BackgroundTransparency=1}):Play()
task.wait(0.3)
gui:Destroy()
task.wait(2)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local lp = Players.LocalPlayer

local LocalData=nil
pcall(function() LocalData=require(ReplicatedStorage.Client.Framework.Services.LocalData) end)
local PetsModule=nil
pcall(function() PetsModule=require(ReplicatedStorage.Shared.Data.Pets) end)

local function waitForDataReady()
	if LocalData and LocalData.IsReady and not LocalData:IsReady() and LocalData.DataReady then
		LocalData.DataReady:Wait()
	end
end

waitForDataReady()

local function gd()
	local ok,d=pcall(function()
		return (LocalData and LocalData.Get) and LocalData:Get() or {}
	end)
	return ok and d or {}
end

local function fmt_num(n)
	n=tonumber(n) or 0
	if n>=1e12 then return string.format("%.2fT",n/1e12)
	elseif n>=1e9 then return string.format("%.2fB",n/1e9)
	elseif n>=1e6 then return string.format("%.2fM",n/1e6)
	elseif n>=1e3 then return string.format("%.2fK",n/1e3)
	else return tostring(n) end
end

local function getSnow() return gd().Snowflakes or 0 end
local function getHatchesRaw() return (gd().Stats and gd().Stats.Hatches) or 0 end
local function getXmas() return (gd().MasteryLevels and gd().MasteryLevels.Christmas) or 0 end

local CHEST_NAME="Peppermint Chest"
local function getPepRemainingSeconds()
	local d=gd()
	local cds=d.Cooldowns
	if type(cds)~="table" then return nil end
	local ts=cds[CHEST_NAME] or cds["PeppermintChest"] or cds["Peppermint"]
	if type(ts)=="number" then return math.max(0,ts-os.time()) end
	return nil
end

local function fmt_hms(sec)
	sec=math.max(0,math.floor(sec or 0))
	return string.format("%02d:%02d:%02d",math.floor(sec/3600),math.floor((sec%3600)/60),sec%60)
end

local function fmt_mmss_or_ready(sec)
	if sec==nil then return "NOT FOUND" end
	sec=math.max(0,math.floor(sec))
	if sec==0 then return "READY !" end
	return string.format("%02d:%02d",math.floor(sec/60),sec%60)
end

local function getPotionsTwoLines()
	local d=gd()
	local fi,fe=0,0
	if d and d.Potions then
		for _,p in pairs(d.Potions) do
			if type(p)=="table" and p.Name and p.Amount then
				local n=tostring(p.Name)
				if n:find("Festive Infinity Elixir",1,true) then
					fi+=tonumber(p.Amount) or 0
				elseif n:find("Festive Elixir",1,true) then
					fe+=tonumber(p.Amount) or 0
				end
			end
		end
	end
	return fi,fe
end

local ITEMS={"Christmas Present","Christmas Key","Christmas Spin Ticket"}
local function getItems()
	local d=gd()
	local r={}
	local function scan(t)
		for k,v in pairs(t) do
			if type(v)=="table" then scan(v) else
				for _,nm in ipairs(ITEMS) do
					if k==nm then r[nm]=v end
				end
			end
		end
	end
	scan(d)
	return r
end

local function getTeam()
	local d=gd()
	local ids=(d.Teams and d.TeamEquipped and d.Teams[d.TeamEquipped] and d.Teams[d.TeamEquipped].Pets) or {}
	local map={}
	if d.Pets then for _,p in pairs(d.Pets) do map[tostring(p.Id)]=p end end
	local arr,sum={},0
	for _,id in ipairs(ids) do
		local p=map[tostring(id)]
		if p and PetsModule and PetsModule[p.Name] and PetsModule[p.Name].Stats then
			local sf=PetsModule[p.Name].Stats.Snowflakes or 0
			sum+=sf
			arr[#arr+1]={Name=p.Name,Snow=sf}
		end
	end
	return arr,sum
end

local gui=Instance.new("ScreenGui")
gui.Parent=lp.PlayerGui
gui.IgnoreGuiInset=true
gui.ResetOnSpawn=false
gui.DisplayOrder=9999999

local bg=Instance.new("Frame",gui)
bg.Size=UDim2.new(1,0,1,0)
bg.BackgroundColor3=Color3.fromRGB(0,0,0)
bg.BackgroundTransparency=0
bg.ZIndex=0

local function Section(x,y,w,h)
	local f=Instance.new("Frame",bg)
	f.AnchorPoint=Vector2.new(0.5,0.5)
	f.Position=UDim2.new(x,0,y,0)
	f.Size=UDim2.new(w,0,h,0)
	f.BackgroundTransparency=1
	f.ZIndex=1
	local ar=Instance.new("UIAspectRatioConstraint",f)
	ar.AspectRatio=4
	ar.DominantAxis=Enum.DominantAxis.Height
	return f
end

local function NewText(p)
	local t=Instance.new("TextLabel",p)
	t.Size=UDim2.new(1,0,1,0)
	t.BackgroundTransparency=1
	t.Font=Enum.Font.GothamBlack
	t.TextScaled=true
	t.TextWrapped=true
	t.TextColor3=Color3.new(1,1,1)
	t.TextTransparency=0
	t.Visible=true
	t.ZIndex=2
	t.TextXAlignment=Enum.TextXAlignment.Center
	t.TextYAlignment=Enum.TextYAlignment.Center
	return t
end

local USER=NewText(Section(0.5,0.12,0.6,0.1))
USER.Text="ü•ö "..lp.Name

local BIG=NewText(Section(0.5,0.22,0.7,0.18))
local RATE=NewText(Section(0.5,0.34,0.5,0.12))

local TL=NewText(Section(0.22,0.08,0.4,0.12))
TL.TextXAlignment=Enum.TextXAlignment.Left

local SESSION=NewText(Section(0.78,0.08,0.36,0.08))
local PEP=NewText(Section(0.78,0.14,0.20,0.05))

local ML=NewText(Section(0.22,0.50,0.42,0.09))
ML.TextXAlignment=Enum.TextXAlignment.Left

local MR=NewText(Section(0.88,0.30,0.42,0.09))
MR.TextXAlignment=Enum.TextXAlignment.Right

local petsFrame=Instance.new("Frame",bg)
petsFrame.Position=UDim2.new(0.02,0,0.86,0)
petsFrame.Size=UDim2.new(0.38,0,0.22,0)
petsFrame.BackgroundColor3=Color3.fromRGB(18,18,20)
petsFrame.ZIndex=1
Instance.new("UICorner",petsFrame)

local petsList=Instance.new("TextLabel",petsFrame)
petsList.Size=UDim2.new(1,-16,1,-16)
petsList.Position=UDim2.new(0,8,0,8)
petsList.BackgroundTransparency=1
petsList.Font=Enum.Font.Gotham
petsList.TextSize=16
petsList.TextColor3=Color3.fromRGB(220,220,220)
petsList.TextWrapped=true
petsList.TextXAlignment=Enum.TextXAlignment.Left
petsList.TextYAlignment=Enum.TextYAlignment.Top
petsList.ZIndex=2

local samples={}
local function push(v)
	samples[#samples+1]={t=tick(),v=v}
	while #samples>1 and tick()-samples[1].t>60 do table.remove(samples,1) end
end

local function perMin()
	if #samples<2 then return 0 end
	local a,b=samples[1],samples[#samples]
	if b.t-a.t<=0 or b.v-a.v<0 then return 0 end
	return ((b.v-a.v)/(b.t-a.t))*60
end

local startTick=tick()

while true do
	local snow=getSnow()
	push(snow)

	local items=getItems()
	local pres=items["Christmas Present"] or 0
	local keys=items["Christmas Key"] or 0
	local spins=items["Christmas Spin Ticket"] or 0

	BIG.Text="‚ùÑÔ∏è "..fmt_num(snow)
	RATE.Text="‚ùÑÔ∏è/min: "..fmt_num(perMin())
	SESSION.Text="‚è±Ô∏è Session: "..fmt_hms(tick()-startTick)
	PEP.Text="üç¨ Peppermint Chest:\n"..fmt_mmss_or_ready(getPepRemainingSeconds())

	local inf,elix=getPotionsTwoLines()
	TL.Text="üß™ Inventory potions\n‚ú® Festive Infinity Elixirs : "..fmt_num(inf).."\nüîÆ Festive Elixirs : "..fmt_num(elix)
	ML.Text="üéÅ Christmas Presents: "..fmt_num(pres)
	MR.Text="üóùÔ∏è "..fmt_num(keys).."\nüé° "..fmt_num(spins)

	local arr,sum=getTeam()
	if #arr>0 then
		local lines={}
		lines[#lines+1]="‚ùÑÔ∏è Total Multi : "..fmt_num(sum)
		lines[#lines+1]=""
		for i=1,#arr do
			lines[#lines+1]="üêæ "..arr[i].Name.." x"..fmt_num(arr[i].Snow).." ‚ùÑÔ∏è"
		end
		petsList.Text=table.concat(lines,"\n")
	else
		petsList.Text="None"
	end

	task.wait(1)
end
