local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

local gui = Instance.new("ScreenGui", lp:WaitForChild("PlayerGui"))
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.DisplayOrder = 999999999

local bg = Instance.new("Frame", gui)
bg.Size = UDim2.new(1,0,1,0)
bg.BackgroundColor3 = Color3.fromRGB(0,0,0)
bg.BorderSizePixel = 0

local function T(size, pos)
    local t = Instance.new("TextLabel", bg)
    t.Size = UDim2.new(0.85,0,0,size)
    t.Position = pos
    t.AnchorPoint = Vector2.new(0.5,0.5)
    t.BackgroundTransparency = 1
    t.Font = Enum.Font.GothamBlack
    t.TextScaled = true
    t.TextColor3 = Color3.fromRGB(255,255,255)
    t.TextWrapped = true
    return t
end

local big = T(130, UDim2.new(0.5,0,0.30,0))
local rate = T(65, UDim2.new(0.5,0,0.40,0))
local pep = T(60, UDim2.new(0.23,0,0.10,0))
pep.TextXAlignment = Enum.TextXAlignment.Left

local xmas = T(60, UDim2.new(0.77,0,0.10,0))
xmas.TextXAlignment = Enum.TextXAlignment.Right

local presents = T(60, UDim2.new(0.23,0,0.55,0))
presents.TextXAlignment = Enum.TextXAlignment.Left

local keys = T(60, UDim2.new(0.77,0,0.55,0))
keys.TextXAlignment = Enum.TextXAlignment.Right

local bottom = T(75, UDim2.new(0.5,0,0.80,0))

local function gd()
    local ok,d = pcall(function() return LocalData:Get() end)
    return ok and d or {}
end

local function fmt(n)
    n = tonumber(n) or 0
    if n>=1e12 then return string.format("%.2fT",n/1e12)
    elseif n>=1e9 then return string.format("%.2fB",n/1e9)
    elseif n>=1e6 then return string.format("%.2fM",n/1e6)
    elseif n>=1e3 then return string.format("%.2fK",n/1e3)
    else return tostring(n) end
end

local function getSnow()
    return gd().Snowflakes or 0
end

local function getPep()
    local d = gd().Cooldowns
    return d and (d["Peppermint Chest"] or d["PeppermintChest"] or d["Peppermint"])
end

local function getXmas()
    return gd().MasteryLevels and gd().MasteryLevels.Christmas or 0
end

local ITEM_NAMES = {
    ["Christmas Present"] = "ğŸ Christmas Presents",
    ["Christmas Key"] = "ğŸ—ï¸ Christmas Keys",
    ["Christmas Spin Ticket"] = "ğŸ¡ Christmas Spin Tickets",
}

local function getItems()
    local d = gd()
    local r = {}

    local function scan(t)
        for k,v in pairs(t) do
            if type(v)=="table" then scan(v)
            else
                if ITEM_NAMES[k] then
                    r[k] = v
                end
            end
        end
    end

    scan(d)
    return r
end

local function getTeam()
    local d = gd()
    local ids = (d.Teams and d.TeamEquipped and d.Teams[d.TeamEquipped] and d.Teams[d.TeamEquipped].Pets) or {}

    local map = {}
    if d.Pets then
        for _,p in pairs(d.Pets) do
            map[tostring(p.Id)] = p
        end
    end

    local arr = {}
    local sum = 0

    for _,id in ipairs(ids) do
        local p = map[tostring(id)]
        if p and PetsModule[p.Name] and PetsModule[p.Name].Stats and PetsModule[p.Name].Stats.Snowflakes then
            local sf = PetsModule[p.Name].Stats.Snowflakes or 0
            sum += sf
            arr[#arr+1] = {Name=p.Name, Snow=sf}
        end
    end

    return arr,sum
end

local function fmtTime(sec)
    if not sec or sec<=0 then return "Ready" end
    sec = math.floor(sec/1000)
    local m = math.floor(sec/60)
    local s = sec % 60
    return string.format("%d:%02d",m,s)
end

local samples = {}
local shown = 0
local idx = 1
local petsCycle = {}

local function push(v)
    samples[#samples+1] = {t=tick(),v=v}
    while #samples>1 and tick()-samples[1].t>60 do
        table.remove(samples,1)
    end
end

local function perMin()
    if #samples<2 then return 0 end
    local a = samples[1]
    local b = samples[#samples]
    if b.t-a.t<=0 or b.v-a.v<0 then return 0 end
    return ((b.v-a.v)/(b.t-a.t))*60
end

task.spawn(function()
    while true do
        local snow = getSnow()
        push(snow)

        local start = shown
        local target = snow
        local t0 = tick()
        local c

        c = RunService.Heartbeat:Connect(function()
            local a = math.clamp((tick()-t0)/0.3,0,1)
            shown = start + (target-start)*a
            big.Text = "â„ï¸ "..fmt(shown)
            if a>=1 then c:Disconnect() end
        end)

        rate.Text = "â„ï¸/min: "..fmt(perMin())

        pep.Text = "ğŸ¬ Peppermint Chest: "..fmtTime(getPep())
        xmas.Text = "ğŸ„ Xmas Mastery: "..getXmas()

        local it = getItems()

        presents.Text = (ITEM_NAMES["Christmas Present"]..": "..fmt(it["Christmas Present"] or 0))
        keys.Text = (ITEM_NAMES["Christmas Key"]..": "..fmt(it["Christmas Key"] or 0).."\n"..ITEM_NAMES["Christmas Spin Ticket"]..": "..fmt(it["Christmas Spin Ticket"] or 0))

        local arr,sum = getTeam()
        if #arr>0 then
            if idx>#arr then idx=1 end
            local p = arr[idx]
            bottom.Text = "ğŸ¾ Pet: "..p.Name.." x"..fmt(p.Snow).."   |   â„ï¸ Team Multi: "..fmt(sum)
            idx += 1
        else
            bottom.Text = "ğŸ¾ No Pets Equipped"
        end

        task.wait(1)
    end
end)
