local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local PetsModule = require(ReplicatedStorage.Shared.Data.Pets)

local function gd()
    local ok, d = pcall(function()
        return LocalData:Get()
    end)
    return ok and d or {}
end

local function fmt(n)
    n = tonumber(n) or 0
    if n >= 1e12 then
        return string.format("%.2fT", n / 1e12)
    elseif n >= 1e9 then
        return string.format("%.2fB", n / 1e9)
    elseif n >= 1e6 then
        return string.format("%.2fM", n / 1e6)
    elseif n >= 1e3 then
        return string.format("%.2fK", n / 1e3)
    else
        return tostring(n)
    end
end

local function getSnow()
    return gd().Snowflakes or 0
end

local function getHatches()
    return gd().Stats and gd().Stats.Hatches or 0
end

local function getPep()
    local d = gd().Cooldowns
    if type(d) ~= "table" then
        return nil
    end
    local ts = d["Peppermint Chest"] or d["PeppermintChest"] or d["Peppermint"]
    if type(ts) == "number" then
        local now = os.time()
        local left = ts - now
        return left
    end
    return nil
end

local function fmtTime(sec)
    if not sec then return "READY" end
    sec = math.max(0, math.floor(sec))
    if sec <= 0 then return "READY" end
    local h = math.floor(sec/3600)
    local m = math.floor((sec%3600)/60)
    local s = sec%60
    return string.format("%02d:%02d:%02d", h, m, s)
end

local function getXmas()
    return gd().MasteryLevels and gd().MasteryLevels.Christmas or 0
end

local ITEMS = {"Christmas Present", "Christmas Key", "Christmas Spin Ticket"}

local function getItems()
    local d = gd()
    local r = {}
    local function scan(t)
        for k, v in pairs(t) do
            if type(v) == "table" then
                scan(v)
            else
                for _, nm in ipairs(ITEMS) do
                    if k == nm then
                        r[nm] = v
                    end
                end
            end
        end
    end
    scan(d)
    return r
end

local function getTeam()
    local d = gd()
    local ids = (d.Teams and d.TeamEquipped and d.Teams[d.TeamEquipped] and d.Teams[d.TeamEquipped].Pets) or {}
    local map = {}
    if d.Pets then
        for _, p in pairs(d.Pets) do
            map[tostring(p.Id)] = p
        end
    end
    local arr = {}
    local sum = 0
    for _, id in ipairs(ids) do
        local p = map[tostring(id)]
        if p and PetsModule[p.Name] and PetsModule[p.Name].Stats then
            local sf = PetsModule[p.Name].Stats.Snowflakes or 0
            sum += sf
            arr[#arr + 1] = {Name = p.Name, Snow = sf, Id = p.Id, Enchants = p.Enchants}
        end
    end
    return arr, sum
end

local function hasTeamUpEnchant(pet)
    if not pet or not pet.Enchants then return false, nil end
    for _, enchant in ipairs(pet.Enchants) do
        if enchant.Id and string.lower(tostring(enchant.Id)):sub(1, 7) == "team-up" then
            return true, enchant.Id
        end
    end
    return false, nil
end

local function getEnchantDisplay(pet)
    if not pet or not pet.Enchants or #pet.Enchants == 0 then
        return "None", "‚ùå"
    end
    local firstEnchant = pet.Enchants[1]
    local enchantName = firstEnchant.Id or "Enchant"
    local isTeamUp = string.lower(tostring(enchantName)):sub(1, 7) == "team-up"
    return enchantName, isTeamUp and "‚úÖ" or "‚ùå"
end

local function getEquippedPetsWithEnchants()
    local d = gd()
    local ids = (d.Teams and d.TeamEquipped and d.Teams[d.TeamEquipped] and d.Teams[d.TeamEquipped].Pets) or {}
    local map = {}
    if d.Pets then
        for _, p in pairs(d.Pets) do
            map[tostring(p.Id)] = p
        end
    end
    local equipped = {}
    for _, id in ipairs(ids) do
        local p = map[tostring(id)]
        if p then
            equipped[#equipped + 1] = {
                Name = p.Name,
                Id = p.Id,
                Enchants = p.Enchants
            }
        end
    end
    return equipped
end

local function getRandomPets(pets, count)
    if #pets <= count then return pets end
    local shuffled = {}
    for _, pet in ipairs(pets) do
        table.insert(shuffled, pet)
    end
    for i = #shuffled, 2, -1 do
        local j = math.random(i)
        shuffled[i], shuffled[j] = shuffled[j], shuffled[i]
    end
    local result = {}
    for i = 1, math.min(count, #shuffled) do
        table.insert(result, shuffled[i])
    end
    return result
end

local function getPotions()
    local d = gd()
    local potions = {}
    if d.Potions then
        for _, pot in pairs(d.Potions) do
            if type(pot) == "table" then
                if pot.Name == "Festive Infinity Elixir 1" then
                    potions.Infinity = pot.Amount or 0
                elseif pot.Name == "Festive Elixir 4" then
                    potions.IV = pot.Amount or 0
                elseif pot.Name == "Festive Elixir 3" then
                    potions.III = pot.Amount or 0
                end
            end
        end
    end
    return potions.Infinity or 0, potions.IV or 0, potions.III or 0
end

local gui = Instance.new("ScreenGui", lp.PlayerGui)
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.DisplayOrder = 9999999

local bg = Instance.new("Frame", gui)
bg.Size = UDim2.new(1, 0, 1, 0)
bg.BackgroundColor3 = Color3.fromRGB(0, 0, 0)

local function Section(x, y, w, h)
    local f = Instance.new("Frame", bg)
    f.AnchorPoint = Vector2.new(0.5, 0.5)
    f.Position = UDim2.new(x, 0, y, 0)
    f.Size = UDim2.new(w, 0, h, 0)
    f.BackgroundTransparency = 1
    local ar = Instance.new("UIAspectRatioConstraint", f)
    ar.AspectRatio = 4
    ar.DominantAxis = Enum.DominantAxis.Height
    return f
end

local function NewText(p)
    local t = Instance.new("TextLabel", p)
    t.Size = UDim2.new(1, 0, 1, 0)
    t.BackgroundTransparency = 1
    t.Font = Enum.Font.GothamBlack
    t.TextScaled = true
    t.TextColor3 = Color3.fromRGB(255, 255, 255)
    t.TextWrapped = true
    return t
end

local user = Section(0.5, 0.12, 0.6, 0.1)
local USER = NewText(user)
USER.Text = "üë§ " .. lp.Name

local snowBig = Section(0.5, 0.22, 0.7, 0.18)
local BIG = NewText(snowBig)

local snowRate = Section(0.5, 0.34, 0.5, 0.12)
local RATE = NewText(snowRate)

local sessionSection = Section(0.22, 0.08, 0.4, 0.12)
local SESSION = NewText(sessionSection)
SESSION.TextXAlignment = Enum.TextXAlignment.Left

local potionsSection = Section(0.22, 0.22, 0.4, 0.12)
local POTIONS = NewText(potionsSection)
POTIONS.TextXAlignment = Enum.TextXAlignment.Left

local midLeft = Section(0.22, 0.50, 0.42, 0.09)
local ML = NewText(midLeft)
ML.TextXAlignment = Enum.TextXAlignment.Left

local midRight = Section(0.88, 0.30, 0.42, 0.09)
local MR = NewText(midRight)
MR.TextXAlignment = Enum.TextXAlignment.Right

local msgBar = Section(0.52, 0.50, 0.75, 0.11)
local MSG = NewText(msgBar)
MSG.TextTransparency = 1
MSG.TextWrapped = true

local petsFrame = Instance.new("Frame", bg)
petsFrame.AnchorPoint = Vector2.new(0, 1)
petsFrame.Position = UDim2.new(0.02, 0, 0.86, 0)
petsFrame.Size = UDim2.new(0.38, 0, 0.22, 0)
petsFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 20)
local petsCorner = Instance.new("UICorner", petsFrame)

local petsTitle = Instance.new("TextLabel", petsFrame)
petsTitle.Size = UDim2.new(1, -16, 0, 22)
petsTitle.Position = UDim2.new(0, 8, 0, 6)
petsTitle.BackgroundTransparency = 1
petsTitle.Font = Enum.Font.GothamBold
petsTitle.TextSize = 16
petsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
petsTitle.Text = "üêæ Equipped Pets"
petsTitle.TextXAlignment = Enum.TextXAlignment.Left

local petsList = Instance.new("TextLabel", petsFrame)
petsList.Size = UDim2.new(1, -16, 1, -34)
petsList.Position = UDim2.new(0, 8, 0, 30)
petsList.BackgroundTransparency = 1
petsList.Font = Enum.Font.Gotham
petsList.TextSize = 16
petsList.TextColor3 = Color3.fromRGB(220, 220, 220)
petsList.TextWrapped = true
petsList.TextXAlignment = Enum.TextXAlignment.Left

local multiFrame = Instance.new("Frame", bg)
multiFrame.AnchorPoint = Vector2.new(1, 1)
multiFrame.Position = UDim2.new(0.98, 0, 0.86, 0)
multiFrame.Size = UDim2.new(0.22, 0, 0.22, 0)
multiFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 20)
local multiCorner = Instance.new("UICorner", multiFrame)

local multiTitle = Instance.new("TextLabel", multiFrame)
multiTitle.Size = UDim2.new(1, -16, 0, 24)
multiTitle.Position = UDim2.new(0, 8, 0, 6)
multiTitle.BackgroundTransparency = 1
multiTitle.Font = Enum.Font.GothamBold
multiTitle.TextSize = 14
multiTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
multiTitle.Text = "Team Multi:"

local multiValue = Instance.new("TextLabel", multiFrame)
multiValue.Size = UDim2.new(1, -16, 1, -36)
multiValue.Position = UDim2.new(0, 8, 0, 30)
multiValue.BackgroundTransparency = 1
multiValue.Font = Enum.Font.GothamBlack
multiValue.TextSize = 28
multiValue.TextColor3 = Color3.fromRGB(220, 220, 220)
multiValue.Text = "‚ùÑÔ∏è\n0"
multiValue.TextXAlignment = Enum.TextXAlignment.Center
multiValue.TextYAlignment = Enum.TextYAlignment.Center
multiValue.TextWrapped = true

local enchantsFrame = Instance.new("Frame", bg)
enchantsFrame.AnchorPoint = Vector2.new(1, 1)
enchantsFrame.Position = UDim2.new(0.98, 0, 0.62, 0)
enchantsFrame.Size = UDim2.new(0.22, 0, 0.22, 0)
enchantsFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 20)
local enchantsCorner = Instance.new("UICorner", enchantsFrame)

local enchantsTitle = Instance.new("TextLabel", enchantsFrame)
enchantsTitle.Size = UDim2.new(1, -16, 0, 22)
enchantsTitle.Position = UDim2.new(0, 8, 0, 6)
enchantsTitle.BackgroundTransparency = 1
enchantsTitle.Font = Enum.Font.GothamBold
enchantsTitle.TextSize = 16
enchantsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
enchantsTitle.Text = "üîÆ Pet Enchants"
enchantsTitle.TextXAlignment = Enum.TextXAlignment.Left

local enchantsList = Instance.new("TextLabel", enchantsFrame)
enchantsList.Size = UDim2.new(1, -16, 1, -34)
enchantsList.Position = UDim2.new(0, 8, 0, 30)
enchantsList.BackgroundTransparency = 1
enchantsList.Font = Enum.Font.Gotham
enchantsList.TextSize = 14
enchantsList.TextColor3 = Color3.fromRGB(220, 220, 220)
enchantsList.TextWrapped = true
enchantsList.TextXAlignment = Enum.TextXAlignment.Left
enchantsList.TextYAlignment = Enum.TextYAlignment.Top

local masterySection = Instance.new("Frame", bg)
masterySection.Size = UDim2.new(0.36, 0, 0.08, 0)
masterySection.BackgroundTransparency = 1
masterySection.AnchorPoint = Vector2.new(0.5, 0.5)

local masteryLabel = Instance.new("TextLabel", masterySection)
masteryLabel.Size = UDim2.new(1, 0, 1, 0)
masteryLabel.BackgroundTransparency = 1
masteryLabel.Font = Enum.Font.GothamBold
masteryLabel.TextScaled = true
masteryLabel.TextWrapped = true
masteryLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
masteryLabel.Text = "üéÑ Xmas Mastery: 0"

local samples = {}
local function push(v)
    samples[#samples + 1] = {t = tick(), v = v}
    while #samples > 1 and tick() - samples[1].t > 60 do
        table.remove(samples, 1)
    end
end

local function perMin()
    if #samples < 2 then
        return 0
    end
    local a = samples[1]
    local b = samples[#samples]
    if b.t - a.t <= 0 or b.v - a.v < 0 then
        return 0
    end
    return ((b.v - a.v) / (b.t - a.t)) * 60
end

local startTick = tick()
local last = {
    snow = getSnow(),
    presents = 0,
    keys = 0,
    spins = 0,
    xmas = getXmas(),
    hatches = getHatches(),
    enchants = {}
}
local queue = {}
local lastEnchantChange = 0

local function fadeMsg(t)
    MSG.Text = t
    MSG.Position = UDim2.new(0.52, 0, 0.50, 18)
    MSG.TextTransparency = 1
    TweenService:Create(MSG, TweenInfo.new(0.5), {
        TextTransparency = 0,
        Position = UDim2.new(0.52, 0, 0.50, 0)
    }):Play()
end

local function addMsg(m)
    if queue[#queue] ~= m then
        queue[#queue + 1] = m
    end
end

local function updateEnchantsDisplay()
    local equipped = getEquippedPetsWithEnchants()
    
    local teamUpPets = {}
    local nonTeamUpPets = {}
    
    for _, pet in ipairs(equipped) do
        local hasTeamUp, _ = hasTeamUpEnchant(pet)
        if hasTeamUp then
            table.insert(teamUpPets, pet)
        else
            table.insert(nonTeamUpPets, pet)
        end
    end
    
    local displayPets = {}
    local displayCount = 4
    
    if #nonTeamUpPets > 0 then
        displayPets = getRandomPets(nonTeamUpPets, math.min(displayCount, #nonTeamUpPets))
    else
        displayPets = getRandomPets(equipped, math.min(displayCount, #equipped))
    end
    
    local lines = {}
    for _, pet in ipairs(displayPets) do
        local enchantName, status = getEnchantDisplay(pet)
        local line = string.format("%s > %s %s", pet.Name, enchantName, status)
        table.insert(lines, line)
    end
    
    enchantsList.Text = table.concat(lines, "\n")
    
    local currentEnchants = {}
    for _, pet in ipairs(equipped) do
        if pet.Id then
            currentEnchants[tostring(pet.Id)] = pet.Enchants
        end
    end
    
    for id, enchants in pairs(currentEnchants) do
        local oldEnchants = last.enchants[id]
        if oldEnchants and not rawequal(oldEnchants, enchants) then
            lastEnchantChange = tick()
            addMsg("üîÆ Enchanting Pets...")
            break
        end
    end
    last.enchants = currentEnchants
end

task.spawn(function()
    while true do
        local snow = getSnow()
        push(snow)
        
        local items = getItems()
        local pres = items["Christmas Present"] or 0
        local keys = items["Christmas Key"] or 0
        local spins = items["Christmas Spin Ticket"] or 0
        local xmas = getXmas()
        local htc = getHatches()
        local pepTime = getPep()
        local inf, iv, iii = getPotions()
        
        if xmas > last.xmas then
            addMsg("üéÑ Upgraded Xmas Mastery!")
        end
        if keys < last.keys then
            addMsg("üóùÔ∏è Opening Christmas Chest‚Ä¶")
        end
        if keys > last.keys then
            addMsg("üóùÔ∏è +" .. fmt(keys - last.keys) .. " Christmas Keys!")
        end
        if spins < last.spins then
            addMsg("üé° Spinning Christmas Wheel‚Ä¶")
        end
        if spins > last.spins then
            addMsg("üé° +" .. fmt(spins - last.spins) .. " Christmas Spins!")
        end
        if pres > last.presents then
            addMsg("üéÅ +" .. fmt(pres - last.presents) .. " Christmas Presents!")
        end
        if snow > last.snow then
            addMsg("‚ùÑÔ∏è Automatically Giving Gifts‚Ä¶")
        end
        if snow < last.snow and htc > last.hatches then
            addMsg("ü•ö Hatching Eggs: +" .. fmt(htc - last.hatches))
        end
        
        last.snow = snow
        last.presents = pres
        last.keys = keys
        last.spins = spins
        last.xmas = xmas
        last.hatches = htc
        
        local s0 = shown or snow
        local s1 = snow
        local t0 = tick()
        local c
        c = RunService.Heartbeat:Connect(function()
            local a = math.clamp((tick() - t0) / 0.3, 0, 1)
            shown = s0 + (s1 - s0) * a
            BIG.Text = "‚ùÑÔ∏è " .. fmt(shown)
            if a >= 1 then
                c:Disconnect()
            end
        end)
        
        RATE.Text = "‚ùÑÔ∏è/min: " .. fmt(perMin())
        
        local elapsed = math.floor(tick() - startTick)
        local h = math.floor(elapsed / 3600)
        local m = math.floor((elapsed % 3600) / 60)
        local s = elapsed % 60
        SESSION.Text = string.format("Session: %02d:%02d:%02d\nPeppermint Chest: %s", h, m, s, fmtTime(pepTime))
        
        POTIONS.Text = string.format("üéØ Inventory Potions\nFestive Infinity Elixirs: %s\nFestive Elixir IV: %s\nFestive Elixir III: %s", fmt(inf), fmt(iv), fmt(iii))
        
        ML.Text = "üéÅ Christmas Presents: " .. fmt(pres)
        MR.Text = "üóùÔ∏è " .. fmt(keys) .. "\nüé° " .. fmt(spins)
        
        local arr, sum = getTeam()
        if #arr > 0 then
            local lines = {}
            for i = 1, #arr do
                local e = arr[i].Name .. " x" .. fmt(arr[i].Snow) .. " ‚ùÑÔ∏è"
                local r = math.floor((i - 1) / 3) + 1
                lines[r] = lines[r] and (lines[r] .. "      " .. e) or e
            end
            petsList.Text = table.concat(lines, "\n")
            multiValue.Text = "‚ùÑÔ∏è\n" .. fmt(sum)
        else
            petsList.Text = "None"
            multiValue.Text = "‚ùÑÔ∏è\n0"
        end
        
        updateEnchantsDisplay()
        
        local petPos = petsFrame.AbsolutePosition
        local petSize = petsFrame.AbsoluteSize
        local multiPos = multiFrame.AbsolutePosition
        local multiSize = multiFrame.AbsoluteSize
        
        local midX = (petPos.X + petSize.X / 2 + multiPos.X + multiSize.X / 2) / 2
        local midY = (petPos.Y + petSize.Y / 2 + multiPos.Y + multiSize.Y / 2) / 2
        
        masterySection.Position = UDim2.new(midX / bg.AbsoluteSize.X, 0, midY / bg.AbsoluteSize.Y, 0)
        masteryLabel.Text = "üéÑ Xmas Mastery: " .. xmas
        
        if #queue > 0 then
            local m = table.remove(queue, 1)
            fadeMsg(m)
            task.wait(math.random(3, 10))
            TweenService:Create(MSG, TweenInfo.new(0.35), {
                TextTransparency = 1,
                Position = UDim2.new(0.52, 0, 0.50, 18)
            }):Play()
        else
            MSG.Text = ""
        end
        
        task.wait(1)
    end
end)
